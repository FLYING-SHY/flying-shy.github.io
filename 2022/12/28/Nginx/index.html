<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Nginx | 阿华</title><meta name="author" content="HUA"><meta name="copyright" content="HUA"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="Nginx基础篇Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器，同时也提供了 IMAP&#x2F;POP3&#x2F;SMTP服务。Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的 Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004 年10月4日。 其将源代码以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、简单的">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx">
<meta property="og:url" content="http://example.com/2022/12/28/Nginx/index.html">
<meta property="og:site_name" content="阿华">
<meta property="og:description" content="Nginx基础篇Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器，同时也提供了 IMAP&#x2F;POP3&#x2F;SMTP服务。Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的 Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004 年10月4日。 其将源代码以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、简单的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/page5.jpg">
<meta property="article:published_time" content="2022-12-28T01:47:09.000Z">
<meta property="article:modified_time" content="2023-10-14T09:33:57.430Z">
<meta property="article:author" content="HUA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/page5.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/12/28/Nginx/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Nginx',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-14 17:33:57'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-clock/lib/clock.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/loading.gif" data-original="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">阿华</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Nginx</h1><div id="post-meta"><div class="meta-firstline"></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">38.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>156分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Nginx"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="Nginx基础篇"><a href="#Nginx基础篇" class="headerlink" title="Nginx基础篇"></a>Nginx基础篇</h1><p>Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器，同时也提供了 IMAP&#x2F;POP3&#x2F;SMTP服务。Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的 Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004 年10月4日。 其将源代码以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、简单的配 置文件和低系统资源的消耗而闻名。2011年6月1日，nginx 1.0.4发布。 Nginx是一款轻量级的Web 服务器&#x2F;反向代理服务器及电子邮件（IMAP&#x2F;POP3） 代理服务器，在BSD-like 协议下发行。其特点是占有内存少，并发能力强，事实 上nginx的并发能力在同类型的网页服务器中表现较好，中国大陆使用nginx网站 用户有：百度、京东、新浪、网易、腾讯、淘宝等。</p>
<h2 id="虚拟机安装配置配置"><a href="#虚拟机安装配置配置" class="headerlink" title="虚拟机安装配置配置"></a>虚拟机安装配置配置</h2><h3 id="安装虚拟机CentOS7-4"><a href="#安装虚拟机CentOS7-4" class="headerlink" title="安装虚拟机CentOS7.4"></a>安装虚拟机CentOS7.4</h3><p>略</p>
<p>在这次学习时使用mini班操作系统镜像，安装速度快，也去除了我们用不到的软件</p>
<h3 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h3><p>略</p>
<h3 id="Linux配置"><a href="#Linux配置" class="headerlink" title="Linux配置"></a>Linux配置</h3><h4 id="配置上网"><a href="#配置上网" class="headerlink" title="配置上网"></a>配置上网</h4><ul>
<li>修改配置网卡配置文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-ens33</span><br></pre></td></tr></table></figure>

<ul>
<li>修改 <code>ONBOOT=yes</code></li>
<li>重启网络服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ping qq.com</span><br></pre></td></tr></table></figure>

<p>至此，我们的虚拟机就可以访问互联网了。</p>
<h4 id="配置静态ip"><a href="#配置静态ip" class="headerlink" title="配置静态ip"></a>配置静态ip</h4><ul>
<li>查看本地IP</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141725895.png" alt="image-20220917141707267"></p>
<p>之前的网络配置是使用dhcp方式分配ip地址，这种方式会在系统每次联网的时候分配一个ip给我们用，也就是说有可能系统下次启动的时候ip会变，这样非常不方便我们管理。</p>
<p>网段和网关可以通过以下方式查看：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141725758.png" alt="image-20220917142431736"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141725312.png" alt="image-20220917142640285"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141725981.png" alt="image-20220917142655381"></p>
<ul>
<li>配置静态ip首先需要打开网卡配置文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-ens33</span><br></pre></td></tr></table></figure>

<ul>
<li>修改启动协议 <code>BOOTPROTO=static</code></li>
<li>手动配置ip地址</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=d768f819-cfc1-4a6d-8bf5-cd7359a86c75</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IP地址 （根据自己的环境修改）</span></span><br><span class="line">IPADDR=192.168.182.129</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">子网掩码</span></span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网关（根据自己的环境修改）</span></span><br><span class="line">GATEWAY=192.168.182.2</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">DNS</span></span><br><span class="line">DNS1=223.5.5.5</span><br></pre></td></tr></table></figure>

<p>根据大家自己的环境，ip地址可能略有不同。</p>
<ul>
<li>接下来重启网络服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<p>重启之后 MobaXterm可能无响应，这是因为ip变了，修改配置中的ip重新连接即可。</p>
<p>完整配置截图如下</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141725446.png" alt="image-20220917151735959"></p>
<h4 id="不能上网的错误排查"><a href="#不能上网的错误排查" class="headerlink" title="不能上网的错误排查"></a>不能上网的错误排查</h4><ul>
<li><p>vmware中网关是否正确</p>
</li>
<li><p>直接ping ip是否能通（物理连接排查）</p>
</li>
<li><p>卸载重装</p>
</li>
</ul>
<h4 id="一些公网DNS服务器"><a href="#一些公网DNS服务器" class="headerlink" title="一些公网DNS服务器"></a>一些公网DNS服务器</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">阿里</span></span><br><span class="line">223.5.5.5</span><br><span class="line">223.6.6.6</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">腾讯</span></span><br><span class="line">119.29.29.29</span><br><span class="line">182.254.118.118</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">百度</span></span><br><span class="line">180.76.76.76</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">114 DNS</span></span><br><span class="line">114.114.114.114</span><br><span class="line">114.114.115.115</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">谷歌</span></span><br><span class="line">8.8.8.8</span><br><span class="line">8.8.4.4</span><br></pre></td></tr></table></figure>

<h4 id="Centos7-防火墙的关闭"><a href="#Centos7-防火墙的关闭" class="headerlink" title="Centos7 防火墙的关闭"></a>Centos7 防火墙的关闭</h4><p>CentOS 7.0默认使用的是firewall作为防火墙</p>
<p>查看防火墙状态</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">firewall-cmd --state</span><br></pre></td></tr></table></figure>

<p>停止firewall</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure>

<p>禁止firewall开机启动</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure>

<p>放行端口</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure>

<p>重启防火墙</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h3 id="Nginx的安装"><a href="#Nginx的安装" class="headerlink" title="Nginx的安装"></a>Nginx的安装</h3><h4 id="版本区别"><a href="#版本区别" class="headerlink" title="版本区别"></a>版本区别</h4><p>常用版本分为四大阵营：</p>
<ul>
<li>Nginx开源版</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://nginx.org/">http://nginx.org/</a></p>
<ul>
<li>Nginx plus 商业版</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.nginx.com/">https://www.nginx.com</a></p>
<ul>
<li>openresty</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://openresty.org/cn/">http://openresty.org/cn/</a></p>
<ul>
<li>Tengine</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://tengine.taobao.org/">http://tengine.taobao.org</a></p>
<h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141725781.png" alt="image-20220917145353040"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进行解压</span></span><br><span class="line">tar zxvf nginx-1.21.6.tar.gz</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@nginx ~]# ls</span><br><span class="line">1  anaconda-ks.cfg  nginx-1.21.6  nginx-1.21.6.tar.gz</span><br><span class="line">[root@nginx ~]# cd nginx-1.21.6</span><br><span class="line">[root@nginx nginx-1.21.6]# ls</span><br><span class="line">auto     CHANGES.ru  configure  html     man     src</span><br><span class="line">CHANGES  conf        contrib    LICENSE  README</span><br><span class="line">[root@nginx nginx-1.21.6]# ./configure</span><br><span class="line">checking for OS</span><br><span class="line"> + Linux 3.10.0-693.el7.x86_64 x86_64</span><br><span class="line">checking for C compiler ... not found</span><br><span class="line"></span><br><span class="line">./configure: error: C compiler cc is not found</span><br></pre></td></tr></table></figure>

<h5 id="如果出现警告或报错"><a href="#如果出现警告或报错" class="headerlink" title="如果出现警告或报错"></a>如果出现警告或报错</h5><p>提示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">checking for OS</span><br><span class="line">+ Linux 3.10.0-693.el7.x86_64 x86_64</span><br><span class="line">checking for C compiler ... not found</span><br><span class="line">./configure: error: C compiler cc is not found</span><br></pre></td></tr></table></figure>

<p>安装gcc</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y gcc</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/configure: error: the HTTP rewrite module requires the PCRE library.</span><br><span class="line">You can either disable the module by using --without-http_rewrite_module</span><br><span class="line">option, or install the PCRE library into the system, or build the PCRE library</span><br><span class="line">statically from the source with nginx by using --with-pcre=&lt;path&gt; option.</span><br></pre></td></tr></table></figure>

<p>安装perl库</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y pcre pcre-devel</span><br></pre></td></tr></table></figure>

<p>提示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./configure: error: the HTTP gzip module requires the zlib library.</span><br><span class="line">You can either disable the module by using --without-http_gzip_module</span><br><span class="line">option, or install the zlib library into the system, or build the zlib library</span><br><span class="line">statically from the source with nginx by using --with-zlib=&lt;path&gt; option.</span><br></pre></td></tr></table></figure>

<p>安装zlib库:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y zlib zlib-devel</span><br></pre></td></tr></table></figure>

<p>指定安装路径是&#x2F;usr&#x2F;local&#x2F;nginx</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx </span><br></pre></td></tr></table></figure>

<p>接下来执行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h4 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h4><p>进入安装好的目录<code>/usr/local/nginx/sbin</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./nginx					    # 启动</span><br><span class="line">./nginx -s stop			 	#快速停止</span><br><span class="line">./nginx -s quit 			#优雅关闭，在退出前完成已经接受的连接请求</span><br><span class="line">./nginx -s reload 			#重新加载配置</span><br></pre></td></tr></table></figure>

<p>访问地址-<a target="_blank" rel="noopener" href="http://192.168.182.129/">http://192.168.182.129/</a></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141725813.png" alt="image-20220917153250542"></p>
<h4 id="安装成系统服务"><a href="#安装成系统服务" class="headerlink" title="安装成系统服务"></a>安装成系统服务</h4><p>在如下位置创建服务脚本nginx.service</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>

<p>服务脚本内容如下(注意路径要对应，这里的路径是&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin)：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=nginx - web server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/local/nginx/logs/nginx.pid</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">ExecStop=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">ExecQuit=/usr/local/nginx/sbin/nginx -s quit</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>查看nginx服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps -ef |grep nginx</span><br></pre></td></tr></table></figure>

<p>关闭nginx</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./nginx  -s stop</span><br></pre></td></tr></table></figure>

<p>重新加载系统服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl start nginx.service</span><br></pre></td></tr></table></figure>

<p>开机启动</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl enable nginx.service</span><br></pre></td></tr></table></figure>

<h2 id="Nginx基础使用"><a href="#Nginx基础使用" class="headerlink" title="Nginx基础使用"></a>Nginx基础使用</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141725639.png" alt="image-20220917155410067"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# tree /usr/local/nginx</span><br><span class="line">/usr/local/nginx</span><br><span class="line">├── client_body_temp                 # POST 大文件暂存目录</span><br><span class="line">├── conf                             # Nginx所有配置文件的目录</span><br><span class="line">│   ├── fastcgi.conf                 # fastcgi相关参数的配置文件</span><br><span class="line">│   ├── fastcgi.conf.default         # fastcgi.conf的原始备份文件</span><br><span class="line">│   ├── fastcgi_params               # fastcgi的参数文件</span><br><span class="line">│   ├── fastcgi_params.default       </span><br><span class="line">│   ├── koi-utf</span><br><span class="line">│   ├── koi-win</span><br><span class="line">│   ├── mime.types                   # 媒体类型</span><br><span class="line">│   ├── mime.types.default</span><br><span class="line">│   ├── nginx.conf                   #这是Nginx默认的主配置文件，日常使用和修改的文件</span><br><span class="line">│   ├── nginx.conf.default</span><br><span class="line">│   ├── scgi_params                  # scgi相关参数文件</span><br><span class="line">│   ├── scgi_params.default  </span><br><span class="line">│   ├── uwsgi_params                 # uwsgi相关参数文件</span><br><span class="line">│   ├── uwsgi_params.default</span><br><span class="line">│   └── win-utf</span><br><span class="line">├── fastcgi_temp                     # fastcgi临时数据目录</span><br><span class="line">├── html                             # Nginx默认站点目录</span><br><span class="line">│   ├── 50x.html                     # 错误页面优雅替代显示文件，例如出现502错误时会调用此页面</span><br><span class="line">│   └── index.html                   # 默认的首页文件</span><br><span class="line">├── logs                             # Nginx日志目录</span><br><span class="line">│   ├── access.log                   # 访问日志文件</span><br><span class="line">│   ├── error.log                    # 错误日志文件</span><br><span class="line">│   └── nginx.pid                    # pid文件，Nginx进程启动后，会把所有进程的ID号写到此文件</span><br><span class="line">├── proxy_temp                       # 临时目录</span><br><span class="line">├── sbin                             # Nginx 可执行文件目录</span><br><span class="line">│   └── nginx                        # Nginx 二进制可执行程序</span><br><span class="line">├── scgi_temp                        # 临时目录</span><br><span class="line">└── uwsgi_temp                       # 临时目录</span><br></pre></td></tr></table></figure>

<p>主要的目录是conf,html,及sbin。</p>
<ul>
<li>conf目录放的是核心配置文件</li>
<li>html目录放的是静态页面<ul>
<li>50x.html是发生错误展示的页面，index.html是默认的访问页面。可以在该目录下新建html或者修改，然后在浏览器中访问。</li>
</ul>
</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726342.png" alt="image-20220917160057270"></p>
<ul>
<li>logs文件夹用于存放日志信息：<ul>
<li>error.log存放出错的信息，nginx.pid存放的是当前nginx的pid。</li>
</ul>
</li>
<li>sbin存放的是可执行文件，可以用 .&#x2F;nginx启动nginx：</li>
</ul>
<h3 id="基本运行原理"><a href="#基本运行原理" class="headerlink" title="基本运行原理"></a>基本运行原理</h3><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726946.png" alt="image-20220429201217315"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@nginx ~]# ps -ef | grep nginx</span><br><span class="line">root        939      1  0 15:46 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">nobody      940    939  0 15:46 ?        00:00:00 nginx: worker process</span><br><span class="line">root       1262   1216  0 16:04 pts/0    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<p>Nginx的进程是使用经典的「Master-Worker」模型,Nginx在启动后，会有一个master进程和多个worker进程。master进程主要用来管理worker进程，包含：接收来自外界的信号，向各worker进程发送信号，监控worker进程的运行状态，当worker进程退出后(异常情况下)，会自动重新启动新的worker进程。worker进程主要处理基本的网络事件，多个worker进程之间是对等的，他们同等竞争来自客户端的请求，各进程互相之间是独立的。一个请求，只可能在一个worker进程中处理，一个worker进程，不可能处理其它进程的请求。worker进程的个数是可以设置的，一般会设置与机器cpu核数一致，这里面的原因与nginx的进程模型以及事件处理模型是分不开的。</p>
<h3 id="Nginx配置与应用场景"><a href="#Nginx配置与应用场景" class="headerlink" title="Nginx配置与应用场景"></a>Nginx配置与应用场景</h3><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726340.png" alt="image-20220917161023458"></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    root           html;</span></span><br><span class="line">        <span class="comment">#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line">        <span class="comment">#    fastcgi_index  index.php;</span></span><br><span class="line">        <span class="comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="line">        <span class="comment">#    include        fastcgi_params;</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">        <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">        <span class="comment">#    deny  all;</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># another virtual host using mix of IP-, name-, and port-based configuration</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       8000;</span></span><br><span class="line">    <span class="comment">#    listen       somename:8080;</span></span><br><span class="line">    <span class="comment">#    server_name  somename  alias  another.alias;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># HTTPS server</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       443 ssl;</span></span><br><span class="line">    <span class="comment">#    server_name  localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_certificate      cert.pem;</span></span><br><span class="line">    <span class="comment">#    ssl_certificate_key  cert.key;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_session_cache    shared:SSL:1m;</span></span><br><span class="line">    <span class="comment">#    ssl_session_timeout  5m;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span></span><br><span class="line">    <span class="comment">#    ssl_prefer_server_ciphers  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释说明：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>; <span class="comment">#允许进程数量，建议设置为cpu核心数或者auto自动检测，注意Windows服务器上虽然可以启动多个processes，但是实际只会用其中一个</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="comment">#单个进程最大连接数（最大连接数=连接数*进程数）</span></span><br><span class="line">    <span class="comment">#根据硬件调整，和前面工作进程配合起来用，尽量大，但是别把cpu跑到100%就行。</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment">#文件扩展名与文件类型映射表(是conf目录下的一个文件)</span></span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="comment">#默认文件类型，如果mime.types预先定义的类型没匹配上，默认使用二进制流的方式传输</span></span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#sendfile指令指定nginx是否调用sendfile 函数（zero copy 方式）来输出文件，对于普通应用，必须设为on。如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络IO处理速度。</span></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">#长连接超时时间，单位是秒</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">#虚拟主机的配置</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment">#监听端口</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="comment">#主机名/域名，可以有多个，用空格隔开</span></span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#配置根目录以及默认页面  匹配路径</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;<span class="comment"># 文件根目录</span></span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;<span class="comment"># 默认页名称</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#出错页面配置</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;<span class="comment"># 报错编码对应页面</span></span><br><span class="line">        <span class="comment">#/50x.html文件所在位置</span></span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>worker_processes</code></strong> </p>
<p>worker_processes 1; 默认为1，表示开启一个业务进程 </p>
<p><strong><code>worker_connections </code></strong></p>
<p>worker_connections 1024; 单个业务进程可接受连接数 </p>
<p><strong><code>include mime.types</code></strong></p>
<p> include mime.types; 引入http mime类型</p>
<p><strong><code> default_type application/octet-stream</code></strong></p>
<p>default_type application&#x2F;octet-stream; 如果mime类型没匹配上，默认使用二进制流的方式传输。 </p>
<p><strong><code>sendfile on</code></strong></p>
<p> sendfile on; 使用linux的 sendfile(socket, file, len) 高效网络传输，也就是数据0拷贝。</p>
<ul>
<li>未开启sendfil</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726938.png" alt="image-20220917161828769"></p>
<ul>
<li>开启sendfil</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726904.png" alt="image-20220917161901730"></p>
<h4 id="Nginx-虚拟主机与域名解析"><a href="#Nginx-虚拟主机与域名解析" class="headerlink" title="Nginx 虚拟主机与域名解析"></a>Nginx 虚拟主机与域名解析</h4><p>虚拟主机使用特殊的软硬件技术，把一台运行在因特网上的服务器主机分成一台台“虚拟”的主机，每一台虚拟主机都具有独立的域名，具有完整的Internet服务器（WWW、FTP、Email等）功能，虚拟主机之间完全独立，并可由用户自行管理，在外界看来，每一台虚拟主机和一台独立的主机完全一样。</p>
<p>域名解析就是域名到IP地址的转换过程，IP地址是网路上标识站点的数字地址，为了简单好记，采用域名来代替ip地址标识站点地址，。域名的解析工作由DNS服务器完成。</p>
<h5 id="域名、dns、ip地址的关系"><a href="#域名、dns、ip地址的关系" class="headerlink" title="域名、dns、ip地址的关系"></a>域名、dns、ip地址的关系</h5><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726939.png" alt="image-20220917170955361"></p>
<p>域名是相对网站来说的，IP是相对网络来说的。当输入一个域名的时候，网页是如何做出反应的？<br>输入域名—-&gt;域名解析服务器（dns）解析成ip地址—&gt;访问IP地址—&gt;完成访问的内容—&gt;返回信息。</p>
<p>Internet上的计算机IP是唯一的，一个IP地址对应一个计算机。<br>一台计算机上面可以有很多个服务，也就是一个ip地址对应了很多个域名，即一个计算机上有很多网站。</p>
<p><strong>IP地址和DNS地址的区别</strong></p>
<p>IP地址是指单个主机的唯一IP地址，而DNS服务器地址是用于域名解析的地址。</p>
<p>一个是私网地址，一个是公网地址；</p>
<p>一个作为主机的逻辑标志，一个作为域名解析服务器的访问地址。</p>
<p><strong>IP地址</strong></p>
<p>IP，就是Internet Protocol的缩写，是一种通信协议，我们用的因特网基本是IP网组成的。</p>
<p>IP地址就是因特网上的某个设备的一个编号。</p>
<p>IP地址一般由网络号，主机号，掩码来组成。</p>
<p>IP网络上有很多路由器，路由器之间转发、通信都是只认这个IP地址，类似什么哪？就好像你寄包裹，你的写上发件人地址，你的姓名，收件人地址，收件人姓名。</p>
<p>这个发件人地址就是你电脑的IP的网络号，你的姓名就是你的主机号。</p>
<p>收件人的地址就是你要访问的IP的网络号，收件人的姓名就是访问IP的主机号。</p>
<p>现在还有了更复杂的IPV6,还有IPV9。</p>
<p><strong>DNS是什么？</strong></p>
<p>我们访问因特网必须知道对端的IP地址，可是我们访问网站一般只知道域名啊，怎么办？</p>
<p>这时候DNS就有用处了，电脑先访问DNS服务器，查找域名对应的IP,于是，你的电脑就知道要发包到IP地址了。</p>
<h5 id="http协议"><a href="#http协议" class="headerlink" title="http协议"></a>http协议</h5><p>HTTP是一个应用层协议，由请求和响应构成，是一个标准的客户端服务器模型。HTTP是一个无状态的协议。</p>
<p>HTTP协议通常承载于TCP协议之上，有时也承载于TLS或SSL协议层之上，这个时候，就成了我们常说的HTTPS。如下图所示：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726588.png" alt="image-20220430195715455"></p>
<p>客户端与服务器的数据交互的流程：</p>
<ol>
<li>首先客户机与服务器需要建立TCP连接。只要单击某个超级链接，HTTP的工作开始，下图是TCP连接流程。</li>
</ol>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726011.png" alt="image-20220430195747864"></p>
<ol>
<li>建立连接后，客户机发送一个请求给服务器，请求方式的格式为：统一资源标识符（URL）、协议版本号，后边是MIME信息包括请求修饰符、客户机信息和可能的内容。</li>
<li>服务器接到请求后，给予相应的响应信息，其格式为一个状态行，包括信息的协议版本号、一个成功或错误的代码，后边是MIME信息包括服务器信息、实体信息和可能的内容，例如返回一个HTML的文本。、</li>
<li>客户端接收服务器所返回的信息通过浏览器显示在用户的显示屏上，然后客户机与服务器断开连接。如果在以上过程中的某一步出现错误，那么产生错误的信息将返回到客户端，有显示屏输出。对于用户来说，这些过程是由HTTP自己完成的，用户只要用鼠标点击，等待信息显示就可以了。</li>
</ol>
<h5 id="虚拟主机原理"><a href="#虚拟主机原理" class="headerlink" title="虚拟主机原理"></a>虚拟主机原理</h5><p>虚拟主机是为了在同一台物理机器上运行多个不同的网站，提高资源利用率引入的技术。</p>
<p>一般的web服务器一个ip地址的80端口只能正确对应一个网站。web服务器在不使用多个ip地址和端口的情况下，如果需要支持多个相对独立的网站就需要一种机制来分辨同一个ip地址上的不同网站的请求，这就出现了主机头绑定的方法。简单的说就是，将不同的网站空间对应不同的域名，以连接请求中的域名字段来分发和应答正确的对应空间的文件执行结果。举个例子来说，一台服务器ip地址为192.168.8.101，有两个域名和对应的空间在这台服务器上，使用的都是192.168.8.101的80端口来提供服务。如果只是简单的将两个域名A和B的域名记录解析到这个ip地址，那么web服务器在收到任何请求时反馈的都会是同一个网站的信息，这显然达不到要求。接下来我们使用主机头绑定域名A和B到他们对应的空间文件夹C和D。当含有域名A的web请求信息到达192.168.8.101时，web服务器将执行它对应的空间C中的首页文件，并返回给客户端，含有域名B的web请求信息同理，web服务器将执行它对应的空间D中的首页文件，并返回给客户端，所以在使用主机头绑定功能后就不能使用ip地址访问其上的任何网站了，因为请求信息中不存在域名信息，所以会出错。</p>
<h5 id="域名解析实战"><a href="#域名解析实战" class="headerlink" title="域名解析实战"></a>域名解析实战</h5><ul>
<li>配置单机域名</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726487.png" alt="image-20220917173101357"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726084.png" alt="image-20220917173416233"></p>
<p><a target="_blank" rel="noopener" href="https://www.aliyun.com/">阿里云-为了无法计算的价值 (aliyun.com)</a></p>
<ul>
<li><strong>监听不同端口号</strong></li>
</ul>
<p>设置两个端口访问的文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx ~]# cd /</span><br><span class="line">[root@nginx /]# mkdir www</span><br><span class="line">[root@nginx /]# cd www/</span><br><span class="line">[root@nginx www]# mkdir video</span><br><span class="line">[root@nginx www]# ls</span><br><span class="line">video</span><br><span class="line">[root@nginx www]# mkdir www</span><br><span class="line">[root@nginx www]# ls</span><br><span class="line">video  www</span><br><span class="line">[root@nginx www]# cd video/</span><br><span class="line">[root@nginx video]# vi index.html</span><br><span class="line">[root@nginx video]# cd ../</span><br><span class="line">[root@nginx www]# cd www/</span><br><span class="line">[root@nginx www]# vi index.html</span><br><span class="line">[root@nginx www]# pwd</span><br><span class="line">/www/www</span><br></pre></td></tr></table></figure>

<p>配置nginx.cfg</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>; <span class="comment">#允许进程数量，建议设置为cpu核心数或者auto自动检测，注意Windows服务器上虽然可以启动多个processes，但是实际只会用其中一个</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="comment">#单个进程最大连接数（最大连接数=连接数*进程数）</span></span><br><span class="line">    <span class="comment">#根据硬件调整，和前面工作进程配合起来用，尽量大，但是别把cpu跑到100%就行。</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment">#文件扩展名与文件类型映射表(是conf目录下的一个文件)</span></span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="comment">#默认文件类型，如果mime.types预先定义的类型没匹配上，默认使用二进制流的方式传输</span></span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#sendfile指令指定nginx是否调用sendfile 函数（zero copy 方式）来输出文件，对于普通应用，必须设为on。如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络IO处理速度。</span></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">#长连接超时时间，单位是秒</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">#虚拟主机的配置</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment">#监听端口</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="comment">#域名，可以有多个，用空格隔开</span></span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#配置根目录以及默认页面</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   /www/www;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#出错页面配置</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="comment">#/50x.html文件所在位置</span></span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">#虚拟主机的配置</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment">#监听端口</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">88</span>;</span><br><span class="line">        <span class="comment">#域名，可以有多个，用空格隔开</span></span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#配置根目录以及默认页面</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   /www/voide;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#出错页面配置</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="comment">#/50x.html文件所在位置</span></span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重启nginx服务</li>
</ul>
<blockquote>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726917.png" alt="image-20220919190235197"></p>
<p>解决办法：</p>
<p>打开环境变量所在的文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure>

<p>2、在profile文件末尾，加上一行</p>
<p>指向你的nginx的安装位置的sbin 目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">PATH=$PATH:/usr/local/nginx/sbin</span><br></pre></td></tr></table></figure>

<p>3、重新加载环境，解决</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查一下Nginx是否有误，没报错后方可进行重启</span></span><br><span class="line">nginx -t</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启</span></span><br><span class="line">systemctl reload nginx</span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure>

<ul>
<li>测试——<a target="_blank" rel="noopener" href="http://192.168.182.129/">http://192.168.182.129/</a> &amp; <a target="_blank" rel="noopener" href="http://192.168.182.129:88/">http://192.168.182.129:88/</a></li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726579.png" alt="image-20220918143914618"></p>
<p>如果匹配不到会访问第一个站点</p>
<h5 id="ServerName匹配规则"><a href="#ServerName匹配规则" class="headerlink" title="ServerName匹配规则"></a>ServerName匹配规则</h5><p>我们可以在同一个servername中配置多个域名</p>
<h6 id="完整匹配"><a href="#完整匹配" class="headerlink" title="完整匹配"></a>完整匹配</h6><p>server中可以配置多个域名，例如：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">server_name</span>  test81.xzj520520.cn  test82.xzj520520.cn;</span><br></pre></td></tr></table></figure>

<h6 id="通配符匹配"><a href="#通配符匹配" class="headerlink" title="通配符匹配"></a>通配符匹配</h6><p>使用通配符的方式如下：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">server_name</span>  <span class="regexp">*.xzj</span>520520.cn;</span><br></pre></td></tr></table></figure>

<p>需要注意的是精确匹配的<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E4%BC%98%E5%85%88%E7%BA%A7&spm=1001.2101.3001.7020">优先级</a>大于通配符匹配和正则匹配。</p>
<h6 id="通配符结束匹配"><a href="#通配符结束匹配" class="headerlink" title="通配符结束匹配"></a>通配符结束匹配</h6><p>使用通配符结束匹配的方式如下：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">server_name</span>  www.xzj520520.*;</span><br></pre></td></tr></table></figure>

<h6 id="正则匹配"><a href="#正则匹配" class="headerlink" title="正则匹配"></a>正则匹配</h6><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726079.png" alt="image-20220430170058418"></p>
<p>采用正则的匹配方式如下:</p>
<p>正则匹配格式，必须以<del>开头，比如：<code>server_name ~^www\d+\.example\.net$;</code>。如果开头没有&#96;</del><code>，则nginx认为是精确匹配。在逻辑上，需要添加</code>^<code>和</code>$<code>锚定符号。注意，正则匹配格式中.为正则元字符，如果需要匹配.，则需要反斜线转义。如果正则匹配中含有</code>{<code>和</code>}<code>则需要双引号引用起来，避免nginx报错，如果没有加双引号，则nginx会报如下错误：</code>directive “server_name” is not terminated by “;” in …&#96;。<br><strong>特殊匹配格式：</strong></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">server_name</span> <span class="string">&quot;&quot;</span>; 匹配Host请求头不存在的情况。</span><br></pre></td></tr></table></figure>

<p><strong>匹配顺序：</strong></p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">1. 精确的名字</span><br><span class="line">2. 以*号开头的最长通配符名称，例如 *.example.org</span><br><span class="line">3. 以*号结尾的最长通配符名称，例如 mail.*</span><br><span class="line">4. 第一个匹配的正则表达式（在配置文件中出现的顺序）</span><br></pre></td></tr></table></figure>

<p><strong>优化：</strong></p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">1. 尽量使用精确匹配;</span><br><span class="line">2. 当定义大量server<span class="built_in">_</span>name时或特别长的server<span class="built_in">_</span>name时，需要在http级别调整server<span class="built_in">_</span>names<span class="built_in">_</span>hash<span class="built_in">_</span>max<span class="built_in">_</span>size和server<span class="built_in">_</span>names<span class="built_in">_</span>hash<span class="built_in">_</span>bucket<span class="built_in">_</span>size，否则nginx将无法启动。</span><br></pre></td></tr></table></figure>

<p><strong>附录：</strong><br>为区分大小写的匹配<br><code>~*</code>不区分大小写的匹配（匹配firefox的正则同时匹配FireFox）</p>
<p><code>!~ </code>区分大小写不匹配</p>
<p><code>!~*</code>不区分大小写不匹配</p>
<p><code>. </code>匹配除换行符以外的任意字符</p>
<p><code>\w</code>匹配字母或数字或下划线或汉字</p>
<p><code>\s</code> 匹配任意的空白符</p>
<p><code>\d</code> 匹配数字</p>
<p><code>\b</code>匹配单词的开始或结束</p>
<p><code>^</code> 匹配字符串的开始</p>
<p><code>$</code> 匹配字符串的结束</p>
<p><code>*</code>重复零次或更多次前面一个字符</p>
<p><code>+</code>重复一次或更多次前面一个字符</p>
<p><code>?</code> 重复零次或一次前面一个字符</p>
<p><code>&#123;n&#125;</code> 重复n次前面一个字符{n,} 重复n次或更多次</p>
<p><code>&#123;n,m&#125;</code> 重复n到m次</p>
<p><code>*?</code> 重复任意次，但尽可能少重复</p>
<p><code>+?</code> 重复1次或更多次，但尽可能少重复</p>
<p><code>??</code> 重复0次或1次，但尽可能少重复{n,m}? 重复n到m次，但尽可能少重复<code>&#123;n,&#125;?</code> 重复n次以上，但尽可能少重复</p>
<p><code>\W</code> 匹配任意不是字母，数字，下划线，汉字的字符</p>
<p><code>\S </code>匹配任意不是空白符的字符</p>
<p><code>\D</code> 匹配任意非数字的字符</p>
<p><code>\B </code>匹配不是单词开头或结束的位置</p>
<p><code>[^x] </code>匹配除了x以外的任意字符</p>
<p><code>[^abc]</code> 匹配除了abc这几个字母以外的任意字符</p>
<p><code>(exp)</code> 匹配exp,并捕获文本到0…9</p>
<p><code>(?exp)</code> 匹配exp,并捕获文本到名称为name的组里，也可以写成(?’name’exp)<code>(?:exp)</code> 匹配exp,不捕获匹配的文本，也不给此分组分配组号</p>
<p><code>(?=exp)</code> 零宽断言,匹配exp前面的位置</p>
<p><code>(?&lt;=exp)</code> 匹配exp后面的位置</p>
<p><code>(?!exp) </code>匹配后面跟的不是exp的位置</p>
<p><code>(?&lt;!exp)</code> 匹配前面不是exp的位置</p>
<p><code>(?#comment)</code> 注释,这种类型的分组不对正则表达式的处理产生任何影响，用于提供注释让人阅读</p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><h4 id="在系统结构中的应用场景"><a href="#在系统结构中的应用场景" class="headerlink" title="在系统结构中的应用场景"></a>在系统结构中的应用场景</h4><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726505.png" alt="image-20220918155735842"></p>
<p>反向代理方式是指以代理服务器来接受Internet上的连接请求，然后将请求转发给内部网络上的服务器；并将从服务器上得到的结果返回给Internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。</p>
<p>反向代理服务器通常有两种模型，一种是作为内容服务器的替身，另一种作为内容服务器集群的负载均衡器。</p>
<ul>
<li><p>作内容服务器的替身</p>
<ul>
<li><p>如果您的内容服务器具有必须保持安全的敏感信息，如信用卡号数据库，可在防火墙外部设置一个代理服务器作为内容服务器的替身。当外部客户机尝试访问内容服务器时，会将其送到代理服务器。实际内容位于内容服务器上，在防火墙内部受到安全保护。代理服务器位于防火墙外部，在客户机看来就像是内容服务器。</p>
</li>
<li><p>当客户机向站点提出请求时，请求将转到代理服务器。然后，代理服务器通过防火墙中的特定通路，将客户机的请求发送到内容服务器。内容服务器再通过该通道将结果回传给代理服务器。代理服务器将检索到的信息发送给客户机，好像代理服务器就是实际的内容服务器。如果内容服务器返回错误消息，代理服务器会先行截取该消息并更改标头中列出的任何 URL，然后再将消息发送给客户机。如此可防止外部客户机获取内部内容服务器的重定向 URL。</p>
</li>
<li><p>这样，代理服务器就在安全数据库和可能的恶意攻击之间提供了又一道屏障。与有权访问整个数据库的情况相对比，就算是侥幸攻击成功，作恶者充其量也仅限于访问单个事务中所涉及的信息。未经授权的用户无法访问到真正的内容服务器，因为防火墙通路只允许代理服务器有权进行访问。</p>
</li>
</ul>
</li>
<li><p>作为内容服务器的负载均衡器</p>
<ul>
<li><p>可以在一个组织内使用多个代理服务器来平衡各 Web 服务器间的网络负载。在此模型中，可以利用代理服务器的高速缓存特性，创建一个用于负载平衡的服务器池。此时，代理服务器可以位于防火墙的任意一侧。如果 Web 服务器每天都会接收大量的请求，则可以使用代理服务器分担 Web 服务器的负载并提高网络访问效率。</p>
</li>
<li><p>对于客户机发往真正服务器的请求，代理服务器起着中间调停者的作用。代理服务器会将所请求的文档存入高速缓存。如果有不止一个代理服务器，DNS 可以采用“轮询法”选择其 IP 地址，随机地为请求选择路由。客户机每次都使用同一个 URL，但请求所采取的路由每次都可能经过不同的代理服务器。</p>
</li>
<li><p>可以使用多个代理服务器来处理对一个高用量内容服务器的请求，这样做的好处是内容服务器可以处理更高的负载，并且比其独自工作时更有效率。在初始启动期间，代理服务器首次从内容服务器检索文档，此后，对内容服务器的请求数会大大下降。</p>
</li>
</ul>
</li>
</ul>
<h4 id="Nginx的反向代理配置"><a href="#Nginx的反向代理配置" class="headerlink" title="Nginx的反向代理配置"></a>Nginx的反向代理配置</h4><p>配置语法：<code>proxy_pass  http://www.bilibili.com;</code></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span>  http://www.bilibili.com;</span><br><span class="line">           <span class="comment"># root   /www/www;</span></span><br><span class="line">           <span class="comment"># index  index.html index.htm;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://192.168.182.129/">http://192.168.182.129/</a></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726624.png" alt="image-20220918171937861"></p>
<h4 id="基于反向代理的负载均衡器"><a href="#基于反向代理的负载均衡器" class="headerlink" title="基于反向代理的负载均衡器"></a>基于反向代理的负载均衡器</h4><h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><p>克隆两个centos，ip分别设为192.168.180.130，192.168.182.131（网段要用自己的电脑对应）</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726965.png" alt="image-20220919200953106"></p>
<p>修改静态ip</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-ens33</span><br></pre></td></tr></table></figure>

<p>重启网络服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<p>另一个虚拟机的配置也是一样。配置好虚拟机之后,配置nginx.conf。默认就行。可以修改默认的index.html文件，便于区分。</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    root           html;</span></span><br><span class="line">        <span class="comment">#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line">        <span class="comment">#    fastcgi_index  index.php;</span></span><br><span class="line">        <span class="comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="line">        <span class="comment">#    include        fastcgi_params;</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">        <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">        <span class="comment">#    deny  all;</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># another virtual host using mix of IP-, name-, and port-based configuration</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       8000;</span></span><br><span class="line">    <span class="comment">#    listen       somename:8080;</span></span><br><span class="line">    <span class="comment">#    server_name  somename  alias  another.alias;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># HTTPS server</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       443 ssl;</span></span><br><span class="line">    <span class="comment">#    server_name  localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_certificate      cert.pem;</span></span><br><span class="line">    <span class="comment">#    ssl_certificate_key  cert.key;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_session_cache    shared:SSL:1m;</span></span><br><span class="line">    <span class="comment">#    ssl_session_timeout  5m;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span></span><br><span class="line">    <span class="comment">#    ssl_prefer_server_ciphers  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141726750.png" alt="image-20220919201359079"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727808.png" alt="image-20220919201414714"></p>
<h5 id="负载均衡策略——轮询"><a href="#负载均衡策略——轮询" class="headerlink" title="负载均衡策略——轮询"></a>负载均衡策略——轮询</h5><p><strong>默认情况下使用轮询方式，逐一转发，这种方式适用于无状态请求。</strong></p>
<ul>
<li><p>修改129的nginx.conf文件</p>
<ul>
<li>&#96;&#96;&#96;nginx<br>upstream httpds{<br>  server 192.168.182.130:80;<br>  server 192.168.182.131:80;<br>}<br>——————————————————别名要一致——————————————————<br>location &#x2F; {<br>      proxy_pass <a target="_blank" rel="noopener" href="http://httpds/">http://httpds</a>;<br>        #root   html;<br>        #index  index.html index.htm;<br>    }<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">```nginx</span><br><span class="line">worker_processes  1; #允许进程数量，建议设置为cpu核心数或者auto自动检测，注意Windows服务器上虽然可以启动多个processes，但是实际只会用其中一个</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    #单个进程最大连接数（最大连接数=连接数*进程数）</span><br><span class="line">    #根据硬件调整，和前面工作进程配合起来用，尽量大，但是别把cpu跑到100%就行。</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    #文件扩展名与文件类型映射表(是conf目录下的一个文件)</span><br><span class="line">    include       mime.types;</span><br><span class="line">    #默认文件类型，如果mime.types预先定义的类型没匹配上，默认使用二进制流的方式传输</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #sendfile指令指定nginx是否调用sendfile 函数（zero copy 方式）来输出文件，对于普通应用，必须设为on。如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络IO处理速度。</span><br><span class="line">    sendfile        on;</span><br><span class="line">    </span><br><span class="line">     #长连接超时时间，单位是秒</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">#定义一组服务器</span><br><span class="line">upstream httpds&#123;</span><br><span class="line">    server 192.168.182.130:80;</span><br><span class="line">    server 192.168.182.131:80;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> #虚拟主机的配置</span><br><span class="line">    server &#123;</span><br><span class="line">    #监听端口</span><br><span class="line">        listen       80;</span><br><span class="line">        #域名，可以有多个，用空格隔开</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">	#配置根目录以及默认页面</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://httpds;</span><br><span class="line">            # root   /www/test80;</span><br><span class="line">            # index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	#出错页面配置</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        #/50x.html文件所在位置</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p><strong>测试：</strong></p>
<p>多次访问<a target="_blank" rel="noopener" href="http://192.168.182.129/%E5%8F%91%E7%8E%B0130%E5%92%8C131%E8%A2%AB%E4%BA%A4%E6%9B%BF%E8%AE%BF%E9%97%AE">http://192.168.182.129/发现130和131被交替访问</a></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727379.png" alt="image-20220919201917503"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727813.png" alt="image-20220919201928056"></p>
<h5 id="负载均衡策略——weight-权重"><a href="#负载均衡策略——weight-权重" class="headerlink" title="负载均衡策略——weight(权重)"></a>负载均衡策略——weight(权重)</h5><p><strong>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</strong></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> httpds&#123;</span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.182.130:80</span> weight=<span class="number">8</span>;</span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.182.131:80</span> weight=<span class="number">2</span>;</span><br><span class="line">   <span class="comment"># server 192.168.182.130:80 weight=10 down; #down表示不参与负载均衡</span></span><br><span class="line">   <span class="comment"># server 192.168.182.131:80 weight=10 backup; #backup表示是备用服务器，没有服务器可用的时候使用</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>down：表示当前的server暂时不参与负载 </li>
<li>weight：默认为1。weight越大，负载的权重就越大。 </li>
<li>backup： <strong>其它所有的非backup机器down或者忙的时候</strong>，才请求backup机器，平常时候不请求。</li>
</ul>
<p><strong>测试：</strong></p>
<p>多次访问<a target="_blank" rel="noopener" href="http://192.168.182.129/%E5%8F%91%E7%8E%B0130%E8%AE%BF%E9%97%AE%E7%9A%84%E6%AC%A1%E6%95%B0%E5%A4%9A%E4%BD%99131%E8%AE%BF%E9%97%AE%E7%9A%84%E6%AC%A1%E6%95%B0%E3%80%82">http://192.168.182.129/发现130访问的次数多余131访问的次数。</a></p>
<h5 id="其他负载均衡策略（不常用）"><a href="#其他负载均衡策略（不常用）" class="headerlink" title="其他负载均衡策略（不常用）"></a>其他负载均衡策略（不常用）</h5><ul>
<li><p>ip_hash</p>
<p>根据客户端的ip地址转发同一台服务器，可以保持会话，但是很少用这种方式去保持会话，例如我们当前正在使用wifi访问，当切换成手机信号访问时，会话就不保持了。</p>
</li>
<li><p>least_conn</p>
<p>最少连接访问，优先访问连接最少的那一台服务器，这种方式也很少使用，因为连接少，可能是由于该服务器配置较低，刚开始赋予的权重较低。</p>
</li>
<li><p>url_hash（需要第三方插件）</p>
<p>根据用户访问的url定向转发请求，不同的url转发到不同的服务器进行处理（定向流量转发）。</p>
</li>
<li><p>fair（需要第三方插件）</p>
<p>根据后端服务器响应时间转发请求，这种方式也很少使用，因为容易造成流量倾斜，给某一台服务器压垮。</p>
</li>
</ul>
<h4 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h4><p>为了提高网站的响应速度，减轻程序服务器（Tomcat，Jboss等）的负载，对于静态资源，如图片、js、css等文件，可以在反向代理服务器中进行缓存，这样浏览器在请求一个静态资源时，代理服务器就可以直接处理，而不用将请求转发给后端服务器。对于用户请求的动态文件，如servlet、jsp，则转发给Tomcat，Jboss服务器处理，这就是动静分离。即动态文件与静态文件的分离。</p>
<h5 id="动静分离原理"><a href="#动静分离原理" class="headerlink" title="动静分离原理"></a>动静分离原理</h5><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727331.png" alt="img"></p>
<p>动静分离可通过location对请求url进行匹配，将网站静态资源（HTML，JavaScript，CSS，img等文件）与后台应用分开部署，提高用户访问静态代码的速度，降低对后台应用访问。<strong>通常将静态资源放到nginx中，动态资源转发到tomcat服务器中</strong>。</p>
<h5 id="安装tomcat"><a href="#安装tomcat" class="headerlink" title="安装tomcat"></a>安装tomcat</h5><ul>
<li>复制文件到虚拟机中——<a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/downloads/#java8">Java Downloads | Oracle</a>——<a target="_blank" rel="noopener" href="https://tomcat.apache.org/download-80.cgi">Apache Tomcat® - Apache Tomcat 8 Software Downloads</a></li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727985.png" alt="image-20220919213449462"></p>
<ul>
<li>安装jdk</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入目录</span></span><br><span class="line">cd /usr/local/java/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">tar -zxvf jdk-8u321-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>编辑配置文件添加下面的内容</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/java/jdk1.8.0_321</span><br><span class="line">export JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br><span class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib:$&#123;JRE_HOME&#125;/lib</span><br><span class="line">export  PATH=$&#123;JAVA_HOME&#125;/bin:$PATH</span><br></pre></td></tr></table></figure>

<ul>
<li>使配置立即生效</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727190.png" alt="image-20220919213335901"></p>
<ul>
<li>解压apache-tomcat</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -zxvf apache-tomcat-8.5.82.tar.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>进入bin目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/java/apache-tomcat-8.5.82/bin/</span><br></pre></td></tr></table></figure>

<ul>
<li>启动tomcat</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./startup.sh</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>在浏览器地址栏中输入<a target="_blank" rel="noopener" href="http://192.168.182.130:8080/">http://192.168.182.130:8080</a></strong></li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727563.png" alt="image-20220919214324050"></p>
<h5 id="Nginx动静分离配置"><a href="#Nginx动静分离配置" class="headerlink" title="Nginx动静分离配置"></a>Nginx动静分离配置</h5><ul>
<li>随便找个html页面，一些静态资源放入到<code>/usr/local/java/apache-tomcat-8.5.82/webapps/ROOT/</code>目录中</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727951.png" alt="image-20220919215700461"></p>
<ul>
<li>访问页面</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727148.png" alt="image-20220919215803055"></p>
<ul>
<li>在129上配置反向代理 <code>nginx.conf</code></li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">          <span class="attribute">proxy_pass</span> http://192.168.182.130:8080;</span><br><span class="line">            <span class="comment">#root   html;</span></span><br><span class="line">            <span class="comment">#index  index.html index.htm;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">——————————————————————————————————————————————————</span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line"><span class="attribute">nginx</span> -t</span><br><span class="line">systemctl reload nginx</span><br></pre></td></tr></table></figure>

<ul>
<li>访问<a target="_blank" rel="noopener" href="http://192.168.182.129/">http://192.168.182.129/</a></li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727784.png" alt="image-20220919220447641"></p>
<ul>
<li>删除130上tomcat目录的静态资源images、css、js，重新访问</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727298.png" alt="image-20220919220834656"></p>
<ul>
<li>配置129的nginx.conf</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> httpds&#123;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.130:80</span> weight=<span class="number">8</span> down;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.131:80</span> weight=<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">          <span class="attribute">proxy_pass</span> http://192.168.182.130:8080;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 优先级比/更高</span></span><br><span class="line">        <span class="section">location</span> /css &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="section">location</span> /fonts &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="section">location</span> /images &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="section">location</span> /js &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>访问<a href="http://192.168.182.129，发现静态资源又出现了：">http://192.168.182.129，发现静态资源又出现了：</a></li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727057.png" alt="image-20220919221736557"></p>
<h5 id="使用正则配置动静分离"><a href="#使用正则配置动静分离" class="headerlink" title="使用正则配置动静分离"></a>使用正则配置动静分离</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> ~*/(js|fonts|images|css) &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727738.png" alt="image-20220920201945552"></p>
<h6 id="常见的Nginx正则表达式"><a href="#常见的Nginx正则表达式" class="headerlink" title="常见的Nginx正则表达式"></a>常见的Nginx正则表达式</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">^ ：匹配输入字符串的起始位置</span><br><span class="line">$ ：匹配输入字符串的结束位置</span><br><span class="line">* ：匹配前面的字符零次或多次。如“ol*”能匹配“o”及“ol”、“oll”</span><br><span class="line">+ ：匹配前面的字符一次或多次。如“ol+”能匹配“ol”及“oll”、“olll”，但不能匹配“o”</span><br><span class="line">? ：匹配前面的字符零次或一次，例如“do(es)?”能匹配“do”或者“does”，”?”等效于”&#123;0,1&#125;”</span><br><span class="line">. ：匹配除“\n”之外的任何单个字符，若要匹配包括“\n”在内的任意字符，请使用诸如“[.\n]”之类的模式</span><br><span class="line">\ ：将后面接着的字符标记为一个特殊字符或一个原义字符或一个向后引用。如“\n”匹配一个换行符，而“\$”则匹配“$”</span><br><span class="line">\d ：匹配纯数字</span><br><span class="line">&#123;n&#125; ：重复 n 次</span><br><span class="line">&#123;n,&#125; ：重复 n 次或更多次</span><br><span class="line">&#123;n,m&#125; ：重复 n 到 m 次</span><br><span class="line">[] ：定义匹配的字符范围</span><br><span class="line">[c] ：匹配单个字符 c</span><br><span class="line">[a-z] ：匹配 a-z 小写字母的任意一个</span><br><span class="line">[a-zA-Z0-9] ：匹配所有大小写字母或数字</span><br><span class="line">() ：表达式的开始和结束位置</span><br><span class="line">| ：或运算符  //例(js|img|css)</span><br></pre></td></tr></table></figure>

<h6 id="location正则："><a href="#location正则：" class="headerlink" title="location正则："></a>location正则：</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//location大致可以分为三类</span><br><span class="line">精准匹配：location = /&#123;&#125;</span><br><span class="line">一般匹配：location /&#123;&#125;</span><br><span class="line">正则匹配：location ~/&#123;&#125;</span><br><span class="line">//location常用的匹配规则：</span><br><span class="line">= ：进行普通字符精确匹配，也就是完全匹配。</span><br><span class="line">^~ ：表示前缀字符串匹配（不是正则匹配，需要使用字符串），如果匹配成功，则不再匹配其它 location。</span><br><span class="line">~ ：区分大小写的匹配（需要使用正则表达式）。</span><br><span class="line">~* ：不区分大小写的匹配（需要使用正则表达式）。</span><br><span class="line">!~ ：区分大小写的匹配取非（需要使用正则表达式）。</span><br><span class="line">!~* ：不区分大小写的匹配取非（需要使用正则表达式）。</span><br><span class="line">//优先级</span><br><span class="line">首先精确匹配 =</span><br><span class="line">其次前缀匹配 ^~</span><br><span class="line">其次是按文件中顺序的正则匹配 ~或~*</span><br><span class="line">然后匹配不带任何修饰的前缀匹配</span><br><span class="line">最后是交给 / 通用匹配</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ul>
<li>精确匹配： <code>=</code> ， 后面的表达式中写的是纯字符串</li>
<li>字符串匹配： <code>^~</code> 和 <code>无符号匹配</code> ， 后面的表达式中写的是纯字符串</li>
<li>正则匹配： <code>~</code> 和 <code>~*</code> 和 <code>!~</code> 和 <code>!~*</code> ， 后面的表达式中写的是正则表达式</li>
</ul>
<p>location匹配顺序 </p>
<ul>
<li>多个正则location直接按书写顺序匹配，成功后就不会继续往后面匹配 </li>
<li>普通（非正则）location会一直往下，直到找到匹配度最高的（最大前缀匹配） </li>
<li>当普通location与正则location同时存在，如果正则匹配成功,则不会再执行普通匹配 </li>
<li>所有类型location存在时，“&#x3D;”匹配 &gt; “^~”匹配 &gt; 正则匹配 &gt; 普通（最大前缀匹配）</li>
</ul>
<p>location的说明</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> (1）location = / &#123;&#125;</span><br><span class="line">=为精确匹配 / ，主机名后面不能带任何字符串，比如访问 / 和 /data，则 / 匹配，/data 不匹配</span><br><span class="line">再比如 location = /abc，则只匹配/abc ，/abc/或 /abcd不匹配。若 location  /abc，则即匹配/abc 、/abcd/ 同时也匹配 /abc/。</span><br><span class="line"></span><br><span class="line">（2）location / &#123;&#125;</span><br><span class="line">因为所有的地址都以 / 开头，所以这条规则将匹配到所有请求 比如访问 / 和 /data, 则 / 匹配， /data 也匹配，</span><br><span class="line">但若后面是正则表达式会和最长字符串优先匹配（最长匹配）</span><br><span class="line"></span><br><span class="line">（3）location /documents/ &#123;&#125;</span><br><span class="line">匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索其它 location</span><br><span class="line">只有其它 location后面的正则表达式没有匹配到时，才会采用这一条</span><br><span class="line"></span><br><span class="line">（4）location /documents/abc &#123;&#125;</span><br><span class="line">匹配任何以 /documents/abc 开头的地址，匹配符合以后，还要继续往下搜索其它 location</span><br><span class="line">只有其它 location后面的正则表达式没有匹配到时，才会采用这一条</span><br><span class="line"></span><br><span class="line">（5）location ^~ /images/ &#123;&#125;</span><br><span class="line">匹配任何以 /images/ 开头的地址，匹配符合以后，停止往下搜索正则，采用这一条</span><br><span class="line"></span><br><span class="line">（6）location ~* \.(gif|jpg|jpeg)$ &#123;&#125;</span><br><span class="line">匹配所有以 gif、jpg或jpeg 结尾的请求</span><br><span class="line">然而，所有请求 /images/ 下的图片会被 location ^~ /images/ 处理，因为 ^~ 的优先级更高，所以到达不了这一条正则</span><br><span class="line"></span><br><span class="line">（7）location /images/abc &#123;&#125;</span><br><span class="line">最长字符匹配到 /images/abc，优先级最低，继续往下搜索其它 location，会发现 ^~ 和 ~ 存在</span><br><span class="line"></span><br><span class="line">（8）location ~ /images/abc &#123;&#125;</span><br><span class="line">匹配以/images/abc 开头的，优先级次之，只有去掉 location ^~ /images/ 才会采用这一条</span><br><span class="line"></span><br><span class="line">（9）location /images/abc/1.html &#123;&#125;</span><br><span class="line">匹配/images/abc/1.html 文件，如果和正则 ~ /images/abc/1.html 相比，正则优先级更高</span><br><span class="line"></span><br><span class="line">优先级总结：</span><br><span class="line">(location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 部分起始路径) &gt; (location /)</span><br></pre></td></tr></table></figure>

<p>实际网站使用中，至少有三个匹配规则定义:</p>
<ul>
<li>第一个必选规则</li>
</ul>
<p>直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，比如说官网。这里是直接转发给后端应用服务器了，也可以是一个静态首页</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> = / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8080/; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第二个必选规则</li>
</ul>
<p>处理静态文件请求，这是nginx作为http服务器的强项,有两种配置模式，目录匹配或后缀匹配,任选其一或搭配使用</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /static/ &#123;</span><br><span class="line">    <span class="attribute">root</span> /webroot/static/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* \.(html|gif|jpg|jpeg|png|css|js|ico)$</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /webroot/res/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第三个规则</li>
</ul>
<p>通用规则，用来转发动态请求到后端应用服务器</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> /api/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:3000/api/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="alias与root"><a href="#alias与root" class="headerlink" title="alias与root"></a>alias与root</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> /css &#123;</span><br><span class="line">	<span class="attribute">alias</span> /usr/local/nginx/static/css;</span><br><span class="line">	<span class="attribute">index</span> index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>root用来设置根目录，而alias在接受请求的时候在路径上不会加上location。</p>
<ol>
<li>alias指定的目录是准确的，即location匹配访问的path目录下的文件直接是在alias目录下查找的；</li>
<li>root指定 的目录是location匹配访问的path目录的上一级目录,这个path目录一定要是真实存在root指定目录下的；</li>
<li>使用 alias标签的目录块中不能使用rewrite的break（具体原因不明）；另外，alias指定的目录后面必须要加上”&#x2F;“符 号！！</li>
<li>alias虚拟目录配置中，location匹配的path目录如果后面不带”&#x2F;“，那么访问的url地址中这个path目录后 面加不加”&#x2F;“不影响访问，访问时它会自动加上”&#x2F;“； 但是如果location匹配的path目录后面加上”&#x2F;“，那么访问的url地 址中这个path目录必须要加上”&#x2F;“，访问时它不会自动加上”&#x2F;“。如果不加上”&#x2F;“，访问就会失败！</li>
<li>root目录配置 中，location匹配的path目录后面带不带”&#x2F;“，都不会影响访问。</li>
</ol>
<h4 id="URLRewrite"><a href="#URLRewrite" class="headerlink" title="URLRewrite"></a>URLRewrite</h4><p>rewrite是实现URL重写的关键指令，根据regex(正则表达式)部分内容，重定向到repacement，结尾是flag标记。</p>
<p>格式：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141727926.png" alt="image-20220501143255652"></p>
<h5 id="URLRewrite的优缺点"><a href="#URLRewrite的优缺点" class="headerlink" title="URLRewrite的优缺点"></a>URLRewrite的优缺点</h5><p>优点：掩藏真实的url以及url中可能暴露的参数，以及隐藏web使用的编程语言，提高安全性便于搜索引擎收录</p>
<p>缺点：降低效率，影响性能。如果项目是<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%86%85%E7%BD%91&spm=1001.2101.3001.7020">内网</a>使用，比如公司内部软件，则没有必要配置。</p>
<h5 id="实例："><a href="#实例：" class="headerlink" title="实例："></a>实例：</h5><ul>
<li>配置129的nginx.conf</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">         <span class="attribute">rewrite</span><span class="regexp"> ^/2.html$</span> /index.html?testParam=<span class="number">3</span> <span class="literal">break</span>;</span><br><span class="line">         <span class="attribute">proxy_pass</span> http://192.168.182.130:8080;</span><br><span class="line">           <span class="comment">#root   html;</span></span><br><span class="line">           <span class="comment">#index  index.html index.htm;</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>例：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/2.html$</span> /index.html?testParam=<span class="number">3</span> <span class="literal">break</span>;</span><br><span class="line"></span><br><span class="line">//也可以用正则表达式的形式：</span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/([0-9]+).html$</span> /index.html?testParam=<span class="variable">$1</span> <span class="literal">break</span>; //$1表示第一个匹配的正则规则即$1=([0-9]+)匹配的值</span><br></pre></td></tr></table></figure>

<ul>
<li>测试，访问<a target="_blank" rel="noopener" href="http://192.168.182.129/2.html">http://192.168.182.129/2.html</a></li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728159.png" alt="image-20220920203013406"></p>
<h4 id="负载均衡-URLRewrite实战"><a href="#负载均衡-URLRewrite实战" class="headerlink" title="负载均衡+URLRewrite实战"></a>负载均衡+URLRewrite实战</h4><ul>
<li>开启130的防火墙</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl start firewalld</span><br></pre></td></tr></table></figure>

<ul>
<li>129反向代理失败</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728857.png" alt="image-20220920205600511"></p>
<ul>
<li>配置规则，添加指定端口和ip访问(添加之后记得重新启动防火墙)</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent --add-rich-rule=&quot;rule family=&quot;ipv4&quot; source address=&quot;192.168.182.129&quot; port protocol=&quot;tcp&quot; port=&quot;8080&quot; accept&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>重载规则</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<ul>
<li>重启防火墙</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl restart firewalld</span><br></pre></td></tr></table></figure>

<ul>
<li>查看已配置规则</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728009.png" alt="image-20220920210002617"></p>
<p>重新访问成功</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728428.png" alt="image-20220920210041566"></p>
<ul>
<li>移除规则</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent --remove-rich-rule=&quot;rule family=&quot;ipv4&quot; source address=&quot;192.168.182.129&quot; port protocol=&quot;tcp&quot; port=&quot;8080&quot; accept&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>在网关服务器129 上nginx.conf中添加负载均衡策略</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> httpds&#123;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.130:8080</span>;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.131:80</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">          <span class="attribute">rewrite</span><span class="regexp"> ^/2.html$</span> /index.html?testParam=<span class="number">3</span> <span class="literal">break</span>;</span><br><span class="line">          <span class="attribute">proxy_pass</span> http://httpds;</span><br><span class="line">            <span class="comment">#root   html;</span></span><br><span class="line">            <span class="comment">#index  index.html index.htm;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 优先级比/更高</span></span><br><span class="line">        <span class="section">location</span> ~*/(js|fonts|images|css) &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试 轮询访问</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728633.png" alt="image-20220920210808725"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728988.png" alt="image-20220920210825286"></p>
<h4 id="防盗链配置"><a href="#防盗链配置" class="headerlink" title="防盗链配置"></a>防盗链配置</h4><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p>防盗链简单来说就是存在我们服务中的一些资源，只有我们规定的合法的一类人才能去访问，其他人就不能去访问的资源（如css，js，img等资源）。</p>
<p>​	具体点就是用户发送请求给nginx服务器，nginx服务器根据请求去寻找资源，请求的比如说是有个index.html文件，这个文件中会包含很多js，css，img等资源，这些文件在这个骨架中会被二次请求，在第二次请求时，会在请求头部上加上有个referer，这个referer只会在第二次请求时才会被加上。（referer表示第二次资源的来源地址）</p>
<p>如下图中b站的referer头部展示：<br><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728325.png" alt="img"></p>
<h5 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h5><p> valid_referers:nginx会通过查看referer，自动和valid_referers后面的内容进行匹配，如果匹配到了就将$invalid_referer变量置0，如果没有匹配到，则将$invalid_referer变量置为1，匹配的过程不区分大小写</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">valid_referers</span> <span class="literal">none</span> | <span class="literal">blocked</span> | server_names | strings ....;</span><br><span class="line"></span><br><span class="line">位置（可以书写的地方）：<span class="section">location</span>下</span><br></pre></td></tr></table></figure>

<ul>
<li>none， 检测 Referer 头域不存在的情况，referer为空，允许访问。 </li>
<li>blocked，检测 Referer 头域的值被防火墙或者代理服务器删除或伪装的情况。这种情况该头域的值不以 “http:&#x2F;&#x2F;” 或 “https:&#x2F;&#x2F;” 开头，允许访问。 </li>
<li>server_names ，（指定具体的域名或者IP）设置一个或多个 URL ，检测 Referer 头域的值是否是这些 URL 中的某一个。</li>
</ul>
<p>例：</p>
<ul>
<li>启动131虚拟机，nginx.conf下配置访问129，然后reload</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">proxy_pass</span> http://192.168.182.129;</span><br><span class="line">           <span class="comment">#root   html;</span></span><br><span class="line">           <span class="comment">#index  index.html index.htm;</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>访问成功</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728321.png" alt="image-20220920213234909"></p>
<ul>
<li>在129 nginx.conf中配置，然后reload</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> ~*/(js|fonts|images|css) &#123;</span><br><span class="line">            <span class="attribute">valid_referers</span> <span class="number">192.168.182.129</span>;</span><br><span class="line">    		<span class="comment">#valid_referers none 192.168.182.129;</span></span><br><span class="line">            <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">              <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">vaild_referers</span> <span class="number">192.168.182.129</span></span><br><span class="line">    这个是如果返回的头部referer为<span class="number">192.168.182.129</span>那么就不会执行valid_referer下面内容，反之就会</span><br><span class="line"> </span><br><span class="line">if (<span class="variable">$invalid_referer</span>)</span><br><span class="line">    这个含义就是结合上面的valid_referer，如果请求头部为<span class="number">192.168.182.129</span>，那么就<span class="variable">$invalid_referer</span>就会被赋值为<span class="number">0</span>，就不会执行返回错误代码<span class="number">401</span>，如果不是www.baidu.com，那么就会赋值为<span class="number">1</span>，就会执行下面内容</span><br><span class="line"> </span><br><span class="line">return <span class="number">403</span>：返回错误代码<span class="number">403</span></span><br></pre></td></tr></table></figure>

<ol>
<li>不添加none访问失败了，图片也访问失败</li>
</ol>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728094.png" alt="image-20220920214157914"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728083.png" alt="image-20220920215026834"></p>
<p>​	2. 添加none，图片可以访问成功</p>
<p>解答：这里主要有两个原因：这种形式的访问是直接请求服务器中默认html中的jpg文件，是没有头部的（只有二次以上请求才会有referer头部），并且我们在配置文件中添加了[none]这个参数，它的含义就是当我们在没有头部referer时，依然能访问到文件，所以我们配置的防盗链在这个时候是不起作用的。</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728586.png" alt="image-20220920215140446"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728934.png" alt="image-20220920215302832"></p>
<blockquote>
<p>注意事项：<br>每次修改配置文件后都要重启服务</p>
<p>在配置过程中，我们刷新浏览器会得不到想要的结果，不要慌张，可能是浏览器的缓存没有被清除F12进入开发者模式，打开下面两项，再去刷新就可以了</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728573.png" alt="image-20220920214109928"></p>
<p>或者</p>
<p>Edge浏览器点击清空缓存并硬性重新加载（只能在打开开发者面板的时候右键打开）</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728962.png" alt="img"></p>
</blockquote>
<h5 id="使用curl测试"><a href="#使用curl测试" class="headerlink" title="使用curl测试"></a>使用curl测试</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装</span></span><br><span class="line">yum install -y curl</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-I/--head 仅返回头部信息，使用HEAD请求</span></span><br><span class="line">curl -I http://192.168.182.131/images/bg.jpg</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">带引用 -e/--referer &lt;URL&gt;  指定引用地址</span></span><br><span class="line">curl -e &quot;http://baidu.com&quot; -I http://192.168.182.131/images/bg.jpg</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728313.png" alt="image-20220920220432452"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728838.png" alt="image-20220920220506898"></p>
<h5 id="返回错误图片设置"><a href="#返回错误图片设置" class="headerlink" title="返回错误图片设置"></a>返回错误图片设置</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> ~*/(js|fonts|images|css) &#123;</span><br><span class="line">            <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="number">192.168.182.129</span>;</span><br><span class="line">            <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">              <span class="attribute">rewrite</span><span class="regexp"> ^/</span> /images/<span class="literal">error</span>.jpg; break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="nginx高可用及Keepalived实战"><a href="#nginx高可用及Keepalived实战" class="headerlink" title="nginx高可用及Keepalived实战"></a>nginx高可用及Keepalived实战</h3><h4 id="高可用配置"><a href="#高可用配置" class="headerlink" title="高可用配置"></a>高可用配置</h4><h5 id="高可用场景及解决方案"><a href="#高可用场景及解决方案" class="headerlink" title="高可用场景及解决方案"></a>高可用场景及解决方案</h5><p>Keepalived软件起初是专为LVS负载均衡软件设计的，用来管理并监控LVS集群系统中各个服务节点的状态，后来又加入了可以实现高可用的VRRP功能。因此，Keepalived除了能够管理LVS软件外，还可以作为其他服务（例如：Nginx、Haproxy、MySQL等）的高可用解决方案软件。VRRP出现的目的就是为了解决静态路由单点故障问题的，它能够保证当个别节点宕机时，整个网络可以不间断地运行。所以，Keepalived 一方面具有配置管理LVS的功能，同时还具有对LVS下面节点进行健康检查的功能，另一方面也可实现系统网络服务的高可用功能。</p>
<p>keepalived官网<a target="_blank" rel="noopener" href="http://www.keepalived.org/">http://www.keepalived.org</a></p>
<p>keepalived服务的三个重要功能：</p>
<ul>
<li>管理LVS负载均衡软件</li>
<li>实现LVS集群节点的健康检查中</li>
<li>作为系统网络服务的高可用性（failover）</li>
</ul>
<h5 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h5><p>keepalived可用于多种软件的高可用实现，用来解决单点故障问题，同时在主、备服务器部署相同nginx，通过一个虚拟IP地址（即VIP）对外提供服务，当主服务器的nginx出现故障时，虚拟IP就会自动漂移到备服务器上，整个漂移过程是自动实现的，无需人工干预，从而保障了服务的高可用性。</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728881.png" alt="img"></p>
<ul>
<li><p>安装keepalived</p>
<ul>
<li>编译安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载地址</span> </span><br><span class="line">https://www.keepalived.org/download.html</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 ./configure 编译安装 如遇报错提示</span> </span><br><span class="line">configure: error: </span><br><span class="line">	!!! OpenSSL is not properly installed on your system. !!! 	</span><br><span class="line">	!!! Can not include OpenSSL headers files. !!! </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装依赖</span> </span><br><span class="line">yum install openssl-devel yum</span><br></pre></td></tr></table></figure>

<ul>
<li>yum安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装</span> </span><br><span class="line">yum install keepalived</span><br></pre></td></tr></table></figure>
</li>
<li><p>分别在129和131虚拟机上进行安装</p>
</li>
<li><p>配置 </p>
<ul>
<li><p>使用yum安装后配置文件在 <code>/etc/keepalived/keepalived.conf</code></p>
</li>
<li><p>129为主nginx，131为备用机</p>
</li>
<li><p>129虚拟机配置</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LB_129</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_129 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    # 网关</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    # 优先级 最高的为master</span><br><span class="line">    priority 100</span><br><span class="line">    # 间隔检测时间</span><br><span class="line">    advert_int 1</span><br><span class="line">    # 分组配置</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    # 虚拟ip</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.182.200</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>131配置</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LB_131</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_131 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.182.200</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>依次启动keepalived，查看ip</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">systemctl start keepalived</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看状态</span></span><br><span class="line">systemctl status keepalived</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看本机ip</span></span><br><span class="line">ip addr</span><br></pre></td></tr></table></figure>

<p>可以看到129虚拟机添加一个IP</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728919.png" alt="image-20220921211500744"></p>
<p>131 IP保持不变</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141728628.png" alt="image-20220921211553335"></p>
<ul>
<li>访问<a target="_blank" rel="noopener" href="http://192.168.182.200/">http://192.168.182.200/</a></li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729108.png" alt="image-20220921211904218"></p>
<ul>
<li>关闭129虚拟机：<code>init 0</code>直接关机，再次访问</li>
</ul>
<p>请求超时就是nginx129主机宕掉之后，切换给从机131的过程</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729403.png" alt="image-20220921213413093"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729336.png" alt="image-20220921212022499"></p>
<p>同时在131上添加了设置的虚拟ip</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729427.png" alt="image-20220921212110384"></p>
<ul>
<li>重新启动129，虚拟ip会自动重新分配给master</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729994.png" alt="image-20220921213259685"></p>
<h3 id="Https证书配置"><a href="#Https证书配置" class="headerlink" title="Https证书配置"></a>Https证书配置</h3><h4 id="不安全的http协议"><a href="#不安全的http协议" class="headerlink" title="不安全的http协议"></a>不安全的http协议</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/XinTeng2012/article/details/106917571">HTTP的不安全以及安全的HTTPS原理及流程</a></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729613.png" alt="image-20220921213029876"></p>
<h4 id="Https原理"><a href="#Https原理" class="headerlink" title="Https原理"></a>Https原理</h4><h5 id="对称加密算法"><a href="#对称加密算法" class="headerlink" title="对称加密算法"></a>对称加密算法</h5><h5 id="非对称加密算法"><a href="#非对称加密算法" class="headerlink" title="非对称加密算法"></a>非对称加密算法</h5><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729632.png" alt="img"></p>
<h5 id="ca机构参与保证互联网安全"><a href="#ca机构参与保证互联网安全" class="headerlink" title="ca机构参与保证互联网安全"></a>ca机构参与保证互联网安全</h5><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_33964094/article/details/85100922?ops_request_misc=%7B%22request_id%22:%22165052460216782246417186%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=165052460216782246417186&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-85100922.142%5Ev9%5Econtrol,157%5Ev4%5Econtrol&utm_term=ca%E6%9C%BA%E6%9E%84&spm=1018.2226.3001.4187">什么是证书颁发机构（CA）</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Munch_D_Rudy/article/details/114337721?ops_request_misc=%7B%22request_id%22:%22165052451316780261916415%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=165052451316780261916415&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-114337721.142%5Ev9%5Econtrol,157%5Ev4%5Econtrol&utm_term=ca&spm=1018.2226.3001.4187">CA证书简单介绍</a></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729940.png" alt="img"></p>
<h4 id="自签名"><a href="#自签名" class="headerlink" title="自签名"></a>自签名</h4><p>openssl工具</p>
<p>包含：SSL协议库、应用程序以及密码算法库</p>
<p>图形化工具 XCA </p>
<p>下载地址 <a target="_blank" rel="noopener" href="https://www.hohnstaedt.de/xca/index.php/download">https://www.hohnstaedt.de/xca/index.php/download</a></p>
<h4 id="在线证书申请"><a href="#在线证书申请" class="headerlink" title="在线证书申请"></a>在线证书申请</h4><p>使用阿里云配置https<br>阿里云免费证书购买在如下位置：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729409.png" alt="image-20220502180114579"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729198.png" alt="image-20220502180253209"></p>
<p>购买完成后在如下位置创建证书并申请证书：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729958.png" alt="image-20220502180721249"></p>
<p>填写验证信息</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729428.png" alt="image-20220502180746873"></p>
<p>DNS对应的记录在如下页面：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729921.png" alt="image-20220502180905706"></p>
<p>证书签发后，选择下载：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729715.png" alt="image-20220922221659090"></p>
<p>下载后的文件如图所示：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729885.png" alt="image-20220922221718845"></p>
<p>接下来需要将这两个文件上传到nginx目录下的conf目录下：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729169.png" alt="image-20220922221737524"></p>
<p>nginx配置证书：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">	    <span class="attribute">server_name</span> localhost;  <span class="comment"># 接收所有访问443端口的请求</span></span><br><span class="line">	    <span class="attribute">ssl_certificate</span> 8514410_www.hylshyflying.com.pem;</span><br><span class="line">	    <span class="attribute">ssl_certificate_key</span> 8514410_www.hylshyflying.com.key;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>配置完之后，重启nginx:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<ul>
<li><p>报错信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@nginx ~]# systemctl reload nginx</span><br><span class="line">Job for nginx.service failed because the control process exited with error code.           See &quot;systemctl status nginx.service&quot; and &quot;journalctl -xe&quot; for details.</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方法：</p>
<ul>
<li><p>手动安装openssl环境</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure>
</li>
<li><p>Nginx开启SSL模块</p>
</li>
<li><p>切换到<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%BA%90%E7%A0%81&spm=1001.2101.3001.7020">源码</a>包：</p>
</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/nginx-1.21.6/</span><br></pre></td></tr></table></figure>

<ul>
<li>查看nginx原有的模块</li>
</ul>
  <figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin/nginx -V</span><br></pre></td></tr></table></figure>

<ul>
<li>那么我们的新配置信息就应该这样写：</li>
</ul>
  <figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">./configure --prefix=<span class="regexp">/usr/</span>local/nginx --<span class="keyword">with</span>-http_stub_status_module --<span class="keyword">with</span>-http_ssl_module</span><br></pre></td></tr></table></figure>

<ul>
<li>运行上面的命令即可，等配置完成后，运行命令</li>
</ul>
  <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="built_in">make</span></span><br></pre></td></tr></table></figure>

<p>  这里不要进行make install，否则就是覆盖安装</p>
<ul>
<li>然后备份原有已安装好的nginx</li>
</ul>
  <figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">cp <span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin<span class="regexp">/nginx /</span>usr<span class="regexp">/local/</span>nginx<span class="regexp">/sbin/</span>nginx.bak</span><br></pre></td></tr></table></figure>

<ul>
<li>然后将刚刚编译好的nginx覆盖掉原有的nginx（这个时候nginx要停止状态）</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> ./objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>

<ul>
<li>然后启动nginx，仍可以通过命令查看是否已经加入成功</li>
</ul>
  <figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin/nginx -V　</span><br></pre></td></tr></table></figure></li>
</ul>
<p>配置nginx.cfg</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> httpds&#123;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.130:80</span> weight=<span class="number">8</span> down;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.131:80</span> weight=<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">	    <span class="attribute">server_name</span> localhost;  <span class="comment"># 接收所有访问443端口的请求</span></span><br><span class="line">	    <span class="attribute">ssl_certificate</span> 8514410_www.hylshyflying.com.pem;</span><br><span class="line">	    <span class="attribute">ssl_certificate_key</span> 8514410_www.hylshyflying.com.key;</span><br><span class="line">	<span class="comment">#配置根目录以及默认页面</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm index.php;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#出错页面配置</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="comment">#/50x.html文件所在位置</span></span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">server_name</span> www.hylshyflying.com hylshyflying.com;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 重定向，会显示跳转的地址server_name,如果访问的地址没有匹配会默认使用第一个，即www.hylshyflying.com</span></span><br><span class="line">	<span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://www.hylshyflying.com/">http://www.hylshyflying.com</a>, 发现自动变成https访问：</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729546.png" alt="image-20220922223108302"></p>
<p>访问<a target="_blank" rel="noopener" href="https://hua.hylshyflying.com/%E6%98%BE%E7%A4%BA%E5%AE%89%E5%85%A8%E6%8F%90%E7%A4%BA%E9%A1%B5%E9%9D%A2">https://hua.hylshyflying.com/显示安全提示页面</a>:</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729982.png" alt="image-20220922223249144"></p>
<h1 id="Nginx高级篇"><a href="#Nginx高级篇" class="headerlink" title="Nginx高级篇"></a>Nginx高级篇</h1><h1 id="Nginx高并发网站技术架构实战"><a href="#Nginx高并发网站技术架构实战" class="headerlink" title="Nginx高并发网站技术架构实战"></a>Nginx高并发网站技术架构实战</h1><h2 id="第一部分：扩容"><a href="#第一部分：扩容" class="headerlink" title="第一部分：扩容"></a>第一部分：扩容</h2><p><strong>通过扩容提升整体吞吐量</strong></p>
<h3 id="扩容方式"><a href="#扩容方式" class="headerlink" title="扩容方式"></a>扩容方式</h3><h4 id="1-单机垂直扩容：硬件资源增加"><a href="#1-单机垂直扩容：硬件资源增加" class="headerlink" title="1.单机垂直扩容：硬件资源增加"></a>1.单机垂直扩容：硬件资源增加</h4><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">云服务资源增加</span><br><span class="line">整机：IBM、浪潮、DELL、HP等</span><br><span class="line">CPU/主板：更新到主流</span><br><span class="line">网卡：10G/40G网卡</span><br><span class="line">磁盘：SAS(SCSI) HDD（机械）、HHD（混合）、SATA SSD、PCI-e SSD、 MVMe SSD</span><br><span class="line">SSD</span><br><span class="line">多副本机制</span><br><span class="line">系统盘/热点数据/数据库存储</span><br><span class="line">HDD</span><br><span class="line">冷数据存储</span><br></pre></td></tr></table></figure>

<h4 id="2-水平扩展：集群化"><a href="#2-水平扩展：集群化" class="headerlink" title="2.水平扩展：集群化"></a>2.水平扩展：集群化</h4><h5 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a>会话管理</h5><h6 id="Nginx高级负载均衡"><a href="#Nginx高级负载均衡" class="headerlink" title="Nginx高级负载均衡"></a>Nginx高级负载均衡</h6><ol>
<li><strong>ip_hash</strong></li>
</ol>
<p>当对后端的多台动态应用服务器做<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1&spm=1001.2101.3001.7020">负载均衡</a>时，ip_hash指令能够将某个客户端IP的请求通过哈希算法定位到同一台后端服务器上。这样，当来自某一个IP的用户在后端Web服务器A上登录后，在访问该站点的其他URL，能保证其访问的还是后端web服务器A。</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141729350.png"></p>
<p><strong>应用场景</strong>：适用于中小型项目，快速扩容。</p>
<p><strong>问题</strong>：使用ip_hash指令无法保证后端服务器的负载均衡，可能导致有些后端服务器接收到的请求多，有些后端服务器接收的请求少，而且设置后端服务器权重等方法将不起作用。当服务器宕机后，该服务器保存的session会丢失。</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在129服务器上配置</span></span><br><span class="line"><span class="section">upstream</span> httpds&#123;</span><br><span class="line">      <span class="comment">#ip_hash;</span></span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.130:80</span>;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.131:80</span>;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.hylshyflying.com hylshyflying.com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://httpds;</span><br><span class="line">            <span class="comment">#root   html;</span></span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p><strong>其他hash</strong></p>
<ul>
<li><strong>hash    $cookie_jsessionid;</strong><ul>
<li>jsessionid是tomcat和Java下发的</li>
</ul>
</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> httpds&#123;</span><br><span class="line">     <span class="attribute">hash</span>    <span class="variable">$cookie_jsessionid</span>;</span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.182.131:8080</span>;// 安装了<span class="attribute">tomcat</span></span><br><span class="line">     server <span class="number">192.168.182.132:8080</span>;// 安装了<span class="attribute">tomcat</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>hash    $request_uri;</strong> <ul>
<li>不支持cookie的情况下</li>
<li>资源不平均分配情况</li>
</ul>
</li>
</ul>
</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> httpds&#123;</span><br><span class="line">      <span class="attribute">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.130:80</span>;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.131:80</span>;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<ul>
<li>没有url计算的hash值求余到了131服务器</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730303.png" alt="image-20220926212436874"></p>
<ul>
<li>index.html的url地址计算的hash求余匹配到了130服务器</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730580.png" alt="image-20220926212659506"></p>
<pre><code>3. **使用lua逻辑定向分发**
</code></pre>
<h6 id="使用sticky模块完成对Nginx的负载均衡"><a href="#使用sticky模块完成对Nginx的负载均衡" class="headerlink" title="使用sticky模块完成对Nginx的负载均衡"></a>使用sticky模块完成对Nginx的负载均衡</h6><p><strong>使用参考</strong></p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#sticky">http://nginx.org/en/docs/http/ngx_http_upstream_module.html#sticky</a></p>
<p>tengine中有session_sticky模块我们通过第三方的方式安装在开源版本中</p>
<p>sticky是第三方模块，需要重新编译Nginx,他可以对Nginx这种静态文件服务器使用<strong>基于cookie的负载均衡</strong>。</p>
<ol>
<li>下载模块</li>
</ol>
<p><strong>项目官网</strong></p>
<p><a target="_blank" rel="noopener" href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/src/master/">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/src/master/</a></p>
<p>另外一个版本</p>
<p><a target="_blank" rel="noopener" href="https://github.com/bymaximus/nginx-sticky-module-ng">https://github.com/bymaximus/nginx-sticky-module-ng</a></p>
<p><strong>下载</strong></p>
<p><a target="_blank" rel="noopener" href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/get/1.2.6.zip">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/get/1.2.6.zip</a></p>
<pre><code>2. 上传解压
</code></pre>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730506.png" alt="image-20220926222925425"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@nginx nginx-1.21.6]# cd /root/</span><br><span class="line">[root@nginx ~]# ls</span><br><span class="line">1                nginx-1.21.6.tar.gz</span><br><span class="line">anaconda-ks.cfg  nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d.tar.gz</span><br><span class="line">nginx-1.21.6</span><br><span class="line">[root@nginx ~]# tar -zxvf nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d.tar.gz</span><br></pre></td></tr></table></figure>

<pre><code> 2. 重新编译nginx
</code></pre>
<p>依赖<code>openssl-devel</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx ~]# cd nginx-1.21.6</span><br><span class="line">[root@nginx nginx-1.21.6]# ls</span><br><span class="line">auto     CHANGES.ru  configure  html     Makefile  objs    src</span><br><span class="line">CHANGES  conf        contrib    LICENSE  man       README</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">**进到源码目录重新编译**</span></span><br><span class="line">[root@nginx nginx-1.21.6]#  ./configure --prefix=/usr/local/nginx --add-module=/root/nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d/</span><br><span class="line">....</span><br><span class="line">[root@nginx nginx-1.21.6]# make</span><br></pre></td></tr></table></figure>

<p><strong>如遇报错修改源码</strong></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730869.png" alt="image-20220926223349478"></p>
<ul>
<li>打开 <code>ngx_http_sticky_misc.c</code>文件</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730246.png" alt="image-20220926223439433"></p>
<ul>
<li>添加以下内容</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;openssl/sha.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;openssl/md5.h&gt;</span></span><br></pre></td></tr></table></figure>

<pre><code>3. 重新执行
</code></pre>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx nginx-1.21.6]#  ./configure --prefix=/usr/local/nginx --add-module=/root/nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d/</span><br><span class="line">[root@nginx nginx-1.21.6]# make</span><br></pre></td></tr></table></figure>

<p> <img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730728.png" alt="image-20220926223705020"></p>
<pre><code>4. **升级检测**
</code></pre>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make upgrade</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730093.png" alt="image-20220926223801834"></p>
<pre><code> 5. **备份之前的程序**
</code></pre>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br></pre></td></tr></table></figure>

<pre><code>6. **把编译好的Nginx程序替换到原来的目录里**
</code></pre>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730641.png" alt="image-20220926224046856"></p>
<pre><code> 7. 检查程序中是否包含新模块
</code></pre>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730831.png" alt="image-20220926223930208"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">[root@nginx sbin]# systemcti start nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">8. 在129服务器中配置</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> httpds&#123;</span><br><span class="line">    <span class="comment"># name 下发值的名称 expires 过期时间</span></span><br><span class="line">    <span class="attribute">sticky</span> name=route expires=<span class="number">6h</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.182.131:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.182.132:8080</span>;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730197.png" alt="image-20220927200822656"></p>
<h3 id="KeepAlive"><a href="#KeepAlive" class="headerlink" title="KeepAlive"></a>KeepAlive</h3><p>keepalive是在TCP中一个可以检测死连接的机制，作用是保持socket长连接不被断开，属于tcp层的功能，并不属于应用层。默认http1.1协议的请求头是默认开启keepalive。</p>
<h4 id="在浏览器查看是否启用keepalive"><a href="#在浏览器查看是否启用keepalive" class="headerlink" title="在浏览器查看是否启用keepalive"></a>在浏览器查看是否启用keepalive</h4><p>在http协议header中可以看到当前连接状态</p>
<p>访问<a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com</a></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730604.png" alt="image-20220927202706174"></p>
<h4 id="测试工具charles进行抓包检测"><a href="#测试工具charles进行抓包检测" class="headerlink" title="测试工具charles进行抓包检测"></a>测试工具charles进行抓包检测</h4><p><strong>下载地址</strong>——<a target="_blank" rel="noopener" href="https://www.charlesproxy.com/assets/release/4.6.2/charles-proxy-4.6.2-win64.msi?k=fc1457e312">https://www.charlesproxy.com/assets/release/4.6.2/charles-proxy-4.6.2-win64.msi?k=fc1457e312</a></p>
<p><strong>官网</strong>——<a target="_blank" rel="noopener" href="https://www.charlesproxy.com/">https://www.charlesproxy.com</a></p>
<p>使用教程——<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903665304600589">Charles 功能介绍和使用教程 - 掘金 (juejin.cn)</a></p>
<h4 id="什么时候使用？"><a href="#什么时候使用？" class="headerlink" title="什么时候使用？"></a>什么时候使用？</h4><p>明显的预知用户会在当前连接上有下一步操作</p>
<p>复用连接，有效减少握手次数，尤其是https建立一次连接开销会更大</p>
<h4 id="什么时候不用？"><a href="#什么时候不用？" class="headerlink" title="什么时候不用？"></a>什么时候不用？</h4><p>访问内联资源一般用缓存，不需要keepalive</p>
<p>长时间的tcp连接容易导致系统资源无效占用</p>
<h4 id="对客户端使用keepalive"><a href="#对客户端使用keepalive" class="headerlink" title="对客户端使用keepalive"></a>对客户端使用keepalive</h4><p>官方文档——<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive_time">Module ngx_http_upstream_module (nginx.org)</a></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730783.png" alt="image-20220927211215737"></p>
<h5 id="常用配置选项"><a href="#常用配置选项" class="headerlink" title="常用配置选项"></a>常用配置选项</h5><ul>
<li><strong>keepalive_time</strong></li>
</ul>
<p>限制keepalive保持连接的最大时间 默认1h    1.19.10新功能</p>
<ul>
<li><strong>keepalive_timeout</strong></li>
</ul>
<p>用于设置Nginx服务器与客户端保持连接的时间 默认65s，用于踢出不活动连接</p>
<p><code>keepalive_timeout  65;</code>默认配置</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730568.png" alt="image-20220927210408911"></p>
<p><code>keepalive_timeout  0;</code> 即关闭</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730052.png" alt="image-20220927210306516"></p>
<p><code>keepalive_timeout  65 65;</code></p>
<ul>
<li><strong>send_timeout</strong></li>
</ul>
<p>两次向客户端写操作之间的间隔 如果大于这个时间则关闭连接 默认60s</p>
<blockquote>
<p>注：不要设置太小</p>
</blockquote>
<p><strong>此处有坑</strong>，设置值太小，注意耗时的同步操作超出时间，有可能会丢弃用户连接。</p>
<p><code>send_timeout 10;</code>  10秒</p>
<p><code>send_timeout 10 10;</code> 同时下发一个header 告诉浏览器</p>
<p>该设置表示Nginx服务器与客户端连接后，某次会话中服务器等待客户端响应超过10s，就会自动关闭连接。</p>
<ul>
<li><strong>keepalive_request</strong></li>
</ul>
<p>单个连接中可处理的请求数 默认1000</p>
<ul>
<li><strong>keepalive_disable</strong></li>
</ul>
<p>不对某些浏览器建立长连接 默认msie6</p>
<p><strong>案例：</strong></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span> <span class="number">65</span>; <span class="comment">#超过这个时间 没有活动，会让keepalive失效 http1.0版本</span></span><br><span class="line">    <span class="attribute">keepalive_time</span> <span class="number">1h</span>; <span class="comment"># 一个tcp连接总时长，超过之后 强制失效</span></span><br><span class="line">  </span><br><span class="line">    <span class="attribute">send_timeout</span> <span class="number">60</span>;<span class="comment"># 默认60s 不要设置太小  此处有坑！！ 系统中 若有耗时操作，超过 send_timeout会强制断开连接。 注意：准备过程中，不是传输过程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_requests</span> <span class="number">1000</span>;  <span class="comment">#一个tcp复用中 可以并发接收的请求个数</span></span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>

<h4 id="对上游服务器使用keepalive"><a href="#对上游服务器使用keepalive" class="headerlink" title="对上游服务器使用keepalive"></a>对上游服务器使用keepalive</h4><p>首先需要配置使用http1.1协议。以便建立更高效的传输，默认使用http1.0，在http1.0中需要配置header才能在Upstream中所配置的上游服务器默认都是用短连接，即每次请求都会在完成之后断开。</p>
<h5 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h5><h6 id="nginx-cong中的upstream中配置"><a href="#nginx-cong中的upstream中配置" class="headerlink" title="nginx.cong中的upstream中配置"></a>nginx.cong中的upstream中配置</h6><p><strong>keepalive 100;</strong></p>
<p>向上游服务器的保留连接数</p>
<p>**keepalive_timeout  **</p>
<p>连接保留时间</p>
<p> **keepalive_requests ** </p>
<p>一个tcp复用中 可以并发接收的请求个数</p>
<h6 id="nginx-conf中的server中配置"><a href="#nginx-conf中的server中配置" class="headerlink" title="nginx.conf中的server中配置"></a>nginx.conf中的server中配置</h6><pre><code># 配置http版本号
proxy_http_version 1.1;
# 默认使用http1.0协议，需要在request中增加”Connection： keep-alive“ header才能够支持，而HTTP1.1默认支持。清除close信息。
proxy_set_header Connection &quot;&quot;;
</code></pre>
<h6 id="完整配置："><a href="#完整配置：" class="headerlink" title="完整配置："></a>完整配置：</h6><p>IP129服务器中nginx.conf</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span> <span class="number">65</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">keepalive_time</span> <span class="number">1h</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="attribute">send_timeout</span> <span class="number">60</span>;</span><br><span class="line">    <span class="attribute">keepalive_requests</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> httpds&#123;</span><br><span class="line">      <span class="attribute">keepalive</span> <span class="number">100</span>;</span><br><span class="line">      <span class="attribute">keepalive_requests</span> <span class="number">1000</span>;</span><br><span class="line">      <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line">      <span class="comment">#hash    $cookie_jsessionid;</span></span><br><span class="line">      <span class="comment">#sticky name=route expires=6h;</span></span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.131:8080</span>;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.132:8080</span>;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.hylshyflying.com hylshyflying.com;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://httpds;</span><br><span class="line">            <span class="comment">#root   html;</span></span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="section">location</span> ~*/(js|fonts|images|css) &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="AB压力测试"><a href="#AB压力测试" class="headerlink" title="AB压力测试"></a>AB压力测试</h5><h6 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h6><p><code>yum install httpd-tools</code></p>
<p>参数说明：</p>
<ul>
<li>-n  即requests，用于指定压力测试总共的执行次数。</li>
<li>-c  即concurrency，用于指定的并发数。</li>
<li>-t  即timelimit，等待响应的最大时间(单位：秒)。</li>
<li>-b  即windowsize，TCP发送&#x2F;接收的缓冲大小(单位：字节)。</li>
<li>-p  即postfile，发送POST请求时需要上传的文件，此外还必须设置-T参数。</li>
<li>-u  即putfile，发送PUT请求时需要上传的文件，此外还必须设置-T参数。</li>
<li>-T  即content-type，用于设置Content-Type请求头信息，例如：application&#x2F;x-www-form-urlencoded，默认值为text&#x2F;plain。</li>
<li>-v  即verbosity，指定打印帮助信息的冗余级别。</li>
<li>-w  以HTML表格形式打印结果。</li>
<li>-i  使用HEAD请求代替GET请求。</li>
<li>-x  插入字符串作为table标签的属性。</li>
<li>-y  插入字符串作为tr标签的属性。</li>
<li>-z  插入字符串作为td标签的属性。</li>
<li>-C  添加cookie信息，例如：”Apache&#x3D;1234”(可以重复该参数选项以添加多个)。</li>
<li>-H  添加任意的请求头，例如：”Accept-Encoding: gzip”，请求头将会添加在现有的多个请求头之后(可以重复该参数选项以添加多个)。</li>
<li>-A  添加一个基本的网络认证信息，用户名和密码之间用英文冒号隔开。</li>
<li>-P  添加一个基本的代理认证信息，用户名和密码之间用英文冒号隔开。</li>
<li>-X  指定使用的和端口号，例如:”126.10.10.3:88”。</li>
<li>-V  打印版本号并退出。</li>
<li>-k  使用HTTP的KeepAlive特性。</li>
<li>-d  不显示百分比。</li>
<li>-S  不显示预估和警告信息。</li>
<li>-g  输出结果信息到gnuplot格式的文件中。</li>
<li>-e  输出结果信息到CSV格式的文件中。</li>
<li>-r  指定接收到错误信息时不退出程序。</li>
<li>-h  显示用法信息，其实就是ab -help。</li>
</ul>
<h6 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h6><p><strong>nginx反向代理Tomcat + keepalive</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx bin]# ab -n 10000 -c 30 http://www.hylshyflying.com/</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking www.hylshyflying.com (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> nginx 版本</span></span><br><span class="line">Server Software:        nginx/1.21.6</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务器主机</span></span><br><span class="line">Server Hostname:        www.hylshyflying.com</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口号</span></span><br><span class="line">Server Port:            80</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文档地址</span></span><br><span class="line">Document Path:          /</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文档长度</span></span><br><span class="line">Document Length:        14284 bytes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">并发数</span></span><br><span class="line">Concurrency Level:      30</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">整个持续时间</span></span><br><span class="line">Time taken for tests:   6.533 seconds</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">完成请求数</span></span><br><span class="line">Complete requests:      10000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">失败请求次数</span></span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">整个场景中的网络传输量</span></span><br><span class="line">Total transferred:      145260000 bytes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">整个场景中的HTML内容传输量</span></span><br><span class="line">HTML transferred:       142840000 bytes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">相当于 LR 中的 每秒事务数 ，后面括号中的 mean 表示这是一个平均值</span></span><br><span class="line">Requests per second:    1831.52 [#/sec] (mean)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">相当于 LR 中的 平均事务响应时间 ，后面括号中的 mean 表示这是一个平均值</span></span><br><span class="line">Time per request:       16.380 [ms] (mean)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每个请求实际运行时间的平均值</span></span><br><span class="line">Time per request:       0.653 [ms] (mean, across all concurrent requests)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">平均每秒网络上的流量，可以帮助排除是否存在网络流量过大导致响应时间延长的问题</span></span><br><span class="line">Transfer rate:          21713.09 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    2   1.3      1      17</span><br><span class="line">Processing:     5   15   4.2     14      80</span><br><span class="line">Waiting:        3   13   3.7     13      55</span><br><span class="line">Total:          8   16   4.7     15      83</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">整个场景中所有请求的响应情况。在场景中每个请求都有一个响应时间，其中50％的用户响应时间小于16 毫秒，66％ 的用户响应时间小于18 毫秒，最大的响应时间小于166 毫秒</span></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">    15</span></span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">    17</span></span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">    17</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">    18</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">    20</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">    23</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">    29</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">    36</span></span><br><span class="line"><span class="meta prompt_"> 100% </span><span class="language-bash">    83 (longest request)</span></span><br></pre></td></tr></table></figure>

<p><strong>直连nginx</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@nginx ~]# ab -n 10000 -c 30 http://192.168.182.132/</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 192.168.182.132 (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx/1.21.6</span><br><span class="line">Server Hostname:        192.168.182.132</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        279 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   3.525 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      5120000 bytes</span><br><span class="line">HTML transferred:       2790000 bytes</span><br><span class="line">Requests per second:    2837.19 [#/sec] (mean)</span><br><span class="line">Time per request:       10.574 [ms] (mean)</span><br><span class="line">Time per request:       0.352 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1418.60 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    2   2.4      1      19</span><br><span class="line">Processing:     1    8   4.6      8      56</span><br><span class="line">Waiting:        0    8   4.4      7      55</span><br><span class="line">Total:          2   10   4.9     10      57</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">    10</span></span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">    11</span></span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">    11</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">    12</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">    16</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">    19</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">    23</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">    30</span></span><br><span class="line"><span class="meta prompt_"> 100% </span><span class="language-bash">    57 (longest request)</span></span><br></pre></td></tr></table></figure>

<p><strong>nginx反向代理Tomcat</strong> </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx bin]# ab -n 10000 -c 30 http://www.hylshyflying.com/</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking www.hylshyflying.com (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx/1.21.6</span><br><span class="line">Server Hostname:        www.hylshyflying.com</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        14284 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   8.470 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      145260000 bytes</span><br><span class="line">HTML transferred:       142840000 bytes</span><br><span class="line">Requests per second:    1180.69 [#/sec] (mean)</span><br><span class="line">Time per request:       25.409 [ms] (mean)</span><br><span class="line">Time per request:       0.847 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          16748.80 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    3   1.8      3      18</span><br><span class="line">Processing:     5   22   9.8     20     146</span><br><span class="line">Waiting:        4   20   9.9     18     143</span><br><span class="line">Total:          9   25   9.7     23     147</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">    23</span></span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">    26</span></span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">    27</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">    29</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">    33</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">    40</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">    52</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">    61</span></span><br><span class="line"><span class="meta prompt_"> 100% </span><span class="language-bash">   147 (longest request)</span></span><br></pre></td></tr></table></figure>

<p><strong>直连Tomcat</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx bin]# ab -n 10000 -c 30 http://192.168.182.132/</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 192.168.182.132 (be patient)</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Completed 3000 requests</span><br><span class="line">Completed 4000 requests</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 6000 requests</span><br><span class="line">Completed 7000 requests</span><br><span class="line">Completed 8000 requests</span><br><span class="line">Completed 9000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx/1.21.6</span><br><span class="line">Server Hostname:        192.168.182.132</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        279 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   3.618 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      5120000 bytes</span><br><span class="line">HTML transferred:       2790000 bytes</span><br><span class="line">Requests per second:    2763.82 [#/sec] (mean)</span><br><span class="line">Time per request:       10.855 [ms] (mean)</span><br><span class="line">Time per request:       0.362 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1381.91 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    3   2.4      2      15</span><br><span class="line">Processing:     1    8   3.9      7      32</span><br><span class="line">Waiting:        1    7   3.5      6      32</span><br><span class="line">Total:          3   11   4.8      9      34</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">     9</span></span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">    10</span></span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">    11</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">    14</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">    18</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">    20</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">    25</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">    28</span></span><br><span class="line"><span class="meta prompt_"> 100% </span><span class="language-bash">    34 (longest request)</span></span><br></pre></td></tr></table></figure>

<h3 id="Nginx反向代理核心流程"><a href="#Nginx反向代理核心流程" class="headerlink" title="Nginx反向代理核心流程"></a>Nginx反向代理核心流程</h3><h4 id="Http1-X协议报文组成"><a href="#Http1-X协议报文组成" class="headerlink" title="Http1.X协议报文组成"></a>Http1.X协议报文组成</h4><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730594.png" alt="image-20220928205651037"></p>
<h4 id="UpStream工作流程"><a href="#UpStream工作流程" class="headerlink" title="UpStream工作流程"></a>UpStream工作流程</h4><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730929.png" alt="image-20220928212016118"></p>
<p>proxy_pass 向上游服务器请求数据共有6个阶段</p>
<ul>
<li>初始化</li>
<li>与上游服务器建立连接</li>
<li>向上游服务器发送请求</li>
<li>处理响应头</li>
<li>处理响应体</li>
<li>结束</li>
</ul>
<h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a><strong>参数</strong></h5><ul>
<li><strong><code>set_header</code></strong></li>
</ul>
<p>设置header</p>
<ul>
<li><strong><code>proxy_connect_timeout</code></strong></li>
</ul>
<p>与上游服务器连接超时时间、快速失败</p>
<ul>
<li><strong><code>proxy_send_timeout</code></strong></li>
</ul>
<p>定义nginx向后端服务发送请求的间隔时间(不是耗时)。默认60秒，超过这个时间会关闭连接</p>
<ul>
<li><strong><code>proxy_read_timeout</code></strong></li>
</ul>
<p>后端服务给nginx响应的时间，规定时间内后端服务没有给nginx响应，连接会被关闭，nginx返回504 Gateway Time-out。默认60秒</p>
<h4 id="缓冲区"><a href="#缓冲区" class="headerlink" title="缓冲区"></a>缓冲区</h4><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141730344.png" alt="image-20220928212355819"></p>
<h5 id="参数-1"><a href="#参数-1" class="headerlink" title="参数"></a>参数</h5><ul>
<li><strong><code>proxy_requset_buffering</code></strong></li>
</ul>
<p>是否完全读到请求体之后再向上游服务器发送请求</p>
<ul>
<li><strong><code>proxy_buffering</code></strong></li>
</ul>
<p>是否缓冲上游服务器数据</p>
<ul>
<li><strong><code>proxy_buffers</code> 32 64k;</strong></li>
</ul>
<p>缓冲区大小 32个 64k大小内存缓冲块</p>
<ul>
<li><strong><code>proxy_buffer_size</code></strong></li>
</ul>
<p>header缓冲区大小</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">proxy_requset_buffering on;</span><br><span class="line">proxy_buffering on;</span><br><span class="line"></span><br><span class="line">proxy_buffer_size 64k;</span><br><span class="line"></span><br><span class="line">proxy_buffers 32 128k;</span><br><span class="line">proxy_busy_buffers_size 8k;</span><br><span class="line">proxy_max_temp_file_size 1024m;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>proxy_temp_file_write_size</code> 8k</strong></li>
</ul>
<p>当启用从代理服务器到临时文件的响应的缓冲时，一次限制写入临时文件的数据的大小。 默认情况下，大小由proxy_buffer_size和proxy_buffers指令设置的两个缓冲区限制。 临时文件的最大大小由proxy_max_temp_file_size指令设置。  </p>
<ul>
<li><strong><code>proxy_max_temp_file_size</code> 1024m;</strong></li>
</ul>
<p>临时文件最大值  默认1G</p>
<ul>
<li><strong><code>proxy_temp_path</code></strong></li>
</ul>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">proxy_temp_path /spool/nginx/proxy_temp 1 2;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>a temporary file might look like this:</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/spool/nginx/proxy_temp/7/45/00000123457</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="对客户端的限制"><a href="#对客户端的限制" class="headerlink" title="对客户端的限制"></a>对客户端的限制</h4><p>可配置位置</p>
<ul>
<li>http</li>
<li>server</li>
<li>location</li>
</ul>
<h5 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h5><ul>
<li><strong><code>client_body_buffer_size</code></strong></li>
</ul>
<p>对客户端请求中的body缓冲区大小</p>
<p>默认32位8k 64位16k</p>
<p>如果请求体大于配置，则写入临时文件</p>
<ul>
<li><strong><code>client_header_buffer_size</code></strong></li>
</ul>
<p>设置读取客户端请求体的缓冲区大小。 如果请求体大于缓冲区，则将整个请求体或仅将其部分写入临时文件。 默认32位8K。 64位平台16K。  </p>
<ul>
<li><strong><code>client_max_body_size</code> 1000M;</strong></li>
</ul>
<p>默认1m，如果一个请求的大小超过配置的值，会返回413 (request Entity Too Large)错误给客户端</p>
<p>将size设置为0将禁用对客户端请求正文大小的检查。  </p>
<ul>
<li><strong><code>client_body_timeout</code></strong></li>
</ul>
<p>指定客户端与服务端建立连接后发送 request body 的超时时间。如果客户端在指定时间内没有发送任何内容，Nginx 返回 HTTP 408（Request Timed Out）</p>
<ul>
<li><strong><code>client_header_timeout</code></strong></li>
</ul>
<p>客户端向服务端发送一个完整的 request header 的超时时间。如果客户端在指定时间内没有发送一个完整的 request header，Nginx 返回 HTTP 408（Request Timed Out）。</p>
<ul>
<li><strong><code>client_body_temp_path</code></strong> <em>path</em><code> [</code><em>level1</em><code> [</code><em>level2</em><code> [</code><em>level3</em>&#96;]]]</li>
</ul>
<p>在磁盘上客户端的body临时缓冲区位置</p>
<ul>
<li><strong><code>client_body_in_file_only</code> on;</strong></li>
</ul>
<p>把body写入磁盘文件，请求结束也不会删除</p>
<ul>
<li><strong><code>client_body_in_single_buffer</code></strong></li>
</ul>
<p>尽量缓冲body的时候在内存中使用连续单一缓冲区，在二次开发时使用<code>$request_body</code>读取数据时性能会有所提高</p>
<ul>
<li><strong><code>client_header_buffer_size</code></strong></li>
</ul>
<p>设置读取客户端请求头的缓冲区大小</p>
<p>如果一个请求行或者一个请求头字段不能放入这个缓冲区，那么就会使用<code>large_client_header_buffers</code></p>
<ul>
<li><strong><code>large_client_header_buffers</code></strong></li>
</ul>
<p>默认8k</p>
<h3 id="反向代理中的容错机制"><a href="#反向代理中的容错机制" class="headerlink" title="反向代理中的容错机制"></a>反向代理中的容错机制</h3><h4 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h4><p><a target="_blank" rel="noopener" href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/">https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/</a></p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/stream/ngx_stream_proxy_module.html#proxy_bind">http://nginx.org/en/docs/stream/ngx_stream_proxy_module.html#proxy_bind</a></p>
<p><strong>proxy_timeout</strong> </p>
<h4 id="重试机制"><a href="#重试机制" class="headerlink" title="重试机制"></a>重试机制</h4><p><strong>proxy_next_upstream</strong></p>
<p>作用：</p>
<p>当后端服务器返回指定的错误时，将请求传递到其他服务器。</p>
<ul>
<li><p><code>error</code>与服务器建立连接，向其传递请求或读取响应头时发生错误;</p>
</li>
<li><p><code>timeout</code>在与服务器建立连接，向其传递请求或读取响应头时发生超时;</p>
</li>
<li><p><code>invalid_header</code>服务器返回空的或无效的响应;</p>
</li>
<li><p><code>http_500</code>服务器返回代码为500的响应;</p>
</li>
<li><p><code>http_502</code>服务器返回代码为502的响应;</p>
</li>
<li><p><code>http_503</code>服务器返回代码为503的响应;</p>
</li>
<li><p><code>http_504</code>服务器返回代码504的响应;</p>
</li>
<li><p><code>http_403</code>服务器返回代码为403的响应;</p>
</li>
<li><p><code>http_404</code>服务器返回代码为404的响应;</p>
</li>
<li><p><code>http_429</code>服务器返回代码为429的响应;</p>
</li>
</ul>
<p>不了解这个机制，在日常开发web服务的时候，就可能会踩坑。</p>
<p>比如有这么一个场景：一个用于导入数据的web页面，上传一个excel，通过读取、处理excel，向数据库中插入数据，处理时间较长（如1分钟），且为同步操作（即处理完成后才返回结果）。暂且不论这种方式的好坏，若nginx配置的响应等待时间（proxy_read_timeout）为30秒，就会触发超时重试，将请求又打到另一台。如果处理中没有考虑到重复数据的场景，就会发生数据多次重复插入！（当然，这种场景，内网可以通过机器名访问该服务器进行操作，就可以绕过nginx了，不过外网就没办法了。）</p>
<h3 id="获取客户端真实IP"><a href="#获取客户端真实IP" class="headerlink" title="获取客户端真实IP"></a>获取客户端真实IP</h3><h4 id="java代码获取IP"><a href="#java代码获取IP" class="headerlink" title="java代码获取IP"></a>java代码获取IP</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.Inet4Address;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.NetworkInterface;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NetDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;本机IP:&quot;</span> + getIpAddress());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getIpAddress</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hostname</span> <span class="operator">=</span> <span class="string">&quot;eth0&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取所有的网络接口</span></span><br><span class="line">            Enumeration&lt;NetworkInterface&gt; allNetInterfaces = NetworkInterface.getNetworkInterfaces();</span><br><span class="line">            <span class="keyword">while</span> (allNetInterfaces.hasMoreElements()) &#123;</span><br><span class="line">                <span class="comment">//遍历每一个网络接口</span></span><br><span class="line">                <span class="type">NetworkInterface</span> <span class="variable">netInterface</span> <span class="operator">=</span> allNetInterfaces.nextElement();</span><br><span class="line">                <span class="comment">//若是网路接口是：1回环接口 2虚拟网口 3网口状态为unUser，则跳过</span></span><br><span class="line">                <span class="keyword">if</span> (netInterface.isLoopback() || netInterface.isVirtual() || !netInterface.isUp()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//返回和网络接口绑定的所有ip地址</span></span><br><span class="line">                    Enumeration&lt;InetAddress&gt; addresses = netInterface.getInetAddresses();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> netInterface.getName();</span><br><span class="line">                    System.out.println(<span class="string">&quot;网口名称：&quot;</span> + name);</span><br><span class="line">                    <span class="keyword">while</span> (addresses.hasMoreElements()) &#123;</span><br><span class="line">                        <span class="comment">//遍历获取每一个IP地址</span></span><br><span class="line">                        <span class="type">InetAddress</span> <span class="variable">inetAddress</span> <span class="operator">=</span> addresses.nextElement();</span><br><span class="line">                        System.out.println(<span class="string">&quot;inetAddress.getHostAddress(): &quot;</span> + inetAddress.getHostAddress());</span><br><span class="line">                        <span class="keyword">if</span> (inetAddress != <span class="literal">null</span> &amp;&amp; inetAddress <span class="keyword">instanceof</span> Inet4Address) &#123;</span><br><span class="line">                            <span class="keyword">return</span> inetAddress.getHostAddress();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;IP地址获取失败&quot;</span> + e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731024.png" alt="image-20220928215808043"></p>
<p>打包上传到安装了tomcat的linux中运行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar .......</span><br></pre></td></tr></table></figure>

<h4 id="X-Real-IP"><a href="#X-Real-IP" class="headerlink" title="X-Real-IP"></a>X-Real-IP</h4><p>额外模块，不推荐使用</p>
<h4 id="setHeader"><a href="#setHeader" class="headerlink" title="setHeader"></a>setHeader</h4><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731364.png" alt="image-20220928221114698"></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.hylshyflying.com hylshyflying.com;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://httpds;</span><br><span class="line">        <span class="comment">#root   html;</span></span><br><span class="line">        <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="Gzip"><a href="#Gzip" class="headerlink" title="Gzip"></a>Gzip</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>启用Gzip压缩功能， 可以使网站的css、js 、xml、html 等静态资源在传输时进行压缩，经过Gzip压缩后资源可以变为原来的30%甚至更小，尽管这样会消耗一定的cpu资源，但是会节约大量的出口带宽来提高访问速度</p>
<p>Gzip 的压缩页面需要浏览器和服务器双方都支持，实际上就是服务器端压缩，传到浏览器后解压并解析。浏览器那里不需要我们担心，因为目前的大多数浏览器都支持解析Gzip。</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731002.png" alt="image-20220929194514023"></p>
<blockquote>
<p>注意：不建议压缩图片和大文件：图片如jpg、png文件本身就会有压缩，所以就算开启gzip后，压缩前和压缩后大小没有多大区别，所以开启了反而会白白的浪费CPU资源。（如果优化可以可以图片的生命周期设置长一点，让客户端来缓存）</p>
<p>而大文件资源会消耗大量的cpu资源，且不一定有明显的效果。</p>
</blockquote>
<p>Gzip的压缩分为动态压缩和静态压缩。动态压缩简而言之就是nginx上的资源是以原始文件形式存在的，当返回给浏览器的时候再进行压缩，浏览器收到压缩文件再解压缩。静态压缩就是nginx上的资源不是原始文件，而是提前压缩好的压缩文件，直接返回给浏览器，浏览器再进行解压缩。</p>
<ul>
<li>Nginx 动态压缩，静态文件还是普通文件，请求来了再压缩，然后返回给前端。</li>
<li>Nginx 静态压缩，提前把文件压缩成 .gz 格式，请求来了，直接返回即可。</li>
</ul>
<h4 id="动态压缩"><a href="#动态压缩" class="headerlink" title="动态压缩"></a>动态压缩</h4><p><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html">Module ngx_http_gzip_module (nginx.org)</a></p>
<h5 id="ngx-http-gzip-module"><a href="#ngx-http-gzip-module" class="headerlink" title="ngx_http_gzip_module"></a>ngx_http_gzip_module</h5><p><code>ngx_http_gzip_module</code> 模块是一个使用了 <strong>gzip</strong> 方法压缩响应的过滤器。有助于将传输数据的大小减少一半甚至更多。</p>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><blockquote>
<p>注：gzip动态压缩之后，<code>sendfile</code>的零拷贝就失效了</p>
</blockquote>
<p>作用域 <code>http, server, location</code></p>
<h6 id="gzip-on"><a href="#gzip-on" class="headerlink" title="gzip on;"></a><code>gzip on</code>;</h6><p>开关，默认关闭</p>
<h6 id="gzip-buffers-32-4k-16-8k"><a href="#gzip-buffers-32-4k-16-8k" class="headerlink" title="gzip_buffers 32 4k|16 8k"></a><code>gzip_buffers</code> 32 4k|16 8k</h6><p>32位操作系统建议32 4k	64位操作系统建议16 8k</p>
<p>缓冲区大小，设置系统获取几个单位的缓存用于存储gzip的压缩结果数据流， 默认值: gzip_buffers 4 4k&#x2F;8k</p>
<h6 id="gzip-comp-level-1；"><a href="#gzip-comp-level-1；" class="headerlink" title="gzip_comp_level 1；"></a><strong><code>gzip_comp_level</code> 1</strong>；</h6><p>压缩等级 1-9，数字越大压缩比越高，同时消耗cpu资源也越多，建议设置在5左右。默认值：1</p>
<h6 id="gzip-http-version-1-1"><a href="#gzip-http-version-1-1" class="headerlink" title="gzip_http_version 1.1;"></a><code>gzip_http_version</code> 1.1;</h6><p>使用gzip的最小版本，默认值: gzip_http_version 1.1(就是说对HTTP&#x2F;1.1协议的请求才会进行gzip压缩)</p>
<h6 id="gzip-min-length-1k；"><a href="#gzip-min-length-1k；" class="headerlink" title="gzip_min_length 1k；"></a><code>gzip_min_length</code> 1k；</h6><p>设置将被gzip压缩的响应的最小长度。 长度仅由“Content-Length”响应报头字段确定。</p>
<h6 id="gzip-proxied-多选"><a href="#gzip-proxied-多选" class="headerlink" title="gzip_proxied 多选"></a><code>gzip_proxied</code> 多选</h6><p>off 为不做限制</p>
<p><strong>作为反向代理时，针对上游服务器返回的头信息进行压缩</strong></p>
<ul>
<li>expired - 启用压缩，如果header头中包含 “Expires” 头信息</li>
<li>no-cache - 启用压缩，如果header头中包含 “Cache-Control:no-cache” 头信息</li>
<li>no-store - 启用压缩，如果header头中包含 “Cache-Control:no-store” 头信息</li>
<li>private - 启用压缩，如果header头中包含 “Cache-Control:private” 头信息<br>no_last_modified - 启用压缩,如果header头中不包含 “Last-Modified” 头信息</li>
<li>no_etag - 启用压缩 ,如果header头中不包含 “ETag” 头信息</li>
<li>auth - 启用压缩 , 如果header头中包含 “Authorization” 头信息</li>
<li>any - 无条件启用压缩</li>
</ul>
<h6 id="gzip-vary-on"><a href="#gzip-vary-on" class="headerlink" title="gzip_vary on;"></a><code>gzip_vary on</code>;</h6><p>增加一个header，是否添加“<code>Vary: Accept-Encoding</code>”响应头，适配老的浏览器，给代理服务器用的，有的浏览器支持压缩，有的不支持，所以避免浪费不支持的也压缩，所以根据客户端的HTTP头来判断，是否需要压缩</p>
<h6 id="gzip-types-mime-type-mime-type"><a href="#gzip-types-mime-type-mime-type" class="headerlink" title="gzip_types mime-type [mime-type ...]"></a><code>gzip_types mime-type [mime-type ...]</code></h6><p>哪些mime类型的文件进行压缩，默认值: gzip_types text&#x2F;html (默认不对js&#x2F;css文件进行压缩)，设置哪压缩种文本文件可参考 conf&#x2F;mime.types，不能用通配符 text&#x2F;*</p>
<h6 id="gzip-disable"><a href="#gzip-disable" class="headerlink" title="gzip_disable"></a><code>gzip_disable</code></h6><p>禁止某些浏览器使用gzip，配置禁用gzip条件，支持正则。（建议不写）</p>
<h5 id="完整实例"><a href="#完整实例" class="headerlink" title="完整实例"></a>完整实例</h5><ul>
<li>查看一个网站是否使用gzip压缩，可以通过控制台查看打开响应头中的Content-Encoding选项，如果出现gzip，则开启成功</li>
</ul>
<p><strong>不添加gzip配置的访问——<a target="_blank" rel="noopener" href="http://www.hylshyflying.com/">http://www.hylshyflying.com/</a></strong></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731489.png" alt="image-20220929201545305"></p>
<p><strong>在129服务器nginx.conf中配置gzip进行访问</strong></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.hylshyflying.com hylshyflying.com;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="comment"># 开启gzip</span></span><br><span class="line">            <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="comment"># 以8k为单位,按照原始数据的大小以16倍的方式申请内存空间,一般此项不要修改</span></span><br><span class="line">            <span class="attribute">gzip_buffers</span> <span class="number">16</span> <span class="number">8k</span>;</span><br><span class="line">            <span class="comment"># 压缩级别1-9，越大压缩率越高，同时消耗cpu资源也越多，建议设置在5左右。 </span></span><br><span class="line">            <span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line">            <span class="comment"># 使用gzip的最小版本</span></span><br><span class="line">            <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="comment"># 低于256的资源不压缩 1024=1K</span></span><br><span class="line">            <span class="attribute">gzip_min_length</span> <span class="number">256</span>;</span><br><span class="line">            <span class="comment"># 无条件启用压缩</span></span><br><span class="line">            <span class="attribute">gzip_proxied</span> any;</span><br><span class="line">            <span class="comment"># 是否添加“Vary: Accept-Encoding”响应头</span></span><br><span class="line">            <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="comment"># 需要压缩哪些响应类型的资源，多个空格隔开。不建议压缩图片.</span></span><br><span class="line">            <span class="attribute">gzip_types</span></span><br><span class="line">              text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</span><br><span class="line">              text/javascript application/javascript application/x-javascript</span><br><span class="line">              text/x-json application/json application/x-web-app-manifest+json</span><br><span class="line">              text/css text/plain text/x-component</span><br><span class="line">              font/opentype application/x-font-ttf application/vnd.ms-fontobject</span><br><span class="line">              image/x-icon;</span><br><span class="line">            <span class="comment"># 配置禁用gzip条件，支持正则。此处表示ie6及以下不启用gzip（因为ie低版本不支持)</span></span><br><span class="line">            <span class="attribute">gzip_disable</span> <span class="string">&quot;MSIE [1-6]\.(?!.*SV1)&quot;</span>;</span><br><span class="line">        .....</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731450.png" alt="image-20220929201630580"></p>
<ul>
<li>查看一个网站是否使用gzip压缩，可以使用如下命令</li>
</ul>
<p><code>curl -I -H &quot;Accept-Encoding:gzip,deflate&quot; &quot;想要查看的网址&quot;</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx bin]# curl -I -H &quot;Accept-Encoding:gzip,deflate&quot; &quot;http://www.hylshyflying.com/&quot;</span><br><span class="line">HTTP/1.1 200</span><br><span class="line">Server: nginx/1.21.6</span><br><span class="line">Date: Thu, 29 Sep 2022 12:17:52 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Keep-Alive: timeout=65</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">ETag: W/&quot;14284-1664279899812&quot;</span><br><span class="line">Last-Modified: Tue, 27 Sep 2022 11:58:19 GMT</span><br><span class="line">Content-Encoding: gzip</span><br></pre></td></tr></table></figure>

<h4 id="静态压缩"><a href="#静态压缩" class="headerlink" title="静态压缩"></a>静态压缩</h4><h5 id="ngx-http-gunzip-module"><a href="#ngx-http-gunzip-module" class="headerlink" title="ngx_http_gunzip_module"></a>ngx_http_gunzip_module</h5><p><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_gunzip_module.html">Module ngx_http_gunzip_module (nginx.org)</a></p>
<p>帮助不支持gzip的客户端解压本地文件。<code>ngx_http_gunzip_module</code> 模块是一个过滤器，用于对不支持 <strong>gzip</strong> 编码方法的客户端解压缩 <code>Content-Encoding：gzip</code> 的响应。当需要存储压缩数据以节省空间并降低 I&#x2F;O 成本时，该模块将非常有用。</p>
<ul>
<li>此模块不是默认构建，您可以使用 <code>--with-http_gunzip_module</code> 配置参数启用。</li>
</ul>
<h6 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h6><p><strong><code>gunzip</code></strong></p>
<table>
<thead>
<tr>
<th>-</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>语法</strong></td>
<td><strong>gunzip</strong> <code>on</code></td>
</tr>
<tr>
<td><strong>默认</strong></td>
<td>gunzip off;</td>
</tr>
</tbody></table>
<p>作用域 <code>http, server, location</code></p>
<p>对缺少 gzip 支持的客户端启用或禁用 gzip 响应解压缩。如果开启，在确定客户端是否支持 gzip 时还会考虑以下指令：<a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/ngx_http_gzip_module.md#gzip_http_version">gzip_http_version</a>、<a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/ngx_http_gzip_module.md#gzip_proxied">gzip_proxied</a> 和 <a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/ngx_http_gzip_module.md#gzip_disable">gzip_disable</a>。另请参阅 <a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/ngx_http_gzip_module.md#gzip_vary">gzip_vary</a> 指令。</p>
<p><strong><code>gunzip_buffers</code></strong></p>
<table>
<thead>
<tr>
<th>-</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>语法</strong></td>
<td><strong>gunzip_buffers</strong> <code>number size</code>;</td>
</tr>
<tr>
<td><strong>默认</strong></td>
<td>gunzip_buffers 32 4k|16 8k;</td>
</tr>
</tbody></table>
<p>设置用于解压响应的缓冲区的数量（<code>number</code>）和大小（<code>size</code>）。默认情况下，缓冲区大小等于一个内存页（4K 或 8K，取决于平台）。</p>
<h5 id="http-gzip-static-module"><a href="#http-gzip-static-module" class="headerlink" title="http_gzip_static_module"></a>http_gzip_static_module</h5><p><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_gzip_static_module.html">Module ngx_http_gzip_static_module (nginx.org)</a></p>
<p><code>ngx_http_gzip_static_module</code> 模块允许发送以 <strong>.gz</strong> 结尾的预压缩文件替代普通文件。<br>该模块默认不会被构建到 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=nginx&spm=1001.2101.3001.7020">nginx</a> 中，需要在编译时加入 <code>--with-http_gzip_static_module</code> 配置参数启用。</p>
<ul>
<li>默认情况下不构建此模块，应使用配置参数启用它。<code>--with-http_gzip_static_module</code></li>
</ul>
<h6 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h6><p><strong><code>gzip_static</code></strong></p>
<table>
<thead>
<tr>
<th>-</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>语法</strong></td>
<td><strong>gzip_static</strong> <code>on</code></td>
</tr>
<tr>
<td><strong>默认</strong></td>
<td>gzip_static off;</td>
</tr>
</tbody></table>
<p>作用域 <code>http, server, location</code></p>
<p>开启(<strong>on</strong>)或禁用(<strong>off</strong>)会检查预压缩文件是否存在。下列指令也会被影响到 <a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/ngx_http_gzip_module.md#gzip_http_version">gzip_http_verson</a>， <a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/ngx_http_gzip_module.md#gzip_proxied">gzip_proxied</a>， <a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/ngx_http_gzip_module.md#gzip_disable">gzip_disable</a>， <a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/ngx_http_gzip_module.md#gzip_vary">gzip_vary</a>。</p>
<p>值为 <strong>always</strong> (1.3.6)，在所有情况下都会使用压缩文件，不检查客户端是否支持。如果磁盘上没有未被压缩的文件或者 <a target="_blank" rel="noopener" href="https://blog.csdn.net/WuLex/article/details/ngx_http_gunzip_module.md">ngx_http_gunzip_module</a> 模块被启用，这个参数非常有用。</p>
<p>文件可以使用<code>gzip</code>命令，或者任何兼容文件进行压缩。建议压缩文件和源文件的修改日期和时间保持一致。</p>
<h5 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h5><ul>
<li>关闭gzip支持</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731138.png" alt="image-20220929212742361"></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731390.png" alt="image-20220929212704841"></p>
<ul>
<li>进行配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx ~]# ls</span><br><span class="line">1  anaconda-ks.cfg  nginx-1.21.6  nginx-1.21.6.tar.gz</span><br><span class="line">[root@nginx ~]# cd nginx-1.21.6</span><br><span class="line">[root@nginx nginx-1.21.6]# ./configure --prefix=/usr/local/nginx/ --with-http_gzip_static_module --with-http_gunzip_module</span><br><span class="line">....</span><br><span class="line">[root@nginx nginx-1.21.6]# make</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">[root@nginx nginx-1.21.6]# systemctl stop nginx</span><br><span class="line">[root@nginx nginx-1.21.6]# cd objs/</span><br><span class="line">[root@nginx objs]# ls</span><br><span class="line">autoconf.err  nginx    ngx_auto_config.h   ngx_modules.c  src</span><br><span class="line">Makefile      nginx.8  ngx_auto_headers.h  ngx_modules.o</span><br><span class="line">[root@nginx objs]# mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old2</span><br><span class="line">[root@nginx objs]# cp nginx  /usr/local/nginx/sbin/</span><br><span class="line">[root@nginx objs]# systemctl start nginx</span><br><span class="line">[root@nginx objs]# nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx//conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx//conf/nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.hylshyflying.com hylshyflying.com;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">gunzip</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">gzip_static</span> always;</span><br><span class="line">            <span class="comment"># 开启gzip</span></span><br><span class="line">            <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="comment"># 以8k为单位,按照原始数据的大小以16倍的方式申请内存空间,一般此项不要修改</span></span><br><span class="line">            <span class="attribute">gzip_buffers</span> <span class="number">16</span> <span class="number">8k</span>;</span><br><span class="line">            <span class="comment"># 压缩级别1-9，越大压缩率越高，同时消耗cpu资源也越多，建议设置在5左右。 </span></span><br><span class="line">            <span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line">        ....</span><br></pre></td></tr></table></figure>

<h3 id="Brotli"><a href="#Brotli" class="headerlink" title="Brotli"></a>Brotli</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p>Brotli是开源的一种新型压缩算法，Brotli压缩比智能压缩性能更好。开启Brotli压缩功能后，CDN节点会对资源进行智能压缩后返回，缩小传输文件大小，提升文件传输效率，减少带宽消耗。</p>
<p><strong>背景信息</strong></p>
<ul>
<li>压缩分为Gzip压缩和Brotli压缩，智能压缩功能主要针对Gzip压缩，智能压缩详情请参见<a target="_blank" rel="noopener" href="https://www.alibabacloud.com/help/zh/alibaba-cloud-cdn/latest/configure-intelligent-compression#task-187634">智能压缩</a>。</li>
<li>当源站文件的大小超过1 KB时，您可以使用智能压缩或Brotli压缩来压缩文件（即1 KB以下的文件不做压缩），Brotli压缩比智能压缩性能更好，性能提升约15%~25%。</li>
<li>Brotli压缩支持的文件类型有text&#x2F;xml、text&#x2F;plain、text&#x2F;css、application&#x2F;javascript、application&#x2F;x-javascript、application&#x2F;rss+xml、text&#x2F;javascript、image&#x2F;tiff、image&#x2F;svg+xml、application&#x2F;json、application&#x2F;xml。</li>
<li>服务端响应携带响应头<code>Content-Encoding: br</code>：服务端响应的内容是经过Brotli压缩后的资源。</li>
<li>客户端请求携带请求头<code>Accept-Encoding: br</code>：客户端希望获取对应资源时进行Brotli压缩。</li>
</ul>
<p><strong>区别：</strong></p>
<p>Brotli主要特点</p>
<ul>
<li>针对常见的 Web 资源内容，<a target="_blank" rel="noopener" href="https://www.xgss.net/tag/brotli">Brotli</a> 的性能相比 <a target="_blank" rel="noopener" href="https://www.xgss.net/tag/gzip">Gzip</a> 提高了 17-25%；</li>
<li>当 <a target="_blank" rel="noopener" href="https://www.xgss.net/tag/brotli">Brotli</a> 压缩级别为 1 时，压缩率比 <a target="_blank" rel="noopener" href="https://www.xgss.net/tag/gzip">Gzip</a> 压缩等级为 9（最高）时还要高；</li>
<li>在处理不同 HTML 文档时，Brotli 依然能够提供非常高的压缩率。</li>
</ul>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><ul>
<li>官网<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/google/ngx_brotli">https://github.com/google/ngx_brotli</a></li>
<li><a target="_blank" rel="noopener" href="https://codeload.github.com/google/brotli/tar.gz/refs/tags/v1.0.9">https://codeload.github.com/google/brotli/tar.gz/refs/tags/v1.0.9</a></li>
</ul>
</li>
<li>下载 两个项目</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731803.png" alt="image-20220929215857709"></p>
<ul>
<li>解压缩</li>
</ul>
<p>模块化编译</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./configure --with-compat --add-dynamic-module=/root/ngx_brotli-1.0.0rc --prefix=/usr/local/nginx/</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--add-dynamic-module=brotli目录</span><br></pre></td></tr></table></figure>

<ul>
<li>命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@nginx ~]# ls</span><br><span class="line">1                    nginx-1.21.6.tar.gz</span><br><span class="line">anaconda-ks.cfg      nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d</span><br><span class="line">brotli-1.0.9.tar.gz  nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d.tar.gz</span><br><span class="line">nginx-1.21.6         ngx_brotli-1.0.0rc.tar.gz</span><br><span class="line">[root@nginx ~]# tar -zxvf ngx_brotli-1.0.0rc.tar.gz</span><br><span class="line">....</span><br><span class="line">[root@nginx ~]# tar -zxvf brotli-1.0.9.tar.gz</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# cd brotli-1.0.9</span><br><span class="line">[root@nginx brotli-1.0.9]# mv ./* /root/ngx_brotli-1.0.0rc/deps/brotli/</span><br><span class="line">[root@nginx brotli-1.0.9]# ls</span><br><span class="line">[root@nginx brotli-1.0.9]# cd ~</span><br><span class="line">[root@nginx ~]# cd nginx-1.21.6</span><br><span class="line">[root@nginx nginx-1.21.6]# ls</span><br><span class="line">auto     CHANGES.ru  configure  html     Makefile  objs    src</span><br><span class="line">CHANGES  conf        contrib    LICENSE  man       README</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生成makefile，注意根据自己使用的模块添加</span></span><br><span class="line">[root@nginx nginx-1.21.6]# ./configure --with-compat --add-dynamic-module=/root/ngx_brotli-1.0.0rc --prefix=/usr/local/nginx/</span><br><span class="line">.....</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编译nginx</span></span><br><span class="line">[root@nginx nginx-1.21.6]# make</span><br><span class="line">......</span><br><span class="line">[root@nginx nginx-1.21.6]# cd objs/</span><br><span class="line">[root@nginx objs]# ls</span><br><span class="line">addon</span><br><span class="line">autoconf.err</span><br><span class="line">Makefile</span><br><span class="line">nginx</span><br><span class="line">nginx.8</span><br><span class="line">ngx_auto_config.h</span><br><span class="line">ngx_auto_headers.h</span><br><span class="line">ngx_http_brotli_filter_module_modules.c</span><br><span class="line">ngx_http_brotli_filter_module_modules.o</span><br><span class="line">ngx_http_brotli_filter_module.so</span><br><span class="line">ngx_http_brotli_static_module_modules.c</span><br><span class="line">ngx_http_brotli_static_module_modules.o</span><br><span class="line">ngx_http_brotli_static_module.so</span><br><span class="line">ngx_modules.c</span><br><span class="line">ngx_modules.o</span><br><span class="line">src</span><br><span class="line">[root@nginx objs]# mkdir /usr/local/nginx/modules</span><br><span class="line">[root@nginx objs]# cp ngx_http_brotli_filter_module.so /usr/local/nginx/modules/</span><br><span class="line">[root@nginx objs]# cp ngx_http_brotli_static_module.so /usr/local/nginx/modules/</span><br><span class="line">[root@nginx objs]# mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old3</span><br><span class="line">[root@nginx objs]# cp nginx /usr/local/nginx/sbin/</span><br><span class="line">[root@nginx objs]# systemctl restart nginx</span><br><span class="line">[root@nginx objs]# nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx//conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx//conf/nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<ul>
<li>配置文件中添加</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">load_module</span> <span class="string">&quot;/usr/local/nginx/modules/ngx_http_brotli_filter_module.so&quot;</span>;</span><br><span class="line"><span class="attribute">load_module</span> <span class="string">&quot;/usr/local/nginx/modules/ngx_http_brotli_static_module.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">     <span class="attribute">keepalive_timeout</span>  <span class="number">65</span> <span class="number">65</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">keepalive_time</span> <span class="number">1h</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="attribute">send_timeout</span> <span class="number">60</span>;</span><br><span class="line">    <span class="attribute">keepalive_requests</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> httpds&#123;</span><br><span class="line">      <span class="attribute">keepalive</span> <span class="number">100</span>;</span><br><span class="line">      <span class="attribute">keepalive_requests</span> <span class="number">1000</span>;</span><br><span class="line">      <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line">      <span class="comment">#hash    $cookie_jsessionid;</span></span><br><span class="line">      <span class="comment">#sticky name=route expires=6h;</span></span><br><span class="line">      <span class="comment">#server 192.168.182.131:8080;</span></span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.132:8080</span>;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.hylshyflying.com hylshyflying.com;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="comment">#开启Brotli压缩</span></span><br><span class="line">            <span class="attribute">brotli</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="comment">#是否允许查找预处理好的、以 .br 结尾的压缩文件。可选值为 on、off、always</span></span><br><span class="line">            <span class="attribute">brotli_static</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="comment">#压缩等级，0 到 11，默认值是 6，过大会额外消耗服务器CPU</span></span><br><span class="line">          	<span class="attribute">brotli_comp_level</span> <span class="number">6</span>;</span><br><span class="line">          	<span class="attribute">brotli_buffers</span> <span class="number">16</span> <span class="number">8k</span>;</span><br><span class="line">            <span class="comment">#设置需要进行压缩的最小响应大小，单位为字节</span></span><br><span class="line">          	<span class="attribute">brotli_min_length</span> <span class="number">20</span>;</span><br><span class="line">            <span class="comment">#指定哪些MIME类型进行压缩</span></span><br><span class="line">          	<span class="attribute">brotli_types</span> text/plain text/css text/javascript application/javascript text/xml application/xml application/xml+rss application/json image/jpeg image/gif image/png;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://httpds;</span><br><span class="line">            <span class="comment">#root   html;</span></span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="section">location</span> ~*/(js|fonts|images|css) &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>默认http协议是没有br的</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install curl</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -H &#x27;Accept-Encoding: gzip&#x27; -I http://www.hylshyflying.com/</span><br><span class="line">curl -H &#x27;Accept-Encoding: br&#x27; -I http://www.hylshyflying.com/</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[root@nginx ~]# curl -H &#x27;Accept-Encoding: br&#x27; -I http://www.hylshyflying.com/</span><br><span class="line">HTTP/1.1 200</span><br><span class="line">Server: nginx/1.21.6</span><br><span class="line">Date: Tue, 04 Oct 2022 06:35:15 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Keep-Alive: timeout=65</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">ETag: W/&quot;14284-1664279899812&quot;</span><br><span class="line">Last-Modified: Tue, 27 Sep 2022 11:58:19 GMT</span><br><span class="line">Content-Encoding: br</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>其它说明</strong></p>
<p>支持<a target="_blank" rel="noopener" href="https://www.xgss.net/tag/brotli%E5%8E%8B%E7%BC%A9">Brotli压缩</a>算法的浏览器使用的内容编码类型为br，例如以下是Chrome浏览器请求头里Accept-Encoding的值（只有在HTTPS的情况下，浏览器才会发送br这个Accept-Encoding）：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Accept</span>-<span class="title class_">Encoding</span>: gzip, deflate, sdch, br</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>如果服务端支持Brotli算法，则会返回以下的响应头：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Content</span>-<span class="title class_">Encoding</span>: br</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>Brotli和Gzip可以共存，因此建议2个压缩都启用，当部分老旧的浏览器并不支持Brotli的情况下自动降级为Gzip来处理。</p>
</blockquote>
<h3 id="合并请求"><a href="#合并请求" class="headerlink" title="合并请求"></a>合并请求</h3><h4 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h4><p>web项目中有时候一个页面会加载多个js或css资源请求，导致页面加载耗时较长，这时优化的方向可以采用资源合并，可以在客户端事先合并，也可以在服务端进行资源合并，服务端合并的方式使用起来更灵活。</p>
<p>nginx-http-concat是阿里云开发的nginx开源组件，可以在nginx编译安装时添加模块，也可以在已安装的nginx中重新添加模块。</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731140.png" alt="image-20221004144214172"></p>
<h4 id="Concat模块"><a href="#Concat模块" class="headerlink" title="Concat模块"></a>Concat模块</h4><p>Tengine</p>
<p>Nginx官方介绍</p>
<p><a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/modules/concat/">https://www.nginx.com/resources/wiki/modules/concat/</a></p>
<p>git地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/nginx-http-concat">https://github.com/alibaba/nginx-http-concat</a></p>
<h5 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx ~]# ls</span><br><span class="line">1                    nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d</span><br><span class="line">anaconda-ks.cfg      nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d.tar.gz</span><br><span class="line">brotli-1.0.9         nginx-http-concat-master.zip</span><br><span class="line">brotli-1.0.9.tar.gz  ngx_brotli-1.0.0rc</span><br><span class="line">nginx-1.21.6         ngx_brotli-1.0.0rc.tar.gz</span><br><span class="line">nginx-1.21.6.tar.gz</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">没有则进行安装</span></span><br><span class="line">[root@nginx ~]# yum install -y unzip</span><br><span class="line">[root@nginx ~]# unzip nginx-http-concat-master.zip</span><br><span class="line">Archive:  nginx-http-concat-master.zip</span><br><span class="line">b8d3e7ec511724a6900ba3915df6b504337891a9</span><br><span class="line">   creating: nginx-http-concat-master/</span><br><span class="line">  inflating: nginx-http-concat-master/README.md</span><br><span class="line">  inflating: nginx-http-concat-master/config</span><br><span class="line">  inflating: nginx-http-concat-master/ngx_http_concat_module.c</span><br><span class="line">[root@nginx ~]# cd nginx-http-concat-master</span><br><span class="line">[root@nginx nginx-http-concat-master]# ls</span><br><span class="line">config  ngx_http_concat_module.c  README.md</span><br><span class="line">[root@nginx nginx-http-concat-master]# cd</span><br><span class="line">[root@nginx ~]# cd nginx-1.21.6</span><br><span class="line">[root@nginx nginx-1.21.6]# ls</span><br><span class="line">auto     CHANGES.ru  configure  html     Makefile  objs    src</span><br><span class="line">CHANGES  conf        contrib    LICENSE  man       README</span><br><span class="line">[root@nginx nginx-1.21.6]# ./configure --prefix=/usr/local/nginx/ --add-module=/root/nginx-http-concat-master</span><br><span class="line">。。。。</span><br><span class="line">[root@nginx nginx-1.21.6]# make</span><br><span class="line">[root@nginx nginx-1.21.6]# cd objs/</span><br><span class="line">[root@nginx objs]# ls</span><br><span class="line">addon</span><br><span class="line">autoconf.err</span><br><span class="line">Makefile</span><br><span class="line">nginx</span><br><span class="line">nginx.8</span><br><span class="line">ngx_auto_config.h</span><br><span class="line">ngx_auto_headers.h</span><br><span class="line">ngx_http_brotli_filter_module_modules.c</span><br><span class="line">ngx_http_brotli_filter_module_modules.o</span><br><span class="line">ngx_http_brotli_filter_module.so</span><br><span class="line">ngx_http_brotli_static_module_modules.c</span><br><span class="line">ngx_http_brotli_static_module_modules.o</span><br><span class="line">ngx_http_brotli_static_module.so</span><br><span class="line">ngx_modules.c</span><br><span class="line">ngx_modules.o</span><br><span class="line">src</span><br><span class="line">[root@nginx objs]# ./nginx -V</span><br><span class="line">nginx version: nginx/1.21.6</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx/ --add-module=/root/nginx-http-concat-master</span><br><span class="line">[root@nginx objs]# systemctl stop nginx</span><br><span class="line">....复制备份....略</span><br><span class="line">[root@nginx objs]# cp nginx /usr/local/nginx/sbin/</span><br><span class="line">cp：是否覆盖&quot;/usr/local/nginx/sbin/nginx&quot;？ y</span><br><span class="line">[root@nginx objs]# nginx -t</span><br><span class="line">[root@nginx objs]# systemctl start nginx</span><br></pre></td></tr></table></figure>

<h5 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h5><ul>
<li><strong>concat</strong>，是否打开资源合并开关，选项：on | off，默认：off</li>
<li><strong>concat_types</strong>，模块处理的资源类型，默认：text&#x2F;css application&#x2F;x-javascript</li>
<li><strong>concat_unique</strong>，是否允许合并不同类型的资源，选项：on | off，默认：on</li>
<li><strong>concat_max_files</strong>，允许合并的最大资源数目，默认：10 </li>
<li><strong>concat_delimiter</strong>，合并后的文件内容分隔符，用于区分不同文件的内容</li>
<li><strong>concat_ignore_file_error</strong>，是否忽略404或403错误，选项：on | off，默认：off</li>
</ul>
<h5 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h5><ul>
<li>配置css放在不同的文件中test2.css&amp;test2.css</li>
</ul>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"># test1<span class="selector-class">.css</span></span><br><span class="line"><span class="selector-tag">body</span>&#123;</span><br><span class="line">  <span class="attribute">color</span>:green;</span><br><span class="line">&#125;</span><br><span class="line"># test2<span class="selector-class">.css</span></span><br><span class="line"><span class="selector-tag">body</span>&#123;</span><br><span class="line">  <span class="attribute">background-color</span>:black;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>nginx.conf中配置</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">....</span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">concat</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">concat_max_files</span> <span class="number">30</span>;</span><br><span class="line">        </span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<ul>
<li>通过一个link进行引入</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">....</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;??./css/test1.css,./css/test2.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">.....</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141731234.png" alt="image-20221004152801874"></p>
<h3 id="资源静态化"><a href="#资源静态化" class="headerlink" title="资源静态化"></a>资源静态化</h3><ul>
<li>高并发系统资源静态化方案</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732258.png" alt="image-20221004160804244"></p>
<p>通常普通网站流程是，用户请求Tomcat服务器，拿到数据渲染后动态的jsp页面，返回给用户，可能优化数据直接放在缓存（不访问数据库以提高用户访问速度）。</p>
<p>  静态化技术就是让用户访问的资源变成静态html页面，针对一些访问量大、不改动或者改动不频繁的业务，比如商品详情页（上架后数据基本不会变化）。生成的静态页面html放在nginx服务器上（Tomcat的上一级），用户访问不需要访问tomcat服务器，直接在nginx服务器中拿到需要的页面。</p>
<p>  举例商品详情页生成，首先通过freemaker技术（静态页面模板），生成该商品的html静态页面（这边可以使用消息中间件，上架商品id放在消息队列中，然后消费监听根据商品id从商品系统、图片系统等等，拿到数据，通过freemaker模板生成html静态页面），静态页面存放在nginx服务集群中。</p>
<p>  缺点就是当商品量达到一定层度（比如千万级）</p>
<p>  1、nginx服务器内存要求太高；、</p>
<p>  2、当模板freemaker或者数据改变，需要对所有的nginx服务器重新刷新，工作量大。</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732241.png" alt="image-20221004160905796"></p>
<ul>
<li><p>一致性问题</p>
</li>
<li><p>合并文件输出</p>
</li>
<li><p>集群文件同步</p>
</li>
</ul>
<h4 id="SSI合并文件输出"><a href="#SSI合并文件输出" class="headerlink" title="SSI合并文件输出"></a>SSI合并文件输出</h4><h5 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h5><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_ssi_module.html">http://nginx.org/en/docs/http/ngx_http_ssi_module.html</a></p>
<h5 id="介绍-3"><a href="#介绍-3" class="headerlink" title="介绍"></a>介绍</h5><p><strong>什么是SSI</strong></p>
<p>Server Side Include，通常称为服务器端嵌入，是一种类似于ASP的基于服务器的网页制作技术。大多数(尤其是基于Unix平台)的WEB服务器如Netscape Enterprise Server等均支持SSI命令。</p>
<p><strong>为什么要用SSI</strong></p>
<p>用个例子来说明，一个静态化的页面中，需要嵌入一小块实时变化的内容，。例如首页，大部分的页面内容需要缓存但是用户登录后的个人信息是动态信息，不能缓存。那么如何解决这个”页面部分缓存”问题，利用SSI就可以解决，在首页的静态页面中嵌入个人信息的动态页，由于是服务器端的嵌入，所以用户浏览的时候都是一个嵌入后的页面。</p>
<h5 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h5><p><strong>ssi on</strong></p>
<p>开启ssi支持，默认是off</p>
<p><strong>ssi_min_file_chunk</strong> </p>
<p>向磁盘存储并使用sendfile发送，文件大小最小值</p>
<p><strong>ssi_last_modified</strong> </p>
<p>默认为off，是否保留lastmodified</p>
<p><strong>ssi_silent_errors</strong> </p>
<p>默认值是off，开启后在处理SSI文件出错时不输出错误提示:”[an error occurred while processing the directive] ”</p>
<p><strong>ssi_value_length</strong></p>
<p>限制脚本参数最大长度</p>
<p><strong>ssi_types</strong> </p>
<p>默认是ssi_types text&#x2F;html，所以如果需要htm和html支持，则不需要设置这句，如果需要shtml支持，则需要设置：ssi_types text&#x2F;shtml</p>
<h5 id="静态文件中使用"><a href="#静态文件中使用" class="headerlink" title="静态文件中使用"></a>静态文件中使用</h5><p><strong>include file</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!--# include file=&quot;footer.html&quot; --&gt;</span><br></pre></td></tr></table></figure>

<p>静态文件直接引用</p>
<p><strong>include virtual</strong></p>
<p>可以指向location，而不一定是具体文件</p>
<p><strong>inclue wait</strong></p>
<p>阻塞请求</p>
<p><strong>include set</strong></p>
<p>在virtual基础上设置变量</p>
<p><strong>set</strong></p>
<p>设置临时变量</p>
<p><strong>block</strong></p>
<p>可以声明一个ssi的命令块，里面可以包裹其他命令</p>
<p><strong>config errmsg</strong></p>
<p>在模板中配置报错情况</p>
<p><strong>config timefmt</strong></p>
<p>日期格式化</p>
<p><strong>echo</strong></p>
<p>直接输出变量</p>
<ul>
<li>var变量名称</li>
<li>encoding 是否使用特殊编码格式</li>
<li>default 变量没有值的时候使用默认值</li>
</ul>
<p><strong>if</strong></p>
<p>逻辑判断</p>
<h5 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h5><ul>
<li>nginx.conf中配置</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">ssi</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">concat</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">concat_max_files</span> <span class="number">30</span>;</span><br><span class="line">        </span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<ul>
<li>添加两个测试页面</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"># top.html</span><br><span class="line"><span class="tag">&lt;<span class="name">P</span>&gt;</span>top.....<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"># bottom.html</span><br><span class="line"><span class="tag">&lt;<span class="name">P</span>&gt;</span>bottom.....<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>index.html文件中添加</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--# include file=&quot;top.html&quot; --&gt;</span></span><br><span class="line">......</span><br><span class="line"><span class="comment">&lt;!--# include file=&quot;bottom.html&quot; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<ul>
<li>无需重启。直接访问——<a target="_blank" rel="noopener" href="http://www.hylshyflying.com/">http://www.hylshyflying.com/</a></li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732424.png" alt="image-20221004163931934"></p>
<h4 id="rsync集群文件同步"><a href="#rsync集群文件同步" class="headerlink" title="rsync集群文件同步"></a>rsync集群文件同步</h4><p>主页——<a target="_blank" rel="noopener" href="https://www.samba.org/ftp/rsync/rsync.html">https://www.samba.org/ftp/rsync/rsync.html</a></p>
<h5 id="介绍-4"><a href="#介绍-4" class="headerlink" title="介绍"></a>介绍</h5><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wq1205750492/article/details/124497271">(61条消息) rsync详解_simple11618的博客-CSDN博客_rsync</a></p>
<h6 id="rsync是什么"><a href="#rsync是什么" class="headerlink" title="rsync是什么"></a>rsync是什么</h6><p>remote synchronize是一个远程数据同步工具，可通过 LAN&#x2F;WAN 快速同步多台主机之间的文件。也可以使用 rsync 同步本地硬盘中的不同目录。<br>rsync 是用于替代 rcp 的一个工具，rsync 使用所谓的 rsync算法 进行数据同步，这种算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。除此之外，rsync可拷贝、显示目录属性，以及拷贝文件，并可选择性的压缩以及递归拷贝。</p>
<h6 id="rsync的工作原理"><a href="#rsync的工作原理" class="headerlink" title="rsync的工作原理"></a>rsync的工作原理</h6><p>a、客户端构造FileList，FileList包含了需要与服务器同步的所有文件信息对name-&gt;id<br>（id用来唯一表示文件例如MD5）</p>
<p>b、客户端将FileList发送到服务器。</p>
<p>c、服务器上rsync处理客户端发过来的FileList，构建新的NewFileList。<br> 其中根据MD5值比较，删除服务器上已经存在的文件信息对，只保留服务器上不存在或变化的文件。</p>
<p>d、客户端得到服务器发送过来的NewFileList，然后把NewFileList中的文件重新传输到服务器。</p>
<p>rsync 基于inotify 开发</p>
<p>Rsync有三种模式：</p>
<ul>
<li>本地模式（类似于cp命令）</li>
<li>远程模式（类似于scp命令）</li>
<li>守护进程（socket进程：是rsync的重要功能）</li>
</ul>
<h5 id="rsync-常用选项"><a href="#rsync-常用选项" class="headerlink" title="rsync 常用选项"></a>rsync 常用选项</h5><table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-a</td>
<td align="left">包含-rtplgoD</td>
</tr>
<tr>
<td align="left">-r</td>
<td align="left">同步目录时要加上，类似cp时的-r选项</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">同步时显示一些信息，让我们知道同步的过程</td>
</tr>
<tr>
<td align="left">-l</td>
<td align="left">保留软连接</td>
</tr>
<tr>
<td align="left">-L</td>
<td align="left">加上该选项后，同步软链接时会把源文件给同步</td>
</tr>
<tr>
<td align="left">-p</td>
<td align="left">保持文件的权限属性</td>
</tr>
<tr>
<td align="left">-o</td>
<td align="left">保持文件的属主</td>
</tr>
<tr>
<td align="left">-g</td>
<td align="left">保持文件的属组</td>
</tr>
<tr>
<td align="left">-D</td>
<td align="left">保持设备文件信息</td>
</tr>
<tr>
<td align="left">-t</td>
<td align="left">保持文件的时间属性</td>
</tr>
<tr>
<td align="left">–delete</td>
<td align="left">删除DEST中SRC没有的文件</td>
</tr>
<tr>
<td align="left">–exclude</td>
<td align="left">过滤指定文件，如–exclude “logs”会把文件名包含logs的文件或者目录过滤掉，不同步</td>
</tr>
<tr>
<td align="left">-P</td>
<td align="left">显示同步过程，比如速率，比-v更加详细</td>
</tr>
<tr>
<td align="left">-u</td>
<td align="left">加上该选项后，如果DEST中的文件比SRC新，则不同步</td>
</tr>
<tr>
<td align="left">-z</td>
<td align="left">传输时压缩</td>
</tr>
</tbody></table>
<h5 id="rsync认证方式"><a href="#rsync认证方式" class="headerlink" title="rsync认证方式"></a>rsync认证方式</h5><blockquote>
<p>rsync有两种常用的认证方式，一种是rsync-daemon方式，另外一种是ssh方式。</p>
<p>在平时使用过程，我们使用最多的是rsync-daemon方式。</p>
<p><strong>注意：在使用rsync时，服务器和客户端都必须安装rsync程序</strong>。</p>
</blockquote>
<h6 id="rsync-daemon-认证"><a href="#rsync-daemon-认证" class="headerlink" title="rsync-daemon 认证"></a><strong>rsync-daemon 认证</strong></h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rsync在rsync-daemon认证方式下，默认监听TCP的873端口。</span><br><span class="line"></span><br><span class="line">rsync-daemon认证方式是rsync的主要认证方式，这个也是我们经常使用的认证方式。</span><br><span class="line">并且也只有在此种模式下，rsync才可以把密码写入到一个文件中。</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">	rsync-daemon认证方式，需要服务器和客户端都安装rsync服务</span><br><span class="line">	并且只需要rsync服务器端启动rsync，同时配置rsync配置文件。</span><br><span class="line">	客户端启动不启动rsync服务，都不影响同步的正常进行。</span><br></pre></td></tr></table></figure>

<h6 id="ssh认证"><a href="#ssh认证" class="headerlink" title="ssh认证"></a><strong>ssh认证</strong></h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rsync在ssh认证方式下，可通过系统用户进行认证，即在rsync上通过ssh隧道进行传输，类似于scp工具。</span><br><span class="line">此时同步操作不在局限于rsync中定义的同步文件夹。</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">	ssh认证方式，不需要服务器和客户端配置rsync配置文件</span><br><span class="line">	只需要双方都安装rsync服务，并且也不需要双方启动rsync。</span><br><span class="line">	</span><br><span class="line"># 若rsync服务端SSH为标准端口，此时rsync使用方式如下：</span><br><span class="line">	rsync -avz /root/test root@10.10.10.10:/root/</span><br><span class="line"># 若rsync服务端SSH为非标准端口，可通过rsync的-e参数进行端口指定。使用方式如下：</span><br><span class="line">	rsync -avz /root/test -e &#x27;ssh -p1234&#x27; root@10.10.10.10:/root/</span><br></pre></td></tr></table></figure>

<h4 id="rsync案例"><a href="#rsync案例" class="headerlink" title="rsync案例"></a>rsync案例</h4><h5 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h5><p>两端安装——129源服务器-131目标服务器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y rsync</span><br><span class="line"># 配置文件地址`/etc/rsyncd.conf`</span><br></pre></td></tr></table></figure>

<h5 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a>配置</h5><p>129中<code>/etc/rsyncd.conf</code>添加</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ftp]</span><br><span class="line">    path = /usr/local/nginx/html</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进行启动</span></span><br><span class="line">[root@nginx ~]# rsync --daemon</span><br></pre></td></tr></table></figure>

<h5 id="安全认证"><a href="#安全认证" class="headerlink" title="安全认证"></a>安全认证</h5><h6 id="密码文件"><a href="#密码文件" class="headerlink" title="密码文件"></a>密码文件</h6><p>内容</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &quot;sgg:111&quot; &gt;&gt; /etc/rsyncd.passwd</span><br></pre></td></tr></table></figure>

<p>在129中rsyncd.conf修改配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">auth users = sgg</span><br><span class="line">secrets file = /etc/rsyncd.passwd</span><br></pre></td></tr></table></figure>

<p>需要进行重启</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改权限</span></span><br><span class="line">chmod 600 /etc/rsync.password</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看rsync进程</span> </span><br><span class="line">ps -ef | grep rsync</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">杀死rsync启动进程</span></span><br><span class="line">kill -9 进程号</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">rsync --daemon</span><br></pre></td></tr></table></figure>

<h6 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h6><p>在<code>/etc/rc.local</code>文件中添加</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">rsync --daemon</span><br></pre></td></tr></table></figure>

<h5 id="查看远程目录"><a href="#查看远程目录" class="headerlink" title="查看远程目录"></a>查看远程目录</h5><p>131中进行查看</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> </span></span><br><span class="line">[root@nginx ~]# rsync --list-only 192.168.182.129::ftp/</span><br><span class="line">drwxr-xr-x            259 2022/10/04 16:12:45 .</span><br><span class="line">-rw-r--r--            497 2022/09/17 15:16:26 50x.html</span><br><span class="line">-rw-r--r--     11,965,286 2022/09/23 20:18:44 Discuz_X3.4_SC_UTF8_20220811.zip</span><br><span class="line">-rw-r--r--          8,310 2022/08/11 08:33:14 LICENSE</span><br><span class="line">-rw-r--r--             18 2022/10/04 16:15:42 bottom.html</span><br><span class="line">-rw-r--r--            770 2022/10/04 16:15:42 index.html</span><br><span class="line">-rw-r--r--         26,774 2021/09/22 11:29:22 qqqun.png</span><br><span class="line">-rw-r--r--         71,393 2022/01/31 14:53:22 readme.html</span><br><span class="line">-rw-r--r--             16 2022/10/04 16:13:57 top.html</span><br><span class="line">-rw-r--r--            142 2022/01/29 17:51:02 utility.html</span><br><span class="line">drwxr-xr-x          4,096 2022/08/11 10:21:40 bbs</span><br><span class="line">drwxr-xr-x             57 2022/10/04 15:09:17 css</span><br><span class="line">drwxr-xr-x            102 2022/09/17 21:55:19 fonts</span><br><span class="line">drwxr-xr-x            104 2022/09/17 21:55:18 images</span><br><span class="line">drwxr-xr-x             84 2022/09/17 21:55:19 js</span><br><span class="line">drwxr-xr-x            124 2022/08/11 10:21:22 readme</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定用户</span></span><br><span class="line">[root@nginx ~]# rsync --list-only sgg@192.168.182.129::ftp/</span><br></pre></td></tr></table></figure>

<h5 id="拉取数据到指定目录"><a href="#拉取数据到指定目录" class="headerlink" title="拉取数据到指定目录"></a>拉取数据到指定目录</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同步到指定目录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rsync协议</span></span><br><span class="line">[root@nginx ~]# rsync -avz rsync://192.168.182.129:873/ftp /usr/local/nginx/html/</span><br><span class="line">[root@nginx ~]# rsync -avz 192.168.182.129::ftp/ /usr/local/nginx/html/</span><br><span class="line">receiving incremental file list</span><br><span class="line">./</span><br><span class="line">Discuz_X3.4_SC_UTF8_20220811.zip</span><br><span class="line">LICENSE</span><br><span class="line">bottom.html</span><br><span class="line">index.html</span><br><span class="line">qqqun.png</span><br><span class="line">readme.html</span><br><span class="line">top.html</span><br><span class="line">utility.html</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<h6 id="使用SSH方式"><a href="#使用SSH方式" class="headerlink" title="使用SSH方式"></a>使用SSH方式</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">　将当前目录下文件同步到远端（服务端）</span></span><br><span class="line">rsync -avzP /usr/local/nginx/html/ sgg@192.168.182.129:/ftp/</span><br></pre></td></tr></table></figure>

<h5 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h5><h6 id="客户端免密"><a href="#客户端免密" class="headerlink" title="客户端免密"></a>客户端免密</h6><p>131中客户端</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &quot;sgg:111&quot; &gt;&gt; /etc/rsyncd.passwd</span><br></pre></td></tr></table></figure>

<p>131中rsync.conf中配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">auth users = sgg</span><br><span class="line">secrets file = /etc/rsyncd.passwd</span><br><span class="line">read only = no</span><br><span class="line">[ftp]</span><br><span class="line">    path = /usr/local/nginx/html</span><br></pre></td></tr></table></figure>

<p>重启</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改权限</span></span><br><span class="line">chmod 600 /etc/rsync.password</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看rsync进程</span> </span><br><span class="line">ps -ef | grep rsync</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">杀死rsync启动进程</span></span><br><span class="line">kill -9 进程号</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">rsync --daemon</span><br></pre></td></tr></table></figure>

<p>此时在客户端已经可以配合脚本实现定时同步了</p>
<h6 id="如何实现推送？"><a href="#如何实现推送？" class="headerlink" title="如何实现推送？"></a>如何实现推送？</h6><p>129中客户端只放密码</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &quot;111&quot; &gt;&gt; /etc/rsyncd.passwd.client</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">rsync --list-only --password-file=/etc/rsyncd.passwd.client  sgg@192.168.182.131::ftp/</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">rsync -avz --password-file=/etc/rsyncd.passwd.client /usr/local/nginx/html/ rsync://sgg@192.168.182.131::ftp/</span></span><br></pre></td></tr></table></figure>

<p><code>--delete 删除目标目录比源目录多余文件</code></p>
<h5 id="实时推送"><a href="#实时推送" class="headerlink" title="实时推送"></a>实时推送</h5><h6 id="推送端安装inotify"><a href="#推送端安装inotify" class="headerlink" title="推送端安装inotify"></a>推送端安装inotify</h6><p>依赖</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y automake</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压之后进入目录编译</span></span><br><span class="line">./configure --prefix=/usr/local/inotify</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>监控目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%Y-%m-%d %H:%M:%S&#x27; --format &#x27;%T %w%f %e&#x27; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/</span><br></pre></td></tr></table></figure>

<h6 id="简单自动化脚本"><a href="#简单自动化脚本" class="headerlink" title="简单自动化脚本"></a>简单自动化脚本</h6><p>131中rsync.conf中配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uid = root</span><br><span class="line">gid = root</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx ~]# vi auto.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%d/%m/%y %H:%M&#x27; --format &#x27;%T %w%f %e&#x27; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/ | while read file</span><br><span class="line">do</span><br><span class="line">       </span><br><span class="line">        rsync -az --delete --password-file=/etc/rsyncd.passwd.client /usr/local/nginx/html/ sgg@192.168.182.131::ftp/</span><br><span class="line">done</span><br><span class="line">[root@nginx ~]# chomd 777 auto.sh</span><br><span class="line">[root@nginx ~]# chomd 777 /usr/local/nginx/html/</span><br><span class="line">[root@nginx ~]# ./auto.sh</span><br></pre></td></tr></table></figure>

<h6 id="inotify常用参数"><a href="#inotify常用参数" class="headerlink" title="inotify常用参数"></a>inotify常用参数</h6><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-r</td>
<td>–recursive</td>
<td>#递归查询目录</td>
</tr>
<tr>
<td>-q</td>
<td>–quiet</td>
<td>#打印很少的信息，仅仅打印监控事件信息</td>
</tr>
<tr>
<td>-m</td>
<td>–monitor</td>
<td>#始终保持事件监听状态</td>
</tr>
<tr>
<td>–excludei</td>
<td></td>
<td>#排除文件或目录时，不区分大小写</td>
</tr>
<tr>
<td>–timefmt</td>
<td></td>
<td>#指定事件输出格式</td>
</tr>
<tr>
<td>–format</td>
<td></td>
<td>#打印使用指定的输出类似格式字符串</td>
</tr>
<tr>
<td>-e</td>
<td>–event[ -e|–event … ]accessmodifyattribcloseopenmove_tomove createdeleteumount</td>
<td>#通过此参数可以指定要监控的事件 #文件或目录被读取#文件或目录的内容被修改#文件或目录属性被改变#文件或目录封闭，无论读&#x2F;写模式#文件或目录被打开#文件或目录被移动至另外一个目录#文件或目录被移动另一个目录或从另一个目录移动至当前目录#文件或目录被创建在当前目录#文件或目录被删除#文件系统被卸载</td>
</tr>
</tbody></table>
<h3 id="多级缓存"><a href="#多级缓存" class="headerlink" title="多级缓存"></a>多级缓存</h3><p>缓存（cache），原始意义是指访问速度比一般随机存取存储器（RAM）快的一种高速存储器，通常它不像系统主存那样使用 DRAM 技术，而使用昂贵但较快速的 SRAM 技术。缓存的设置是所有现代计算机系统发挥高性能的重要因素之一。</p>
<p>Web 缓存是指一个 Web 资源（如 html 页面，图片，js，数据等）存在于 Web 服务器和客户端（浏览器）之间的副本。缓存会根据进来的请求保存输出内容的副本；当下一个请求来到的时候，如果是相同的 URL，缓存会根据缓存机制决定是直接使用副本响应访问请求，还是向源服务器再次发送请求。比较常见的就是浏览器会缓存访问过网站的网页，当再次访问这个 URL 地址的时候，如果网页没有更新，就不会再次下载网页，而是直接使用本地缓存的网页。只有当网站明确标识资源已经更新，浏览器才会再次下载网页。<br>  Web 缓存分为<code>客户端缓存</code>和<code>服务端缓存</code>，客户端缓存就是<code>浏览器缓存</code>，而服务器缓存就是常见的<code>Nginx、Redis、Memcached</code>等。</p>
<h4 id="静态资源缓存"><a href="#静态资源缓存" class="headerlink" title="静态资源缓存"></a>静态资源缓存</h4><h4 id="浏览器缓存"><a href="#浏览器缓存" class="headerlink" title="浏览器缓存"></a>浏览器缓存</h4><p>浏览器缓存是为了节约网络的资源加速浏览，浏览器在用户磁盘上对最近请求过的文档进行存储，当访问者再次请求这个页面时，浏览器就可以从本地磁盘显示文档，这样就可以加速页面的阅览。</p>
<h5 id="浏览器缓存的执行流程"><a href="#浏览器缓存的执行流程" class="headerlink" title="浏览器缓存的执行流程"></a>浏览器缓存的执行流程</h5><p>先看一下 HTTP 协议中和页面缓存相关的字段：</p>
<table>
<thead>
<tr>
<th>header</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Expires</td>
<td>缓存过期的日期和时间</td>
</tr>
<tr>
<td>Cache-Control</td>
<td>设置和缓存相关的配置信息</td>
</tr>
<tr>
<td>Last-Modified</td>
<td>请求资源最后修改时间</td>
</tr>
<tr>
<td>ETag</td>
<td>请求变量的实体标签的当前值，比如文件的MD5值</td>
</tr>
</tbody></table>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732957.png" alt="在这里插入图片描述"></p>
<ol>
<li>用户首次通过浏览器发送请求到服务端获取数据，客户端是没有对应的缓存，所以需要发送 request 请求来获取数据；</li>
<li>服务端接收到请求后，获取服务端的数据及服务端缓存的允许后，返回 200 的成功状态码并且在响应头上附上对应资源以及缓存信息；</li>
<li>当用户再次访问相同资源的时候，客户端会在浏览器的缓存目录中查找是否存在响应的缓存文件；</li>
<li>如果没有找到对应的缓存文件，则走第二步；</li>
<li>如果有缓存文件，接下来对缓存文件是否过期进行判断，过期的判断标准是 Expires；</li>
<li>如果没有过期，则直接从本地缓存中返回数据进行展示；</li>
<li>如果 Expires 过期，接下来需要判断缓存文件是否发生过变化；</li>
<li>判断的标准有两个，一个是 <code>ETag（Entity Tag）</code>，一个是<code> Last-Modified</code>；</li>
<li>判断结果是未发生变化，则服务端返回 304，直接从缓存文件中获取数据；</li>
<li>如果判断是发生了变化，重新从服务端获取数据，并根据缓存协商（服务端所设置的是否需要进行缓存数据的设置）来进行数据缓存。</li>
</ol>
<h5 id="什么时候可以用缓存？"><a href="#什么时候可以用缓存？" class="headerlink" title="什么时候可以用缓存？"></a>什么时候可以用缓存？</h5><ol>
<li>不常改变的内容</li>
<li>过期时间</li>
<li>针对post&#x2F;get请求都可以</li>
<li>存储位置</li>
<li>磁盘使用空间限制</li>
</ol>
<h5 id="观察京东缓存及加载速度"><a href="#观察京东缓存及加载速度" class="headerlink" title="观察京东缓存及加载速度"></a>观察京东缓存及加载速度</h5><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732717.png" alt="image-20221005141309519"></p>
<ul>
<li>diskcache</li>
</ul>
<p>字面理解是从内存中，其实也是字面的含义，这个资源是直接从内存中拿到的，<strong>不会请求服务器</strong>一般已经加载过该资源且缓存在了内存当中，当关闭该页面时，此资源就被内存释放掉了，再次重新打开相同页面时不会出现from memory cache的情况</p>
<ul>
<li>memorycache</li>
</ul>
<p>是从磁盘当中取出的，也是在已经在之前的某个时间加载过该资源，<strong>不会请求服务器</strong>但是此资源不会随着该页面的关闭而释放掉，因为是存在硬盘当中的，下次打开仍会from disk cache</p>
<h5 id="Nginx默认缓存"><a href="#Nginx默认缓存" class="headerlink" title="Nginx默认缓存"></a>Nginx默认缓存</h5><p>Nginx版本不同会默认配置</p>
<h5 id="强制缓存与协商缓存"><a href="#强制缓存与协商缓存" class="headerlink" title="强制缓存与协商缓存"></a>强制缓存与协商缓存</h5><p>强制缓存：直接从本机读取，不请求服务器</p>
<p>协商缓存：发送请求header中携带Last-Modified，服务器可能会返回304 Not Modified</p>
<h6 id="浏览器强制缓存"><a href="#浏览器强制缓存" class="headerlink" title="浏览器强制缓存"></a>浏览器强制缓存</h6><p>expires： 该指令用来控制页面缓存的作用。可以通过该指令控制 HTTP 应答中的 “<code>Expires</code>” 和 “<code>Cache-Control</code>”。</p>
<p><strong>add_header</strong>： 该指令是用来添加指定的响应头和响应值。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>add_header name value [always]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>-</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location…</td>
</tr>
</tbody></table>
<p><strong>cache-control</strong></p>
<p>http1.1的规范，使用max-age表示文件可以在浏览器中缓存的时间以秒为单位</p>
<table>
<thead>
<tr>
<th>标记</th>
<th>类型</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>public</td>
<td>响应头</td>
<td>响应的数据可以被缓存，客户端和代理层都可以缓存</td>
</tr>
<tr>
<td>private</td>
<td>响应头</td>
<td>可私有缓存，客户端可以缓存，代理层不能缓存（CDN，proxy_pass）</td>
</tr>
<tr>
<td>no-cache</td>
<td>请求头</td>
<td>可以使用本地缓存，但是必须发送请求到服务器回源验证</td>
</tr>
<tr>
<td>no-store</td>
<td>请求和响应</td>
<td>应禁用缓存</td>
</tr>
<tr>
<td>max-age</td>
<td>请求和响应</td>
<td>文件可以在浏览器中缓存的时间以秒为单位</td>
</tr>
<tr>
<td>s-maxage</td>
<td>请求和响应</td>
<td>用户代理层缓存，CDN下发，当客户端数据过期时会重新校验</td>
</tr>
<tr>
<td>max-stale</td>
<td>请求和响应</td>
<td>缓存最大使用时间，如果缓存过期，但还在这个时间范围内则可以使用缓存数据</td>
</tr>
<tr>
<td>min-fresh</td>
<td>请求和响应</td>
<td>缓存最小使用时间，</td>
</tr>
<tr>
<td>must-revalidate</td>
<td>请求和响应</td>
<td>当缓存过期后，必须回源重新请求资源。比no-cache更严格。因为HTTP 规范是允许客户端在某些特殊情况下直接使用过期缓存的，比如校验请求发送失败的时候。那么带有must-revalidate的缓存必须校验，其他条件全部失效。</td>
</tr>
<tr>
<td>proxy-revalidate</td>
<td>请求和响应</td>
<td>和must-revalidate类似，只对CDN这种代理服务器有效，客户端遇到此头，需要回源验证</td>
</tr>
<tr>
<td>stale-while-revalidate</td>
<td>响应</td>
<td>表示在指定时间内可以先使用本地缓存，后台进行异步校验</td>
</tr>
<tr>
<td>stale-if-error</td>
<td>响应</td>
<td>在指定时间内，重新验证时返回状态码为5XX的时候，可以用本地缓存</td>
</tr>
<tr>
<td>only-if-cached</td>
<td>响应</td>
<td>那么只使用缓存内容，如果没有缓存 则504 getway timeout</td>
</tr>
</tbody></table>
<p>在浏览器和服务器端验证文件是否过期的时候，浏览器在二次请求的时候会携带IF-Modified-Since属性</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732838.png" alt="image-20221005141909038"></p>
<p><strong>Expires</strong></p>
<p>expires： 该指令用来控制页面缓存的作用。可以通过该指令控制 HTTP 应答中的 “Expires” 和 “Cache-Control”。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>expires [modified] time&#x2F;expires epoch|max|off</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>expires off</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<ul>
<li>time：可以整数也可以是负数，指定过期时间，如果是负数，CacheControl 则为 no-cache，如果为整数或 0，则 Cache-Control 的值为 maxage&#x3D;time；</li>
<li>epoch：指定 Expires 的值为’1 January,1970,00:00:01 GMT’（1970-01-01 00:00:00），Cache-Control 的值 no-cache；</li>
<li>max：指定 Expires 的值为’31 December2037 23:59:59GMT’（2037-12-31 23:59:59），Cache-Control 的值为 10 年；</li>
<li>off：默认不缓存。</li>
</ul>
<p>过期时间</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">expires 30s;   #缓存30秒</span><br><span class="line">expires 30m;  #缓存30分钟   </span><br><span class="line">expires 2h;     #缓存2小时</span><br><span class="line">expires 30d;    #缓存30天      </span><br></pre></td></tr></table></figure>

<p><strong>案例：</strong></p>
<p>首次访问就从缓存中获取</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">expires</span> <span class="number">30s</span>;</span><br><span class="line">            <span class="attribute">add_header</span> cache-control <span class="string">&quot;max-age:300&quot;</span>; </span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732921.png" alt="image-20221005150052309"></p>
<h6 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h6><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732604.png" alt="image-20221005142824509"></p>
<p><strong>last-modified</strong></p>
<p><strong>etag</strong></p>
<p>http1.1支持</p>
<p>在HTTP协议中If-Modified-Since和If-None-Match分别对应Last-Modified和ETag</p>
<p>Entity Tag 的缩写，中文译过来就是实体标签的意思.</p>
<p>HTTP中并没有指定如何生成ETag，哈希是比较理想的选择。</p>
<p>在计算Etag的时候，会产生CPU的耗费，所以也可以用时间戳，但这样直接使用Last-Modified即可。</p>
<p>ETag 用来校验用户请求的资源是否有变化，作用和lastmodified很像，区别是lastmodified精确到秒，ETag可以用hash算法来生成更精确的比对内容。</p>
<p><strong>当用户首次请求资源的时候返回给用户数据和200状态码并生成ETag，再次请求的时候服务器比对ETag，没有发生变化的话返回304;</strong></p>
<p>Cache-Control直接是通过不请求来实现，而ETag是会发请求的，只不过服务器根据请求的东西的内容有无变化来判断是否返回请求的资源;</p>
<h6 id="强制关闭协商缓存的方式"><a href="#强制关闭协商缓存的方式" class="headerlink" title="强制关闭协商缓存的方式"></a>强制关闭协商缓存的方式</h6><p>在129中nginx.conf中配置</p>
<p>- </p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">etag</span> <span class="literal">off</span>;</span><br><span class="line">    		<span class="comment"># 不进行返回</span></span><br><span class="line">            <span class="attribute">add_header</span> Last-Modified <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732769.png" alt="image-20221005144038022"></p>
<p>- </p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">etag</span> <span class="literal">off</span>;</span><br><span class="line">    		<span class="comment"># 返回但不进行判断</span></span><br><span class="line">            <span class="attribute">if_modified_since</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="comment">#add_header Last-Modified &quot;&quot;;</span></span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732739.png" alt="image-20221005144249285"></p>
<h6 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h6><p><strong>cache-control expires 强制缓存</strong></p>
<p>页面首次打开，直接读取缓存数据，刷新，会向服务器发起请求</p>
<p><strong>etag lastmodify  协商缓存</strong></p>
<p>首次访问之后，每次请求，没发生变化 返回304 不发送数据，读取缓存数据</p>
<h5 id="last-modified-与ssi的冲突"><a href="#last-modified-与ssi的冲突" class="headerlink" title="last-modified 与ssi的冲突"></a>last-modified 与ssi的冲突</h5><h5 id="浏览器缓存原则"><a href="#浏览器缓存原则" class="headerlink" title="浏览器缓存原则"></a>浏览器缓存原则</h5><ul>
<li><p>多级集群负载时<code>last-modified</code>必须保持一致</p>
</li>
<li><p>还有一些场景下我们希望禁用浏览器缓存。比如轮训api上报数据数据</p>
</li>
<li><p>浏览器缓存很难彻底禁用，大家的做法是加版本号，随机数等方法。</p>
</li>
<li><p>只缓存200响应头的数据，像3XX这类跳转的页面不需要缓存。</p>
</li>
<li><p>对于js，css这类可以缓存很久的数据，可以通过加版本号的方式更新内容</p>
</li>
<li><p>不需要强一致性的数据，可以缓存几秒</p>
</li>
<li><p>异步加载的接口数据，可以使用ETag来校验。</p>
</li>
<li><p>在服务器添加Server头，有利于排查错误</p>
</li>
<li><p>分为手机APP和Client以及是否遵循http协议</p>
</li>
<li><p>在没有联网的状态下可以展示数据</p>
</li>
<li><p>流量消耗过多</p>
</li>
<li><p>提前下发  避免秒杀时同时下发数据造成流量短时间暴增</p>
</li>
<li><p>兜底数据 在服务器崩溃和网络不可用的时候展示</p>
</li>
<li><p>临时缓存  退出即清理</p>
</li>
<li><p>固定缓存  展示框架这种，可能很长时间不会更新，可用随客户端下发</p>
<ul>
<li>首页有的时候可以看做是框架 应该禁用缓存，以保证加载的资源都是最新的</li>
</ul>
</li>
<li><p>父子连接 页面跳转时有一部分内容不需要重新加载，可用从父菜单带过来</p>
</li>
<li><p>预加载     某些逻辑可用判定用户接下来的操作，那么可用异步加载那些资源</p>
</li>
<li><p>漂亮的加载过程 异步加载 先展示框架，然后异步加载内容，避免主线程阻塞</p>
</li>
</ul>
<h4 id="CDN缓存"><a href="#CDN缓存" class="headerlink" title="CDN缓存"></a>CDN缓存</h4><h5 id="GEOip"><a href="#GEOip" class="headerlink" title="GEOip"></a>GEOip</h5><p>GeoIP即为IP地理位置数据库，可以根据IP获得地理位置信息。</p>
<h6 id="下载数据库"><a href="#下载数据库" class="headerlink" title="下载数据库"></a>下载数据库</h6><p>官网需注册登录</p>
<p>下载数据库</p>
<p><a target="_blank" rel="noopener" href="https://www.maxmind.com/en/home">https://www.maxmind.com/en/home</a></p>
<h6 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h6><p>官方git</p>
<p><a target="_blank" rel="noopener" href="https://github.com/maxmind/libmaxminddb">https://github.com/maxmind/libmaxminddb</a></p>
<p>下载后执行编译安装之后</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ echo /usr/local/lib  &gt;&gt; /etc/ld.so.conf.d/local.conf </span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<h6 id="Nginx模块"><a href="#Nginx模块" class="headerlink" title="Nginx模块"></a>Nginx模块</h6><p><a target="_blank" rel="noopener" href="https://github.com/leev/ngx_http_geoip2_module">https://github.com/leev/ngx_http_geoip2_module</a></p>
<p>更完整的配置可参考官方文档</p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_geoip_module.html#geoip_proxy">http://nginx.org/en/docs/http/ngx_http_geoip_module.html#geoip_proxy</a></p>
<h6 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">    geoip2 /root/GeoLite2-ASN_20220524/GeoLite2-ASN.mmdb &#123;</span><br><span class="line">$geoip2_country_code country iso_code;</span><br><span class="line">    &#125;</span><br><span class="line">add_header country $geoip2_country_code;</span><br></pre></td></tr></table></figure>

<h4 id="正向代理与反向代理缓存"><a href="#正向代理与反向代理缓存" class="headerlink" title="正向代理与反向代理缓存"></a>正向代理与反向代理缓存</h4><h5 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h5><h6 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h6><p>正向代理是一个位于客户端和目标服务器之间的代理服务器（中间服务器）。为了从目标服务器取得内容，客户端向代理服务器发送一个请求，并且指定目标服务器，之后代理向目标服务器转发请求，将获得的内容返回给客户端。正向代理的情况下，客户端必须要进行一些特殊的设置才能使用。</p>
<h6 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h6><ul>
<li>正向代理需要主动设置代理服务器ip或者域名进行访问，由设置的服务器ip或者域名去访问内容并返回</li>
<li>正向代理是代理客户端，为客户端收发请求，使真实客户端对服务器不可见。</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732714.png" alt="在这里插入图片描述"></p>
<h6 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h6><ul>
<li><strong>突破访问显示</strong>：通过代理服务器，可以突破自身ip访问限制，访问国外网站等</li>
<li><strong>提高访问速度</strong>：通常代理服务器都设置一个较大的硬盘缓冲区，会将部分请求的响应保存到缓冲区中，当其他用户再访问相同的信息时，则直接由缓冲区中取出信息，传给用户，以提高访问速度</li>
<li><strong>隐藏客户端真实ip</strong>：上网者可以通过正向代理的方法隐藏自己的ip，免受攻击</li>
</ul>
<h6 id="正向代理配置"><a href="#正向代理配置" class="headerlink" title="正向代理配置"></a>正向代理配置</h6><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line">      <span class="section">location</span> / &#123;</span><br><span class="line">          <span class="attribute">proxy_pass</span> <span class="variable">$scheme</span>://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">          <span class="attribute">root</span>   html;</span><br><span class="line">          <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h6 id="代理https请求"><a href="#代理https请求" class="headerlink" title="代理https请求"></a>代理https请求</h6><p>需要第三方模块</p>
<p><a target="_blank" rel="noopener" href="https://github.com/chobits/ngx_http_proxy_connect_module">https://github.com/chobits/ngx_http_proxy_connect_module</a></p>
<p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen                         3128;</span><br><span class="line"></span><br><span class="line">    # dns resolver used by forward proxying</span><br><span class="line">    resolver                       8.8.8.8;</span><br><span class="line"></span><br><span class="line">    # forward proxy for CONNECT request</span><br><span class="line">    proxy_connect;</span><br><span class="line">    proxy_connect_allow            443 563;</span><br><span class="line">    proxy_connect_connect_timeout  10s;</span><br><span class="line">    proxy_connect_read_timeout     10s;</span><br><span class="line">    proxy_connect_send_timeout     10s;</span><br><span class="line"></span><br><span class="line">    # forward proxy for non-CONNECT request</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://$host;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="反向代理-1"><a href="#反向代理-1" class="headerlink" title="反向代理"></a>反向代理</h5><h6 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h6><p>反向代理是指以代理服务器来接收客户端的请求，然后将请求转发给内部网络上的服务器，将从服务器上得到的结果返回给客户端，此时代理服务器对外表现为一个反向代理服务器。</p>
<p>对于客户端来说，反向代理就相当于目标服务器，只需要将反向代理当作目标服务器一样发送请求就可以了，并且客户端不需要进行任何设置。</p>
<h6 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h6><ul>
<li>正向代理需要配置代理服务器，而反向代理不需要做任何设置。</li>
<li>反向代理是代理服务器，为服务器收发请求，使真实服务器对客户端不可见。</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141732402.png" alt="在这里插入图片描述"></p>
<h6 id="用途-1"><a href="#用途-1" class="headerlink" title="用途"></a>用途</h6><ul>
<li><strong>隐藏服务器真实ip</strong>：使用反向代理，可以对客户端隐藏服务器的ip地址</li>
<li><strong>负载均衡</strong>：反向代理服务器可以做负载均衡，根据所有真实服务器的负载情况，将客户端请求分发到不同的真实服务器上</li>
<li><strong>提高访问速度</strong>：反向代理服务器可以对静态内容及短时间内有大量访问请求的动态内容提供缓存服务，提高访问速度</li>
<li><strong>提供安全保障</strong>：反向代理服务器可以作为应用层防火墙，为网站提供对基于web的攻击行为（例如DoS&#x2F;DDoS）的防护，更容易排查恶意软件等。还可以为后端服务器统一提供加密和SSL加速（如SSL终端代理），提供HTTP访问认证等。</li>
</ul>
<h5 id="反向代理-proxy缓存"><a href="#反向代理-proxy缓存" class="headerlink" title="反向代理-proxy缓存"></a>反向代理-proxy缓存</h5><p>官网解释</p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache</a></p>
<h6 id="配置-5"><a href="#配置-5" class="headerlink" title="配置"></a>配置</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http模块：</span><br><span class="line">proxy_cache_path /ngx_tmp levels=1:2 keys_zone=test_cache:100m inactive=1d max_size=10g ;</span><br><span class="line">location模块：</span><br><span class="line">add_header  Nginx-Cache &quot;$upstream_cache_status&quot;;</span><br><span class="line">proxy_cache test_cache;</span><br><span class="line">proxy_cache_valid 168h;</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_filter_module.so&quot;;</span></span><br><span class="line"><span class="comment">#load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_static_module.so&quot;;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">     <span class="attribute">keepalive_timeout</span>  <span class="number">65</span> <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">send_timeout</span> <span class="number">60</span>;</span><br><span class="line">    <span class="attribute">keepalive_requests</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> httpds&#123;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">192.168.182.132:8080</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">proxy_cache_path</span> /ngx_tmp levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=test_cache:<span class="number">100m</span> inactive=<span class="number">1d</span> max_size=<span class="number">10g</span> ;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.hylshyflying.com hylshyflying.com;</span><br><span class="line">        </span><br><span class="line">        <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://httpds;</span><br><span class="line">            <span class="attribute">add_header</span>  Nginx-Cache <span class="string">&quot;<span class="variable">$upstream_cache_status</span>&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_cache</span> test_cache;</span><br><span class="line">            <span class="attribute">proxy_cache_valid</span> <span class="number">1h</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<ul>
<li>第一次访问</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733411.png" alt="image-20221005164629217"></p>
<ul>
<li>再次访问</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733564.png" alt="image-20221005164700516"></p>
<p>缓存保存的目录</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733480.png" alt="image-20221005164736675"></p>
<h6 id="proxy-cache配置详解"><a href="#proxy-cache配置详解" class="headerlink" title="proxy_cache配置详解"></a>proxy_cache配置详解</h6><p><strong>proxy_cache_use_stale</strong> </p>
<p>默认off</p>
<p>在什么时候可以使用过期缓存</p>
<p>可选<code>error</code> | <code>timeout</code> | <code>invalid_header</code> | <code>updating</code> | <code>http_500</code> | <code>http_502</code> | <code>http_503</code> | <code>http_504</code> | <code>http_403</code> | <code>http_404</code> | <code>http_429</code> | <code>off</code></p>
<p><strong>proxy_cache_background_update</strong> </p>
<p>默认off</p>
<p>运行开启子请求更新过期的内容。同时会把过期的内容返回给客户端</p>
<p><strong>proxy_no_cache</strong>  <strong>proxy_cache_bypass</strong> </p>
<p>指定什么时候不使用缓存而直接请求上游服务器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">proxy_no_cache $cookie_nocache $arg_nocache$arg_comment;</span><br><span class="line">proxy_no_cache $http_pragma    $http_authorization;</span><br></pre></td></tr></table></figure>

<p>如果这些变量如果存在的话不为空或者不等于0，则不使用缓存</p>
<p><strong>proxy_cache_convert_head</strong> </p>
<p>默认 on</p>
<p>是否把head请求转换成get请求后再发送给上游服务器 以便缓存body里的内容</p>
<p>如果关闭 需要在 <code>cache key</code> 中添加 $request_method 以便区分缓存内容</p>
<p><strong>proxy_cache_lock</strong> </p>
<p>默认off</p>
<p>缓存更新锁</p>
<p><strong>proxy_cache_lock_age</strong> </p>
<p>默认5s</p>
<p>缓存锁超时时间</p>
<h6 id="断点续传缓存-range"><a href="#断点续传缓存-range" class="headerlink" title="断点续传缓存 range"></a>断点续传缓存 range</h6><p>当有完整的content-length之后即可断点续传</p>
<p>在反向代理服务器中需向后传递header</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">proxy_set_header Range $http_range;</span><br></pre></td></tr></table></figure>

<p>proxy_cache_key中增加range</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733978.png" alt="image-20221005171742804"></p>
<p><strong>配置详解</strong></p>
<p><strong>proxy_cache_max_range_offset</strong> </p>
<p>range最大值，超过之后不做缓存，默认情况下 不需要对单文件较大的资源做缓存</p>
<p><strong>proxy_cache_methods</strong> </p>
<p>默认 head get</p>
<p><strong>proxy_cache_min_uses</strong> </p>
<p>默认1</p>
<p>被请求多少次之后才做缓存</p>
<p><strong>proxy_cache_path</strong> </p>
<p>path 指定存储目录</p>
<p>以cache_key取md5值</p>
<ul>
<li><strong>levels&#x3D;1:2</strong></li>
</ul>
<p>目录层级数及目录名称位数</p>
<p>取mdb5后几位</p>
<p>TMPFS</p>
<ul>
<li><strong>use_temp_path</strong></li>
</ul>
<p>默认创建缓存文件时，先向缓冲区创建临时文件，再移动到缓存目录</p>
<p>是否使用缓冲区</p>
<ul>
<li><strong>inactive</strong></li>
</ul>
<p>指定时间内未被访问过的缓存将被删除</p>
<h6 id="缓存清理"><a href="#缓存清理" class="headerlink" title="缓存清理"></a>缓存清理</h6><p><strong>purger</strong></p>
<p>需要第三方模块支持</p>
<p><a target="_blank" rel="noopener" href="https://github.com/FRiCKLE/ngx_cache_purge">https://github.com/FRiCKLE/ngx_cache_purge</a></p>
<p>配置</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /purge(/.*)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_cache_purge</span>  test_cache  <span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://httpds;</span><br><span class="line">    <span class="attribute">add_header</span>  Nginx-Cache <span class="string">&quot;<span class="variable">$upstream_cache_status</span>&quot;</span>;</span><br><span class="line">    <span class="attribute">proxy_cache</span> test_cache;</span><br><span class="line">    <span class="attribute">proxy_cache_valid</span> <span class="number">1h</span>;</span><br><span class="line">    <span class="comment">#自定义cachekey</span></span><br><span class="line"> 	<span class="attribute">proxy_cache_key</span> <span class="variable">$uri</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">root</span>   html;</span><br><span class="line">    <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong>——<a target="_blank" rel="noopener" href="http://192.168.182.129/purge">http://192.168.182.129/purge</a> 访问之后会清除缓存</p>
<p><strong>配置解读</strong></p>
<p><strong>proxy_cache_key</strong> </p>
<p>默认<code>$scheme$proxy_host$request_uri</code></p>
<p>缓存的key</p>
<p><strong>proxy_cache_revalidate</strong> </p>
<p>如果缓存过期了，向上游服务器发送“If-Modified-Since” and “If-None-Match来验证是否改变，如果没有就不需要重新下载资源了</p>
<p><strong>proxy_cache_valid</strong> </p>
<p>可以针对不容http状态码设置缓存过期时间</p>
<p>不设置状态码会默认200, 301, 302</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">proxy_cache_valid 200 302 10m;</span><br><span class="line">proxy_cache_valid 301      1h;</span><br><span class="line">proxy_cache_valid any      1m;</span><br></pre></td></tr></table></figure>

<p>any指其他任意状态码</p>
<h2 id="第二部分-高效"><a href="#第二部分-高效" class="headerlink" title="第二部分 高效"></a>第二部分 高效</h2><h3 id="Nginx内存缓存"><a href="#Nginx内存缓存" class="headerlink" title="Nginx内存缓存"></a>Nginx内存缓存</h3><h4 id="缓存文件元数据信息提高sendfile性能"><a href="#缓存文件元数据信息提高sendfile性能" class="headerlink" title="缓存文件元数据信息提高sendfile性能"></a>缓存文件元数据信息提高sendfile性能</h4><h6 id="Strace内核执行过程追踪神器"><a href="#Strace内核执行过程追踪神器" class="headerlink" title="Strace内核执行过程追踪神器"></a>Strace内核执行过程追踪神器</h6><p>一般应用为静态文件元数据信息缓存</p>
<p>sendfile执行过程</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx ~]# yum install -y strace</span><br><span class="line">[root@nginx ~]# ps -ef | grep nginx</span><br><span class="line">root        942      1  0 09:00 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">nobody      943    942  0 09:00 ?        00:00:00 nginx: worker process</span><br><span class="line">nobody      944    942  0 09:00 ?        00:00:00 nginx: cache manager process</span><br><span class="line">root       1310   1267  0 09:58 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line">[root@nginx ~]# strace -p 943</span><br><span class="line">strace: Process 943 attached</span><br></pre></td></tr></table></figure>

<h6 id="nginx发送文件过程"><a href="#nginx发送文件过程" class="headerlink" title="nginx发送文件过程"></a>nginx发送文件过程</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=1904243152, u64=140709327827408&#125;&#125;, &#123;EPOLLIN, &#123;u32=1904242704, u64=140709327826960&#125;&#125;], 512, 25215) = 2</span><br><span class="line">recvfrom(10, &quot;GET / HTTP/1.1\r\nHost: 192.168.44&quot;..., 1024, 0, NULL, NULL) = 475</span><br><span class="line">stat(&quot;/usr/local/nginx//html/index.html&quot;, &#123;st_mode=S_IFREG|0644, st_size=1429, ...&#125;) = 0</span><br><span class="line">open(&quot;/usr/local/nginx//html/index.html&quot;, O_RDONLY|O_NONBLOCK) = 11</span><br><span class="line">fstat(11, &#123;st_mode=S_IFREG|0644, st_size=1429, ...&#125;) = 0</span><br><span class="line">writev(10, [&#123;iov_base=&quot;HTTP/1.1 200 OK\r\nServer: nginx/1&quot;..., iov_len=263&#125;], 1) = 263</span><br><span class="line">sendfile(10, 11, [0] =&gt; [1429], 1429)   = 1429</span><br><span class="line">write(4, &quot;192.168.44.1 - - [27/May/2022:14&quot;..., 193) = 193</span><br><span class="line">close(11) </span><br></pre></td></tr></table></figure>

<h6 id="open-file-cache配置优化"><a href="#open-file-cache配置优化" class="headerlink" title="open_file_cache配置优化"></a><strong>open_file_cache配置优化</strong></h6><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">open_file_cache</span> max=<span class="number">500</span> inactive=<span class="number">60s</span></span><br><span class="line">           open_file_cache_min_uses <span class="number">1</span>; </span><br><span class="line">           <span class="attribute">open_file_cache_valid</span> <span class="number">60s</span>; </span><br><span class="line">           <span class="attribute">open_file_cache_errors</span> <span class="literal">on</span>;</span><br><span class="line">           </span><br><span class="line">           <span class="attribute">root</span>   html;</span><br><span class="line">           <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p><strong>max</strong>缓存最大数量，超过数量后会使用LRU淘汰</p>
<p><strong>inactive</strong> 指定时间内未被访问过的缓存将被删除</p>
<p><strong>pen_file_cache_min_uses</strong></p>
<p>被访问到多少次后会开始缓存</p>
<p><strong>open_file_cache_valid</strong></p>
<p>间隔多长时间去检查文件是否有变化</p>
<p><strong>open_file_cache_errors</strong></p>
<p>对错误信息是否缓存</p>
<h3 id="Nginx外置缓存缓存"><a href="#Nginx外置缓存缓存" class="headerlink" title="Nginx外置缓存缓存"></a>Nginx外置缓存缓存</h3><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_memcached_module.html">http://nginx.org/en/docs/http/ngx_http_memcached_module.html</a></p>
<h4 id="error-page"><a href="#error-page" class="headerlink" title="error_page"></a>error_page</h4><p>指定状态码</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">302</span> http://www.bilibili.com;</span><br><span class="line"></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">200</span> /<span class="number">401</span>.html;</span><br></pre></td></tr></table></figure>

<p>默认指向location</p>
<h4 id="匿名location"><a href="#匿名location" class="headerlink" title="匿名location"></a>匿名location</h4><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">error_page</span>   <span class="number">404</span> = @<span class="number">666</span>;</span><br><span class="line"><span class="section">location</span> @<span class="number">666</span>&#123;</span><br><span class="line">    <span class="attribute">add_header</span> content-type <span class="string">&#x27;text/html&#x27;</span>;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733341.png" alt="image-20221006103701017"></p>
<h4 id="nginx-memcached"><a href="#nginx-memcached" class="headerlink" title="nginx + memcached"></a>nginx + memcached</h4><h5 id="memcached安装"><a href="#memcached安装" class="headerlink" title="memcached安装"></a>memcached安装</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum -y install memcached</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">systemctl start memcached</span><br></pre></td></tr></table></figure>

<p>默认配置文件在</p>
<p><code>/etc/sysconfig/memcached</code></p>
<p>查看状态</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">memcached-tool 127.0.0.1:11211  stats</span><br></pre></td></tr></table></figure>

<p>memcached操作</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y telnet</span><br><span class="line">telnet 127.0.0.1 11211</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# telnet 127.0.0.1 11211</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">set name 0 0 3</span><br><span class="line">123</span><br><span class="line">STORED</span><br><span class="line">get name</span><br><span class="line">VALUE name 0 3</span><br><span class="line">123</span><br><span class="line">END</span><br></pre></td></tr></table></figure>

<h5 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    </span><br><span class="line">   <span class="attribute">server</span> <span class="number">192.168.182.132:8080</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$memcached_key</span> <span class="string">&quot;<span class="variable">$uri</span>?<span class="variable">$args</span>&quot;</span>;</span><br><span class="line">            <span class="attribute">memcached_pass</span> <span class="number">127.0.0.1:11211</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">add_header</span> X-Cache-Satus HIT;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">add_header</span> Content-Type <span class="string">&#x27;text/html; charset=utf-8&#x27;</span>; <span class="comment"># 强制响应数据格式为html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># root   html;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">404</span> = <span class="variable">@fallback</span>;</span><br><span class="line">    <span class="section">location</span> <span class="variable">@fallback</span>&#123;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> memcached_key <span class="variable">$memcached_key</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="nginx-redis"><a href="#nginx-redis" class="headerlink" title="nginx + redis"></a>nginx + redis</h4><h5 id="Redis安装"><a href="#Redis安装" class="headerlink" title="Redis安装"></a>Redis安装</h5><p>7.0下载地址</p>
<p><a target="_blank" rel="noopener" href="https://codeload.github.com/redis/redis/tar.gz/refs/tags/7.0.0">https://codeload.github.com/redis/redis/tar.gz/refs/tags/7.0.0</a></p>
<h5 id="安装依赖-1"><a href="#安装依赖-1" class="headerlink" title="安装依赖"></a>安装依赖</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">依赖</span><br><span class="line">yum install -y tcl-devel</span><br></pre></td></tr></table></figure>

<h5 id="redis2-nginx-module"><a href="#redis2-nginx-module" class="headerlink" title="redis2-nginx-module"></a>redis2-nginx-module</h5><p>redis2-nginx-module是一个支持 Redis 2.0 协议的 Nginx upstream 模块，它可以让 Nginx 以非阻塞方式直接防问远方的 Redis 服务，同时支持 TCP 协议和 Unix Domain Socket 模式，并且可以启用强大的 Redis 连接池功能。</p>
<p><a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/modules/redis2/">https://www.nginx.com/resources/wiki/modules/redis2/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/openresty/redis2-nginx-module">https://github.com/openresty/redis2-nginx-module</a></p>
<p>redis快速安装</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum install -y redis</span><br></pre></td></tr></table></figure>

<p>redis2-nginx-module 安装</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">tar -zxvf redis2-nginx-module-0.15.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译安装</span></span><br><span class="line">./configure --prefix=/usr/local/nginx/ --add-module=/root/redis2-nginx-module-0.15</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="built_in">mv</span> /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old5</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="built_in">cp</span> objs/nginx /usr/local/nginx/sbin/</span></span><br></pre></td></tr></table></figure>

<h6 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h6><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> = /foo &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> auth <span class="number">123123</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">set</span> <span class="variable">$value</span> <span class="string">&#x27;first&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_pass</span> <span class="number">127.0.0.1:6379</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733782.png" alt="image-20221006115701090"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@nginx nginx-1.21.6]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;one&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h6 id="get"><a href="#get" class="headerlink" title="get"></a>get</h6><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"> <span class="section">location</span> = /get &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_pass</span> <span class="number">127.0.0.1:6379</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">#redis2_query auth 123123;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">#set_unescape_uri $key $arg_key;  # this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get <span class="variable">$arg_key</span>;</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733426.png" alt="image-20221006120158946"></p>
<h6 id="set"><a href="#set" class="headerlink" title="set"></a>set</h6><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GET /set?key=one&amp;val=first%20value</span></span><br><span class="line"></span><br><span class="line"><span class="section">location</span> = /set &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_pass</span> <span class="number">127.0.0.1:6379</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_query</span> auth <span class="number">123123</span>;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$key</span> <span class="variable">$arg_key</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$val</span> <span class="variable">$arg_val</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set <span class="variable">$key</span> <span class="variable">$val</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h6 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h6><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">     <span class="attribute">set</span> <span class="variable">$value</span> <span class="string">&#x27;first&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get one;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one two;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get one;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_query</span> del key1;</span><br></pre></td></tr></table></figure>

<h6 id="list"><a href="#list" class="headerlink" title="list"></a>list</h6><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">    redis2_query lpush key1 C;</span><br><span class="line"></span><br><span class="line">    redis2_query lpush key1 B;</span><br><span class="line"></span><br><span class="line">    redis2_query lpush key1 A;</span><br><span class="line"></span><br><span class="line">redis2_query lrange key1 <span class="number">0</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>

<h6 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h6><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> redis_cluster &#123;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> = /redis &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">         <span class="attribute">redis2_next_upstream</span> <span class="literal">error</span> timeout invalid_response;</span><br><span class="line"></span><br><span class="line">         <span class="attribute">redis2_query</span> get foo;</span><br><span class="line"></span><br><span class="line">         <span class="attribute">redis2_pass</span> redis_cluster;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Stream模块"><a href="#Stream模块" class="headerlink" title="Stream模块"></a>Stream模块</h3><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html">http://nginx.org/en/docs/stream/ngx_stream_core_module.html</a></p>
<p>Mysql透明化多主高可用，负载均衡配置</p>
<h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><h4 id="QPS限制"><a href="#QPS限制" class="headerlink" title="QPS限制"></a>QPS限制</h4><p>限制并发请求数的模块为：http_limit_req_module，地址：<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_limit_req_module.html">http://nginx.org/en/docs/http/ngx_http_limit_req_module.html</a></p>
<p>默认编译进Nginx中的。</p>
<p><strong>官方文档</strong></p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_limit_req_module.html">http://nginx.org/en/docs/http/ngx_http_limit_req_module.html</a></p>
<p>漏桶（Leaky Bucket） 算法思路简单，水（请求）先进入到漏桶中，漏桶以一定的速度出水（接口有响应速率），当水流速度过大直接溢出（访问频率超过接口响应频率），然后就拒绝请求，可以看出漏桶算法能强制限制数据的传输速率。</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733017.png" alt="在这里插入图片描述"></p>
<p>测试工具</p>
<p><a target="_blank" rel="noopener" href="https://jmeter.apache.org/">https://jmeter.apache.org/</a></p>
<p>配置</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># 限制请求数，大小为10m，平均处理的频率不能超过每秒一次</span></span><br><span class="line">    <span class="attribute">limit_req_zone</span> <span class="variable">$binary_remote_addr</span> zone=one:<span class="number">10m</span> rate=1r/s;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /search/ &#123;</span><br><span class="line">            <span class="comment"># 限制频率每秒不超过一个请求，同时允许每次超过频率限制的请求数不多于5个（保存在桶中的请求）；nodelay 如果不希望超过的请求被延迟，直接丢弃。</span></span><br><span class="line">            <span class="attribute">limit_req</span> zone=one burst=<span class="number">5</span> nodelay;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><code>limit_req_zone key zone=name:size rate=rate； </code>定义限制并发请求的配置。</p>
<ul>
<li>若占用的内存超过最大共享内存，则服务器返回错误响应</li>
<li>rate定义的是请求速率，如10r&#x2F;s 每秒传递10个请求，10r&#x2F;m 每分钟传递10个请求</li>
</ul>
<p><code>limit_req zone=name [burst=number] [nodelay | delay=number];</code></p>
<ul>
<li>zone 定义使用哪个 limit_req_zone配置</li>
<li>burst&#x3D;number 设置桶可存放的请求数，就是请求的缓冲区大小</li>
<li>nodelay burst桶的请求不再缓冲，直接传递，rate请求速率失效。</li>
<li>delay&#x3D;number 第一次接收请求时，可提前传递number个请求。</li>
</ul>
<p><code>limit_req_log_level info | notice | warn | error; </code>限制发生时的日志级别</p>
<ul>
<li>可定义模块为http、server、location模块</li>
</ul>
<p><code>limit_req_status *code*；</code>限制发生时的错误码</p>
<ul>
<li>可定义模块为http、server、location模块</li>
</ul>
<h4 id="Nginx-带宽限制"><a href="#Nginx-带宽限制" class="headerlink" title="Nginx 带宽限制"></a>Nginx 带宽限制</h4><p>对于很多应用场景来说，除了要求能够限制数据的平均传输速率外，还要求允许某种程度的突发传输。这时候漏桶算法可能就不合适了，令牌桶算法更为适合。如图2所示，令牌桶算法的原理是系统会以一个恒定的速度往桶里放入令牌，而如果请求需要被处理，则需要先从桶里获取一个令牌，当桶里没有令牌可取时，则拒绝服务。</p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733911.png" alt="在这里插入图片描述"></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">limit_rate_after</span> <span class="number">1m</span>;</span><br><span class="line">			<span class="attribute">limit_rate</span> <span class="number">1k</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Nginx-并发数限制"><a href="#Nginx-并发数限制" class="headerlink" title="Nginx 并发数限制"></a>Nginx 并发数限制</h4><p>限制并发连接数的模块为：http_limit_conn_module，地址：<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_limit_conn_module.html">http://nginx.org/en/docs/http/ngx_http_limit_conn_module.html</a></p>
<p>默认编译进Nginx中的。</p>
<p><strong>计数器算法</strong></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">	<span class="attribute">limit_conn_zone</span> <span class="variable">$binary_remote_addr</span> zone=addr:<span class="number">10m</span>;</span><br><span class="line">  <span class="comment">#limit_conn_zone $server_name zone=perserver:10m;</span></span><br><span class="line">  </span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">limit_conn</span> addr <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">limit_conn_log_level</span> <span class="literal">warn</span>;</span><br><span class="line">    <span class="attribute">limit_conn_status</span> <span class="number">503</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>limit_conn_zone key zone=name:size;</code> 定义并发连接的配置</p>
<ul>
<li>可定义的模块为http模块。</li>
<li>key关键字是根据什么变量来限制连接数，示例中有binary_remote_addr、$server_name，根据实际业务需求。</li>
<li>zone定义配置名称和最大共享内存，若占用的内存超过最大共享内存，则服务器返回错误</li>
</ul>
<p>示例中的<code>$binary_remote_addr</code>是二进制的用户地址，用二进制来节省字节数，减少占用共享内存的大小。</p>
<p><code>limit_conn zone number; </code>并发连接限制</p>
<ul>
<li>可定义模块为http、server、location模块</li>
<li>zone为指定使用哪个limit_conn_zone配置</li>
<li>number为限制连接数，示例配置中限制为 1 个连接。</li>
</ul>
<p><code>limit_conn_log_level info | notice | warn | error ; </code>限制发生时的日志级别</p>
<ul>
<li>可定义模块为http、server、location模块</li>
</ul>
<p><code>limit_conn_status code; </code>限制发生时的返回错误码，默认503</p>
<ul>
<li>可定义模块为http、server、location模块</li>
</ul>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p><a target="_blank" rel="noopener" href="http://www.h7hh.cn/208.html">nginx配置系列（三）日志配置（ngx_http_log_module） - 小陈博客,小陈个人博客,程序猿小王子,技术博客,个人博客模板,php博客系统,设计模式,wzyl - 黑夜遮不住光亮 (h7hh.cn)</a></p>
<h4 id="ngx-http-log-module"><a href="#ngx-http-log-module" class="headerlink" title="ngx_http_log_module"></a>ngx_http_log_module</h4><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_log_module.html">http://nginx.org/en/docs/http/ngx_http_log_module.html</a></p>
<p>ngx_http_log_module模块按指定的格式记录访问日志。请求在处理结束时，会按请求路径的配置上下文记访问日志,通过访问日志，你可以得到用户地域来源、跳转来源、使用终端、某个URL访问量等相关信息。你也可以记录错误日志，通过错误日志，你可以得到系统某个服务或server的性能瓶颈等。</p>
<h5 id="配置-access-log-来记录访问日志"><a href="#配置-access-log-来记录访问日志" class="headerlink" title="配置 access_log 来记录访问日志"></a>配置 access_log 来记录访问日志</h5><p><strong>语法</strong></p>
<p>作用域分别有http，server，location，limit_except。</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">access_log</span> path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]]; <span class="comment"># 设置访问日志</span></span><br><span class="line"><span class="attribute">access_log</span> <span class="literal">off</span>; <span class="comment"># 关闭访问日志</span></span><br></pre></td></tr></table></figure>

<ul>
<li>path 指定日志的存放位置。</li>
<li>format 指定日志的格式。默认使用预定义的combined。</li>
<li>buffer 用来指定日志写入时的缓存大小。默认是64k。</li>
<li>gzip 日志写入前先进行压缩。压缩率可以指定，从1到9数值越大压缩比越高，同时压缩的速度也越慢。默认是1。</li>
<li>flush 设置缓存的有效时间。如果超过flush指定的时间，缓存中的内容将被清空。</li>
<li>if 条件判断。如果指定的条件计算为0或空字符串，那么该请求不会写入日志。</li>
</ul>
<p><strong>例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">access_log /home/wwwlogs/nginx-access.log buffer=32k gzip flush=1m</span><br></pre></td></tr></table></figure>

<p>该例子指定日志的写入路径为&#x2F;home&#x2F;wwwlogs&#x2F;nginx-access.log，日志格式使用默认的combined，指定日志的缓存大小为32k，日志写入前启用gzip进行压缩，压缩比使用默认值1，缓存数据有效时间为1分钟。</p>
<h5 id="使用-log-format-自定义日志格式"><a href="#使用-log-format-自定义日志格式" class="headerlink" title="使用 log_format 自定义日志格式"></a><strong>使用 log_format 自定义日志格式</strong></h5><p>Nginx预定义了名为combined日志格式，如果没有明确指定日志格式默认使用该格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">log_format combined ``&#x27;$remote_addr - $remote_user [$time_local] &#x27;``          ``&#x27;&quot;$request&quot; $status $body_bytes_sent &#x27;``          ``&#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot;&#x27;``;</span><br></pre></td></tr></table></figure>

<p>如果不想使用Nginx预定义的格式，可以通过log_format指令来自定义。</p>
<p><strong>语法</strong></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">log_format</span> name [escape=default|json] string ...;</span><br></pre></td></tr></table></figure>

<ul>
<li>name 格式的名称。在 access_log 指令中引用。</li>
<li>escape 设置变量中的字符编码方式是json还是default，默认是default。</li>
<li>string 要定义的日志格式内容。该参数可以有多个。参数中可以使用Nginx变量。</li>
</ul>
<p>下面是 log_format 指令中常用的一些变量：</p>
<ul>
<li>$remote_addr  客户端的IP地址(代理服务器，显示代理服务器的ip)</li>
<li>$remote_user  记录远程客户端的用户名称，针对启用了用户认证的请求，通常情况下为“-”</li>
<li>$time_local  记录访问时间和时区，如”24&#x2F;May&#x2F;2017:18:31:27 +0800”</li>
<li>$request  记录请求的url以及请求方法</li>
<li>$status  响应状态码 例如：200成功、404页面找不到等……</li>
<li>$bytes_sent  发送给客户端的总字节数</li>
<li>$body_bytes_sent  给客户端发送的主体内容字节数，不包括响应头的大小</li>
<li>$http_user_agent  客户端浏览器信息</li>
<li>$http_x_forwarded_for  可以记录客户端IP，通过代理服务器来记录客户端的IP地址。当前端有代理服务器时，设置web节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的x_forwarded_for设置。</li>
<li>$http_referer  记录用户是从哪个链接访问过来的</li>
<li>$time_iso8601  标准格式的本地时间,形如“2017-05-24T18:31:27+08:00”</li>
<li>$msec  日志写入时间，单位为秒，精度是毫秒</li>
<li>$request_length  请求长度（包括请求行，请求头和请求体）</li>
<li>$request_time  请求处理时长，单位为秒，精度为毫秒，从读入客户端的第一个字节开始，直到把最后一个字符发送给客户端进行日志写入为止</li>
</ul>
<p><strong>例：</strong></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">access_log</span> /home/wwwlogs/nginx-access.log main</span><br><span class="line">log_format  main  <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                  <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                  <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="ngx-http-empty-gif-module"><a href="#ngx-http-empty-gif-module" class="headerlink" title="ngx_http_empty_gif_module"></a>ngx_http_empty_gif_module</h5><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_empty_gif_module.html">http://nginx.org/en/docs/http/ngx_http_empty_gif_module.html</a></p>
<h5 id="json"><a href="#json" class="headerlink" title="json"></a>json</h5><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">log_format  ngxlog json &#x27;<span class="punctuation">&#123;</span><span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span><span class="string">&quot;$time_iso8601&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;source&quot;</span><span class="punctuation">:</span><span class="string">&quot;$server_addr&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span><span class="string">&quot;$hostname&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;remote_user&quot;</span><span class="punctuation">:</span><span class="string">&quot;$remote_user&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span><span class="string">&quot;$http_x_forwarded_for&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;client&quot;</span><span class="punctuation">:</span><span class="string">&quot;$remote_addr&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;request_method&quot;</span><span class="punctuation">:</span><span class="string">&quot;$request_method&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span><span class="string">&quot;$scheme&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span><span class="string">&quot;$server_name&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;referer&quot;</span><span class="punctuation">:</span><span class="string">&quot;$http_referer&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;request&quot;</span><span class="punctuation">:</span><span class="string">&quot;$request_uri&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;requesturl&quot;</span><span class="punctuation">:</span><span class="string">&quot;$request&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;args&quot;</span><span class="punctuation">:</span><span class="string">&quot;$args&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span>$body_bytes_sent<span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> $status<span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;responsetime&quot;</span><span class="punctuation">:</span>$request_time<span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;upstreamtime&quot;</span><span class="punctuation">:</span><span class="string">&quot;$upstream_response_time&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;upstreamaddr&quot;</span><span class="punctuation">:</span><span class="string">&quot;$upstream_addr&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;http_user_agent&quot;</span><span class="punctuation">:</span><span class="string">&quot;$http_user_agent&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;http_cookie&quot;</span><span class="punctuation">:</span><span class="string">&quot;$http_cookie&quot;</span><span class="punctuation">,</span>&#x27;</span><br><span class="line">                    &#x27;<span class="attr">&quot;https&quot;</span><span class="punctuation">:</span><span class="string">&quot;$https&quot;</span>&#x27;</span><br><span class="line">                    &#x27;<span class="punctuation">&#125;</span>&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="errorlog"><a href="#errorlog" class="headerlink" title="errorlog"></a>errorlog</h4><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/ngx_core_module.html#error_log">http://nginx.org/en/docs/ngx_core_module.html#error_log</a></p>
<p>错误日志在Nginx中是通过 error_log 指令实现的。该指令记录服务器和请求处理过程中的错误信息。</p>
<p><strong>语法</strong></p>
<p>配置错误日志文件的路径和日志级别。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">error_log ``file` `[level];``Default:  ``error_log logs``/error``.log error;</span><br></pre></td></tr></table></figure>

<p>第一个参数指定日志的写入路径。</p>
<p>第二个参数指定日志的级别。level可以是debug, info, notice, warn, error, crit, alert,emerg 中的任意值。可以看到其取值范围是按紧急程度从低到高排列的。只有日志的错误级别等于或高于level指定的值才会写入错误日志中。默认值是error。</p>
<p><strong>基本用法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">error_log ``/home/wwwlogs/nginx-error``.log crit;</span><br></pre></td></tr></table></figure>

<p>它可以配置在：main， http, mail, stream, server, location 作用域。</p>
<p>例子中指定了错误日志的路径为：&#x2F;home&#x2F;wwwlogs&#x2F;nginx-error.log，日志级别使用的是crit。</p>
<h5 id="日志分割"><a href="#日志分割" class="headerlink" title="日志分割"></a>日志分割</h5><p>1.脚本</p>
<p>2.Logrotate </p>
<h4 id="nginx健康检查"><a href="#nginx健康检查" class="headerlink" title="nginx健康检查"></a>nginx健康检查</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37543627/article/details/120840074">(62条消息) Nginx健康检查_爱我所爱0505的博客-CSDN博客_nginx 健康检查</a></p>
<h5 id="重试机制-1"><a href="#重试机制-1" class="headerlink" title="重试机制"></a>重试机制</h5><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream</a></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733681.png" alt="img"></p>
<p>配置：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="section">upstream</span> backend2 &#123;</span><br><span class="line">		<span class="attribute">server</span> <span class="number">192.168.1.55:9022</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">10s</span> weight=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">8200</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"> </span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">			<span class="attribute">proxy_pass</span> http://backend2;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">#连接超时</span></span><br><span class="line">			<span class="attribute">proxy_connect_timeout</span> <span class="number">5s</span>; </span><br><span class="line">			<span class="comment">#读超时</span></span><br><span class="line">			<span class="attribute">proxy_read_timeout</span> <span class="number">5s</span>;</span><br><span class="line">			<span class="comment">#发送超时</span></span><br><span class="line">			<span class="attribute">proxy_send_timeout</span> <span class="number">5s</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">#上游服务器超时</span></span><br><span class="line">			<span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> timeout;</span><br><span class="line">			<span class="attribute">proxy_next_upstream_timeout</span> <span class="number">10s</span>;</span><br><span class="line">			<span class="comment">#上游服务器重试次数</span></span><br><span class="line">			<span class="attribute">proxy_next_upstream_tries</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">		<span class="section">location</span> /lua &#123;</span><br><span class="line">			<span class="attribute">default_type</span> <span class="string">&#x27;text/html&#x27;</span>;</span><br><span class="line">			<span class="section">content_by_lua_block</span> &#123;</span><br><span class="line">                ngx.say(&quot;&lt;p&gt;hello, world&lt;/p&gt;&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">		<span class="section">location</span> /upstream_status &#123;</span><br><span class="line">			<span class="comment">#开启upstream状态页面</span></span><br><span class="line">			check_status;     </span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>max_fails</strong></p>
<p>最大失败次数</p>
<p>0为标记一直可用，不检查健康状态</p>
<p><strong>fail_timeout</strong></p>
<p>失败时间</p>
<p>当fail_timeout时间内失败了max_fails次，标记服务不可用</p>
<p>fail_timeout时间后会再次激活次服务</p>
<p><strong>proxy_next_upstream</strong> </p>
<p><strong>proxy_next_upstream_timeout</strong> </p>
<p>重试最大超时时间</p>
<p><strong>proxy_next_upstream_tries</strong> </p>
<p>重试次数，包括第一次</p>
<p>proxy_next_upstream_timeout时间内允许proxy_next_upstream_tries次重试</p>
<h5 id="主动健康检查"><a href="#主动健康检查" class="headerlink" title="主动健康检查"></a>主动健康检查</h5><p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733103.png" alt="img"></p>
<p>tengine版</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yaoweibin/nginx_upstream_check_module">https://github.com/yaoweibin/nginx_upstream_check_module</a></p>
<p>nginx商业版</p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html">http://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html</a></p>
<h6 id="配置-6"><a href="#配置-6" class="headerlink" title="配置"></a>配置</h6><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">      <span class="section">upstream</span> backend &#123;</span><br><span class="line">    </span><br><span class="line"><span class="comment">#   server 192.168.44.102 weight=8 down;</span></span><br><span class="line">   <span class="attribute">server</span> <span class="number">192.168.44.104:8080</span>;</span><br><span class="line">   <span class="attribute">server</span> <span class="number">192.168.44.105:8080</span>;</span><br><span class="line">   <span class="comment">#http类型检查：interval调用间隔时间，成功rise次后存活，失败fall次后不存活</span></span><br><span class="line"> <span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http;</span><br><span class="line"> 		<span class="comment">#检查调用接口</span></span><br><span class="line">       <span class="attribute">check_http_send</span> <span class="string">&quot;HEAD / HTTP/1.0\r\n\r\n&quot;</span>;</span><br><span class="line">       <span class="comment">##检查调用接口</span></span><br><span class="line">       <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="section">location</span> /status &#123;</span><br><span class="line">                check_status;</span><br><span class="line">                <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line"></span><br><span class="line">	 <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用Lua对Nginx二次开发"><a href="#使用Lua对Nginx二次开发" class="headerlink" title="使用Lua对Nginx二次开发"></a>使用Lua对Nginx二次开发</h3><p>Lua 是由巴西里约热内卢天主教大学（Pontifical Catholic University of Rio de Janeiro）里的一个研究小组于1993年开发的一种轻量、小巧的脚本语言，用标准 C 语言编写，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p>
<p>官网：<a target="_blank" rel="noopener" href="http://www.lua.org/">http://www.lua.org/</a></p>
<h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><h5 id="EmmyLua插件"><a href="#EmmyLua插件" class="headerlink" title="EmmyLua插件"></a>EmmyLua插件</h5><p><a target="_blank" rel="noopener" href="https://github.com/EmmyLua/IntelliJ-EmmyLua">https://github.com/EmmyLua/IntelliJ-EmmyLua</a></p>
<p><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/">https://emmylua.github.io/zh_CN/</a></p>
<h5 id="LDT-基于eclipse"><a href="#LDT-基于eclipse" class="headerlink" title="LDT 基于eclipse"></a>LDT 基于eclipse</h5><p><a target="_blank" rel="noopener" href="https://www.eclipse.org/ldt/">https://www.eclipse.org/ldt/</a></p>
<h4 id="Lua基础语法"><a href="#Lua基础语法" class="headerlink" title="Lua基础语法"></a>Lua基础语法</h4><h5 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello world!&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="保留关键字"><a href="#保留关键字" class="headerlink" title="保留关键字"></a>保留关键字</h5><p><code>and</code>       <code>break</code>     <code>do   </code> <code>else</code>      <code>elseif</code>      <code>end</code>       <code>false</code>    <code> for</code>       <code>function  if</code>      <code>in</code>        <code>local</code>     <code>nil</code>      <code>not</code>      <code>or</code>      <code>repeat</code>    <code>return</code>    <code>then</code>     <code> true</code>      <code>until</code>    <code> while</code></p>
<h5 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 两个减号是行注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 这是块注释</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 这是块注释.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> --]]</span></span><br></pre></td></tr></table></figure>

<h5 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h5><h6 id="数字类型"><a href="#数字类型" class="headerlink" title="数字类型"></a>数字类型</h6><p>Lua的数字只有double型，64bits</p>
<p>你可以以如下的方式表示数字</p>
 <figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">num = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">3.1416</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">314.16e-2</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0.31416E1</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0x56</span></span><br></pre></td></tr></table></figure>

<h6 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h6><p>可以用单引号，也可以用双引号</p>
<p>也可以使用转义字符‘\n’ （换行）， ‘\r’ （回车）， ‘\t’ （横向制表）， ‘\v’ （纵向制表）， ‘\’ （反斜杠）， ‘\”‘ （双引号）， 以及 ‘\” （单引号)等等</p>
<p>下面的四种方式定义了完全相同的字符串（其中的两个中括号可以用于定义有换行的字符串）</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">a = <span class="string">&#x27;alo\n123&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line">a = <span class="string">&quot;alo\n123\&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">a = <span class="string">&#x27;\97lo\10\04923&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line">a = <span class="string">[[alo</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">123&quot;]]</span></span><br></pre></td></tr></table></figure>

<h6 id="空值"><a href="#空值" class="headerlink" title="空值"></a>空值</h6><p>C语言中的NULL在Lua中是nil，比如你访问一个没有声明过的变量，就是nil</p>
<h6 id="布尔类型"><a href="#布尔类型" class="headerlink" title="布尔类型"></a>布尔类型</h6><p>只有nil和false是 false</p>
<p>数字0，‘’空字符串（’\0’）都是true</p>
<h6 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h6><p>lua中的变量如果没有特殊说明，全是全局变量，那怕是语句块或是函数里。</p>
<p>变量前加local关键字的是局部变量。</p>
<h5 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h5><h6 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h6><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">max</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> i &lt;= <span class="built_in">max</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">i = i +<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="if-else"><a href="#if-else" class="headerlink" title="if-else"></a>if-else</h6><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> age = <span class="number">140</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> sex = <span class="string">&#x27;Male&#x27;</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> age == <span class="number">40</span> <span class="keyword">and</span> sex ==<span class="string">&quot;Male&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; 男人四十一枝花 &quot;</span>)</span><br><span class="line">  <span class="keyword">elseif</span> age &gt; <span class="number">60</span> <span class="keyword">and</span> sex ~=<span class="string">&quot;Female&quot;</span> <span class="keyword">then</span></span><br><span class="line">   </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;old man!!&quot;</span>)</span><br><span class="line">  <span class="keyword">elseif</span> age &lt; <span class="number">20</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;too young, too simple!\n&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Your age is &quot;</span>..age)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h6><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">sum = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">100</span>, <span class="number">1</span>, <span class="number">-2</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">	sum = sum + i</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h6><ol>
<li></li>
</ol>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myPower</span><span class="params">(x,y)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span>      y+x</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">power2 = myPower(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"> <span class="built_in">print</span>(power2)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li></li>
</ol>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newCounter</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span>     <span class="comment">-- anonymous function</span></span><br><span class="line"></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">c1 = newCounter()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1())  <span class="comment">--&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1())  <span class="comment">--&gt; 2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1())</span><br></pre></td></tr></table></figure>

<h5 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">name, age,bGay = <span class="string">&quot;yiming&quot;</span>, <span class="number">37</span>, <span class="literal">false</span>, <span class="string">&quot;yimingl@hotmail.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(name,age,bGay)</span><br></pre></td></tr></table></figure>

 <figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isMyGirl</span><span class="params">(name)</span></span></span><br><span class="line">  <span class="keyword">return</span> name == <span class="string">&#x27;xiao6&#x27;</span> , name</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> bol,name = isMyGirl(<span class="string">&#x27;xiao6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(name,bol)</span><br></pre></td></tr></table></figure>

<h5 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h5><p>key，value的键值对 类似 map</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">dog = &#123;name=<span class="string">&#x27;111&#x27;</span>,age=<span class="number">18</span>,height=<span class="number">165.5</span>&#125;</span><br><span class="line"></span><br><span class="line">dog.age=<span class="number">35</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dog.name,dog.age,dog.height)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dog)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<h5 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">arr = &#123;<span class="string">&quot;string&quot;</span>, <span class="number">100</span>, <span class="string">&quot;dog&quot;</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;wangwang!&quot;</span>) <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">end</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(arr[<span class="number">4</span>]())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<h5 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">arr = &#123;<span class="string">&quot;string&quot;</span>, <span class="number">100</span>, <span class="string">&quot;dog&quot;</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;wangwang!&quot;</span>) <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">end</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(arr) <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">print</span>(k, v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="成员函数"><a href="#成员函数" class="headerlink" title="成员函数"></a>成员函数</h5><h4 id><a href="#" class="headerlink" title></a></h4><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">person = &#123;name=<span class="string">&#x27;旺财&#x27;</span>,age = <span class="number">18</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span>  <span class="title">person.eat</span><span class="params">(food)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(person.name ..<span class="string">&quot; eating &quot;</span>..food)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">person.eat(<span class="string">&quot;骨头&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Openresty-Nginx-Lua"><a href="#Openresty-Nginx-Lua" class="headerlink" title="Openresty Nginx + Lua"></a>Openresty Nginx + Lua</h3><p>Nginx是一个主进程配合多个工作进程的工作模式，每个进程由单个线程来处理多个连接。</p>
<p>在生产环境中，我们往往会把cpu内核直接绑定到工作进程上，从而提升性能。</p>
<h4 id="安装-4"><a href="#安装-4" class="headerlink" title="安装"></a>安装</h4><h5 id="预编译安装"><a href="#预编译安装" class="headerlink" title="预编译安装"></a>预编译安装</h5><p>以CentOS举例 其他系统参照：<a target="_blank" rel="noopener" href="http://openresty.org/cn/linux-packages.html">http://openresty.org/cn/linux-packages.html</a></p>
<p>你可以在你的 CentOS 系统中添加 openresty 仓库，这样就可以便于未来安装或更新我们的软件包（通过 yum update 命令）。运行下面的命令就可以添加我们的仓库：</p>
<p>      <code>yum install yum-utils</code></p>
<p>      <code>yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo</code></p>
<p>然后就可以像下面这样安装软件包，比如 openresty：</p>
<p>   <code>yum install openresty</code></p>
<p>如果你想安装命令行工具 resty，那么可以像下面这样安装 openresty-resty 包：</p>
<p>      <code>sudo yum install openresty-resty</code></p>
<h5 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h5><h5 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h5><p><a target="_blank" rel="noopener" href="http://openresty.org/cn/download.html">http://openresty.org/cn/download.html</a></p>
<p>最小版本基于nginx1.21</p>
<p><code>./configure</code></p>
<p>然后在进入 <code>openresty-VERSION/ </code>目录, 然后输入以下命令配置:</p>
<p> <code>./configure</code></p>
<p>默认, <code>--prefix=/usr/local/openresty</code> 程序会被安装到<code>/usr/local/openresty</code>目录。</p>
<ul>
<li><p>依赖 <code>gcc openssl-devel pcre-devel zlib-devel</code></p>
</li>
<li><p>安装：<code>yum install gcc openssl-devel pcre-devel zlib-devel postgresql-devel</code></p>
</li>
<li><p>您可以指定各种选项，比如</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./configure --prefix=/opt/openresty \</span><br><span class="line"></span><br><span class="line">            --with-luajit \</span><br><span class="line"></span><br><span class="line">            --without-http_redis2_module \</span><br><span class="line"></span><br><span class="line">            --with-http_iconv_module \</span><br><span class="line"></span><br><span class="line">            --with-http_postgres_module</span><br></pre></td></tr></table></figure>

<ul>
<li>试着使用 <code>./configure --help</code> 查看更多的选项。</li>
</ul>
<p><code>make &amp;&amp; make install</code></p>
<h5 id="服务命令"><a href="#服务命令" class="headerlink" title="服务命令"></a>服务命令</h5><h6 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h6><p><code>service openresty start</code></p>
<p><img src="/img/loading.gif" data-original="https://huaflying.oss-cn-hangzhou.aliyuncs.com/JavaStudy/202310141733731.png" alt="image-20221006163554688"></p>
<h6 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h6><p><code>service openresty stop</code></p>
<h6 id="检查配置文件是否正确"><a href="#检查配置文件是否正确" class="headerlink" title="检查配置文件是否正确"></a>检查配置文件是否正确</h6><p><code>Nginx -t</code></p>
<p> 重新加载配置文件</p>
<p><code>service openresty reload</code></p>
<h6 id="查看已安装模块和版本号"><a href="#查看已安装模块和版本号" class="headerlink" title="查看已安装模块和版本号"></a>查看已安装模块和版本号</h6><p><code>Nginx -V</code></p>
<h4 id="测试lua脚本"><a href="#测试lua脚本" class="headerlink" title="测试lua脚本"></a>测试lua脚本</h4><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">在Nginx.<span class="attribute">conf</span> 中写入</span><br><span class="line">   location /lua &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">default_type</span> text/html;</span><br><span class="line">        <span class="attribute">content_by_lua</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">           ngx.say(&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;)</span></span><br><span class="line"><span class="string">         &#x27;</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h4 id="lua-nginx-module"><a href="#lua-nginx-module" class="headerlink" title="lua-nginx-module"></a>lua-nginx-module</h4><h5 id="创建配置文件lua-conf"><a href="#创建配置文件lua-conf" class="headerlink" title="创建配置文件lua.conf"></a>创建配置文件lua.conf</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">   <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">   <span class="section">location</span> /lua &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">content_by_lua_file</span> conf/lua/hello.lua;</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="在Nginx-conf下引入lua配置"><a href="#在Nginx-conf下引入lua配置" class="headerlink" title="在Nginx.conf下引入lua配置"></a>在Nginx.conf下引入lua配置</h5><p><code>include       lua.conf;</code></p>
<h5 id="创建外部lua脚本"><a href="#创建外部lua脚本" class="headerlink" title="创建外部lua脚本"></a>创建外部lua脚本</h5><p><code>conf/lua/hello.lua</code></p>
<p>内容：</p>
<p><code>ngx.say(&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;)</code></p>
<h5 id="获取Nginx-uri中的单一变量"><a href="#获取Nginx-uri中的单一变量" class="headerlink" title="获取Nginx uri中的单一变量"></a>获取Nginx uri中的单一变量</h5> <figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> /nginx_var &#123;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">    <span class="section">content_by_lua_block</span> &#123;</span><br><span class="line"></span><br><span class="line">        ngx.say(ngx.var.arg_a)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="获取Nginx-uri中的所有变量"><a href="#获取Nginx-uri中的所有变量" class="headerlink" title="获取Nginx uri中的所有变量"></a>获取Nginx uri中的所有变量</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> uri_args = ngx.req.get_uri_args()  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(uri_args) <span class="keyword">do</span>  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot; : &quot;</span>, <span class="built_in">table</span>.<span class="built_in">concat</span>(v, <span class="string">&quot;, &quot;</span>), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot;: &quot;</span>, v, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="在处理http请求时还可以使用"><a href="#在处理http请求时还可以使用" class="headerlink" title="在处理http请求时还可以使用"></a>在处理http请求时还可以使用</h5><ul>
<li>set_by_lua</li>
</ul>
<p>修改nginx变量</p>
<ul>
<li>rewrite_by_lua</li>
</ul>
<p>修改uri</p>
<ul>
<li>access_by_lua</li>
</ul>
<p>访问控制</p>
<ul>
<li>header_filter_by_lua</li>
</ul>
<p>修改响应头</p>
<ul>
<li>boy_filter_by_lua</li>
</ul>
<p>修改响应体</p>
<ul>
<li>log_by_lua</li>
</ul>
<p>日志</p>
<h5 id="代码热部署"><a href="#代码热部署" class="headerlink" title="代码热部署"></a>代码热部署</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lua_code_cache off</span><br></pre></td></tr></table></figure>

<h5 id="获取Nginx请求头信息"><a href="#获取Nginx请求头信息" class="headerlink" title="获取Nginx请求头信息"></a>获取Nginx请求头信息</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> headers = ngx.req.get_headers()                         </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;Host : &quot;</span>, headers[<span class="string">&quot;Host&quot;</span>], <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;user-agent : &quot;</span>, headers[<span class="string">&quot;user-agent&quot;</span>], <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;user-agent : &quot;</span>, headers.user_agent, <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(headers) <span class="keyword">do</span>  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot; : &quot;</span>, <span class="built_in">table</span>.<span class="built_in">concat</span>(v, <span class="string">&quot;,&quot;</span>), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot; : &quot;</span>, v, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span>  </span><br></pre></td></tr></table></figure>

<h5 id="获取post请求参数"><a href="#获取post请求参数" class="headerlink" title="获取post请求参数"></a>获取post请求参数</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ngx.req.read_body()  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;post args begin&quot;</span>, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> post_args = ngx.req.get_post_args()  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(post_args) <span class="keyword">do</span>  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot; : &quot;</span>, <span class="built_in">table</span>.<span class="built_in">concat</span>(v, <span class="string">&quot;, &quot;</span>), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot;: &quot;</span>, v, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="http协议版本"><a href="#http协议版本" class="headerlink" title="http协议版本"></a>http协议版本</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ngx.say(<span class="string">&quot;ngx.req.http_version : &quot;</span>, ngx.req.http_version(), <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ngx.say(<span class="string">&quot;ngx.req.get_method : &quot;</span>, ngx.req.get_method(), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br></pre></td></tr></table></figure>

<h5 id="原始的请求头内容"><a href="#原始的请求头内容" class="headerlink" title="原始的请求头内容"></a>原始的请求头内容</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ngx.say(<span class="string">&quot;ngx.req.raw_header : &quot;</span>,  ngx.req.raw_header(), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br></pre></td></tr></table></figure>

<h5 id="body内容体"><a href="#body内容体" class="headerlink" title="body内容体"></a>body内容体</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ngx.say(<span class="string">&quot;ngx.req.get_body_data() : &quot;</span>, ngx.req.get_body_data(), <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Openresty常用模块"><a href="#Openresty常用模块" class="headerlink" title="Openresty常用模块"></a>Openresty常用模块</h3><h4 id="Nginx缓存"><a href="#Nginx缓存" class="headerlink" title="Nginx缓存"></a>Nginx缓存</h4><h5 id="Nginx全局内存缓存"><a href="#Nginx全局内存缓存" class="headerlink" title="Nginx全局内存缓存"></a>Nginx全局内存缓存</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">lua_shared_dict shared_data <span class="number">1</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> shared_data = ngx.shared.shared_data  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> i = shared_data:get(<span class="string">&quot;i&quot;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> i <span class="keyword">then</span>  </span><br><span class="line"></span><br><span class="line">    i = <span class="number">1</span>  </span><br><span class="line"></span><br><span class="line">    shared_data:set(<span class="string">&quot;i&quot;</span>, i)  </span><br><span class="line"></span><br><span class="line">    ngx.say(<span class="string">&quot;lazy set i &quot;</span>, i, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">i = shared_data:incr(<span class="string">&quot;i&quot;</span>, <span class="number">1</span>)  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;i=&quot;</span>, i, <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="lua-resty-lrucache"><a href="#lua-resty-lrucache" class="headerlink" title="lua-resty-lrucache"></a>lua-resty-lrucache</h5><p>Lua 实现的一个简单的 LRU 缓存，适合在 Lua 空间里直接缓存较为复杂的 Lua 数据结构：它相比 ngx_lua 共享内存字典可以省去较昂贵的序列化操作，相比 memcached 这样的外部服务又能省去较昂贵的 socket 操作</p>
<p><a target="_blank" rel="noopener" href="https://github.com/openresty/lua-resty-lrucache">https://github.com/openresty/lua-resty-lrucache</a></p>
<p>引用lua文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> content_by_lua_block &#123;</span><br><span class="line">    require(&quot;my/cache&quot;).go()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义函数</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> _M = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lrucache = <span class="built_in">require</span> <span class="string">&quot;resty.lrucache&quot;</span></span><br><span class="line"></span><br><span class="line">c, err = lrucache.new(<span class="number">200</span>)  <span class="comment">-- allow up to 200 items in the cache</span></span><br><span class="line">ngx.say(<span class="string">&quot;count=init&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">error</span>(<span class="string">&quot;failed to create the cache: &quot;</span> .. (err <span class="keyword">or</span> <span class="string">&quot;unknown&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.go</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">count = c:get(<span class="string">&quot;count&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c:set(<span class="string">&quot;count&quot;</span>,<span class="number">100</span>)</span><br><span class="line">ngx.say(<span class="string">&quot;count=&quot;</span>, count, <span class="string">&quot; --&lt;br/&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> count <span class="keyword">then</span>  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    c:set(<span class="string">&quot;count&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    ngx.say(<span class="string">&quot;lazy set count &quot;</span>, c:get(<span class="string">&quot;count&quot;</span>), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c:set(<span class="string">&quot;count&quot;</span>,count+<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;count=&quot;</span>, count, <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> _M</span><br></pre></td></tr></table></figure>

<p>打开lua_code_cache</p>
<h4 id="lua-resty-redis访问redis"><a href="#lua-resty-redis访问redis" class="headerlink" title="lua-resty-redis访问redis"></a>lua-resty-redis访问redis</h4><p><a target="_blank" rel="noopener" href="https://github.com/openresty/lua-resty-redis">https://github.com/openresty/lua-resty-redis</a></p>
<h5 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> res, err = red:get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> res, err = red:lrange(<span class="string">&quot;nokey&quot;</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;res:&quot;</span>,cjson.encode(res))</span><br></pre></td></tr></table></figure>

<h5 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">red, err = redis:new()</span><br><span class="line"></span><br><span class="line">ok, err = red:connect(host, port, options_table?)</span><br></pre></td></tr></table></figure>

<h5 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">red:set_timeout(<span class="built_in">time</span>)</span><br></pre></td></tr></table></figure>

<h5 id="keepalive"><a href="#keepalive" class="headerlink" title="keepalive"></a>keepalive</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">red:set_keepalive(max_idle_timeout, pool_size)</span><br></pre></td></tr></table></figure>

<h5 id="close"><a href="#close" class="headerlink" title="close"></a>close</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ok, err = red:close()</span><br></pre></td></tr></table></figure>

<h5 id="pipeline-1"><a href="#pipeline-1" class="headerlink" title="pipeline"></a>pipeline</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">red:init_pipeline()</span><br><span class="line"></span><br><span class="line">results, <span class="attribute">err</span> = red:commit_pipeline()</span><br></pre></td></tr></table></figure>

<h5 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">    <span class="attribute">local</span> res, err = red:auth(<span class="string">&quot;foobared&quot;</span>)</span><br><span class="line"></span><br><span class="line">    if not res then</span><br><span class="line"></span><br><span class="line">        ngx.say(<span class="string">&quot;failed to authenticate: &quot;</span>, err)</span><br><span class="line"></span><br><span class="line">        return</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> local redis = require &quot;resty.redis&quot;</span><br><span class="line">               local red = redis:new()</span><br><span class="line"></span><br><span class="line">               red:set_timeouts(1000, 1000, 1000) -- 1 sec</span><br><span class="line"></span><br><span class="line"> local ok, err = red:connect(&quot;127.0.0.1&quot;, 6379)</span><br><span class="line">if not ok then</span><br><span class="line">                   ngx.say(&quot;failed to connect: &quot;, err)</span><br><span class="line">                   return</span><br><span class="line">               end</span><br><span class="line"></span><br><span class="line">               ok, err = red:set(&quot;dog&quot;, &quot;an animal&quot;)</span><br><span class="line">               if not ok then</span><br><span class="line">                   ngx.say(&quot;failed to set dog: &quot;, err)</span><br><span class="line">                   return</span><br><span class="line">               end</span><br><span class="line"></span><br><span class="line">               ngx.say(&quot;set result: &quot;, ok)</span><br><span class="line"></span><br><span class="line">               local res, err = red:get(&quot;dog&quot;)</span><br><span class="line">               if not res then</span><br><span class="line">                   ngx.say(&quot;failed to get dog: &quot;, err)</span><br><span class="line">                   return</span><br><span class="line">               end</span><br><span class="line"></span><br><span class="line">               if res == ngx.null then</span><br><span class="line">                   ngx.say(&quot;dog not found.&quot;)</span><br><span class="line">                   return</span><br><span class="line">               end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">             ngx.say(&quot;dog: &quot;, res)</span><br></pre></td></tr></table></figure>

<h5 id="redis-cluster支持"><a href="#redis-cluster支持" class="headerlink" title="redis-cluster支持"></a>redis-cluster支持</h5><p><a target="_blank" rel="noopener" href="https://github.com/steve0511/resty-redis-cluster">https://github.com/steve0511/resty-redis-cluster</a></p>
<h4 id="redis2-nginx-module-1"><a href="#redis2-nginx-module-1" class="headerlink" title="redis2-nginx-module"></a>redis2-nginx-module</h4><p>redis2-nginx-module是一个支持 Redis 2.0 协议的 Nginx upstream 模块，它可以让 Nginx 以非阻塞方式直接防问远方的 Redis 服务，同时支持 TCP 协议和 Unix Domain Socket 模式，并且可以启用强大的 Redis 连接池功能。</p>
<h5 id="test"><a href="#test" class="headerlink" title="test"></a>test</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> = /foo &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> auth <span class="number">123123</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">set</span> <span class="variable">$value</span> <span class="string">&#x27;first&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_pass</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">location</span> = /get &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_pass</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> auth <span class="number">123123</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$key</span> <span class="variable">$arg_key</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="set-1"><a href="#set-1" class="headerlink" title="set"></a>set</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GET /set?key=one&amp;val=first%20value</span></span><br><span class="line"></span><br><span class="line"><span class="section">location</span> = /set &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_pass</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_query</span> auth <span class="number">123123</span>;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$key</span> <span class="variable">$arg_key</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$val</span> <span class="variable">$arg_val</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set <span class="variable">$key</span> <span class="variable">$val</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="pipeline-2"><a href="#pipeline-2" class="headerlink" title="pipeline"></a>pipeline</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">     <span class="attribute">set</span> <span class="variable">$value</span> <span class="string">&#x27;first&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get one;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one two;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get one;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_query</span> del key1;</span><br></pre></td></tr></table></figure>

<h5 id="list-1"><a href="#list-1" class="headerlink" title="list"></a>list</h5><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">    redis2_query lpush key1 C;</span><br><span class="line"></span><br><span class="line">    redis2_query lpush key1 B;</span><br><span class="line"></span><br><span class="line">    redis2_query lpush key1 A;</span><br><span class="line"></span><br><span class="line">redis2_query lrange key1 <span class="number">0</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>

<h5 id="集群-1"><a href="#集群-1" class="headerlink" title="集群"></a>集群</h5><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> redis_cluster &#123;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> = /redis &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">         <span class="attribute">redis2_next_upstream</span> <span class="literal">error</span> timeout invalid_response;</span><br><span class="line"></span><br><span class="line">         <span class="attribute">redis2_query</span> get foo;</span><br><span class="line"></span><br><span class="line">         <span class="attribute">redis2_pass</span> redis_cluster;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="lua-resty-mysql"><a href="#lua-resty-mysql" class="headerlink" title="lua-resty-mysql"></a>lua-resty-mysql</h4><p> <a target="_blank" rel="noopener" href="https://github.com/openresty/lua-resty-mysql">https://github.com/openresty/lua-resty-mysql</a></p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local mysql = require &quot;resty.mysql&quot;</span><br><span class="line">                local db, err = mysql:new()</span><br><span class="line">                if not db then</span><br><span class="line">                    ngx.say(&quot;failed to instantiate mysql: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                db:set_timeout(1000) -- 1 sec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                local ok, err, errcode, sqlstate = db:connect&#123;</span><br><span class="line">                    host = &quot;192.168.44.211&quot;,</span><br><span class="line">                    port = 3306,</span><br><span class="line">                    database = &quot;zhangmen&quot;,</span><br><span class="line">                    user = &quot;root&quot;,</span><br><span class="line">                    password = &quot;111111&quot;,</span><br><span class="line">                    charset = &quot;utf8&quot;,</span><br><span class="line">                    max_packet_size = 1024 * 1024,</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                ngx.say(&quot;connected to mysql.&lt;br&gt;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                local res, err, errcode, sqlstate = db:query(&quot;drop table if exists cats&quot;)</span><br><span class="line">                if not res then</span><br><span class="line">                    ngx.say(&quot;bad result: &quot;, err, &quot;: &quot;, errcode, &quot;: &quot;, sqlstate, &quot;.&quot;)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                res, err, errcode, sqlstate =</span><br><span class="line">                    db:query(&quot;create table cats &quot;</span><br><span class="line">                             .. &quot;(id serial primary key, &quot;</span><br><span class="line">                             .. &quot;name varchar(5))&quot;)</span><br><span class="line">                if not res then</span><br><span class="line">                    ngx.say(&quot;bad result: &quot;, err, &quot;: &quot;, errcode, &quot;: &quot;, sqlstate, &quot;.&quot;)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                ngx.say(&quot;table cats created.&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                res, err, errcode, sqlstate =</span><br><span class="line">                    db:query(&quot;select * from t_emp&quot;)</span><br><span class="line">                if not res then</span><br><span class="line">                    ngx.say(&quot;bad result: &quot;, err, &quot;: &quot;, errcode, &quot;: &quot;, sqlstate, &quot;.&quot;)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                local cjson = require &quot;cjson&quot;</span><br><span class="line">                ngx.say(&quot;result: &quot;, cjson.encode(res))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                local ok, err = db:set_keepalive(10000, 100)</span><br><span class="line">                if not ok then</span><br><span class="line">                    ngx.say(&quot;failed to set keepalive: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="模板实时渲染-lua-resty-template"><a href="#模板实时渲染-lua-resty-template" class="headerlink" title="模板实时渲染 lua-resty-template"></a>模板实时渲染 lua-resty-template</h3><p><a target="_blank" rel="noopener" href="https://github.com/bungle/lua-resty-template">https://github.com/bungle/lua-resty-template</a></p>
<p>如果学习过JavaEE中的servlet和JSP的话，应该知道JSP模板最终会被翻译成Servlet来执行；</p>
<p>而lua-resty-template模板引擎可以认为是JSP，其最终会被翻译成Lua代码，然后通过ngx.print输出。   </p>
<p>lua-resty-template大体内容有： </p>
<p>l   模板位置：从哪里查找模板； </p>
<p>l   变量输出&#x2F;转义：变量值输出； </p>
<p>l   代码片段：执行代码片段，完成如if&#x2F;else、for等复杂逻辑，调用对象函数&#x2F;方法； </p>
<p>l   注释：解释代码片段含义； </p>
<p>l   include：包含另一个模板片段； </p>
<p>l   其他：lua-resty-template还提供了不需要解析片段、简单布局、可复用的代码块、宏指令等支持。</p>
<p>基础语法</p>
<p>l   {(include_file)}：包含另一个模板文件；</p>
<p>l   {* var *}：变量输出；</p>
<p>l   ：变量转义输出；</p>
<p>l   { code }：代码片段；</p>
<p>l    comment ：注释；</p>
<p>l   {-raw-}：中间的内容不会解析，作为纯文本输出；</p>
<h4 id="lua代码热加载"><a href="#lua代码热加载" class="headerlink" title="lua代码热加载"></a>lua代码热加载</h4><p>在http模块中加入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lua_code_cache off;</span><br></pre></td></tr></table></figure>

<p>reload后Nginx会提示影响性能，记得在生产环境中关掉。</p>
<h4 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h4><h5 id="一、初始化"><a href="#一、初始化" class="headerlink" title="一、初始化"></a>一、初始化</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- Using template.new</span><br><span class="line">local template = require &quot;resty.template&quot;</span><br><span class="line">local view = template.new &quot;view.html&quot;</span><br><span class="line">view.message = &quot;Hello, World!&quot;</span><br><span class="line">view:render()</span><br><span class="line"></span><br><span class="line">-- Using template.render</span><br><span class="line">-- template.render(&quot;view.html&quot;, &#123; message = &quot;Hel11lo, Worl1d!&quot; &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="二、执行函数，得到渲染之后的内容"><a href="#二、执行函数，得到渲染之后的内容" class="headerlink" title="二、执行函数，得到渲染之后的内容"></a>二、执行函数，得到渲染之后的内容</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local func = template.compile(&quot;view.html&quot;)  </span><br><span class="line"></span><br><span class="line">local content = func(context)  </span><br><span class="line"></span><br><span class="line">ngx.say(&quot;xx:&quot;,content) </span><br></pre></td></tr></table></figure>

<h5 id="模板文件存放位置"><a href="#模板文件存放位置" class="headerlink" title="模板文件存放位置"></a>模板文件存放位置</h5><h6 id="nginx-conf中配置"><a href="#nginx-conf中配置" class="headerlink" title="nginx.conf中配置"></a>nginx.conf中配置</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set $template_root /usr/local/openresty/nginx/tmp;</span><br></pre></td></tr></table></figure>

<h4 id="resty-template-html"><a href="#resty-template-html" class="headerlink" title="resty.template.html"></a>resty.template.html</h4><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> html = <span class="built_in">require</span> <span class="string">&quot;resty.template.html&quot;</span></span><br><span class="line"></span><br><span class="line">template.render(<span class="string">[[</span></span><br><span class="line"><span class="string">&lt;ul&gt;</span></span><br><span class="line"><span class="string">&#123;% for _, person in ipairs(context) do %&#125;</span></span><br><span class="line"><span class="string">    &#123;*html.li(person.name)*&#125; --</span></span><br><span class="line"><span class="string">&#123;% end %&#125;</span></span><br><span class="line"><span class="string">&lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;table&gt;</span></span><br><span class="line"><span class="string">&#123;% for _, person in ipairs(context) do %&#125;</span></span><br><span class="line"><span class="string">    &lt;tr data-sort=&quot;&#123;&#123;(person.name or &quot;&quot;):lower()&#125;&#125;&quot;&gt;</span></span><br><span class="line"><span class="string">        &#123;*html.td&#123; id = person.id &#125;(person.name)*&#125;</span></span><br><span class="line"><span class="string">    &lt;/tr&gt;</span></span><br><span class="line"><span class="string">&#123;% end %&#125;</span></span><br><span class="line"><span class="string">&lt;/table&gt;]]</span>, &#123;</span><br><span class="line">    &#123; id = <span class="number">1</span>, name = <span class="string">&quot;Emma&quot;</span>&#125;,</span><br><span class="line">    &#123; id = <span class="number">2</span>, name = <span class="string">&quot;James&quot;</span> &#125;,</span><br><span class="line">    &#123; id = <span class="number">3</span>, name = <span class="string">&quot;Nicholas&quot;</span> &#125;,</span><br><span class="line">    &#123; id = <span class="number">4</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="模板内容"><a href="#模板内容" class="headerlink" title="模板内容"></a>模板内容</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="多值传入"><a href="#多值传入" class="headerlink" title="多值传入"></a>多值传入</h4><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">template.caching(<span class="literal">false</span>)</span><br><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> context = &#123;</span><br><span class="line">    name = <span class="string">&quot;lucy&quot;</span>,</span><br><span class="line">    age = <span class="number">50</span>,</span><br><span class="line">&#125;</span><br><span class="line">template.render(<span class="string">&quot;view.html&quot;</span>, context)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="模板内容-1"><a href="#模板内容-1" class="headerlink" title="模板内容"></a>模板内容</h4><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;h1&gt;name:&#123;&#123;name&#125;&#125;&lt;/h1&gt;</span><br><span class="line">  &lt;h1&gt;age:&#123;&#123;age&#125;&#125;&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="模板管理与缓存"><a href="#模板管理与缓存" class="headerlink" title="模板管理与缓存"></a>模板管理与缓存</h4><p>模板缓存：默认开启，开发环境可以手动关闭</p>
<p><code>template.caching(true)</code></p>
<p>模板文件需要业务系统更新与维护，当模板文件更新后，可以通过模板版本号或消息通知Openresty清空缓存重载模板到内存中</p>
<p><code>template.cache = &#123;&#125;</code></p>
<h4 id="完整页面"><a href="#完整页面" class="headerlink" title="完整页面"></a>完整页面</h4><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)</span><br><span class="line">template.caching(<span class="literal">false</span>)</span><br><span class="line"><span class="keyword">local</span> context = &#123;</span><br><span class="line">    title = <span class="string">&quot;测试&quot;</span>,</span><br><span class="line">    name = <span class="string">&quot;lucy&quot;</span>,</span><br><span class="line">    description = <span class="string">&quot;&lt;script&gt;alert(1);&lt;/script&gt;&quot;</span>,</span><br><span class="line">    age = <span class="number">40</span>,</span><br><span class="line">    hobby = &#123;<span class="string">&quot;电影&quot;</span>, <span class="string">&quot;音乐&quot;</span>, <span class="string">&quot;阅读&quot;</span>&#125;,</span><br><span class="line">    score = &#123;语文 = <span class="number">90</span>, 数学 = <span class="number">80</span>, 英语 = <span class="number">70</span>&#125;,</span><br><span class="line">    score2 = &#123;</span><br><span class="line">        &#123;name = <span class="string">&quot;语文&quot;</span>, score = <span class="number">90</span>&#125;,</span><br><span class="line">        &#123;name = <span class="string">&quot;数学&quot;</span>, score = <span class="number">80</span>&#125;,</span><br><span class="line">        &#123;name = <span class="string">&quot;英语&quot;</span>, score = <span class="number">70</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">template.render(<span class="string">&quot;view.html&quot;</span>, context)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;(header.html)&#125;  </span><br><span class="line">   <span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line">       不转义变量输出   </span><br><span class="line">      姓名：&#123;* string.upper(name) *&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">       转义变量输出   </span><br><span class="line">      简介：&#123;&#123;description&#125;&#125;</span><br><span class="line">           简介：&#123;* description *&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">       可以做一些运算   </span><br><span class="line">      年龄: &#123;* age + 10 *&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">       循环输出   </span><br><span class="line">      爱好：  </span><br><span class="line">      &#123;% for i, v in ipairs(hobby) do %&#125;  </span><br><span class="line">         &#123;% if v == &#x27;电影&#x27; then  %&#125; - xxoo</span><br><span class="line">            </span><br><span class="line">              &#123;%else%&#125;  - &#123;* v *&#125; </span><br><span class="line">&#123;% end %&#125;  </span><br><span class="line">         </span><br><span class="line">      &#123;% end %&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">      成绩：  </span><br><span class="line">      &#123;% local i = 1; %&#125;  </span><br><span class="line">      &#123;% for k, v in pairs(score) do %&#125;  </span><br><span class="line">         &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">         &#123;* k *&#125; = &#123;* v *&#125;  </span><br><span class="line">         &#123;% i = i + 1 %&#125;  </span><br><span class="line">      &#123;% end %&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">      成绩2：  </span><br><span class="line">      &#123;% for i = 1, #score2 do local t = score2[i] %&#125;  </span><br><span class="line">         &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">          &#123;* t.name *&#125; = &#123;* t.score *&#125;  </span><br><span class="line">      &#123;% end %&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">       中间内容不解析   </span><br><span class="line">      &#123;-raw-&#125;&#123;(file)&#125;&#123;-raw-&#125;  </span><br><span class="line">&#123;(footer.html)&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="layout-布局统一风格"><a href="#layout-布局统一风格" class="headerlink" title="layout 布局统一风格"></a>layout 布局统一风格</h4><p>使用模板内容嵌套可以实现全站风格同一布局</p>
<h5 id="lua"><a href="#lua" class="headerlink" title="lua"></a>lua</h5><p><code>local template = require &quot;resty.template&quot;</code></p>
<p>一、</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local layout   = template.new &quot;layout.html&quot;</span><br><span class="line"></span><br><span class="line">layout.title   = &quot;Testing lua-resty-template&quot;</span><br><span class="line"></span><br><span class="line">layout.view    = template.compile &quot;view.html&quot; &#123; message = &quot;Hello, World!&quot; &#125;</span><br><span class="line"></span><br><span class="line">layout:render()</span><br></pre></td></tr></table></figure>

<p>二、</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">template.render(&quot;layout.html&quot;, &#123;</span><br><span class="line"></span><br><span class="line">  title = &quot;Testing lua-resty-template&quot;,</span><br><span class="line"></span><br><span class="line">  msg = &quot;type=2&quot;,</span><br><span class="line"></span><br><span class="line">  view  = template.compile &quot;view.html&quot; &#123; message = &quot;Hello, World!&quot; &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>三、</p>
<p>此方式重名变量值会被覆盖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local view     = template.new(&quot;view.html&quot;, &quot;layout.html&quot;)</span><br><span class="line"></span><br><span class="line">view.title     = &quot;Testing lua-resty-template&quot;</span><br><span class="line"></span><br><span class="line">view.msg = &quot;type=3&quot;</span><br><span class="line"></span><br><span class="line">view.message   = &quot;Hello, World!&quot;</span><br><span class="line"></span><br><span class="line">view:render()</span><br></pre></td></tr></table></figure>

<p>四、</p>
<p>可以区分一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local layout   = template.new &quot;layout.html&quot;</span><br><span class="line"></span><br><span class="line">layout.title   = &quot;Testing lua-resty-template&quot;</span><br><span class="line"></span><br><span class="line">layout.msg = &quot;type=4&quot;</span><br><span class="line"></span><br><span class="line">local view     = template.new(&quot;view.html&quot;, layout)</span><br><span class="line"></span><br><span class="line">view.message   = &quot;Hello, World!&quot;</span><br><span class="line"></span><br><span class="line">view:render()</span><br></pre></td></tr></table></figure>

<h5 id="layout-html"><a href="#layout-html" class="headerlink" title="layout.html"></a>layout.html</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line"></span><br><span class="line">​    &lt;title&gt;&#123;&#123;title&#125;&#125;&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;layout&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">​    &#123;*view*&#125;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h5 id="view-html"><a href="#view-html" class="headerlink" title="view.html"></a>view.html</h5><p><code>msg:&#123;&#123;message&#125;&#125;</code></p>
<h5 id="多级嵌套"><a href="#多级嵌套" class="headerlink" title="多级嵌套"></a>多级嵌套</h5><p>lua</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">local view     = template.new(&quot;view.html&quot;, &quot;layout.html&quot;)</span><br><span class="line"></span><br><span class="line">view.title     = &quot;Testing lua-resty-template&quot;</span><br><span class="line"></span><br><span class="line">view.message   = &quot;Hello, World!&quot;</span><br><span class="line"></span><br><span class="line">view:render()</span><br><span class="line"></span><br><span class="line">view.html</span><br><span class="line"></span><br><span class="line">&#123;% layout=&quot;section.html&quot; %&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>msg:&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>section.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag"><span class="attr">id</span>=<span class="string">&quot;section&quot;</span>&gt;</span></span><br><span class="line">    &#123;view&#125; - sss</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>layout.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>  </span><br><span class="line">    ​    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>layout &#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">​    &#123;view&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Redis缓存-mysql-模板输出"><a href="#Redis缓存-mysql-模板输出" class="headerlink" title="Redis缓存+mysql+模板输出"></a>Redis缓存+mysql+模板输出</h4><p>lua</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  cjson = require &quot;cjson&quot;</span><br><span class="line">sql=&quot;select * from t_emp&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local redis = require &quot;resty.redis&quot;</span><br><span class="line">                local red = redis:new()</span><br><span class="line"></span><br><span class="line">                red:set_timeouts(1000, 1000, 1000) -- 1 sec</span><br><span class="line"></span><br><span class="line">  local ok, err = red:connect(&quot;127.0.0.1&quot;, 6379)</span><br><span class="line"> if not ok then</span><br><span class="line">                    ngx.say(&quot;failed to connect: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">                local res, err = red:get(sql)</span><br><span class="line">                if not res then</span><br><span class="line">                    ngx.say(&quot;failed to get sql: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                if res == ngx.null then</span><br><span class="line">                    ngx.say(&quot;sql&quot;..sql..&quot; not found.&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--mysql查询</span><br><span class="line">local mysql = require &quot;resty.mysql&quot;</span><br><span class="line">                local db, err = mysql:new()</span><br><span class="line">                if not db then</span><br><span class="line">                    ngx.say(&quot;failed to instantiate mysql: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                db:set_timeout(1000) -- 1 sec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                local ok, err, errcode, sqlstate = db:connect&#123;</span><br><span class="line">                    host = &quot;192.168.44.211&quot;,</span><br><span class="line">                    port = 3306,</span><br><span class="line">                    database = &quot;zhangmen&quot;,</span><br><span class="line">                    user = &quot;root&quot;,</span><br><span class="line">                    password = &quot;111111&quot;,</span><br><span class="line">                    charset = &quot;utf8&quot;,</span><br><span class="line">                    max_packet_size = 1024 * 1024,</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                ngx.say(&quot;connected to mysql.&lt;br&gt;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> res, err, errcode, sqlstate =</span><br><span class="line">                    db:query(sql)</span><br><span class="line">                if not res then</span><br><span class="line">                    ngx.say(&quot;bad result: &quot;, err, &quot;: &quot;, errcode, &quot;: &quot;, sqlstate, &quot;.&quot;)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          --ngx.say(&quot;result: &quot;, cjson.encode(res))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      ok, err = red:set(sql, cjson.encode(res))</span><br><span class="line">                if not ok then</span><br><span class="line">                    ngx.say(&quot;failed to set sql: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                ngx.say(&quot;set result: &quot;, ok)</span><br><span class="line"></span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local template = require(&quot;resty.template&quot;)</span><br><span class="line">template.caching(false)</span><br><span class="line">local context = &#123;</span><br><span class="line">    title = &quot;测试&quot;,</span><br><span class="line">    name = &quot;lucy&quot;,</span><br><span class="line">    description = &quot;&lt;script&gt;alert(1);&lt;/script&gt;&quot;,</span><br><span class="line">    age = 40,</span><br><span class="line">    hobby = &#123;&quot;电影&quot;, &quot;音乐&quot;, &quot;阅读&quot;&#125;,</span><br><span class="line">    score = &#123;语文 = 90, 数学 = 80, 英语 = 70&#125;,</span><br><span class="line">    score2 = &#123;</span><br><span class="line">        &#123;name = &quot;语文&quot;, score = 90&#125;,</span><br><span class="line">        &#123;name = &quot;数学&quot;, score = 80&#125;,</span><br><span class="line">        &#123;name = &quot;英语&quot;, score = 70&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">zhangmen=cjson.decode(res)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">template.render(&quot;view.html&quot;, context)</span><br></pre></td></tr></table></figure>

<p>模板</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;(header.html)&#125;  </span><br><span class="line">   &lt;body&gt;  </span><br><span class="line">       不转义变量输出   </span><br><span class="line">      姓名：&#123;* string.upper(name) *&#125;&lt;br/&gt;  </span><br><span class="line">       转义变量输出   </span><br><span class="line"></span><br><span class="line">      年龄: &#123;* age + 10 *&#125;&lt;br/&gt;  </span><br><span class="line">       循环输出   </span><br><span class="line">      爱好：  </span><br><span class="line">      &#123;% for i, v in ipairs(hobby) do %&#125;  </span><br><span class="line">         &#123;% if v == &#x27;电影&#x27; then  %&#125; - xxoo</span><br><span class="line">            </span><br><span class="line">              &#123;%else%&#125;  - &#123;* v *&#125; </span><br><span class="line">&#123;% end %&#125;  </span><br><span class="line">         </span><br><span class="line">      &#123;% end %&#125;&lt;br/&gt;  </span><br><span class="line">  </span><br><span class="line">      成绩：  </span><br><span class="line">      &#123;% local i = 1; %&#125;  </span><br><span class="line">      &#123;% for k, v in pairs(score) do %&#125;  </span><br><span class="line">         &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">         &#123;* k *&#125; = &#123;* v *&#125;  </span><br><span class="line">         &#123;% i = i + 1 %&#125;  </span><br><span class="line">      &#123;% end %&#125;&lt;br/&gt;  </span><br><span class="line">      成绩2：  </span><br><span class="line">      &#123;% for i = 1, #score2 do local t = score2[i] %&#125;  </span><br><span class="line">         &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">          &#123;* t.name *&#125; = &#123;* t.score *&#125;  </span><br><span class="line">      &#123;% end %&#125;&lt;br/&gt;  </span><br><span class="line">       中间内容不解析   </span><br><span class="line">      &#123;-raw-&#125;&#123;(file)&#125;&#123;-raw-&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">掌门：</span><br><span class="line">&#123;* zhangmen *&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#123;% for i = 1, #zhangmen do local z = zhangmen[i] %&#125;  </span><br><span class="line">         &#123;* z.deptId *&#125;,&#123;* z.age *&#125;,&#123;* z.name *&#125;,&#123;* z.empno *&#125;,&lt;br&gt;</span><br><span class="line">      &#123;% end %&#125;&lt;br/&gt;  </span><br><span class="line"></span><br><span class="line">&#123;(footer.html)&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="Lua-开源项目"><a href="#Lua-开源项目" class="headerlink" title="Lua 开源项目"></a>Lua 开源项目</h2><h3 id="WAF"><a href="#WAF" class="headerlink" title="WAF"></a>WAF</h3><p><a target="_blank" rel="noopener" href="https://github.com/unixhot/waf">https://github.com/unixhot/waf</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/loveshell/ngx_lua_waf">https://github.com/loveshell/ngx_lua_waf</a></p>
<p>l   防止 SQL 注入，本地包含，部分溢出，fuzzing 测试，XSS&#x2F;SSRF 等 Web 攻击</p>
<p>l   防止 Apache Bench 之类压力测试工具的攻击</p>
<p>l   屏蔽常见的扫描黑客工具，扫描器</p>
<p>l   屏蔽图片附件类目录执行权限、防止 webshell 上传</p>
<p>l   支持 IP 白名单和黑名单功能，直接将黑名单的 IP 访问拒绝</p>
<p>l   支持 URL 白名单，将不需要过滤的 URL 进行定义</p>
<p>l   支持 User-Agent 的过滤、支持 CC 攻击防护、限制单个 URL 指定时间的访问次数</p>
<p>l   支持支持 Cookie 过滤，URL 与 URL 参数过滤</p>
<p>l   支持日志记录，将所有拒绝的操作，记录到日志中去</p>
<h3 id="Kong-基于Openresty的流量网关"><a href="#Kong-基于Openresty的流量网关" class="headerlink" title="Kong 基于Openresty的流量网关"></a>Kong 基于Openresty的流量网关</h3><p><a target="_blank" rel="noopener" href="https://konghq.com/">https://konghq.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kong/kong">https://github.com/kong/kong</a></p>
<p>Kong 基于 OpenResty，是一个云原生、快速、可扩展、分布式的微服务抽象层（Microservice Abstraction Layer），也叫 API 网关（API Gateway），在 Service Mesh 里也叫 API 中间件（API Middleware）。</p>
<p>Kong 开源于 2015 年，核心价值在于高性能和扩展性。从全球 5000 强的组织统计数据来看，Kong 是现在依然在维护的，在生产环境使用最广泛的 API 网关。</p>
<p>Kong 宣称自己是世界上最流行的开源微服务 API 网关（The World’s Most Popular Open Source Microservice API Gateway）。</p>
<p>核心优势：</p>
<p>l   可扩展：可以方便的通过添加节点水平扩展，这意味着可以在很低的延迟下支持很大的系统负载。</p>
<p>l   模块化：可以通过添加新的插件来扩展 Kong 的能力，这些插件可以通过 RESTful Admin API 来安装和配置。</p>
<p>l   在任何基础架构上运行：Kong 可以在任何地方都能运行，比如在云或混合环境中部署 Kong，单个或全球的数据中心。</p>
<h3 id="APISIX"><a href="#APISIX" class="headerlink" title="APISIX"></a>APISIX</h3><h3 id="ABTestingGateway"><a href="#ABTestingGateway" class="headerlink" title="ABTestingGateway"></a>ABTestingGateway</h3><p><a target="_blank" rel="noopener" href="https://github.com/CNSRE/ABTestingGateway">https://github.com/CNSRE/ABTestingGateway</a></p>
<p>ABTestingGateway 是一个可以动态设置分流策略的网关，关注与灰度发布相关领域，基于 Nginx 和 ngx-lua 开发，使用 Redis 作为分流策略数据库，可以实现动态调度功能。</p>
<p>ABTestingGateway 是新浪微博内部的动态路由系统 dygateway 的一部分，目前已经开源。在以往的基于 Nginx 实现的灰度系统中，分流逻辑往往通过 rewrite 阶段的 if 和 rewrite 指令等实现，优点是性能较高，缺点是功能受限、容易出错，以及转发规则固定，只能静态分流。ABTestingGateway 则采用 ngx-lua，通过启用 lua-shared-dict 和 lua-resty-lock 作为系统缓存和缓存锁，系统获得了较为接近原生 Nginx 转发的性能。</p>
<p>l   支持多种分流方式，目前包括 iprange、uidrange、uid 尾数和指定uid分流</p>
<p>l   支持多级分流，动态设置分流策略，即时生效，无需重启</p>
<p>l   可扩展性，提供了开发框架，开发者可以灵活添加新的分流方式，实现二次开发</p>
<p>l   高性能，压测数据接近原生 Nginx 转发</p>
<p>l   灰度系统配置写在 Nginx 配置文件中，方便管理员配置</p>
<p>l   适用于多种场景：灰度发布、AB 测试和负载均衡等</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">HUA</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/12/28/Nginx/">http://example.com/2022/12/28/Nginx/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">阿华</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/page5.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/20/Netty/"><img class="prev-cover" src="/img/loading.gif" data-original="/img/page6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Netty</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/25/Dubbo/"><img class="next-cover" src="/img/loading.gif" data-original="/img/page4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Dubbo</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/loading.gif" data-original="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">HUA</div><div class="author-info__description">不要放弃</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/TINGTING-GIT" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="tencent://AddContact/?fromld=45&amp;fromSubld=1&amp;subcmd=all&amp;uin=2164277973&amp;website=www.oicqzone.com" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="mailto:2164277973@qq.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><div class="xpand" style="height:200px;"><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div></div><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople1.js"></script><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/zdog.dist.js"></script><script id="rendered-js" src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople.js"></script><style>.card-widget.card-announcement {
margin: 0;
align-items: center;
justify-content: center;
text-align: center;
}
canvas {
display: block;
margin: 0 auto;
cursor: move;
}</style><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E5%9F%BA%E7%A1%80%E7%AF%87"><span class="toc-number">1.</span> <span class="toc-text">Nginx基础篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">虚拟机安装配置配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%99%9A%E6%8B%9F%E6%9C%BACentOS7-4"><span class="toc-number">1.1.1.</span> <span class="toc-text">安装虚拟机CentOS7.4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.2.</span> <span class="toc-text">系统安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.3.</span> <span class="toc-text">Linux配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%8A%E7%BD%91"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">配置上网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%9D%99%E6%80%81ip"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">配置静态ip</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E8%83%BD%E4%B8%8A%E7%BD%91%E7%9A%84%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">不能上网的错误排查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%85%AC%E7%BD%91DNS%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">一些公网DNS服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Centos7-%E9%98%B2%E7%81%AB%E5%A2%99%E7%9A%84%E5%85%B3%E9%97%AD"><span class="toc-number">1.1.3.5.</span> <span class="toc-text">Centos7 防火墙的关闭</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.4.</span> <span class="toc-text">Nginx的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">版本区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">编译安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E5%87%BA%E7%8E%B0%E8%AD%A6%E5%91%8A%E6%88%96%E6%8A%A5%E9%94%99"><span class="toc-number">1.1.4.2.1.</span> <span class="toc-text">如果出现警告或报错</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8nginx"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">启动nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%88%90%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">安装成系统服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">Nginx基础使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.2.</span> <span class="toc-text">基本运行原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.3.</span> <span class="toc-text">Nginx配置与应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E4%B8%8E%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">Nginx 虚拟主机与域名解析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E3%80%81dns%E3%80%81ip%E5%9C%B0%E5%9D%80%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">1.2.3.1.1.</span> <span class="toc-text">域名、dns、ip地址的关系</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#http%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.2.3.1.2.</span> <span class="toc-text">http协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.3.1.3.</span> <span class="toc-text">虚拟主机原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E5%AE%9E%E6%88%98"><span class="toc-number">1.2.3.1.4.</span> <span class="toc-text">域名解析实战</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ServerName%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="toc-number">1.2.3.1.5.</span> <span class="toc-text">ServerName匹配规则</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E5%8C%B9%E9%85%8D"><span class="toc-number">1.2.3.1.5.1.</span> <span class="toc-text">完整匹配</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E5%8C%B9%E9%85%8D"><span class="toc-number">1.2.3.1.5.2.</span> <span class="toc-text">通配符匹配</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E7%BB%93%E6%9D%9F%E5%8C%B9%E9%85%8D"><span class="toc-number">1.2.3.1.5.3.</span> <span class="toc-text">通配符结束匹配</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D"><span class="toc-number">1.2.3.1.5.4.</span> <span class="toc-text">正则匹配</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">1.2.4.</span> <span class="toc-text">反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">在系统结构中的应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E7%9A%84%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">Nginx的反向代理配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">基于反向代理的负载均衡器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.2.4.3.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E2%80%94%E2%80%94%E8%BD%AE%E8%AF%A2"><span class="toc-number">1.2.4.3.2.</span> <span class="toc-text">负载均衡策略——轮询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E2%80%94%E2%80%94weight-%E6%9D%83%E9%87%8D"><span class="toc-number">1.2.4.3.3.</span> <span class="toc-text">负载均衡策略——weight(权重)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%EF%BC%88%E4%B8%8D%E5%B8%B8%E7%94%A8%EF%BC%89"><span class="toc-number">1.2.4.3.4.</span> <span class="toc-text">其他负载均衡策略（不常用）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">动静分离</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.4.4.1.</span> <span class="toc-text">动静分离原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85tomcat"><span class="toc-number">1.2.4.4.2.</span> <span class="toc-text">安装tomcat</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.4.4.3.</span> <span class="toc-text">Nginx动静分离配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E9%85%8D%E7%BD%AE%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.2.4.4.4.</span> <span class="toc-text">使用正则配置动静分离</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84Nginx%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.2.4.4.4.1.</span> <span class="toc-text">常见的Nginx正则表达式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#location%E6%AD%A3%E5%88%99%EF%BC%9A"><span class="toc-number">1.2.4.4.4.2.</span> <span class="toc-text">location正则：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#alias%E4%B8%8Eroot"><span class="toc-number">1.2.4.4.5.</span> <span class="toc-text">alias与root</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URLRewrite"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">URLRewrite</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#URLRewrite%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">1.2.4.5.1.</span> <span class="toc-text">URLRewrite的优缺点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%EF%BC%9A"><span class="toc-number">1.2.4.5.2.</span> <span class="toc-text">实例：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-URLRewrite%E5%AE%9E%E6%88%98"><span class="toc-number">1.2.4.6.</span> <span class="toc-text">负载均衡+URLRewrite实战</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.4.7.</span> <span class="toc-text">防盗链配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.4.7.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.4.7.2.</span> <span class="toc-text">具体实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8curl%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.4.7.3.</span> <span class="toc-text">使用curl测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E9%94%99%E8%AF%AF%E5%9B%BE%E7%89%87%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.2.4.7.4.</span> <span class="toc-text">返回错误图片设置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8AKeepalived%E5%AE%9E%E6%88%98"><span class="toc-number">1.2.5.</span> <span class="toc-text">nginx高可用及Keepalived实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">高可用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E5%9C%BA%E6%99%AF%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.2.5.1.1.</span> <span class="toc-text">高可用场景及解决方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.5.1.2.</span> <span class="toc-text">配置步骤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Https%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.6.</span> <span class="toc-text">Https证书配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84http%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">不安全的http协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Https%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">Https原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.2.6.2.1.</span> <span class="toc-text">对称加密算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.2.6.2.2.</span> <span class="toc-text">非对称加密算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ca%E6%9C%BA%E6%9E%84%E5%8F%82%E4%B8%8E%E4%BF%9D%E8%AF%81%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8"><span class="toc-number">1.2.6.2.3.</span> <span class="toc-text">ca机构参与保证互联网安全</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E7%AD%BE%E5%90%8D"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">自签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7"><span class="toc-number">1.2.6.4.</span> <span class="toc-text">在线证书申请</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E9%AB%98%E7%BA%A7%E7%AF%87"><span class="toc-number">2.</span> <span class="toc-text">Nginx高级篇</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E9%AB%98%E5%B9%B6%E5%8F%91%E7%BD%91%E7%AB%99%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E5%AE%9E%E6%88%98"><span class="toc-number">3.</span> <span class="toc-text">Nginx高并发网站技术架构实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E6%89%A9%E5%AE%B9"><span class="toc-number">3.1.</span> <span class="toc-text">第一部分：扩容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.1.</span> <span class="toc-text">扩容方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8D%95%E6%9C%BA%E5%9E%82%E7%9B%B4%E6%89%A9%E5%AE%B9%EF%BC%9A%E7%A1%AC%E4%BB%B6%E8%B5%84%E6%BA%90%E5%A2%9E%E5%8A%A0"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">1.单机垂直扩容：硬件资源增加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95%EF%BC%9A%E9%9B%86%E7%BE%A4%E5%8C%96"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">2.水平扩展：集群化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86"><span class="toc-number">3.1.1.2.1.</span> <span class="toc-text">会话管理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Nginx%E9%AB%98%E7%BA%A7%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">3.1.1.2.1.1.</span> <span class="toc-text">Nginx高级负载均衡</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8sticky%E6%A8%A1%E5%9D%97%E5%AE%8C%E6%88%90%E5%AF%B9Nginx%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">3.1.1.2.1.2.</span> <span class="toc-text">使用sticky模块完成对Nginx的负载均衡</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KeepAlive"><span class="toc-number">3.1.2.</span> <span class="toc-text">KeepAlive</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E5%90%AF%E7%94%A8keepalive"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">在浏览器查看是否启用keepalive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7charles%E8%BF%9B%E8%A1%8C%E6%8A%93%E5%8C%85%E6%A3%80%E6%B5%8B"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">测试工具charles进行抓包检测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8%EF%BC%9F"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">什么时候使用？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%B8%8D%E7%94%A8%EF%BC%9F"><span class="toc-number">3.1.2.4.</span> <span class="toc-text">什么时候不用？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8keepalive"><span class="toc-number">3.1.2.5.</span> <span class="toc-text">对客户端使用keepalive</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="toc-number">3.1.2.5.1.</span> <span class="toc-text">常用配置选项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E4%B8%8A%E6%B8%B8%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8keepalive"><span class="toc-number">3.1.2.6.</span> <span class="toc-text">对上游服务器使用keepalive</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.2.6.1.</span> <span class="toc-text">相关配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#nginx-cong%E4%B8%AD%E7%9A%84upstream%E4%B8%AD%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.2.6.1.1.</span> <span class="toc-text">nginx.cong中的upstream中配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#nginx-conf%E4%B8%AD%E7%9A%84server%E4%B8%AD%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.2.6.1.2.</span> <span class="toc-text">nginx.conf中的server中配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE%EF%BC%9A"><span class="toc-number">3.1.2.6.1.3.</span> <span class="toc-text">完整配置：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AB%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">3.1.2.6.2.</span> <span class="toc-text">AB压力测试</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.2.6.2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">3.1.2.6.2.2.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.3.</span> <span class="toc-text">Nginx反向代理核心流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Http1-X%E5%8D%8F%E8%AE%AE%E6%8A%A5%E6%96%87%E7%BB%84%E6%88%90"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">Http1.X协议报文组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UpStream%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">UpStream工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E6%95%B0"><span class="toc-number">3.1.3.2.1.</span> <span class="toc-text">参数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">缓冲区</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E6%95%B0-1"><span class="toc-number">3.1.3.3.1.</span> <span class="toc-text">参数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E9%99%90%E5%88%B6"><span class="toc-number">3.1.3.4.</span> <span class="toc-text">对客户端的限制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">3.1.3.4.1.</span> <span class="toc-text">配置参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%AD%E7%9A%84%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6"><span class="toc-number">3.1.4.</span> <span class="toc-text">反向代理中的容错机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-number">3.1.4.1.</span> <span class="toc-text">参考文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">3.1.4.2.</span> <span class="toc-text">重试机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9C%9F%E5%AE%9EIP"><span class="toc-number">3.1.5.</span> <span class="toc-text">获取客户端真实IP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#java%E4%BB%A3%E7%A0%81%E8%8E%B7%E5%8F%96IP"><span class="toc-number">3.1.5.1.</span> <span class="toc-text">java代码获取IP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#X-Real-IP"><span class="toc-number">3.1.5.2.</span> <span class="toc-text">X-Real-IP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setHeader"><span class="toc-number">3.1.5.3.</span> <span class="toc-text">setHeader</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gzip"><span class="toc-number">3.1.6.</span> <span class="toc-text">Gzip</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.6.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%8E%8B%E7%BC%A9"><span class="toc-number">3.1.6.2.</span> <span class="toc-text">动态压缩</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ngx-http-gzip-module"><span class="toc-number">3.1.6.2.1.</span> <span class="toc-text">ngx_http_gzip_module</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.6.2.2.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#gzip-on"><span class="toc-number">3.1.6.2.2.1.</span> <span class="toc-text">gzip on;</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#gzip-buffers-32-4k-16-8k"><span class="toc-number">3.1.6.2.2.2.</span> <span class="toc-text">gzip_buffers 32 4k|16 8k</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#gzip-comp-level-1%EF%BC%9B"><span class="toc-number">3.1.6.2.2.3.</span> <span class="toc-text">gzip_comp_level 1；</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#gzip-http-version-1-1"><span class="toc-number">3.1.6.2.2.4.</span> <span class="toc-text">gzip_http_version 1.1;</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#gzip-min-length-1k%EF%BC%9B"><span class="toc-number">3.1.6.2.2.5.</span> <span class="toc-text">gzip_min_length 1k；</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#gzip-proxied-%E5%A4%9A%E9%80%89"><span class="toc-number">3.1.6.2.2.6.</span> <span class="toc-text">gzip_proxied 多选</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#gzip-vary-on"><span class="toc-number">3.1.6.2.2.7.</span> <span class="toc-text">gzip_vary on;</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#gzip-types-mime-type-mime-type"><span class="toc-number">3.1.6.2.2.8.</span> <span class="toc-text">gzip_types mime-type [mime-type ...]</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#gzip-disable"><span class="toc-number">3.1.6.2.2.9.</span> <span class="toc-text">gzip_disable</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BE%8B"><span class="toc-number">3.1.6.2.3.</span> <span class="toc-text">完整实例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%8E%8B%E7%BC%A9"><span class="toc-number">3.1.6.3.</span> <span class="toc-text">静态压缩</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ngx-http-gunzip-module"><span class="toc-number">3.1.6.3.1.</span> <span class="toc-text">ngx_http_gunzip_module</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-1"><span class="toc-number">3.1.6.3.1.1.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#http-gzip-static-module"><span class="toc-number">3.1.6.3.2.</span> <span class="toc-text">http_gzip_static_module</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-2"><span class="toc-number">3.1.6.3.2.1.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">3.1.6.3.3.</span> <span class="toc-text">案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Brotli"><span class="toc-number">3.1.7.</span> <span class="toc-text">Brotli</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">3.1.7.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-number">3.1.7.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-number">3.1.7.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E8%AF%B7%E6%B1%82"><span class="toc-number">3.1.8.</span> <span class="toc-text">合并请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-2"><span class="toc-number">3.1.8.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Concat%E6%A8%A1%E5%9D%97"><span class="toc-number">3.1.8.2.</span> <span class="toc-text">Concat模块</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-2"><span class="toc-number">3.1.8.2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-number">3.1.8.2.2.</span> <span class="toc-text">配置项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-number">3.1.8.2.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-number">3.1.9.</span> <span class="toc-text">资源静态化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SSI%E5%90%88%E5%B9%B6%E6%96%87%E4%BB%B6%E8%BE%93%E5%87%BA"><span class="toc-number">3.1.9.1.</span> <span class="toc-text">SSI合并文件输出</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="toc-number">3.1.9.1.1.</span> <span class="toc-text">官方文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-3"><span class="toc-number">3.1.9.1.2.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-3"><span class="toc-number">3.1.9.1.3.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="toc-number">3.1.9.1.4.</span> <span class="toc-text">静态文件中使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="toc-number">3.1.9.1.5.</span> <span class="toc-text">案例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rsync%E9%9B%86%E7%BE%A4%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5"><span class="toc-number">3.1.9.2.</span> <span class="toc-text">rsync集群文件同步</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-4"><span class="toc-number">3.1.9.2.1.</span> <span class="toc-text">介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#rsync%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">3.1.9.2.1.1.</span> <span class="toc-text">rsync是什么</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#rsync%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.9.2.1.2.</span> <span class="toc-text">rsync的工作原理</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#rsync-%E5%B8%B8%E7%94%A8%E9%80%89%E9%A1%B9"><span class="toc-number">3.1.9.2.2.</span> <span class="toc-text">rsync 常用选项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#rsync%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.9.2.3.</span> <span class="toc-text">rsync认证方式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#rsync-daemon-%E8%AE%A4%E8%AF%81"><span class="toc-number">3.1.9.2.3.1.</span> <span class="toc-text">rsync-daemon 认证</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ssh%E8%AE%A4%E8%AF%81"><span class="toc-number">3.1.9.2.3.2.</span> <span class="toc-text">ssh认证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rsync%E6%A1%88%E4%BE%8B"><span class="toc-number">3.1.9.3.</span> <span class="toc-text">rsync案例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-3"><span class="toc-number">3.1.9.3.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-4"><span class="toc-number">3.1.9.3.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">3.1.9.3.3.</span> <span class="toc-text">安全认证</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.9.3.3.1.</span> <span class="toc-text">密码文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">3.1.9.3.3.2.</span> <span class="toc-text">开机启动</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%9C%E7%A8%8B%E7%9B%AE%E5%BD%95"><span class="toc-number">3.1.9.3.4.</span> <span class="toc-text">查看远程目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E6%95%B0%E6%8D%AE%E5%88%B0%E6%8C%87%E5%AE%9A%E7%9B%AE%E5%BD%95"><span class="toc-number">3.1.9.3.5.</span> <span class="toc-text">拉取数据到指定目录</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8SSH%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.9.3.5.1.</span> <span class="toc-text">使用SSH方式</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A8%E9%80%81"><span class="toc-number">3.1.9.3.6.</span> <span class="toc-text">推送</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%8D%E5%AF%86"><span class="toc-number">3.1.9.3.6.1.</span> <span class="toc-text">客户端免密</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%8E%A8%E9%80%81%EF%BC%9F"><span class="toc-number">3.1.9.3.6.2.</span> <span class="toc-text">如何实现推送？</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E6%8E%A8%E9%80%81"><span class="toc-number">3.1.9.3.7.</span> <span class="toc-text">实时推送</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8E%A8%E9%80%81%E7%AB%AF%E5%AE%89%E8%A3%85inotify"><span class="toc-number">3.1.9.3.7.1.</span> <span class="toc-text">推送端安装inotify</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="toc-number">3.1.9.3.7.2.</span> <span class="toc-text">简单自动化脚本</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#inotify%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="toc-number">3.1.9.3.7.3.</span> <span class="toc-text">inotify常用参数</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.</span> <span class="toc-text">多级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.1.</span> <span class="toc-text">静态资源缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.2.</span> <span class="toc-text">浏览器缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.10.2.1.</span> <span class="toc-text">浏览器缓存的执行流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%8F%AF%E4%BB%A5%E7%94%A8%E7%BC%93%E5%AD%98%EF%BC%9F"><span class="toc-number">3.1.10.2.2.</span> <span class="toc-text">什么时候可以用缓存？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F%E4%BA%AC%E4%B8%9C%E7%BC%93%E5%AD%98%E5%8F%8A%E5%8A%A0%E8%BD%BD%E9%80%9F%E5%BA%A6"><span class="toc-number">3.1.10.2.3.</span> <span class="toc-text">观察京东缓存及加载速度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Nginx%E9%BB%98%E8%AE%A4%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.2.4.</span> <span class="toc-text">Nginx默认缓存</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.2.5.</span> <span class="toc-text">强制缓存与协商缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%BA%E5%88%B6%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.2.5.1.</span> <span class="toc-text">浏览器强制缓存</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.2.5.2.</span> <span class="toc-text">协商缓存</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E5%85%B3%E9%97%AD%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.10.2.5.3.</span> <span class="toc-text">强制关闭协商缓存的方式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-number">3.1.10.2.5.4.</span> <span class="toc-text">总结：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#last-modified-%E4%B8%8Essi%E7%9A%84%E5%86%B2%E7%AA%81"><span class="toc-number">3.1.10.2.6.</span> <span class="toc-text">last-modified 与ssi的冲突</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E5%8E%9F%E5%88%99"><span class="toc-number">3.1.10.2.7.</span> <span class="toc-text">浏览器缓存原则</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CDN%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.3.</span> <span class="toc-text">CDN缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#GEOip"><span class="toc-number">3.1.10.3.1.</span> <span class="toc-text">GEOip</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">3.1.10.3.1.1.</span> <span class="toc-text">下载数据库</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">3.1.10.3.1.2.</span> <span class="toc-text">安装依赖</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Nginx%E6%A8%A1%E5%9D%97"><span class="toc-number">3.1.10.3.1.3.</span> <span class="toc-text">Nginx模块</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.10.3.1.4.</span> <span class="toc-text">Nginx配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.4.</span> <span class="toc-text">正向代理与反向代理缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">3.1.10.4.1.</span> <span class="toc-text">正向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-number">3.1.10.4.1.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">3.1.10.4.1.2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%A8%E9%80%94"><span class="toc-number">3.1.10.4.1.3.</span> <span class="toc-text">用途</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.10.4.1.4.</span> <span class="toc-text">正向代理配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%A3%E7%90%86https%E8%AF%B7%E6%B1%82"><span class="toc-number">3.1.10.4.1.5.</span> <span class="toc-text">代理https请求</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86-1"><span class="toc-number">3.1.10.4.2.</span> <span class="toc-text">反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2"><span class="toc-number">3.1.10.4.2.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-1"><span class="toc-number">3.1.10.4.2.2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%A8%E9%80%94-1"><span class="toc-number">3.1.10.4.2.3.</span> <span class="toc-text">用途</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86-proxy%E7%BC%93%E5%AD%98"><span class="toc-number">3.1.10.4.3.</span> <span class="toc-text">反向代理-proxy缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-5"><span class="toc-number">3.1.10.4.3.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#proxy-cache%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.1.10.4.3.2.</span> <span class="toc-text">proxy_cache配置详解</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E7%BC%93%E5%AD%98-range"><span class="toc-number">3.1.10.4.3.3.</span> <span class="toc-text">断点续传缓存 range</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%B8%85%E7%90%86"><span class="toc-number">3.1.10.4.3.4.</span> <span class="toc-text">缓存清理</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86-%E9%AB%98%E6%95%88"><span class="toc-number">3.2.</span> <span class="toc-text">第二部分 高效</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98"><span class="toc-number">3.2.1.</span> <span class="toc-text">Nginx内存缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF%E6%8F%90%E9%AB%98sendfile%E6%80%A7%E8%83%BD"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">缓存文件元数据信息提高sendfile性能</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Strace%E5%86%85%E6%A0%B8%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E8%BF%BD%E8%B8%AA%E7%A5%9E%E5%99%A8"><span class="toc-number">3.2.1.1.0.1.</span> <span class="toc-text">Strace内核执行过程追踪神器</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#nginx%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.1.1.0.2.</span> <span class="toc-text">nginx发送文件过程</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#open-file-cache%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="toc-number">3.2.1.1.0.3.</span> <span class="toc-text">open_file_cache配置优化</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%A4%96%E7%BD%AE%E7%BC%93%E5%AD%98%E7%BC%93%E5%AD%98"><span class="toc-number">3.2.2.</span> <span class="toc-text">Nginx外置缓存缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#error-page"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">error_page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BF%E5%90%8Dlocation"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">匿名location</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-memcached"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">nginx + memcached</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#memcached%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.2.3.1.</span> <span class="toc-text">memcached安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.2.3.2.</span> <span class="toc-text">nginx配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-redis"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">nginx + redis</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Redis%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.2.4.1.</span> <span class="toc-text">Redis安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96-1"><span class="toc-number">3.2.2.4.2.</span> <span class="toc-text">安装依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#redis2-nginx-module"><span class="toc-number">3.2.2.4.3.</span> <span class="toc-text">redis2-nginx-module</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-3"><span class="toc-number">3.2.2.4.3.1.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#get"><span class="toc-number">3.2.2.4.3.2.</span> <span class="toc-text">get</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#set"><span class="toc-number">3.2.2.4.3.3.</span> <span class="toc-text">set</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#pipeline"><span class="toc-number">3.2.2.4.3.4.</span> <span class="toc-text">pipeline</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#list"><span class="toc-number">3.2.2.4.3.5.</span> <span class="toc-text">list</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-number">3.2.2.4.3.6.</span> <span class="toc-text">集群</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stream%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.3.</span> <span class="toc-text">Stream模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E6%B5%81"><span class="toc-number">3.2.4.</span> <span class="toc-text">限流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#QPS%E9%99%90%E5%88%B6"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">QPS限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx-%E5%B8%A6%E5%AE%BD%E9%99%90%E5%88%B6"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">Nginx 带宽限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx-%E5%B9%B6%E5%8F%91%E6%95%B0%E9%99%90%E5%88%B6"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">Nginx 并发数限制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">3.2.5.</span> <span class="toc-text">日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ngx-http-log-module"><span class="toc-number">3.2.5.1.</span> <span class="toc-text">ngx_http_log_module</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-access-log-%E6%9D%A5%E8%AE%B0%E5%BD%95%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97"><span class="toc-number">3.2.5.1.1.</span> <span class="toc-text">配置 access_log 来记录访问日志</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-log-format-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.2.5.1.2.</span> <span class="toc-text">使用 log_format 自定义日志格式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ngx-http-empty-gif-module"><span class="toc-number">3.2.5.1.3.</span> <span class="toc-text">ngx_http_empty_gif_module</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#json"><span class="toc-number">3.2.5.1.4.</span> <span class="toc-text">json</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#errorlog"><span class="toc-number">3.2.5.2.</span> <span class="toc-text">errorlog</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%88%86%E5%89%B2"><span class="toc-number">3.2.5.2.1.</span> <span class="toc-text">日志分割</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">3.2.5.3.</span> <span class="toc-text">nginx健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6-1"><span class="toc-number">3.2.5.3.1.</span> <span class="toc-text">重试机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E5%8A%A8%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">3.2.5.3.2.</span> <span class="toc-text">主动健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-6"><span class="toc-number">3.2.5.3.2.1.</span> <span class="toc-text">配置</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Lua%E5%AF%B9Nginx%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91"><span class="toc-number">3.2.6.</span> <span class="toc-text">使用Lua对Nginx二次开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7"><span class="toc-number">3.2.6.1.</span> <span class="toc-text">工具</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#EmmyLua%E6%8F%92%E4%BB%B6"><span class="toc-number">3.2.6.1.1.</span> <span class="toc-text">EmmyLua插件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LDT-%E5%9F%BA%E4%BA%8Eeclipse"><span class="toc-number">3.2.6.1.2.</span> <span class="toc-text">LDT 基于eclipse</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lua%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="toc-number">3.2.6.2.</span> <span class="toc-text">Lua基础语法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hello-world"><span class="toc-number">3.2.6.2.1.</span> <span class="toc-text">hello world</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">3.2.6.2.2.</span> <span class="toc-text">保留关键字</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A"><span class="toc-number">3.2.6.2.3.</span> <span class="toc-text">注释</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.6.2.4.</span> <span class="toc-text">变量</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.2.6.2.4.1.</span> <span class="toc-text">数字类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">3.2.6.2.4.2.</span> <span class="toc-text">字符串</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A9%BA%E5%80%BC"><span class="toc-number">3.2.6.2.4.3.</span> <span class="toc-text">空值</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.2.6.2.4.4.</span> <span class="toc-text">布尔类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">3.2.6.2.4.5.</span> <span class="toc-text">作用域</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5"><span class="toc-number">3.2.6.2.5.</span> <span class="toc-text">控制语句</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#while%E5%BE%AA%E7%8E%AF"><span class="toc-number">3.2.6.2.5.1.</span> <span class="toc-text">while循环</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#if-else"><span class="toc-number">3.2.6.2.5.2.</span> <span class="toc-text">if-else</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#for%E5%BE%AA%E7%8E%AF"><span class="toc-number">3.2.6.2.5.3.</span> <span class="toc-text">for循环</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.6.2.5.4.</span> <span class="toc-text">函数</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">3.2.6.2.6.</span> <span class="toc-text">返回值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Table"><span class="toc-number">3.2.6.2.7.</span> <span class="toc-text">Table</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E7%BB%84"><span class="toc-number">3.2.6.2.8.</span> <span class="toc-text">数组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%8D%E5%8E%86"><span class="toc-number">3.2.6.2.9.</span> <span class="toc-text">遍历</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.6.2.10.</span> <span class="toc-text">成员函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">3.2.6.3.</span> <span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Openresty-Nginx-Lua"><span class="toc-number">3.2.7.</span> <span class="toc-text">Openresty Nginx + Lua</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-4"><span class="toc-number">3.2.7.1.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%84%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.7.1.1.</span> <span class="toc-text">预编译安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.7.1.2.</span> <span class="toc-text">源码编译安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD"><span class="toc-number">3.2.7.1.3.</span> <span class="toc-text">下载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%91%BD%E4%BB%A4"><span class="toc-number">3.2.7.1.4.</span> <span class="toc-text">服务命令</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">3.2.7.1.4.1.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2"><span class="toc-number">3.2.7.1.4.2.</span> <span class="toc-text">停止</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE"><span class="toc-number">3.2.7.1.4.3.</span> <span class="toc-text">检查配置文件是否正确</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E5%AE%89%E8%A3%85%E6%A8%A1%E5%9D%97%E5%92%8C%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">3.2.7.1.4.4.</span> <span class="toc-text">查看已安装模块和版本号</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95lua%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.7.2.</span> <span class="toc-text">测试lua脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lua-nginx-module"><span class="toc-number">3.2.7.3.</span> <span class="toc-text">lua-nginx-module</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6lua-conf"><span class="toc-number">3.2.7.3.1.</span> <span class="toc-text">创建配置文件lua.conf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8Nginx-conf%E4%B8%8B%E5%BC%95%E5%85%A5lua%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.7.3.2.</span> <span class="toc-text">在Nginx.conf下引入lua配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%A4%96%E9%83%A8lua%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.7.3.3.</span> <span class="toc-text">创建外部lua脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96Nginx-uri%E4%B8%AD%E7%9A%84%E5%8D%95%E4%B8%80%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.7.3.4.</span> <span class="toc-text">获取Nginx uri中的单一变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96Nginx-uri%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.7.3.5.</span> <span class="toc-text">获取Nginx uri中的所有变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E5%A4%84%E7%90%86http%E8%AF%B7%E6%B1%82%E6%97%B6%E8%BF%98%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.7.3.6.</span> <span class="toc-text">在处理http请求时还可以使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%83%AD%E9%83%A8%E7%BD%B2"><span class="toc-number">3.2.7.3.7.</span> <span class="toc-text">代码热部署</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96Nginx%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%BF%A1%E6%81%AF"><span class="toc-number">3.2.7.3.8.</span> <span class="toc-text">获取Nginx请求头信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96post%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0"><span class="toc-number">3.2.7.3.9.</span> <span class="toc-text">获取post请求参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#http%E5%8D%8F%E8%AE%AE%E7%89%88%E6%9C%AC"><span class="toc-number">3.2.7.3.10.</span> <span class="toc-text">http协议版本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.7.3.11.</span> <span class="toc-text">请求方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E7%9A%84%E8%AF%B7%E6%B1%82%E5%A4%B4%E5%86%85%E5%AE%B9"><span class="toc-number">3.2.7.3.12.</span> <span class="toc-text">原始的请求头内容</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#body%E5%86%85%E5%AE%B9%E4%BD%93"><span class="toc-number">3.2.7.3.13.</span> <span class="toc-text">body内容体</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Openresty%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.8.</span> <span class="toc-text">Openresty常用模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E7%BC%93%E5%AD%98"><span class="toc-number">3.2.8.1.</span> <span class="toc-text">Nginx缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Nginx%E5%85%A8%E5%B1%80%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98"><span class="toc-number">3.2.8.1.1.</span> <span class="toc-text">Nginx全局内存缓存</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#lua-resty-lrucache"><span class="toc-number">3.2.8.1.2.</span> <span class="toc-text">lua-resty-lrucache</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lua-resty-redis%E8%AE%BF%E9%97%AEredis"><span class="toc-number">3.2.8.2.</span> <span class="toc-text">lua-resty-redis访问redis</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.8.2.1.</span> <span class="toc-text">常用方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.2.8.2.2.</span> <span class="toc-text">创建连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#timeout"><span class="toc-number">3.2.8.2.3.</span> <span class="toc-text">timeout</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#keepalive"><span class="toc-number">3.2.8.2.4.</span> <span class="toc-text">keepalive</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#close"><span class="toc-number">3.2.8.2.5.</span> <span class="toc-text">close</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pipeline-1"><span class="toc-number">3.2.8.2.6.</span> <span class="toc-text">pipeline</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">3.2.8.2.7.</span> <span class="toc-text">认证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#redis-cluster%E6%94%AF%E6%8C%81"><span class="toc-number">3.2.8.2.8.</span> <span class="toc-text">redis-cluster支持</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis2-nginx-module-1"><span class="toc-number">3.2.8.3.</span> <span class="toc-text">redis2-nginx-module</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#test"><span class="toc-number">3.2.8.3.1.</span> <span class="toc-text">test</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#get-1"><span class="toc-number">3.2.8.3.2.</span> <span class="toc-text">get</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set-1"><span class="toc-number">3.2.8.3.3.</span> <span class="toc-text">set</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pipeline-2"><span class="toc-number">3.2.8.3.4.</span> <span class="toc-text">pipeline</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#list-1"><span class="toc-number">3.2.8.3.5.</span> <span class="toc-text">list</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4-1"><span class="toc-number">3.2.8.3.6.</span> <span class="toc-text">集群</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lua-resty-mysql"><span class="toc-number">3.2.8.4.</span> <span class="toc-text">lua-resty-mysql</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%AE%9E%E6%97%B6%E6%B8%B2%E6%9F%93-lua-resty-template"><span class="toc-number">3.2.9.</span> <span class="toc-text">模板实时渲染 lua-resty-template</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#lua%E4%BB%A3%E7%A0%81%E7%83%AD%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.2.9.1.</span> <span class="toc-text">lua代码热加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-4"><span class="toc-number">3.2.9.2.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.2.9.2.1.</span> <span class="toc-text">一、初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0%EF%BC%8C%E5%BE%97%E5%88%B0%E6%B8%B2%E6%9F%93%E4%B9%8B%E5%90%8E%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">3.2.9.2.2.</span> <span class="toc-text">二、执行函数，得到渲染之后的内容</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E5%AD%98%E6%94%BE%E4%BD%8D%E7%BD%AE"><span class="toc-number">3.2.9.2.3.</span> <span class="toc-text">模板文件存放位置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#nginx-conf%E4%B8%AD%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.9.2.3.1.</span> <span class="toc-text">nginx.conf中配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#resty-template-html"><span class="toc-number">3.2.9.3.</span> <span class="toc-text">resty.template.html</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%86%85%E5%AE%B9"><span class="toc-number">3.2.9.4.</span> <span class="toc-text">模板内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%80%BC%E4%BC%A0%E5%85%A5"><span class="toc-number">3.2.9.5.</span> <span class="toc-text">多值传入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%86%85%E5%AE%B9-1"><span class="toc-number">3.2.9.6.</span> <span class="toc-text">模板内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E7%AE%A1%E7%90%86%E4%B8%8E%E7%BC%93%E5%AD%98"><span class="toc-number">3.2.9.7.</span> <span class="toc-text">模板管理与缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.2.9.8.</span> <span class="toc-text">完整页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.2.9.9.</span> <span class="toc-text">模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#layout-%E5%B8%83%E5%B1%80%E7%BB%9F%E4%B8%80%E9%A3%8E%E6%A0%BC"><span class="toc-number">3.2.9.10.</span> <span class="toc-text">layout 布局统一风格</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lua"><span class="toc-number">3.2.9.10.1.</span> <span class="toc-text">lua</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#layout-html"><span class="toc-number">3.2.9.10.2.</span> <span class="toc-text">layout.html</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#view-html"><span class="toc-number">3.2.9.10.3.</span> <span class="toc-text">view.html</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E5%B5%8C%E5%A5%97"><span class="toc-number">3.2.9.10.4.</span> <span class="toc-text">多级嵌套</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E7%BC%93%E5%AD%98-mysql-%E6%A8%A1%E6%9D%BF%E8%BE%93%E5%87%BA"><span class="toc-number">3.2.9.11.</span> <span class="toc-text">Redis缓存+mysql+模板输出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua-%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.3.</span> <span class="toc-text">Lua 开源项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WAF"><span class="toc-number">3.3.1.</span> <span class="toc-text">WAF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kong-%E5%9F%BA%E4%BA%8EOpenresty%E7%9A%84%E6%B5%81%E9%87%8F%E7%BD%91%E5%85%B3"><span class="toc-number">3.3.2.</span> <span class="toc-text">Kong 基于Openresty的流量网关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APISIX"><span class="toc-number">3.3.3.</span> <span class="toc-text">APISIX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ABTestingGateway"><span class="toc-number">3.3.4.</span> <span class="toc-text">ABTestingGateway</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/11/20/%E4%BD%8D%E8%BF%90%E7%AE%97/" title="位运算"><img src="/img/loading.gif" data-original="/img/page4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="位运算"/></a><div class="content"><a class="title" href="/2023/11/20/%E4%BD%8D%E8%BF%90%E7%AE%97/" title="位运算">位运算</a><time datetime="2023-11-20T10:17:54.000Z" title="发表于 2023-11-20 18:17:54">2023-11-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/18/Vue3/" title="Vue3"><img src="/img/loading.gif" data-original="/img/page5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue3"/></a><div class="content"><a class="title" href="/2023/11/18/Vue3/" title="Vue3">Vue3</a><time datetime="2023-11-18T05:59:47.000Z" title="发表于 2023-11-18 13:59:47">2023-11-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/22/LeetCode/" title="无题"><img src="/img/loading.gif" data-original="/img/page4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/10/22/LeetCode/" title="无题">无题</a><time datetime="2023-10-22T06:30:38.513Z" title="发表于 2023-10-22 14:30:38">2023-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/07/HTTP%E7%8A%B6%E6%80%81%E7%A0%81/" title="无题"><img src="/img/loading.gif" data-original="/img/page5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/10/07/HTTP%E7%8A%B6%E6%80%81%E7%A0%81/" title="无题">无题</a><time datetime="2023-10-07T15:09:36.518Z" title="发表于 2023-10-07 23:09:36">2023-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/06/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" title="JUC并发编程"><img src="/img/loading.gif" data-original="/img/page5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JUC并发编程"/></a><div class="content"><a class="title" href="/2023/10/06/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" title="JUC并发编程">JUC并发编程</a><time datetime="2023-10-06T06:55:28.000Z" title="发表于 2023-10-06 14:55:28">2023-10-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By HUA</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script async src="https://npm.elemecdn.com/tzy-blog/lib/js/other/sakura.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/img/loading.gif" data-original="https://fastly.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/theme_f/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://unpkg.zhimg.com/hexo-butterfly-clock/lib/clock.min.js"></script><!-- hexo injector body_end end -->
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(e){e.imageLazyLoadSetting.processImages=t;var n=e.imageLazyLoadSetting.isSPA,i=e.imageLazyLoadSetting.preloadRatio||1,r=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){n&&(r=o());for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(e.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];e=function(){r=r.filter(function(t){return o!==t})},(t=o).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,t.removeAttribute("data-original"),e&&e()},t.src!==i&&(n.src=i))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),e.addEventListener("resize",a),e.addEventListener("orientationchange",a)}(this);</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":20,"vOffset":-20},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>