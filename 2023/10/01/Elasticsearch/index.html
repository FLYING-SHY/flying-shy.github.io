<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>阿华 | 阿华</title><meta name="author" content="HUA"><meta name="copyright" content="HUA"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="一、ES 介绍1、Elasticsearch 是什么Elastic Stack（Elastic技术体系）, 包括 Elasticsearch、 Kibana（提供了功能强大的图形化工具）、 Beats（轻量化数据采集器）和 Logstash（动态数据收集管道）。能够安全可靠地获取任何来源、任何格式的数据，然后实时地对数据进行搜索、分析和可视化。Elastic Stack是ELK Stack的更新换">
<meta property="og:type" content="article">
<meta property="og:title" content="阿华">
<meta property="og:url" content="http://example.com/2023/10/01/Elasticsearch/index.html">
<meta property="og:site_name" content="阿华">
<meta property="og:description" content="一、ES 介绍1、Elasticsearch 是什么Elastic Stack（Elastic技术体系）, 包括 Elasticsearch、 Kibana（提供了功能强大的图形化工具）、 Beats（轻量化数据采集器）和 Logstash（动态数据收集管道）。能够安全可靠地获取任何来源、任何格式的数据，然后实时地对数据进行搜索、分析和可视化。Elastic Stack是ELK Stack的更新换">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/page4.jpg">
<meta property="article:published_time" content="2023-10-01T01:50:57.541Z">
<meta property="article:modified_time" content="2023-10-08T12:44:42.028Z">
<meta property="article:author" content="HUA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/page4.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/10/01/Elasticsearch/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '阿华',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-08 20:44:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-clock/lib/clock.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/loading.gif" data-original="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">阿华</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fa fa-comments"></i><span> 分享</span></a></li><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">50.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>204分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="一、ES-介绍"><a href="#一、ES-介绍" class="headerlink" title="一、ES 介绍"></a>一、ES 介绍</h2><h3 id="1、Elasticsearch-是什么"><a href="#1、Elasticsearch-是什么" class="headerlink" title="1、Elasticsearch 是什么"></a>1、Elasticsearch 是什么</h3><p><strong>Elastic Stack</strong>（Elastic技术体系）, 包括 Elasticsearch、 <strong>Kibana</strong>（提供了功能强大的图形化工具）、 <strong>Beats</strong>（轻量化数据采集器）和 <strong>Logstash</strong>（动态数据收集管道）。能够安全可靠地获取任何来源、任何格式的数据，然后实时地对数据进行搜索、分析和可视化。Elastic Stack是ELK Stack的更新换代产品。</p>
<p><strong>ELK Stack</strong>就是Elasticsearch、Logstash和Kibana。<strong>Elasticsearch是一个搜索和分析引擎</strong>；Logstash是<strong>服务器端数据处理管道</strong>，能够从多个来源<strong>采集数据、转换数据</strong>，然后将数据发送到诸如Elasticsearch等’存储库’中；Kibana则可以让用户在Elasticsearch中使用图形和图表对<strong>数据进行可视化</strong>。</p>
<p>Elaticsearch，简称为 ES， <strong>ES 是一个开源的高扩展的分布式全文搜索引擎</strong>， 是整个 ElasticStack 技术栈的核心。</p>
<p>它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理 PB 级别的数据。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">elastic</span><br><span class="line">英 [ɪˈlæstɪk] 美 [ɪˈlæstɪk]</span><br><span class="line">n. 橡皮圈(或带);松紧带</span><br><span class="line">adj. 橡皮圈(或带)的;有弹性的;有弹力的;灵活的;可改变的;可伸缩的</span><br></pre></td></tr></table></figure>



<h3 id="2、ES-解决了什么问题"><a href="#2、ES-解决了什么问题" class="headerlink" title="2、ES 解决了什么问题"></a>2、ES 解决了什么问题</h3><p>Elasticsearch 是解决<strong>海量数据全文检索</strong>的不二之选。</p>
<h4 id="2-1、不适用场景"><a href="#2-1、不适用场景" class="headerlink" title="2.1、不适用场景"></a>2.1、不适用场景</h4><ul>
<li>管理数据（只用于搜索数据）</li>
<li>事务场景</li>
<li>大单页查询（适用从海量数据中查询小部分数据）</li>
<li>数据实时写入与更新</li>
</ul>
<h4 id="2-2、选型"><a href="#2-2、选型" class="headerlink" title="2.2、选型"></a>2.2、选型</h4><table>
<thead>
<tr>
<th></th>
<th>Elasticsearch</th>
<th>Solr</th>
<th>MongoDB</th>
<th>MySQL</th>
</tr>
</thead>
<tbody><tr>
<td>DB类型</td>
<td>搜索引擎</td>
<td>搜索引擎</td>
<td>文档数据库</td>
<td>关系型数据库</td>
</tr>
<tr>
<td>基于何种框架开发</td>
<td>Lucene</td>
<td>Lucene</td>
<td></td>
<td></td>
</tr>
<tr>
<td>基于何种开发语言</td>
<td>Java</td>
<td>Java</td>
<td>C++</td>
<td>C、C++</td>
</tr>
<tr>
<td>数据结构</td>
<td>FST、Hash等</td>
<td></td>
<td></td>
<td>B+ Tree</td>
</tr>
<tr>
<td>数据格式</td>
<td>Json</td>
<td>Json&#x2F;XML&#x2F;CSV</td>
<td>Json</td>
<td>Row</td>
</tr>
<tr>
<td>分布式支持</td>
<td>原生支持</td>
<td>支持</td>
<td>原生支持</td>
<td>不支持</td>
</tr>
<tr>
<td>数据分区方案</td>
<td>分片</td>
<td>分片</td>
<td>分片</td>
<td>分库分表</td>
</tr>
<tr>
<td>业务系统类型</td>
<td>OLAP（在线分析处理，聚焦于数据分析和预测）</td>
<td>OLAP</td>
<td>OLTP（联机事务处理，注重交易数据的实时处理）</td>
<td>OLTP</td>
</tr>
<tr>
<td>事务支持</td>
<td>不支持</td>
<td>不支持</td>
<td>多文档ACID事务</td>
<td>支持</td>
</tr>
<tr>
<td>数据量级</td>
<td>PB级（拍字节）&#x3D; 1024TB</td>
<td>TB级（太字节）-PB级</td>
<td>PB级</td>
<td>单表2000万</td>
</tr>
<tr>
<td>一致性策略</td>
<td>最终一致性</td>
<td>最终一致性</td>
<td>最终一致性 即时一致性</td>
<td>即时一致性</td>
</tr>
<tr>
<td>擅长领域</td>
<td>海量数据全文检索     大数据聚合分析</td>
<td>大数据全文检索</td>
<td>海量数据CRUD</td>
<td>强一致性    ACID事务</td>
</tr>
<tr>
<td>劣势</td>
<td>不支持事务    写入实时性差</td>
<td>海量数据的性能不如ES    随着数据量的不断增大，稳定性低于ES</td>
<td>弱事务支持    不支持join查询</td>
<td>大数据全文搜索性能低</td>
</tr>
</tbody></table>
<h4 id="2-3、应用场景"><a href="#2-3、应用场景" class="headerlink" title="2.3、应用场景"></a>2.3、应用场景</h4><h5 id="全文搜索引擎"><a href="#全文搜索引擎" class="headerlink" title="全文搜索引擎"></a>全文搜索引擎</h5><p>Google，百度类的网站搜索，它们都是根据网页中的关键字生成索引，我们在搜索的时候输入关键字，它们会将该关键字即索引匹配到的所有网页返回；还有常见的项目中应用日志的搜索等等。对于这些非结构化的数据文本，关系型数据库搜索不是能很好的支持。</p>
<p>一般传统数据库，全文检索都实现的很鸡肋，因为一般也没人用数据库存文本字段。进行全文检索需要扫描整个表，如果数据量大的话即使对 SQL 的语法优化，也收效甚微。建立了索引，但是维护起来也很麻烦，对于 insert 和 update 操作都会重新构建索引。</p>
<p>基于以上原因可以分析得出，在一些生产环境中，使用常规的搜索方式，性能是非常差的：</p>
<ul>
<li><p>搜索的数据对象是大量的非结构化的文本数据。</p>
</li>
<li><p>文件记录量达到数十万或数百万个甚至更多。</p>
</li>
<li><p>支持大量基于交互式文本的查询。</p>
</li>
<li><p>需求非常灵活的全文搜索查询。</p>
</li>
<li><p>对高度相关的搜索结果的有特殊需求，但是没有可用的关系数据库可以满足。</p>
</li>
<li><p>对不同记录类型、非文本数据操作或安全事务处理的需求相对较少的情况。为了解决结构化数据搜索和非结构化数据搜索性能问题，我们就需要专业，健壮，强大的全文搜索引擎 。</p>
</li>
</ul>
<p>这里说到的全文搜索引擎指的是目前广泛应用的主流搜索引擎。它的工作原理是计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。</p>
<h5 id="Elasticsearch-应用案例"><a href="#Elasticsearch-应用案例" class="headerlink" title="Elasticsearch 应用案例"></a>Elasticsearch 应用案例</h5><ol>
<li>GitHub: 2013 年初，抛弃了 Solr，采取 Elasticsearch 来做 PB 级的搜索。 “GitHub 使用Elasticsearch 搜索 20TB 的数据，包括 13 亿文件和 1300 亿行代码”。</li>
<li>维基百科：启动以 Elasticsearch 为基础的核心搜索架构</li>
<li>百度：目前广泛使用 Elasticsearch 作为文本数据分析，采集百度所有服务器上的各类指标数据及用户自定义数据，通过对各种数据进行多维分析展示，辅助定位分析实例异常或业务层面异常。目前覆盖百度内部 20 多个业务线（包括云分析、网盟、预测、文库、直达号、钱包、 风控等），单集群最大 100 台机器， 200 个 ES 节点，每天导入 30TB+数据。</li>
<li>新浪：使用 Elasticsearch 分析处理 32 亿条实时日志。</li>
<li>阿里：使用 Elasticsearch 构建日志采集和分析体系。</li>
<li>Stack Overflow：解决 Bug 问题的网站，全英文，编程人员交流的网站。</li>
</ol>
<h3 id="3、倒排索引"><a href="#3、倒排索引" class="headerlink" title="3、倒排索引"></a>3、倒排索引</h3><p>正排索引（传统）</p>
<table>
<thead>
<tr>
<th>id</th>
<th>content</th>
</tr>
</thead>
<tbody><tr>
<td>1001</td>
<td>my name is zhang san</td>
</tr>
<tr>
<td>1002</td>
<td>my name is li si</td>
</tr>
</tbody></table>
<p>倒排索引</p>
<table>
<thead>
<tr>
<th>keyword</th>
<th>id</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>1001, 1002</td>
</tr>
<tr>
<td>zhang</td>
<td>1001</td>
</tr>
</tbody></table>
<p>Elasticsearch 是面向文档型数据库，一条数据在这里就是一个文档。 为了方便大家理解，我们将 Elasticsearch 里存储文档数据和关系型数据库 MySQL 存储数据的概念进行一个类比</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/146a779da01f53e7f7a8d53132d3c7cf.png" alt="img"></p>
<p>ES 里的 Index 可以看做一个库，而 Types 相当于表， Documents 则相当于表的行。这里 Types 的概念已经被逐渐弱化， Elasticsearch 6.X 中，一个 index 下已经只能包含一个type， Elasticsearch 7.X 中, Type 的概念已经被删除了。</p>
<h2 id="二、ES-安装"><a href="#二、ES-安装" class="headerlink" title="二、ES 安装"></a>二、ES 安装</h2><h3 id="1、基于-Windows-的环境安装"><a href="#1、基于-Windows-的环境安装" class="headerlink" title="1、基于 Windows 的环境安装"></a>1、基于 Windows 的环境安装</h3><h4 id="1-1、安装Java环境"><a href="#1-1、安装Java环境" class="headerlink" title="1.1、安装Java环境"></a>1.1、安装Java环境</h4><h5 id="ES与JDK兼容性"><a href="#ES与JDK兼容性" class="headerlink" title="ES与JDK兼容性"></a>ES与JDK兼容性</h5><table>
<thead>
<tr>
<th></th>
<th>Oracle&#x2F;OpenJDK**&#x2F;AdoptOpenJDK 1.8.0</th>
<th>Oracle&#x2F;OpenJDK** 9</th>
<th>Oracle&#x2F;OpenJDK** 10</th>
<th>Oracle&#x2F;OpenJDK** 11</th>
</tr>
</thead>
<tbody><tr>
<td>ticsearch 5.0.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 5.1.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 5.2.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 5.3.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 5.4.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 5.5.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 5.6.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 6.0.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 6.1.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 6.2.x</td>
<td>✔</td>
<td>✔</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 6.3.x</td>
<td>✔</td>
<td>X</td>
<td>✔</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 6.4.x</td>
<td>✔</td>
<td>X</td>
<td>✔</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 6.5.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 6.6.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 6.7.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 6.8.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.0.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.1.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.2.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.3.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.4.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.5.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.6.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.7.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.8.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.9.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.10.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.11.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.12.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.13.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.14.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.15.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.16.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 7.17.x</td>
<td>✔</td>
<td>X</td>
<td>X</td>
<td>✔</td>
</tr>
<tr>
<td>Elasticsearch 8.0.x</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 8.1.x</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 8.1.x</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 8.2.x</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 8.3.x</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 8.4.x</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>Elasticsearch 8.5.x</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
</tbody></table>
<p>结论：</p>
<ul>
<li>ES 7.x 及之前版本，选择 Java 8</li>
<li>Java 9、Java 10、Java 12 和 Java 13 均为短期版本，不推荐使用</li>
<li>对于ES 8.x ，支持 Java 17 和 Java 18，推荐版本：<ul>
<li>对于ES 8.0：Java版本仅支持 Java 17，别无选择</li>
<li>对于ES 8.1及以上版本：支持Java 17 以及 Java 18，建议 Java 17，因为对应版本的 Logstash 不支持 Java 18。</li>
</ul>
</li>
</ul>
<h5 id="Java下载安装"><a href="#Java下载安装" class="headerlink" title="Java下载安装"></a>Java下载安装</h5><p><a target="_blank" rel="noopener" href="https://es-cn.blog.csdn.net/article/details/126861940">jdk（Windows&#x2F;Mac含M1&#x2F;M2 Arm原生JDK）安装，附各个版本JDK下载链接_arm jdk_Elastic开源社区的博客-CSDN博客</a></p>
<h5 id="Java版本冲突问题"><a href="#Java版本冲突问题" class="headerlink" title="Java版本冲突问题"></a>Java版本冲突问题</h5><p>可以分别对jdk版本定义一个系统变量，然后在Path中导入</p>
<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231001132158826.png" class title="image-20231001132158826">

<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231001132402416.png" class title="image-20231001132402416">



<h4 id="1-2、下载并安装-ES"><a href="#1-2、下载并安装-ES" class="headerlink" title="1.2、下载并安装 ES"></a>1.2、下载并安装 ES</h4><h5 id="下载地址-amp-中文文档"><a href="#下载地址-amp-中文文档" class="headerlink" title="下载地址&amp;中文文档"></a>下载地址&amp;中文文档</h5><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a>? - 下载直接解压</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</a>?</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/enterprise-search/current/start.html">https://www.elastic.co/guide/en/enterprise-search/current/start.html</a>?</p>
<h5 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h5><p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/bee361571f2b48c496dc3a421ea26210.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBARWxhc3RpY-W8gOa6kOekvuWMug==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p>
<h4 id="1-3、启动服务"><a href="#1-3、启动服务" class="headerlink" title="1.3、启动服务"></a>1.3、启动服务</h4><p>双击 bin 目录下的 elasticsearch.bat文件</p>
<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231001135744414.png" class title="image-20231001135744414">

<p>首次启动 Elasticsearch 时，会自动进行以下安全配置：</p>
<ul>
<li>为传输层和 HTTP 层生成 TLS 证书和密钥。</li>
<li>TLS 配置设置被写入elasticsearch.yml</li>
<li>为 elastic 用户生成密码。</li>
<li>为 Kibana 生成一个注册令牌。（有效期为30分钟）</li>
<li>ES位其他节点加入集群生成的访问令牌，当前集群中需要加入新节点时，需要携带此令牌（有效期为 30 分钟）</li>
</ul>
<p>然后您可以启动 Kibana 并输入有效期为 30 分钟的注册令牌。此令牌自动应用 Elasticsearch 集群中的安全设置，使用内置kibana服务帐户向 Elasticsearch 进行身份验证，并将安全配置写入kibana.yml。</p>
<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231001142654557.png" class title="image-20231001142654557">

<blockquote>
<p>默认端口 9200</p>
<p>注：ES 8.X 以后版本默认启动 Security，需要https连接和密码才能访问，可以在conf下的elasticsearch.yml中修改 <strong>xpack.security.enabled: false</strong> 为false以及<strong>xpack.security.transport.ssl: enabled: false</strong></p>
</blockquote>
<p>控制台中文乱码：首先找到es的conf目录下的jvm.options文件，添加以下配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ensure UTF-8 encoding by default (e.g. filenames)</span><br><span class="line">-Dfile.encoding=GBK</span><br></pre></td></tr></table></figure>

<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231001143836772.png" class title="image-20231001143836772">

<blockquote>
<p>注：如果重新启动报错，可以删除 data 以及 config 下的 elasticsearch.keystore 文件，在重新启动</p>
</blockquote>
<h4 id="1-4-、修改默认密码"><a href="#1-4-、修改默认密码" class="headerlink" title="1.4 、修改默认密码"></a>1.4 、修改默认密码</h4><p>8.x在第一次启动的时候会自动生密码。仅在第一次启动时显示，如果需要修改账户密码，需进行以下操作：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">bin/elasticsearch-reset-password</span><br><span class="line"></span><br><span class="line">-a, --auto</span><br><span class="line">将指定用户的密码重置为自动生成的强密码。（默认）</span><br><span class="line">-b, --batch</span><br><span class="line">运行重置密码过程而不提示用户进行验证。</span><br><span class="line">-E &lt;KeyValuePair&gt;</span><br><span class="line">配置标准 Elasticsearch 或 X-Pack 设置。</span><br><span class="line">-f, --force</span><br><span class="line">强制命令针对不健康的集群运行。</span><br><span class="line">-h, --<span class="built_in">help</span></span><br><span class="line">返回所有命令参数。</span><br><span class="line">-i, --interactive</span><br><span class="line">提示输入指定用户的密码。使用此选项显式设置密码。</span><br><span class="line">-s --silent</span><br><span class="line">在控制台中显示最小输出。</span><br><span class="line">-u, --username</span><br><span class="line">本机领域用户或内置用户的用户名。</span><br><span class="line">--url</span><br><span class="line">指定工具用于向 Elasticsearch 提交 API 请求的基本 URL（本地节点的主机名和端口）。默认值由 elasticsearch.yml文件中的设置确定。如果xpack.security.http.ssl.enabled设置为<span class="literal">true</span>，则必须指定 HTTPS URL。</span><br><span class="line">-v --verbose</span><br><span class="line">在控制台中显示详细输出。</span><br></pre></td></tr></table></figure>

<p>如：</p>
<p>为<code>elastic</code>账号自动生成新的随机密码，输出至控制台：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">bin/elasticsearch-reset-password -u elastic</span><br></pre></td></tr></table></figure>

<p>手动指定<code>elastic</code>的新密码：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">bin/elasticsearch-reset-password --username elastic -i</span><br></pre></td></tr></table></figure>

<p>指定服务地址和账户名：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">bin/elasticsearch-reset-password --url <span class="string">&quot;https://172.0.0.3:9200&quot;</span> --username elastic -i</span><br></pre></td></tr></table></figure>



<h4 id="1-5、生产模式与开发模式"><a href="#1-5、生产模式与开发模式" class="headerlink" title="1.5、生产模式与开发模式"></a>1.5、生产模式与开发模式</h4><h5 id="生产模式和开发模式"><a href="#生产模式和开发模式" class="headerlink" title="生产模式和开发模式"></a>生产模式和开发模式</h5><ul>
<li><strong>生产模式</strong>：生产模式是指Elasticsearch 集群用于生产环境的运行模式。在这种模式下，集群需要在生产环境中部署，以便能够处理来自用户的真实请求。生产模式下需要考虑诸如高可用性、故障转移、性能优化和安全等因素。</li>
<li><strong>开发模式</strong>：开发模式是指Elasticsearch 集群用于开发和测试环境的运行模式。在这种模式下，集群可以在本地开发机器上运行，以便开发人员可以测试和调试代码。开发模式下不需要考虑高可用性和性能优化等因素，但需要确保数据安全，避免意外删除或修改数据。</li>
</ul>
<p>在实践中，为了确保生产集群的稳定性和安全性，通常需要在开发模式下进行开发和测试，并在生产环境之前进行充分测试和验证。</p>
<p><strong>总结：</strong></p>
<p>​		生产模式用于生产环境，因此务必要进行严格的引导检查（即：启动项检查），以保证服务后期的扩展性和高可用性等。而开发模式则更强调降低ES的学习和使用成本，因此应尽量避免引导检查等门槛操作。</p>
<h5 id="引导检查"><a href="#引导检查" class="headerlink" title="引导检查"></a>引导检查</h5><p>在Elasticsearch（ES）中，启动项检查是在启动Elasticsearch 进程时进行的一系列检 查，以确保集群可以正常启动和运行。这些检查包括以下几个方面：</p>
<ol>
<li>配置文件检查：Elasticsearch 使用YAML 格式的配置文件来配置集群的各种设置，包括节点名称、网络设置、存储路径等。在启动Elasticsearch 进程时，会检查配置文件的语法和内容是否正确，包括检查配置项是否存在、是否具有有效的值、是否遵循正确的格式等。</li>
<li>内存限制检查：Elasticsearch 在运行时需要占用一定的内存资源，包括堆内存和操作系统的虚拟内存。启动Elasticsearch 进程时，会检查操作系统的虚拟内存限制是否足够，并根据配置文件中的设置来分配堆内存大小，以避免出现内存不足的情况。</li>
<li>网络设置检查：Elasticsearch 集群中的节点之间通过网络进行通信，启动Elasticsearch 进程时，会检查网络设置是否正确配置，包括检查节点名称是否唯一、通信端口是否可用、网络接口是否正确配置等。</li>
<li>存储路径检查：Elasticsearch 会将索引和数据存储在磁盘上，启动Elasticsearch 进 程时，会检查配置文件中指定的存储路径是否存在、是否有足够的权限，以确保索引和数据能够正常存储和访问。</li>
<li>插件检查：Elasticsearch 支持插件来扩展其功能，启动Elasticsearch 进程时，会检 查配置文件中指定的插件是否存在、是否与当前版本兼容，以确保插件能够正确加载和运行。</li>
</ol>
<p>如果启动项检查中存在任何错误或异常，Elasticsearch 可能会拒绝启动或显示错误信息，需要根据错误信息进行相应的修复或调整，以确保集群可以正常启动和运行。</p>
<h5 id="单节点发现"><a href="#单节点发现" class="headerlink" title="单节点发现"></a>单节点发现</h5><p>单节点发现是 ES 为降低 ES 的使用门槛而提供的一种启动方式，在单节点发现模式下，节点将选举自己为主节点，并且不允许其他任何节点加入，也不会加入其他任何集群。</p>
<p>配置单节点发现的方式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">discovery.type: single-node</span><br></pre></td></tr></table></figure>



<h4 id="1-6、单节点集群"><a href="#1-6、单节点集群" class="headerlink" title="1.6、单节点集群"></a>1.6、单节点集群</h4><h5 id="关闭-Security和SSL"><a href="#关闭-Security和SSL" class="headerlink" title="关闭 Security和SSL"></a>关闭 Security和SSL</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xpack.security.enabled: false</span><br><span class="line">// 关闭 SSL</span><br><span class="line">xpack.security.transport.ssl:</span><br><span class="line">  enabled: false</span><br></pre></td></tr></table></figure>

<p>关闭之后就不需要输入密码和Https连接了</p>
<h5 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h5><ol>
<li>cluster.name：集群名称，默认为 elasticsearch，是确认集群的依据</li>
<li>node.name：节点名称，默认为主机名，同一个集群之间不能重复</li>
<li>http.port：服务端口号，默认为 9200，多节点依次递增，是访问服务的端口</li>
<li>transport.port：节点之间的通信端口，默认为9300，多节点之间依次递增</li>
</ol>
<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231001153815747.png" class title="image-20231001153815747">



<h5 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h5><p>直接双击 bin 目录下的 elasticsearch.bat文件，或者在 PowerShell 下执行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.\bin elasticsearch.bat</span><br></pre></td></tr></table></figure>



<h5 id="验证服务状态"><a href="#验证服务状态" class="headerlink" title="验证服务状态"></a>验证服务状态</h5><img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231001153833130.png" class title="image-20231001153833130">



<h4 id="1-7、多节点集群"><a href="#1-7、多节点集群" class="headerlink" title="1.7、多节点集群"></a>1.7、多节点集群</h4><h5 id="自动发现策略"><a href="#自动发现策略" class="headerlink" title="自动发现策略"></a>自动发现策略</h5><p>在ES中，自动发现策略是指<strong>如何自动检测和识别新的节点加入或节点离开集群的过程</strong>，以确保集群的可靠性和稳定性。</p>
<p>ES使用多播（multicast）和单播（unicast）两种方式进行节点的发现。</p>
<ul>
<li><strong>多播</strong>：多播是一种在局域网中广播消息的方式，ES可以通过多播协议向局域网内的其他节点发送广播消息，以检测新节点的加入或节点离开。新节点可以通过监听特定的多播地址和端口来加入集群，从而实现自动发现。但是，多播可能受到网络环境的限制，如防火墙配置和路由器设置，可能会导致多播消息无法传递，从而影响自动发现的可靠性。</li>
<li><strong>单播</strong>：单播是一种点对点的通信方式，ES可以通过在配置文件中指定预定义的节点列表，定期向这些节点发送单播请求来进行节点的自动发现。这样，新节点可以直接通过与预定义节点的单播通信来加入集群。单播方式相对于多播方式更加灵活，不受网络环境的限制，但需要手动配置节点列表，管理起来可能会更加繁琐。</li>
</ul>
<p>需要注意的是，自动发现策略在ES的配置中可以进行灵活的设置，可以根据具体的需求和网络环境选择合适的方式。另外，ES还支持使用插件或第三方工具进行自动发现，例如使用ZooKeeper、Consul等外部服务进行节点的自动发现。</p>
<h5 id="本地多项目集群"><a href="#本地多项目集群" class="headerlink" title="本地多项目集群"></a>本地多项目集群</h5><p>解压多个 ES 文件，每个作为一个节点，分别修改每个节点的配置。</p>
<blockquote>
<p>也可以不配置直接启动，因为 ES 原生支持分布式，会自动分配到一个集群，以及分配端口</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#节点 1 的配置信息：</span><br><span class="line">#集群名称，节点之间要保持一致</span><br><span class="line">cluster.name: my-elasticsearch</span><br><span class="line">#节点名称，集群内要唯一</span><br><span class="line">node.name: node-1</span><br><span class="line">node.master: true</span><br><span class="line">node.data: true</span><br><span class="line">#ip 地址</span><br><span class="line">network.host: localhost</span><br><span class="line">#http 端口</span><br><span class="line">http.port: 1001</span><br><span class="line">#tcp 监听端口</span><br><span class="line">transport.tcp.port: 9301</span><br><span class="line">#discovery.seed_hosts: [&quot;localhost:9301&quot;, &quot;localhost:9302&quot;,&quot;localhost:9303&quot;]</span><br><span class="line">#discovery.zen.fd.ping_timeout: 1m</span><br><span class="line">#discovery.zen.fd.ping_retries: 5</span><br><span class="line">#集群内的可以被选为主节点的节点列表</span><br><span class="line">#cluster.initial_master_nodes: [&quot;node-1&quot;, &quot;node-2&quot;,&quot;node-3&quot;]</span><br><span class="line">#跨域配置</span><br><span class="line">#action.destructive_requires_name: true</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure>

<p>可以直接一个一个点击运行启动，也可编写脚本 .bat 启动：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">start D:\WorkSpace\StudySkill_Env\elasticsearch-8.10.2-1\bin</span><br><span class="line">start D:\WorkSpace\StudySkill_Env\elasticsearch-8.10.2-2\bin</span><br><span class="line">start D:\WorkSpace\StudySkill_Env\elasticsearch-8.10.2-3\bin</span><br></pre></td></tr></table></figure>

<ul>
<li>优点：一劳永逸，不需要每次执行很多命令</li>
<li>缺点：浪费大量磁盘空间</li>
</ul>
<p><strong>测试</strong></p>
<p>向集群中的node-1节点增加索引：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#PUT http://127.0.0.1:1001/user</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;acknowledged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shards_acknowledged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>向集群中的node-3节点获取索引：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#GET http://127.0.0.1:1003/user</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;creation_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1617993035885&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;XJKERwQlSJ6aUxZEN2EV0w&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7080099&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;provided_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h5 id="本地单项目集群"><a href="#本地单项目集群" class="headerlink" title="本地单项目集群"></a>本地单项目集群</h5><p>只解压一个 ES 文件，使用命令分别执行多次来进行启动不同节点：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">.\elasticsearch.bat -Epath.data=../node1/data -Epath.logs=../node1/log -Enode.name=node1 -Ecluster.name=elastic -Ehttp.port=9201 -Etransport.port=9301 -Expack.security.enabled=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">.\elasticsearch.bat -Epath.data=../node2/data -Epath.logs=../node2/log -Enode.name=node2 -Ecluster.name=elastic -Ehttp.port=9202 -Etransport.port=9302 -Expack.security.enabled=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">.\elasticsearch.bat -Epath.data=../node3/data -Epath.logs=../node3/log -Enode.name=node3 -Ecluster.name=elastic -Ehttp.port=9203 -Etransport.port=9303 -Expack.security.enabled=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>优点：节省磁盘空间</li>
<li>缺点：启动麻烦，容易出错</li>
</ul>
<h4 id="1-8、安装和部署-Kibana"><a href="#1-8、安装和部署-Kibana" class="headerlink" title="1.8、安装和部署 Kibana"></a>1.8、安装和部署 Kibana</h4><p>下载地址：</p>
<ul>
<li>最新版本：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/kibana">https://www.elastic.co/cn/downloads/kibana</a>?</li>
<li>历史版本：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#kibana">https://www.elastic.co/cn/downloads/past-releases#kibana</a></li>
</ul>
<p>双击 config 文件下的 kibana.bat 启动</p>
<h4 id="1-9、常用客户端工具"><a href="#1-9、常用客户端工具" class="headerlink" title="1.9、常用客户端工具"></a>1.9、常用客户端工具</h4><p>PostMan：下载：<a target="_blank" rel="noopener" href="https://www.postman.com/">https://www.postman.com/</a></p>
<p>ApiPost：下载：<a target="_blank" rel="noopener" href="https://www.apipost.cn/">https://www.apipost.cn/</a></p>
<p>Head：Chrome 地址：<a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/multi-elasticsearch-head/cpmmilfkofbeimbmgiclohpodggeheim">传送门</a></p>
<p>ElasticVUE：Chrome 地址：<a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/elasticvue/hkedbapjpblbodpgbajblpnlpenaebaa">传送门</a>，Edge 地址：<a target="_blank" rel="noopener" href="https://microsoftedge.microsoft.com/addons/search/elasticvue?hl=zh-CN">传送门</a></p>
<h3 id="2、基于-Linux-的环境安装"><a href="#2、基于-Linux-的环境安装" class="headerlink" title="2、基于 Linux 的环境安装"></a>2、基于 Linux 的环境安装</h3><h4 id="2-1、构建虚拟机环境"><a href="#2-1、构建虚拟机环境" class="headerlink" title="2.1、构建虚拟机环境"></a>2.1、构建虚拟机环境</h4><p>下载地址：</p>
<ul>
<li>Windows &amp; Linux：<a target="_blank" rel="noopener" href="https://www.vmware.com/cn/products/workstation-pro/workstation-pro-evaluation.html">WMware Workstation 16 Pro</a></li>
<li>MacOS：<a target="_blank" rel="noopener" href="https://www.vmware.com/cn/products/fusion.html">WMware Fusion</a></li>
</ul>
<h4 id="2-2、构建-CentOS-镜像"><a href="#2-2、构建-CentOS-镜像" class="headerlink" title="2.2、构建 CentOS 镜像"></a>2.2、构建 CentOS 镜像</h4><h5 id="下载系统镜像"><a href="#下载系统镜像" class="headerlink" title="下载系统镜像"></a>下载系统镜像</h5><p>下载地址：<a target="_blank" rel="noopener" href="https://centos.org/download/">https://centos.org/download/</a></p>
<p>选择符合符合你电脑的指令集版本，比如我的CPU是 x86_64架构</p>
<h5 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h5><p>配置网卡信息</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-ens33</span><br></pre></td></tr></table></figure>

<p>内容配置为以下信息，ip 地址根据你本地环境而定</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TYPE=&quot;Ethernet&quot;</span><br><span class="line">PROXY_METHOD=&quot;none&quot;</span><br><span class="line">BROWSER_ONLY=&quot;no&quot;</span><br><span class="line">BOOTPROTO=&quot;none&quot; #关闭DHCP</span><br><span class="line">DEFROUTE=&quot;yes&quot;</span><br><span class="line">IPV4_FAILURE_FATAL=&quot;no&quot;</span><br><span class="line">IPV6INIT=&quot;yes&quot;</span><br><span class="line">IPV6_AUTOCONF=&quot;yes&quot;</span><br><span class="line">IPV6_DEFROUTE=&quot;yes&quot;</span><br><span class="line">IPV6_FAILURE_FATAL=&quot;no&quot;</span><br><span class="line">IPV6_ADDR_GEN_MODE=&quot;stable-privacy&quot;</span><br><span class="line">NAME=&quot;ens33&quot;</span><br><span class="line">UUID=&quot;6dcded77-ba54-4f70-a16c-80535656ba86&quot;</span><br><span class="line">DEVICE=&quot;ens33&quot;</span><br><span class="line">ONBOOT=&quot;yes&quot;</span><br><span class="line">IPADDR=&quot;192.168.3.81&quot; #修改每个节点的ip地址</span><br><span class="line">PREFIX=&quot;24&quot;</span><br><span class="line">GATEWAY=&quot;192.168.3.1&quot;</span><br><span class="line">DNS1=&quot;114.114.114.114&quot;</span><br><span class="line">DOMAIN=&quot;8.8.8.8&quot;</span><br><span class="line">IPV6_PRIVACY=&quot;no&quot;</span><br></pre></td></tr></table></figure>

<p>重启网络服务，使用SSH客户端创建连接</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service network restart</span><br></pre></td></tr></table></figure>

<p>安装必要的工具软件比如：vim、wget 等，视个人情况选择安装</p>
<p>配置基础运行环境，配置 java 环境，<a target="_blank" rel="noopener" href="https://blog.csdn.net/wlei0618/article/details/124930218?ops_request_misc=%7B%22request_id%22:%22165398867416782390530796%22,%22scm%22:%2220140713.130102334.pc_blog.%22%7D&request_id=165398867416782390530796&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-2-124930218-null-null.nonecase&utm_term=%E5%85%BC%E5%AE%B9%E6%80%A7&spm=1018.2226.3001.4450">兼容性列表</a></p>
<h4 id="2-3、构建-ES-运行环境（单节点部署Once）"><a href="#2-3、构建-ES-运行环境（单节点部署Once）" class="headerlink" title="2.3、构建 ES 运行环境（单节点部署Once）"></a>2.3、构建 ES 运行环境（单节点部署Once）</h4><h5 id="下载与解压"><a href="#下载与解压" class="headerlink" title="下载与解压"></a>下载与解压</h5><ol>
<li>下载到虚拟机 <code>wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.7.0-linux-x86_64.tar.gz</code></li>
<li>进行解压 <em>tar -zxvf …..</em></li>
<li>进入解压的目录使用 <em>.&#x2F;bin&#x2F;elasticsearch</em> 运行</li>
<li>启动成功之后关闭，修改config目录下的elasticsearch.yml中的 <em>xpack.security.enabled: false</em></li>
<li>在启动，另外开一个窗口进行查看<em>curl “<a href="http://127.0.0.1:9200&quot;">http://127.0.0.1:9200&quot;</a></em></li>
</ol>
<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231001204012986.png" class title="image-20231001204012986">



<h5 id="Elastic-账号"><a href="#Elastic-账号" class="headerlink" title="Elastic  账号"></a>Elastic  账号</h5><p>创建 <code>elastic</code>账号</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">useradd elastic</span><br></pre></td></tr></table></figure>

<p>设置 <code>elastic</code>账号的密码：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">passwd elastic</span><br></pre></td></tr></table></figure>

<p>为账号赋予目录权限：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chown</span> -R elastic:elastic &#123;&#123;espath&#125;&#125;</span><br></pre></td></tr></table></figure>



<h5 id="常见问题及解决方案"><a href="#常见问题及解决方案" class="headerlink" title="常见问题及解决方案"></a>常见问题及解决方案</h5><p><strong>1、禁用 Swapping：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bootstrap.memory_lock: true</span><br></pre></td></tr></table></figure>

<p><strong>2、文件描述符</strong></p>
<p><strong>问题描述</strong>：引导检查报错：未开启内存锁</p>
<p><strong>问题解释</strong>：Elasticsearch 使用了很多文件描述符或文件句柄。耗尽文件描述符可能是灾难性的，并且很可能会导致数据丢失。确保将运行 Elasticsearch 的用户的打开文件描述符数量限制增加到 65,536 或更高。</p>
<p><strong>解决办法</strong>：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/security/limits.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加以下内容</span></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc 32000</span><br><span class="line">* hard nproc 32000</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">* soft memlock unlimited</span><br><span class="line"></span><br><span class="line">vim /etc/systemd/system.conf ，分别修改以下内容。</span><br><span class="line">DefaultLimitNOFILE=65536</span><br><span class="line">DefaultLimitNPROC=32000</span><br><span class="line">DefaultLimitMEMLOCK=infinity</span><br><span class="line"></span><br><span class="line">ulimit -n 65535(需使用root账号)</span><br></pre></td></tr></table></figure>

<p><strong>3、虚拟内存</strong></p>
<p><strong>问题描述</strong>：引导检查报错 max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144]</p>
<p><strong>问题解释</strong>：5.0版本以后ES使用mmapfs作为默认的文件系统存储类型。可以通过配置index.store.type来设置ES默认的文件系统存储类型。ES mmapfs默认使用一个目录来存储它的索引。操作系统对 mmap 计数的默认限制可能太低，这可能会导致内存不足异常.</p>
<p><strong>解决办法</strong>：</p>
<p>修改文件系统</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Niofs(非阻塞文件系统)	mmapfs(内存映射文件系统)</span><br><span class="line">配置:index.store.type: niofs</span><br></pre></td></tr></table></figure>

<p>使用 root 运行以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<p>永久生效：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"></span><br><span class="line">grep vm.max_map_count /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<p><strong>4、线程数</strong></p>
<p><strong>问题描述</strong>：max number of threads [1024] for user [elasticsearch] is too low, increase to at least [2048]</p>
<p><strong>问题解释</strong>：ES 使用多个线程池来进行不同类型的操作。重要的是它能够在需要时创建新线程。确保 Elasticsearch 用户可以创建的线程数至少为 4096。</p>
<p><strong>解决办法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在启动es服务之前使用root账户执行</span><br><span class="line">ulimit -u 4096</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/security/limits.conf</span><br><span class="line">设置nproc为4096</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/security/limits.d/90-nproc.conf </span><br><span class="line">修改如下内容（注意星号）：</span><br><span class="line">* soft nproc 1024  =&gt;  * soft nproc 4096</span><br></pre></td></tr></table></figure>

<p><strong>5、IPv4 forwarding</strong></p>
<p><strong>问题描述</strong>：WARNING: IPv4 forwarding is disabled. Networking will not work.</p>
<p><strong>问题解释</strong>：翻译即可</p>
<p><strong>解决办法</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">restart network &amp;&amp; systemctl restart docker</span><br><span class="line">sysctl net.ipv4.ip_forward</span><br></pre></td></tr></table></figure>

<p><strong>6、内存不足</strong></p>
<p><strong>问题描述</strong>：error&#x3D;’Cannot allocate memory’</p>
<p><strong>问题解释</strong>：ES 5.x+堆内存大小默认配置为 2G ES 7.x+默认4G</p>
<p><strong>解决办法</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//JVM一般为物理内存一半</span><br><span class="line">-e &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br></pre></td></tr></table></figure>



<h4 id="2-4、单节点部署-尚硅谷"><a href="#2-4、单节点部署-尚硅谷" class="headerlink" title="2.4、单节点部署 尚硅谷"></a>2.4、单节点部署 尚硅谷</h4><h5 id="解压软件"><a href="#解压软件" class="headerlink" title="解压软件"></a>解压软件</h5><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压缩</span></span><br><span class="line">tar -zxvf elasticsearch-7.8.0-linux-x86_64.tar.gz -C /opt/module</span><br><span class="line"><span class="comment"># 改名</span></span><br><span class="line"><span class="built_in">mv</span> elasticsearch-7.8.0 es</span><br></pre></td></tr></table></figure>

<h5 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h5><p>因为安全问题， Elasticsearch 不允许 root 用户直接运行，所以要创建新用户，在 root 用户中创建新用户。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">useradd es #新增 es 用户</span><br><span class="line">passwd es #为 es 用户设置密码</span><br><span class="line">userdel -r es #如果错了，可以删除再加</span><br><span class="line">chown -R es:es /opt/module/es #文件夹所有者</span><br></pre></td></tr></table></figure>

<h5 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h5><p>修改<code>/opt/module/es/config/elasticsearch.yml</code>文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 加入如下配置</span><br><span class="line">cluster.name: elasticsearch</span><br><span class="line">node.name: node-1</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br></pre></td></tr></table></figure>

<p>修改<code>/etc/security/limits.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 在文件末尾中增加下面内容</span><br><span class="line"># 每个进程可以打开的文件数的限制</span><br><span class="line">es soft nofile 65536</span><br><span class="line">es hard nofile 65536</span><br></pre></td></tr></table></figure>

<p>修改<code>/etc/security/limits.d/20-nproc.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 在文件末尾中增加下面内容</span><br><span class="line"># 每个进程可以打开的文件数的限制</span><br><span class="line">es soft nofile 65536</span><br><span class="line">es hard nofile 65536</span><br><span class="line"># 操作系统级别对每个用户创建的进程数的限制</span><br><span class="line">* hard nproc 4096</span><br><span class="line"># 注： * 带表 Linux 所有用户名称</span><br></pre></td></tr></table></figure>

<p>修改<code>/etc/sysctl.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 在文件中增加下面内容</span><br><span class="line"># 一个进程可以拥有的 VMA(虚拟内存区域)的数量,默认值为 65536</span><br><span class="line">vm.max_map_count=655360</span><br></pre></td></tr></table></figure>

<p>重新加载</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h5 id="启动软件"><a href="#启动软件" class="headerlink" title="启动软件"></a>启动软件</h5><p>使用 ES 用户启动</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /opt/module/es/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动</span></span><br><span class="line">bin/elasticsearch</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">后台启动</span></span><br><span class="line">bin/elasticsearch -d  </span><br></pre></td></tr></table></figure>

<p>启动时，会动态生成文件，如果文件所属用户不匹配，会发生错误，需要重新进行修改用户和用户组</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/75e24cd1fbc430577681bb4f8a0d3e2b.png" alt="img"></p>
<h5 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">暂时关闭防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">永久关闭防火墙</span></span><br><span class="line">systemctl enable firewalld.service #打开防火墙永久性生效，重启后不会复原</span><br><span class="line">systemctl disable firewalld.service #关闭防火墙，永久性生效，重启后不会复原</span><br></pre></td></tr></table></figure>

<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/477065a2cb499a32871549c21e2fc487.png" alt="img"></p>
<h4 id="2-5、集群配置"><a href="#2-5、集群配置" class="headerlink" title="2.5、集群配置"></a>2.5、集群配置</h4><h5 id="自动发现"><a href="#自动发现" class="headerlink" title="自动发现"></a>自动发现</h5><p>ES 是自动发现的，即零配置，开箱即用，无需任何网络配置，Elasticsearch 将绑定到可用的环回地址并扫描本地端口 9300 到 9305 连接同一服务器上运行的其他节点，自动形成集群。此行为无需进行任何配置即可提供自动集群服务。</p>
<h5 id="集群的核心配置"><a href="#集群的核心配置" class="headerlink" title="集群的核心配置"></a>集群的核心配置</h5><ul>
<li><p>cluster.name：集群名称，节点根据集群名称确定是否是同一个集群。</p>
</li>
<li><p>node.name：节点名称，集群内唯一。</p>
</li>
<li><p>node.roles： [ <code>data， master， voting_only</code> ]， node.roles 配置项如果没有显式的配置，那么当前节点拥有所有角色（<code>master、 data、ingest、ml、</code></p>
<p><code>remote_cluster_client、transform</code>）。如果你放开了注释，或者手动显式添加了 node.roles 配置项，那么当前节点仅拥有此配置项的中括号中显式配置的角色，没有配置的角色将被阉割。因此如果在不熟悉角色配置的情况下，不要轻易修改角色配置值，切勿画蛇添足。</p>
</li>
<li><p>network.host： 节点对外提供服务的地址以及集群内通信的ip地址</p>
</li>
<li><p>bootstrap.memory_lock： Swapping对性能和节点稳定性非常不利，应该不惜一切代价避免。它可能导致GC持续几分钟而不是几毫秒，并且可能导致节点响应缓慢甚至与集群断开连接。在弹性分布式系统中，使用Swap还不如让操作系统杀死节点效果更好。可以通过设置 <code>bootstrap.memory—lock： true</code>以防止任何Elasticsearch堆内存被换出。</p>
</li>
<li><p>http.port：对外提供服务的端口号，默认是9200</p>
</li>
<li><p>transport．port：9300—集群之间通信的端口，若不指定默认：9300</p>
</li>
<li><p>discovery.seed＿hosts：集群初始化的种子节点，可配置部分或全部候选节点，大型集群可通过嗅探器发现剩余节点，考试环境配置全部节点即可</p>
</li>
<li><p>cluster.initial＿master＿nodes：节点初始 <code>active master</code>节点，必须是有master角色的节点，即必须是候选节点，但并不是必须配置所有候选节点。生产模式下启动新集群时，必须明确列出应在第一次选举中计算其选票的候选节点。第一次成功形成集群后，<code>cluster.initial＿master＿nodes</code> 从每个节点的配置中删除设置。重新启动集群或 向现有集群添加新节点时，请勿使用此设置。</p>
</li>
</ul>
<h5 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h5><p>将 ES 文件分别解压到三台服务器上</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 解压缩</span><br><span class="line">tar -zxvf elasticsearch-7.8.0-linux-x86_64.tar.gz -C /opt/module</span><br><span class="line"># 改名</span><br><span class="line">mv elasticsearch-7.8.0 es-cluster</span><br></pre></td></tr></table></figure>

<p>创建用户</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">useradd es #新增 es 用户</span><br><span class="line">passwd es #为 es 用户设置密码</span><br><span class="line">userdel -r es #如果错了，可以删除再加</span><br><span class="line">chown -R es:es /opt/module/es #文件夹所有者</span><br></pre></td></tr></table></figure>

<p>分别修改ES节点的<code>elasticsearch.yml</code>文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 加入如下配置</span><br><span class="line">#集群名称</span><br><span class="line">cluster.name: cluster-es</span><br><span class="line">#节点名称， 每个节点的名称不能重复</span><br><span class="line">node.name: node-1</span><br><span class="line">#ip 地址， 每个节点的地址不能重复</span><br><span class="line">network.host: linux1</span><br><span class="line">#是不是有资格主节点</span><br><span class="line">node.master: true</span><br><span class="line">node.data: true</span><br><span class="line">http.port: 9200</span><br><span class="line"># head 插件需要这打开这两个配置</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.max_content_length: 200mb</span><br><span class="line">#es7.x 之后新增的配置，初始化一个新的集群时需要此配置来选举 master</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br><span class="line">#es7.x 之后新增的配置，节点发现</span><br><span class="line">discovery.seed_hosts: [&quot;linux1:9300&quot;,&quot;linux2:9300&quot;,&quot;linux3:9300&quot;]</span><br><span class="line">gateway.recover_after_nodes: 2</span><br><span class="line">network.tcp.keep_alive: true</span><br><span class="line">network.tcp.no_delay: true</span><br><span class="line">transport.tcp.compress: true</span><br><span class="line">#集群内同时启动的数据任务个数，默认是 2 个</span><br><span class="line">cluster.routing.allocation.cluster_concurrent_rebalance: 16</span><br><span class="line">#添加或删除节点及负载均衡时并发恢复的线程个数，默认 4 个</span><br><span class="line">cluster.routing.allocation.node_concurrent_recoveries: 16</span><br><span class="line">#初始化数据恢复时，并发恢复线程的个数，默认 4 个</span><br><span class="line">cluster.routing.allocation.node_initial_primaries_recoveries: 16</span><br></pre></td></tr></table></figure>

<p>分别修改<code>/etc/security/limits.conf </code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 在文件末尾中增加下面内容</span><br><span class="line">es soft nofile 65536</span><br><span class="line">es hard nofile 65536</span><br></pre></td></tr></table></figure>

<p>分别修改<code>/etc/security/limits.d/20-nproc.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 在文件末尾中增加下面内容</span><br><span class="line">es soft nofile 65536</span><br><span class="line">es hard nofile 65536</span><br><span class="line">\* hard nproc 4096</span><br><span class="line">\# 注： * 带表 Linux 所有用户名称</span><br></pre></td></tr></table></figure>

<p>分别修改<code>/etc/sysctl.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 在文件中增加下面内容</span><br><span class="line">vm.max_map_count=655360</span><br></pre></td></tr></table></figure>

<p>重新加载，然后分别启动</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">cd /opt/module/es-cluster</span><br><span class="line">#启动</span><br><span class="line">bin/elasticsearch</span><br><span class="line">#后台启动</span><br><span class="line">bin/elasticsearch -d</span><br></pre></td></tr></table></figure>

<p>测试集群</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/0412e37cb5249d1ff0e813ee87f49a50.png" alt="img"></p>
<h4 id="2-6、节点角色"><a href="#2-6、节点角色" class="headerlink" title="2.6、节点角色"></a>2.6、节点角色</h4><p><strong>推荐阅读：</strong><a target="_blank" rel="noopener" href="https://www.elastic.org.cn/archives/roles"><strong>ES节点角色深层解读，及高可用集群架构角色设计</strong></a></p>
<h5 id="主节点（active-master）"><a href="#主节点（active-master）" class="headerlink" title="主节点（active master）"></a>主节点（active master）</h5><p>一般口语上所属的“主节点”或者“master节点”指的是 <strong>active master 节点，而非具备 master 角色的节点</strong></p>
<ul>
<li>避免重负载</li>
<li>一般来说，如果小型或轻负载集群的主节点具有其他角色和职责，则其可能运行良好，但是一旦您的集群包含多个节点，使用专用的主节点通常是有意义的。</li>
<li>任何不是 <code>voting-only</code> 的 <code>master-eligible</code>节点都可以被选举为 <code>active master</code>。</li>
<li>高可用性 (HA) 集群需要至少三个候选节点，其中至少两个不是仅投票节点。这样即使其中一个节点发生故障，也可以保证剩下的节点能够选举出一个主节点。</li>
</ul>
<h5 id="master-候选节点-x2F-投票节点"><a href="#master-候选节点-x2F-投票节点" class="headerlink" title="master 候选节点&#x2F;投票节点"></a>master 候选节点&#x2F;投票节点</h5><p>通常也叫 master-eligible 节点，被称之为：具有候选资格的节点。</p>
<p>默认情况下，master-eligible节点是那些在集群状态发布期间参与选举并执行某些任务的节点，配置了master角色的节点都是有效的投票节点，可以参与选举也可以投票</p>
<p>任何不是<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-node.html#voting-only-node">仅投票</a>节点的主合格节点都可以通过<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-discovery.html">主选举过程选举</a>成为主节点。</p>
<p><strong>配置主节点（有选举和被选举权）：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">node.roles: [ master,xx,xx,xx ]</span><br></pre></td></tr></table></figure>

<p><strong>配置专用主节点（dedicated master-eligible node）：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">node.roles: [ master ]</span><br></pre></td></tr></table></figure>

<p><strong>配置仅投票节点（只有选举权，没有被选举权，这样的节点可以同时充当数据节点避免资源浪费）：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">node.roles: [ data, master, voting_only ]</span><br></pre></td></tr></table></figure>



<h5 id="data：数据节点"><a href="#data：数据节点" class="headerlink" title="data：数据节点"></a>data：数据节点</h5><p>数据节点保存包含已编入索引的文档的分片。数据节点处理数据相关操作，如 CRUD、搜索和聚合。这些操作是 I&#x2F;O 密集型、内存密集型和 CPU 密集型的。监控这些资源并在它们过载时添加更多数据节点非常重要。</p>
<p><strong>配置数据节点：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">node.roles: [ data, xxx ]</span><br></pre></td></tr></table></figure>



<h5 id="ingest：预处理节点"><a href="#ingest：预处理节点" class="headerlink" title="ingest：预处理节点"></a>ingest：预处理节点</h5><p>预处理节点有点类似于logstash的消息管道，所以也叫ingest pipeline，常用语一些数据写入之前的预处理操作，比如去除空格、split等操作，常和update_by_query、reindex等一起考</p>
<h5 id="remote-cluster-client："><a href="#remote-cluster-client：" class="headerlink" title="remote_cluster_client："></a>remote_cluster_client：</h5><p>以下操作所需节点必须具有该角色：</p>
<ul>
<li>跨集群搜索</li>
<li>跨集群复制</li>
<li>通过公网IP地址访问节点</li>
</ul>
<p>具有 <code>remote_cluster_client</code>角色的节点，使其有资格充当远程客户端</p>
<h4 id="2-7、高可用集群"><a href="#2-7、高可用集群" class="headerlink" title="2.7、高可用集群"></a>2.7、高可用集群</h4><p><img src="/img/loading.gif" data-original="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/28/1683274881007/6b5a2f888b7140229dd2882eaedc7c70.png" alt="image.png"></p>
<h5 id="节点配置"><a href="#节点配置" class="headerlink" title="节点配置"></a>节点配置</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 节点 node-1</span><br><span class="line">cluster.name: c1</span><br><span class="line">node.name: node-1</span><br><span class="line">node.roles: [master]</span><br><span class="line">path.data: /path/to/data</span><br><span class="line">path.logs: /path/to/logs</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 192.168.3.181</span><br><span class="line">http.port: 9200</span><br><span class="line">transport.port: 9300</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.3.181:9300&quot;, &quot;192.168.3.182:9300&quot;,&quot;192.168.3.183:9300&quot;, &quot;192.168.3.184:9300&quot;,&quot;192.168.3.185:9300&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br><span class="line"></span><br><span class="line">// 节点 node-2</span><br><span class="line">cluster.name: c1</span><br><span class="line">node.name: node-2</span><br><span class="line">node.roles: [master]</span><br><span class="line">path.data: /path/to/data</span><br><span class="line">path.logs: /path/to/logs</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 192.168.3.181</span><br><span class="line">http.port: 9200</span><br><span class="line">transport.port: 9300</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.3.181:9300&quot;, &quot;192.168.3.182:9300&quot;,&quot;192.168.3.183:9300&quot;, &quot;192.168.3.184:9300&quot;,&quot;192.168.3.185:9300&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br><span class="line"></span><br><span class="line">// 节点 node-3</span><br><span class="line">cluster.name: c1</span><br><span class="line">node.name: node-3</span><br><span class="line">node.roles: [master,data,voting_only]</span><br><span class="line">path.data: /path/to/data</span><br><span class="line">path.logs: /path/to/logs</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 192.168.3.183</span><br><span class="line">http.port: 9200</span><br><span class="line">transport.port: 9300</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.3.181:9300&quot;, &quot;192.168.3.182:9300&quot;,&quot;192.168.3.183:9300&quot;, &quot;192.168.3.184:9300&quot;,&quot;192.168.3.185:9300&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br><span class="line"></span><br><span class="line">// 节点 node-4</span><br><span class="line">cluster.name: c1</span><br><span class="line">node.name: node-4</span><br><span class="line">node.roles: [data]</span><br><span class="line">path.data: /path/to/data</span><br><span class="line">path.logs: /path/to/logs</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 192.168.3.184</span><br><span class="line">http.port: 9200</span><br><span class="line">transport.port: 9300</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.3.181:9300&quot;, &quot;192.168.3.182:9300&quot;,&quot;192.168.3.183:9300&quot;, &quot;192.168.3.184:9300&quot;,&quot;192.168.3.185:9300&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br><span class="line"></span><br><span class="line">// 节点 node-5</span><br><span class="line">cluster.name: c1</span><br><span class="line">node.name: node-5</span><br><span class="line">node.roles: [data]</span><br><span class="line">path.data: /path/to/data</span><br><span class="line">path.logs: /path/to/logs</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 192.168.3.185</span><br><span class="line">http.port: 9200</span><br><span class="line">transport.port: 9300</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.3.181:9300&quot;, &quot;192.168.3.182:9300&quot;,&quot;192.168.3.183:00&quot;, &quot;192.168.3.184:9300&quot;,&quot;192.168.3.185:9300&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br></pre></td></tr></table></figure>



<h5 id="部署Kibana"><a href="#部署Kibana" class="headerlink" title="部署Kibana"></a>部署Kibana</h5><h6 id="下载-Kibana："><a href="#下载-Kibana：" class="headerlink" title="下载 Kibana："></a>下载 Kibana：</h6><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">wget</span> https://artifacts.elastic.co/downloads/kibana/kibana<span class="literal">-8</span>.<span class="number">7.1</span><span class="literal">-linux-x86_64</span>.tar.gz</span><br></pre></td></tr></table></figure>

<h6 id="解压："><a href="#解压：" class="headerlink" title="解压："></a>解压：</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -xzvf kibana-8.7.1-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<h6 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server.port: 5601</span><br><span class="line">server.host: &quot;192.168.3.120&quot;</span><br><span class="line">elasticsearch.hosts: [&quot;http://192.168.3.181:9200&quot;,&quot;http://192.168.3.192:9200&quot;]</span><br></pre></td></tr></table></figure>



<h2 id="三、核心概念"><a href="#三、核心概念" class="headerlink" title="三、核心概念"></a>三、核心概念</h2><h3 id="1、节点：Node"><a href="#1、节点：Node" class="headerlink" title="1、节点：Node"></a>1、节点：Node</h3><p>一个节点就是一个Elasticsearch的实例，可以理解为一个 ES 的进程。</p>
<p><strong>注意</strong></p>
<ul>
<li>一个节点 ≠ 一台服务器</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET _cat/nodes?v</span><br></pre></td></tr></table></figure>

<p><strong>通过 Head 插件查看集群节点信息</strong></p>
<p><img src="/img/loading.gif" data-original="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/28/1682519764070/41d1c1d980c742e08024aa1744080bc2.png" alt="image.png"></p>
<h3 id="2、角色：Roles"><a href="#2、角色：Roles" class="headerlink" title="2、角色：Roles"></a>2、角色：Roles</h3><h4 id="2-1-常见的角色"><a href="#2-1-常见的角色" class="headerlink" title="2.1 常见的角色"></a>2.1 常见的角色</h4><ul>
<li><strong>主节点（active master）</strong>：一般指活跃的主节点，一个集群中只能有一个，主要作用是对集群的管理。</li>
<li><strong>候选节点（master-eligible）</strong>：当主节点发生故障时，参与选举，也就是主节点的替代节点。</li>
<li><strong>数据节点（data node）</strong>：数据节点保存包含已编入索引的文档的分片。数据节点处理数据相关操作，如 CRUD、搜索和聚合。这些操作是 I&#x2F;O 密集型、内存密集型和 CPU 密集型的。监控这些资源并在它们过载时添加更多数据节点非常重要。</li>
<li><strong>预处理节点（ingest node）</strong>：预处理节点有点类似于logstash的消息管道，所以也叫ingest pipeline，常用于一些数据写入之前的预处理操作。</li>
</ul>
<h4 id="2-2-使用和配置方法"><a href="#2-2-使用和配置方法" class="headerlink" title="2.2 使用和配置方法"></a>2.2 使用和配置方法</h4><p>准确的说，应该叫节点角色，是区分不同功能节点的一项服务配置，配置方法为</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">node.roles<span class="punctuation">:</span> <span class="punctuation">[</span> 角色<span class="number">1</span><span class="punctuation">,</span> 角色<span class="number">2</span><span class="punctuation">,</span> xxx <span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ul>
<li>如果 node.roles 为缺省配置，那么当前节点具备所有角色</li>
</ul>
<h3 id="3、索引：Index"><a href="#3、索引：Index" class="headerlink" title="3、索引：Index"></a>3、索引：Index</h3><p>一个索引就是一个拥有几分相似特征的文档的集合。比如说，你可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引。一个索引由一个名字来标识（必须全部是小写字母），并且当我们要对这个索引中的文档进行索引、搜索、更新和删除（CRUD）的时候，都要使用到这个名字。在一个集群中，可以定义任意多的索引。</p>
<p>能搜索的数据必须索引，这样的好处是可以提高查询速度，比如：新华字典前面的目录就是索引的意思，目录可以提高查询速度。</p>
<p><strong>Elasticsearch 索引的精髓：一切设计都是为了提高搜索的性能。</strong></p>
<h3 id="4、类型：Type"><a href="#4、类型：Type" class="headerlink" title="4、类型：Type"></a>4、类型：Type</h3><p>在一个索引中，你可以定义一种或多种类型。</p>
<p>一个类型是你的索引的一个逻辑上的分类&#x2F;分区，其语义完全由你来定。通常，会为具<br>有一组共同字段的文档定义一个类型。不同的版本，类型发生了不同的变化。</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>Type</th>
</tr>
</thead>
<tbody><tr>
<td>5.x</td>
<td>支持多种 type</td>
</tr>
<tr>
<td>6.x</td>
<td>只能有一种 type</td>
</tr>
<tr>
<td>7.x</td>
<td>默认不再支持自定义索引类型（默认类型为： _doc）</td>
</tr>
</tbody></table>
<h3 id="5、文档：Document"><a href="#5、文档：Document" class="headerlink" title="5、文档：Document"></a>5、文档：Document</h3><p>一个文档是一个可被索引的基础信息单元，也就是一条数据。</p>
<p>比如：你可以拥有某一个客户的文档，某一个产品的一个文档，当然，也可以拥有某个订单的一个文档。文档以 JSON（Javascript Object Notation）格式来表示，而 JSON 是一个到处存在的互联网数据交互格式。</p>
<p>在一个 index&#x2F;type 里面，你可以存储任意多的文档。</p>
<h3 id="6、字段：Field"><a href="#6、字段：Field" class="headerlink" title="6、字段：Field"></a>6、字段：Field</h3><p>相当于是数据表的字段，对文档数据根据不同属性进行的分类标识。</p>
<h3 id="7、映射：Mapping"><a href="#7、映射：Mapping" class="headerlink" title="7、映射：Mapping"></a>7、映射：Mapping</h3><p><strong>mapping 是处理数据的方式和规则方面做一些限制</strong>，如：某个字段的数据类型、默认值、分析器、是否被索引等等。这些都是映射里面可以设置的，其它就是处理 ES 里面数据的一些使用规则设置也叫做映射，按着最优规则处理数据对性能提高很大，因此才需要建立映射，并且需要思考如何建立映射才能对性能更好。</p>
<h3 id="8、分片：Shard"><a href="#8、分片：Shard" class="headerlink" title="8、分片：Shard"></a>8、分片：Shard</h3><h4 id="8-1、分片的基本概念"><a href="#8-1、分片的基本概念" class="headerlink" title="8.1、分片的基本概念"></a>8.1、分片的基本概念</h4><p>一个索引可以存储超出单个节点硬件限制的大量数据。比如，一个具有 10 亿文档数据<br>的索引占据 1TB 的磁盘空间，而任一节点都可能没有这样大的磁盘空间。 或者单个节点处理搜索请求，响应太慢。为了解决这个问题，<strong>Elasticsearch 提供了将索引划分成多份的能力，每一份就称之为分片。</strong>当你创建一个索引的时候，你可以指定你想要的分片的数量。每个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上。</p>
<p>如用一句话来概括，分片可以理解为 索引 的 碎片。并且所有碎片都是可以无限复制的。</p>
<h4 id="8-2、分片的种类"><a href="#8-2、分片的种类" class="headerlink" title="8.2、分片的种类"></a>8.2、分片的种类</h4><ul>
<li>主分片（primary shard）:</li>
<li>副本分片（replica shard）:</li>
</ul>
<h4 id="8-3、分片的作用和意义"><a href="#8-3、分片的作用和意义" class="headerlink" title="8.3、分片的作用和意义"></a>8.3、分片的作用和意义</h4><ul>
<li>高可用性：提高分布式服务的高可用性。</li>
<li>提高性能：提供系统服务的吞吐量和并发响应的能力</li>
<li>易扩展性：当集群的性能不满足业务要求时，可以方便快速的扩容集群，而无需停止服务。</li>
</ul>
<h4 id="8-4、分片的基本策略"><a href="#8-4、分片的基本策略" class="headerlink" title="8.4、分片的基本策略"></a>8.4、分片的基本策略</h4><ul>
<li>一个索引包含一个或多个分片，在 7.0 之前默认五个主分片，每个主分片一个副本；在 7.0 之后默认一个主分片。副本可以在索引创建之后修改数量，但是主分片的数量一旦确定不可修改，只能创建索引</li>
<li>每个分片都是一个 Lucene 实例，有完整的创建索引和处理请求的能力</li>
<li>ES 会自动再 nodes 上做分片均衡 shard reblance</li>
<li>一个doc不可能同时存在于多个主分片中，但是当每个主分片的副本数量不为一时，可以同时存在于多个副本中。</li>
<li><code>主分片和其副本分片</code>不能同时存在于同一个节点上。</li>
<li><code>完全相同的副本</code>不能同时存在于同一个节点上。</li>
</ul>
<h3 id="10、副本：Replicas"><a href="#10、副本：Replicas" class="headerlink" title="10、副本：Replicas"></a>10、副本：Replicas</h3><p>在一个网络 &#x2F; 云的环境里，失败随时都可能发生，在某个分片&#x2F;节点不知怎么的就处于<br>离线状态，或者由于任何原因消失了，这种情况下，有一个故障转移机制是非常有用并且是强烈推荐的。为此目的， <strong>Elasticsearch 允许你创建分片的一份或多份拷贝，这些拷贝叫做复制分片(副本)。</strong></p>
<p>复制分片之所以重要，有两个主要原因：</p>
<ul>
<li><p>在分片&#x2F;节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分片从不与原&#x2F;主要（original&#x2F;primary）分片置于同一节点上是非常重要的。</p>
</li>
<li><p>扩展你的搜索量&#x2F;吞吐量，因为搜索可以在所有的副本上并行运行。</p>
</li>
</ul>
<p>总之，<strong>每个索引可以被分成多个分片。一个索引也可以被复制 0 次（意思是没有复制）或多次。一旦复制了，每个索引就有了主分片（作为复制源的原来的分片）和复制分片（主分片的拷贝）之别。</strong></p>
<p><strong>分片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制的数量，但是你事后不能改变分片的数量。</strong></p>
<p>默认情况下，<strong>Elasticsearch 中的每个索引被分片 1 个主分片和 1 个复制，</strong>这意味着，如果你的集群中至少有两个节点，你的索引将会有 1 个主分片和另外 1 个复制分片（1 个完全拷贝），这样的话每个索引总共就有 2 个分片， 我们需要根据索引需要确定分片个数。</p>
<h3 id="11、分配：Allocation"><a href="#11、分配：Allocation" class="headerlink" title="11、分配：Allocation"></a>11、分配：Allocation</h3><p>将分片分配给某个节点的过程，包括分配主分片或者副本。如果是副本，还包含从主分片复制数据的过程。这个过程是由 master 节点完成的。</p>
<h3 id="12、集群：Cluster"><a href="#12、集群：Cluster" class="headerlink" title="12、集群：Cluster"></a>12、集群：Cluster</h3><h4 id="12-1、集群的健康值检查"><a href="#12-1、集群的健康值检查" class="headerlink" title="12.1、集群的健康值检查"></a>12.1、集群的健康值检查</h4><h5 id="健康状态"><a href="#健康状态" class="headerlink" title="健康状态"></a>健康状态</h5><ul>
<li>绿色：所有分片都可用</li>
<li>黄色：至少有一个副本不可用，但是所有主分片都可用，此时集群能提供完整的读写服务，但是可用性较低。</li>
<li>红色：至少有一个主分片不可用，数据不完整。此时集群无法提供完整的读写服务。集群不可用。</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/28/1682519764070/54200af7681a4d75beb149b07429a030.png" alt="image.png"></p>
<p><strong>新手误区：对不同健康状态下的可用性描述，集群不可用指的是集群状态为红色，无法提供完整读写服务，而不代表无法通过客户端远程连接和调用服务。</strong></p>
<h5 id="健康值检查"><a href="#健康值检查" class="headerlink" title="健康值检查"></a>健康值检查</h5><p><strong>方法一：_cat API</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET _cat/health</span><br></pre></td></tr></table></figure>

<p>返回结果如下</p>
<p><img src="/img/loading.gif" data-original="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/28/1682519764070/0375a177941d49798390a3e5d45c7fb4.png" alt="image.png"></p>
<p><strong>方法二：_cluster API</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET _cluster/health</span><br></pre></td></tr></table></figure>



<h3 id="13、索引和文档"><a href="#13、索引和文档" class="headerlink" title="13、索引和文档"></a>13、索引和文档</h3><h4 id="13-1、索引"><a href="#13-1、索引" class="headerlink" title="13.1、索引"></a>13.1、索引</h4><p>索引在 ES 中所表述的含义和 MySQL 中的索引完全不同，在 MySQL 中索引指的是加速数据查询的一种特殊的数据结构，如 normal index。</p>
<p>而在 ES 中，索引表述的含义等价于 MySQL 中的表（仅针对 ES 7.x 以后版本），注意这里只是类比去理解，索引并不等于表。</p>
<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231002124948449.png" class title="image-20231002124948449">

<h4 id="13-2、文档"><a href="#13-2、文档" class="headerlink" title="13.2、文档"></a>13.2、文档</h4><p>在 Elasticsearch 中，文档即表示一条数据，而 es 中的文档是以 Json 的格式来存储的。</p>
<p><img src="/img/loading.gif" data-original="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/28/1682519764070/04254dfe2f664098bb872743d16e4064.png" alt="image.png"></p>
<h2 id="四、索引和文档"><a href="#四、索引和文档" class="headerlink" title="四、索引和文档"></a>四、索引和文档</h2><h3 id="1、创建索引"><a href="#1、创建索引" class="headerlink" title="1、创建索引"></a>1、创建索引</h3><h4 id="1-1-基本语法"><a href="#1-1-基本语法" class="headerlink" title="1.1 基本语法"></a>1.1 基本语法</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT &lt;index_name&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>index_name：索引名称</strong></li>
</ul>
<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231002130320371.png" class title="image-20231002130320371">

<h4 id="1-2-索引命名规范"><a href="#1-2-索引命名规范" class="headerlink" title="1.2 索引命名规范"></a>1.2 索引命名规范</h4><ul>
<li><strong>以小写英文字母命名索引</strong></li>
<li><strong>不要使用</strong> <code>&lt;span class=&quot;ne-text&quot;&gt;驼峰&lt;/span&gt;</code>或者 <code>&lt;span class=&quot;ne-text&quot;&gt;帕斯卡&lt;/span&gt;</code>命名法则</li>
<li><strong>如过出现多个单词的索引名称，以全小写 + 下划线分隔的方式：如</strong> <code>&lt;span class=&quot;ne-text&quot;&gt;my_index&lt;/span&gt;</code>。</li>
</ul>
<h4 id="1-3-索引的基本组成"><a href="#1-3-索引的基本组成" class="headerlink" title="1.3 索引的基本组成"></a>1.3 索引的基本组成</h4><ul>
<li><strong>alias：即 索引别名，参考：</strong><a target="_blank" rel="noopener" href="http://www.elastic.org.cn/archives/alias"><strong>ES中索引别名（alias）的到底有什么用</strong></a></li>
<li><strong>settings：索引设置，常见设置如分片和副本的数量等。</strong></li>
<li><strong>mapping：即映射，定义了索引中包含哪些字段，以及字段的类型、长度、分词器等。</strong></li>
</ul>
<h4 id="1-4、Postman请求创建索引"><a href="#1-4、Postman请求创建索引" class="headerlink" title="1.4、Postman请求创建索引"></a>1.4、Postman请求创建索引</h4><p>在 Postman 中，向 ES 服务器发 PUT 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping">http://127.0.0.1:9200/shopping</a></p>
<p>请求后，服务器返回响应：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;acknowledged&quot;: true,//响应结果</span><br><span class="line">    &quot;shards_acknowledged&quot;: true,//分片结果</span><br><span class="line">    &quot;index&quot;: &quot;shopping&quot;//索引名称</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="2、删除索引"><a href="#2、删除索引" class="headerlink" title="2、删除索引"></a>2、删除索引</h3><h4 id="2-1、命令删除"><a href="#2-1、命令删除" class="headerlink" title="2.1、命令删除"></a>2.1、命令删除</h4><h5 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE /&lt;index_name&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>index_name：索引名称</strong></li>
</ul>
<h5 id="判断索引是否存在"><a href="#判断索引是否存在" class="headerlink" title="判断索引是否存在"></a>判断索引是否存在</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HEAD &lt;index_name&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-2、请求删除"><a href="#2-2、请求删除" class="headerlink" title="2.2、请求删除"></a>2.2、请求删除</h4><p>在 Postman 中，向 ES 服务器发 DELETE 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping">http://127.0.0.1:9200/shopping</a></p>
<p>返回结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;acknowledged&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次查看所有索引，GET <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/_cat/indices?v%EF%BC%8C%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/_cat/indices?v，返回结果如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">health status index uuid pri rep docs.count docs.deleted store.size pri.store.size</span><br></pre></td></tr></table></figure>

<p>成功删除。</p>
<h3 id="3、索引的不可变性"><a href="#3、索引的不可变性" class="headerlink" title="3、索引的不可变性"></a>3、索引的不可变性</h3><h4 id="3-1-哪些参数不可变"><a href="#3-1-哪些参数不可变" class="headerlink" title="3.1 哪些参数不可变"></a>3.1 哪些参数不可变</h4><p><strong>ES 索引创建成功之后，索引名称、主分片数量、字段类型、分词器等参数将不可被修改</strong></p>
<h4 id="3-2-有什么影响"><a href="#3-2-有什么影响" class="headerlink" title="3.2 有什么影响"></a>3.2 有什么影响</h4><p><strong>造成项目后期难以维护和扩展。</strong></p>
<h4 id="3-3-如何解决"><a href="#3-3-如何解决" class="headerlink" title="3.3 如何解决"></a>3.3 如何解决</h4><ul>
<li><strong>运行时字段</strong></li>
<li><strong>索引别名</strong></li>
<li><strong>Reindex</strong></li>
</ul>
<h3 id="4、索引的查询"><a href="#4、索引的查询" class="headerlink" title="4、索引的查询"></a>4、索引的查询</h3><h4 id="4-1、命令查询"><a href="#4-1、命令查询" class="headerlink" title="4.1、命令查询"></a>4.1、命令查询</h4><h5 id="查询特定索引"><a href="#查询特定索引" class="headerlink" title="查询特定索引"></a>查询特定索引</h5><p><strong>基本语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /&lt;index_name&gt;/_search </span><br><span class="line">GET /_search</span><br></pre></td></tr></table></figure>

<p><strong>可选参数</strong></p>
<ul>
<li><strong>size：单次查询多少条文档，默认为 10</strong></li>
<li>**from：*<em>起始文档偏移量。需要为非负数，默认为*<em>0</em></em></li>
<li><strong>timeout：</strong> <strong>指定等待每个分片响应的时间段。如果在超时到期之前未收到响应，则请求失败并返回错误。默认为无超时。</strong></li>
</ul>
<h5 id="查询集群中所有索引"><a href="#查询集群中所有索引" class="headerlink" title="查询集群中所有索引"></a>查询集群中所有索引</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_cat/indices</span><br></pre></td></tr></table></figure>

<h4 id="4-2、请求查询"><a href="#4-2、请求查询" class="headerlink" title="4.2、请求查询"></a>4.2、请求查询</h4><h5 id="查看所有索引"><a href="#查看所有索引" class="headerlink" title="查看所有索引"></a>查看所有索引</h5><p>在 Postman 中，向 ES 服务器发 GET 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/_cat/indices?v">http://127.0.0.1:9200/_cat/indices?v</a></p>
<p>这里请求路径中的_cat 表示查看的意思， indices 表示索引，所以整体含义就是查看当前 ES服务器中的所有索引，就好像 MySQL 中的 show tables 的感觉，服务器响应结果如下 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">health status index    uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">yellow open   shopping J0WlEhh4R7aDrfIc3AkwWQ   1   1          0            0       208b           208b</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>表头</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>health</td>
<td>当前服务器健康状态： green(集群完整) yellow(单点正常、集群不完整) red(单点不正常)</td>
</tr>
<tr>
<td>status</td>
<td>索引打开、关闭状态</td>
</tr>
<tr>
<td>index</td>
<td>索引名</td>
</tr>
<tr>
<td>uuid</td>
<td>索引统一编号</td>
</tr>
<tr>
<td>pri</td>
<td>主分片数量</td>
</tr>
<tr>
<td>rep</td>
<td>副本数量</td>
</tr>
<tr>
<td>docs.count</td>
<td>可用文档数量</td>
</tr>
<tr>
<td>docs.deleted</td>
<td>文档删除状态（逻辑删除）</td>
</tr>
<tr>
<td>store.size</td>
<td>主分片和副分片整体占空间大小</td>
</tr>
<tr>
<td>pri.store.size</td>
<td>主分片占空间大小</td>
</tr>
</tbody></table>
<h5 id="查看单个索引"><a href="#查看单个索引" class="headerlink" title="查看单个索引"></a>查看单个索引</h5><p>在 Postman 中，向 ES 服务器发 GET 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping">http://127.0.0.1:9200/shopping</a></p>
<p>返回结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;shopping&quot;: &#123;//索引名</span><br><span class="line">        &quot;aliases&quot;: &#123;&#125;,//别名</span><br><span class="line">        &quot;mappings&quot;: &#123;&#125;,//映射</span><br><span class="line">        &quot;settings&quot;: &#123;//设置</span><br><span class="line">            &quot;index&quot;: &#123;//设置 - 索引</span><br><span class="line">                &quot;creation_date&quot;: &quot;1617861426847&quot;,//设置 - 索引 - 创建时间</span><br><span class="line">                &quot;number_of_shards&quot;: &quot;1&quot;,//设置 - 索引 - 主分片数量</span><br><span class="line">                &quot;number_of_replicas&quot;: &quot;1&quot;,//设置 - 索引 - 主分片数量</span><br><span class="line">                &quot;uuid&quot;: &quot;J0WlEhh4R7aDrfIc3AkwWQ&quot;,//设置 - 索引 - 主分片数量</span><br><span class="line">                &quot;version&quot;: &#123;//设置 - 索引 - 主分片数量</span><br><span class="line">                    &quot;created&quot;: &quot;7080099&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;provided_name&quot;: &quot;shopping&quot;//设置 - 索引 - 主分片数量</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5、索引文档"><a href="#5、索引文档" class="headerlink" title="5、索引文档"></a>5、<strong>索引文档</strong></h3><h4 id="5-1、命令创建"><a href="#5-1、命令创建" class="headerlink" title="5.1、命令创建"></a>5.1、命令创建</h4><p><strong>将 JSON 文档添加到指定的数据流或索引并使其可被检索。如果目标是索引并且文档已经存在，则请求更新文档并增加其版本号。</strong></p>
<p><strong>基本语法</strong> ★</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT /&lt;target&gt;/_doc/&lt;_id&gt;</span><br><span class="line"></span><br><span class="line">PUT /&lt;target&gt;/_create/&lt;_id&gt;</span><br><span class="line"></span><br><span class="line">POST /&lt;target&gt;/_create/&lt;_id&gt;</span><br></pre></td></tr></table></figure>

<p><strong>案例</strong></p>
<p><strong>索引一条 _id 为 1 的文档，并为其添加 test_field 和 test_title 两个字段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT test_index/_doc/1?op_type=index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;赵四&quot;,</span><br><span class="line">  &quot;age&quot;:18</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2、请求创建"><a href="#5-2、请求创建" class="headerlink" title="5.2、请求创建"></a>5.2、请求创建</h4><p>假设索引已经创建好了，接下来我们来创建文档，并添加数据。这里的文档可以类比为关系型数据库中的表数据，添加的数据格式为 JSON 格式</p>
<p>在 Postman 中，向 ES 服务器发 POST 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_doc%EF%BC%8C%E8%AF%B7%E6%B1%82%E4%BD%93JSON%E5%86%85%E5%AE%B9%E4%B8%BA%EF%BC%9A">http://127.0.0.1:9200/shopping/_doc，请求体JSON内容为：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;:&quot;小米手机&quot;,</span><br><span class="line">    &quot;category&quot;:&quot;小米&quot;,</span><br><span class="line">    &quot;images&quot;:&quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">    &quot;price&quot;:3999.00</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/20d54cba223bd9d70ea356d3e40a8161.png" alt="img"></p>
<blockquote>
<p>注意，此处发送请求的方式必须为 POST，不能是 PUT，否则会发生错误 。</p>
</blockquote>
<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,//索引</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,//类型-文档</span><br><span class="line">    &quot;_id&quot;: &quot;ANQqsHgBaKNfVnMbhZYU&quot;,//唯一标识，可以类比为 MySQL 中的主键，随机生成</span><br><span class="line">    &quot;_version&quot;: 1,//版本</span><br><span class="line">    &quot;result&quot;: &quot;created&quot;,//结果，这里的 create 表示创建成功</span><br><span class="line">    &quot;_shards&quot;: &#123;//</span><br><span class="line">        &quot;total&quot;: 2,//分片 - 总数</span><br><span class="line">        &quot;successful&quot;: 1,//分片 - 总数</span><br><span class="line">        &quot;failed&quot;: 0//分片 - 总数</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 0,</span><br><span class="line">    &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的数据创建后，由于没有指定数据唯一性标识（ID），默认情况下， ES 服务器会随机生成一个。</p>
<p>如果想要自定义唯一性标识，需要在创建时指定： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_doc/1%EF%BC%8C%E8%AF%B7%E6%B1%82%E4%BD%93JSON%E5%86%85%E5%AE%B9%E4%B8%80%E6%A0%B7%E3%80%82">http://127.0.0.1:9200/shopping/_doc/1，请求体JSON内容一样。</a></p>
<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1&quot;,//&lt;------------------自定义唯一性标识</span><br><span class="line">    &quot;_version&quot;: 1,</span><br><span class="line">    &quot;result&quot;: &quot;created&quot;,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 1,</span><br><span class="line">    &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：如果增加数据时明确数据主键，那么请求方式也可以为 PUT。</strong></p>
</blockquote>
<h3 id="6、查询文档"><a href="#6、查询文档" class="headerlink" title="6、查询文档"></a>6、查询文档</h3><h4 id="6-1、命令查询"><a href="#6-1、命令查询" class="headerlink" title="6.1、命令查询"></a>6.1、命令查询</h4><h5 id="基本语法-1"><a href="#基本语法-1" class="headerlink" title="基本语法"></a>基本语法</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET &lt;index&gt;/_doc/&lt;_id&gt;</span><br></pre></td></tr></table></figure>

<h5 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET product/_doc/1</span><br></pre></td></tr></table></figure>

<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/image-20231002131553084.png" class title="image-20231002131553084">

<h5 id="source-API"><a href="#source-API" class="headerlink" title="_source API"></a>_source API</h5><p><strong>使用 _source API 可以打开或者关闭源数据字段，true 为打开，false 为关闭，默认为 true。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET &lt;index&gt;/_doc/&lt;_id&gt;?_source=false</span><br></pre></td></tr></table></figure>

<p><strong>当然也可以只查看 _source 字段，而不查看任何 mata data。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET &lt;index&gt;/_source/&lt;_id&gt;</span><br></pre></td></tr></table></figure>

<h4 id="6-2、请求查询"><a href="#6-2、请求查询" class="headerlink" title="6.2、请求查询"></a>6.2、请求查询</h4><h5 id="普通查询"><a href="#普通查询" class="headerlink" title="普通查询"></a>普通查询</h5><p>查看文档时，需要指明文档的唯一性标识，类似于 MySQL 中数据的主键查询</p>
<p>在 Postman 中，向 ES 服务器发 GET 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_doc/1">http://127.0.0.1:9200/shopping/_doc/1</a> </p>
<p>返回结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;_version&quot;: 1,</span><br><span class="line">    &quot;_seq_no&quot;: 1,</span><br><span class="line">    &quot;_primary_term&quot;: 1,</span><br><span class="line">    &quot;found&quot;: true,</span><br><span class="line">    &quot;_source&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">        &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">        &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">        &quot;price&quot;: 3999</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看索引下所有数据，向 ES 服务器发 GET 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search">http://127.0.0.1:9200/shopping/_search</a></p>
<p>返回结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 133,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 2,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 1,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;ANQqsHgBaKNfVnMbhZYU&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">                    &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">                    &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">                    &quot;price&quot;: 3999</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">                    &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">                    &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">                    &quot;price&quot;: 3999</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="条件查询-amp-分页查询-amp-查询排序"><a href="#条件查询-amp-分页查询-amp-查询排序" class="headerlink" title="条件查询 &amp; 分页查询 &amp; 查询排序"></a>条件查询 &amp; 分页查询 &amp; 查询排序</h5><h6 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h6><p><strong>1、URL带参查询</strong></p>
<p><strong>查找category为小米的文档</strong>，在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search?q=category:%E5%B0%8F%E7%B1%B3%EF%BC%8C%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search?q=category:小米，返回结果如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 94,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 3,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 1.3862942,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;ANQqsHgBaKNfVnMbhZYU&quot;,</span><br><span class="line">                &quot;_score&quot;: 1.3862942,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">                    &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">                    &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">                    &quot;price&quot;: 3999</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;A9R5sHgBaKNfVnMb25Ya&quot;,</span><br><span class="line">                &quot;_score&quot;: 1.3862942,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">                    &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">                    &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">                    &quot;price&quot;: 1999</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;BNR5sHgBaKNfVnMb7pal&quot;,</span><br><span class="line">                &quot;_score&quot;: 1.3862942,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">                    &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">                    &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">                    &quot;price&quot;: 1999</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述为URL带参数形式查询，这很容易让不善者心怀恶意，或者参数值出现中文会出现乱码情况。为了避免这些情况，我们可用使用带JSON请求体请求进行查询。</p>
<p><strong>2、请求体带参查询</strong></p>
<p>接下带JSON请求体，还是<strong>查找category为小米的文档</strong>，在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match&quot;:&#123;</span><br><span class="line">			&quot;category&quot;:&quot;小米&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3、带请求体方式的查找所有内容</strong></p>
<p><strong>查找所有文档内容</strong>，也可以这样，在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match_all&quot;:&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4、查询指定字段</strong></p>
<p><strong>如果你想查询指定字段</strong>，在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match_all&quot;:&#123;&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;_source&quot;:[&quot;title&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 5,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 6,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 1,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;ANQqsHgBaKNfVnMbhZYU&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;A9R5sHgBaKNfVnMb25Ya&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;BNR5sHgBaKNfVnMb7pal&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;BtR6sHgBaKNfVnMbX5Y5&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;华为手机&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;B9R6sHgBaKNfVnMbZpZ6&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;华为手机&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;CdR7sHgBaKNfVnMbsJb9&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;华为手机&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h6><p>在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match_all&quot;:&#123;&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;from&quot;:0,</span><br><span class="line">	&quot;size&quot;:2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 1,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 6,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 1,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;ANQqsHgBaKNfVnMbhZYU&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">                    &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">                    &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">                    &quot;price&quot;: 3999</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;A9R5sHgBaKNfVnMb25Ya&quot;,</span><br><span class="line">                &quot;_score&quot;: 1,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">                    &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">                    &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">                    &quot;price&quot;: 1999</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="查询排序"><a href="#查询排序" class="headerlink" title="查询排序"></a>查询排序</h6><p>如果你想通过排序查出价格最高的手机，在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match_all&quot;:&#123;&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;sort&quot;:&#123;</span><br><span class="line">		&quot;price&quot;:&#123;</span><br><span class="line">			&quot;order&quot;:&quot;desc&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="多条件查询-amp-范围查询"><a href="#多条件查询-amp-范围查询" class="headerlink" title="多条件查询 &amp; 范围查询"></a>多条件查询 &amp; 范围查询</h5><h6 id="多条件查询"><a href="#多条件查询" class="headerlink" title="多条件查询"></a>多条件查询</h6><p>假设想找出小米牌子，价格为3999元的。（**must相当于数据库的&amp;&amp;**）</p>
<p>在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;bool&quot;:&#123;</span><br><span class="line">			&quot;must&quot;:[&#123;</span><br><span class="line">				&quot;match&quot;:&#123;</span><br><span class="line">					&quot;category&quot;:&quot;小米&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,&#123;</span><br><span class="line">				&quot;match&quot;:&#123;</span><br><span class="line">					&quot;price&quot;:3999.00</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;: 134,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: &#123;</span><br><span class="line">            &quot;value&quot;: 1,</span><br><span class="line">            &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;: 2.3862944,</span><br><span class="line">        &quot;hits&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">                &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">                &quot;_id&quot;: &quot;ANQqsHgBaKNfVnMbhZYU&quot;,</span><br><span class="line">                &quot;_score&quot;: 2.3862944,</span><br><span class="line">                &quot;_source&quot;: &#123;</span><br><span class="line">                    &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">                    &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">                    &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">                    &quot;price&quot;: 3999</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设想找出小米和华为的牌子。（**should相当于数据库的||**）</p>
<p>在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;bool&quot;:&#123;</span><br><span class="line">			&quot;should&quot;:[&#123;</span><br><span class="line">				&quot;match&quot;:&#123;</span><br><span class="line">					&quot;category&quot;:&quot;小米&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,&#123;</span><br><span class="line">				&quot;match&quot;:&#123;</span><br><span class="line">					&quot;category&quot;:&quot;华为&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;]</span><br><span class="line">		&#125;,</span><br><span class="line">        &quot;filter&quot;:&#123;</span><br><span class="line">            &quot;range&quot;:&#123;</span><br><span class="line">                &quot;price&quot;:&#123;</span><br><span class="line">                    &quot;gt&quot;:2000</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h6><p>假设想找出小米和华为的牌子，价格大于2000元的手机。</p>
<p>在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;should&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;category&quot;</span><span class="punctuation">:</span><span class="string">&quot;小米&quot;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;category&quot;</span><span class="punctuation">:</span><span class="string">&quot;华为&quot;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            	<span class="attr">&quot;range&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                	<span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                    	<span class="attr">&quot;gt&quot;</span><span class="punctuation">:</span><span class="number">2000</span></span><br><span class="line">                	<span class="punctuation">&#125;</span></span><br><span class="line">	            <span class="punctuation">&#125;</span></span><br><span class="line">    	    <span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h5 id="全文检索-amp-完全匹配-amp-高亮查询"><a href="#全文检索-amp-完全匹配-amp-高亮查询" class="headerlink" title="全文检索 &amp; 完全匹配 &amp; 高亮查询"></a>全文检索 &amp; 完全匹配 &amp; 高亮查询</h5><h6 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h6><p>这功能像搜索引擎那样，如品牌输入“小华”，返回结果带回品牌有“小米”和华为的。</p>
<p>在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;category&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;小华&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ANQqsHgBaKNfVnMbhZYU&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">3999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A9R5sHgBaKNfVnMb25Ya&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BNR5sHgBaKNfVnMb7pal&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BtR6sHgBaKNfVnMbX5Y5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B9R6sHgBaKNfVnMbZpZ6&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CdR7sHgBaKNfVnMbsJb9&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h6 id="完全匹配"><a href="#完全匹配" class="headerlink" title="完全匹配"></a>完全匹配</h6><p>在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;category&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;为&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BtR6sHgBaKNfVnMbX5Y5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B9R6sHgBaKNfVnMbZpZ6&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CdR7sHgBaKNfVnMbsJb9&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h6 id="高亮查询"><a href="#高亮查询" class="headerlink" title="高亮查询"></a>高亮查询</h6><p>在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;category&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;为&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="comment">//&lt;----高亮这字段</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BtR6sHgBaKNfVnMbX5Y5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;华&lt;em&gt;为&lt;/em&gt;&quot;</span><span class="comment">//&lt;------高亮一个为字。</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B9R6sHgBaKNfVnMbZpZ6&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;华&lt;em&gt;为&lt;/em&gt;&quot;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CdR7sHgBaKNfVnMbsJb9&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.6931471</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;华&lt;em&gt;为&lt;/em&gt;&quot;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h5><p>聚合允许使用者对 es 文档进行统计分析，类似与关系型数据库中的 group by，当然还有很多其他的聚合，例如取最大值max、平均值avg等等。</p>
<p>接下来按price字段进行分组：</p>
<p>在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="comment">//聚合操作</span></span><br><span class="line">		<span class="attr">&quot;price_group&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="comment">//名称，随意起名</span></span><br><span class="line">			<span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="comment">//分组</span></span><br><span class="line">				<span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;price&quot;</span><span class="comment">//分组字段</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">63</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ANQqsHgBaKNfVnMbhZYU&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">3999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A9R5sHgBaKNfVnMb25Ya&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BNR5sHgBaKNfVnMb7pal&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BtR6sHgBaKNfVnMbX5Y5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B9R6sHgBaKNfVnMbZpZ6&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shopping&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CdR7sHgBaKNfVnMbsJb9&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="number">1999</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;aggregations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;price_group&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1999</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3999</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面返回结果会附带原始数据的。若不想要不附带原始数据的结果，在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;price_group&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;price&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;aggregations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;price_group&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">1999</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="number">3999</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;doc_count&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>若想对所有手机价格求<strong>平均值</strong>。</p>
<p>在 Postman 中，向 ES 服务器发 GET请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_search%EF%BC%8C%E9%99%84%E5%B8%A6JSON%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A">http://127.0.0.1:9200/shopping/_search，附带JSON体如下：</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;price_avg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="comment">//名称，随意起名</span></span><br><span class="line">			<span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="comment">//求平均</span></span><br><span class="line">				<span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;price&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;aggregations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;price_avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">2332.3333333333335</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="7、删除文档"><a href="#7、删除文档" class="headerlink" title="7、删除文档"></a>7、删除文档</h3><h4 id="7-1、命令删除"><a href="#7-1、命令删除" class="headerlink" title="7.1、命令删除"></a>7.1、命令删除</h4><p><strong>删除索引中指定 id 的文档</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE /&lt;index&gt;/_doc/&lt;_id&gt;</span><br></pre></td></tr></table></figure>

<p><strong>比如：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE product/_doc/1</span><br></pre></td></tr></table></figure>

<h4 id="7-2、请求删除"><a href="#7-2、请求删除" class="headerlink" title="7.2、请求删除"></a>7.2、请求删除</h4><p>删除一个文档不会立即从磁盘上移除，它只是被标记成已删除（逻辑删除）。</p>
<p>在 Postman 中，向 ES 服务器发 DELETE 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_doc/1">http://127.0.0.1:9200/shopping/_doc/1</a></p>
<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;_version&quot;: 4,</span><br><span class="line">    &quot;result&quot;: &quot;deleted&quot;,//&lt;---删除成功</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 4,</span><br><span class="line">    &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8、更新文档"><a href="#8、更新文档" class="headerlink" title="8、更新文档"></a>8、更新文档</h3><h4 id="8-1、命令修改"><a href="#8-1、命令修改" class="headerlink" title="8.1、命令修改"></a>8.1、命令修改</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /&lt;index&gt;/_update/&lt;_id&gt;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">    &quot;&lt;field_name&gt;&quot;: &quot;&lt;field_value&gt;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong> <strong>：7.x 及之前版本的语法</strong> <code>&lt;span class=&quot;ne-text&quot;&gt;POST test/_doc/1/_update&lt;/span&gt;</code>已不再支持</p>
<h4 id="8-2、请求修改"><a href="#8-2、请求修改" class="headerlink" title="8.2、请求修改"></a>8.2、请求修改</h4><h5 id="全量修改"><a href="#全量修改" class="headerlink" title="全量修改"></a>全量修改</h5><p>和新增文档一样，输入相同的 URL 地址请求，如果请求体变化，会将原有的数据内容覆盖</p>
<p>在 Postman 中，向 ES 服务器发 POST 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_doc/1">http://127.0.0.1:9200/shopping/_doc/1</a></p>
<p>请求体JSON内容为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;:&quot;华为手机&quot;,</span><br><span class="line">    &quot;category&quot;:&quot;华为&quot;,</span><br><span class="line">    &quot;images&quot;:&quot;http://www.gulixueyuan.com/hw.jpg&quot;,</span><br><span class="line">    &quot;price&quot;:1999.00</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改成功后，服务器响应结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;_version&quot;: 2,</span><br><span class="line">    &quot;result&quot;: &quot;updated&quot;,//&lt;-----------updated 表示数据被更新</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 2,</span><br><span class="line">    &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="局部修改"><a href="#局部修改" class="headerlink" title="局部修改"></a>局部修改</h5><p>修改数据时，也可以只修改某一给条数据的局部信息</p>
<p>在 Postman 中，向 ES 服务器发 POST 请求 ： <a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping/_update/1">http://127.0.0.1:9200/shopping/_update/1</a></p>
<p>请求体JSON内容为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;doc&quot;: &#123;</span><br><span class="line">		&quot;title&quot;:&quot;小米手机&quot;,</span><br><span class="line">		&quot;category&quot;:&quot;小米&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;_version&quot;: 3,</span><br><span class="line">    &quot;result&quot;: &quot;updated&quot;,//&lt;-----------updated 表示数据被更新</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 3,</span><br><span class="line">    &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="五、Mapping"><a href="#五、Mapping" class="headerlink" title="五、Mapping"></a>五、Mapping</h2><h3 id="1、Mapping-介绍"><a href="#1、Mapping-介绍" class="headerlink" title="1、Mapping 介绍"></a>1、Mapping 介绍</h3><h4 id="1-1、映射的基本概念"><a href="#1-1、映射的基本概念" class="headerlink" title="1.1、映射的基本概念"></a>1.1、映射的基本概念</h4><p>有了索引库，等于有了数据库中的 database。</p>
<p>接下来就需要建索引库(index)中的映射了，类似于数据库(database)中的表结构(table)。</p>
<p>Mapping 也称之为映射，定义了 ES 的索引结构、字段类型、分词器等属性，是索引必不可少的组成部分。</p>
<p>ES 中的 mapping 有点类似与RDB中“表结构”的概念，在 MySQL 中，表结构里包含了字段名称，字段的类型还有索引信息等。在 Mapping 里也包含了一些属性，比如字段名称、类型、字段使用的分词器、是否评分、是否创建索引等属性，并且在ES中一个字段可以有对个类型。</p>
<p>创建数据库表需要设置字段名称，类型，长度，约束等；索引库也一样，需要知道这个类型下有哪些字段，每个字段有哪些约束信息，这就叫做映射(mapping)。</p>
<h4 id="1-2、查看索引-mapping"><a href="#1-2、查看索引-mapping" class="headerlink" title="1.2、查看索引 mapping"></a>1.2、查看索引 mapping</h4><p>查看完整 mapping</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /index/_mappings</span><br></pre></td></tr></table></figure>

<p>查看指定字段 mapping</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /index/_mappings/field/&lt;field_name&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-3、请求方式操作映射"><a href="#1-3、请求方式操作映射" class="headerlink" title="1.3、请求方式操作映射"></a>1.3、请求方式操作映射</h4><p>先创建一个索引：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># PUT http://127.0.0.1:9200/user</span><br></pre></td></tr></table></figure>

<p><strong>创建映射：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># PUT http://127.0.0.1:9200/user/_mapping</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;name&quot;:&#123;</span><br><span class="line">        	&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        	&quot;index&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sex&quot;:&#123;</span><br><span class="line">        	&quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        	&quot;index&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;tel&quot;:&#123;</span><br><span class="line">        	&quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        	&quot;index&quot;: false</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;acknowledged&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>查询映射：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#GET http://127.0.0.1:9200/user/_mapping</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;tel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>增加数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#PUT http://127.0.0.1:9200/user/_create/1001</span><br><span class="line">&#123;</span><br><span class="line">	&quot;name&quot;:&quot;小米&quot;,</span><br><span class="line">	&quot;sex&quot;:&quot;男的&quot;,</span><br><span class="line">	&quot;tel&quot;:&quot;1111&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查找name含有”小“数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#GET http://127.0.0.1:9200/user/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match&quot;:&#123;</span><br><span class="line">			&quot;name&quot;:&quot;小&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">495</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1001&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;小米&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;男的&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;tel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1111&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>“sex”只能完全为”男的“，只因创建映射时”sex”的类型为”keyword”，才能得出原数据。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#GET http://127.0.0.1:9200/user/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match&quot;:&#123;</span><br><span class="line">			&quot;sex&quot;:&quot;男的&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询电话：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># GET http://127.0.0.1:9200/user/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match&quot;:&#123;</span><br><span class="line">			&quot;tel&quot;:&quot;11&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query_shard_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;failed to create query: Cannot search on field [tel] since it is not indexed.&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ivLnMfQKROS7Skb2MTFOew&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;search_phase_execution_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;all shards failed&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;phase&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;grouped&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4P7dIRfXSbezE5JTiuylew&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query_shard_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;failed to create query: Cannot search on field [tel] since it is not indexed.&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ivLnMfQKROS7Skb2MTFOew&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;caused_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal_argument_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cannot search on field [tel] since it is not indexed.&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>报错只因创建映射时”tel”的”index”为false。</p>
<h3 id="2、字段数据类型"><a href="#2、字段数据类型" class="headerlink" title="2、字段数据类型"></a>2、字段数据类型</h3><p>映射的数据类型也就是 ES 索引支持的数据类型，其概念和 MySQL 中的字段类型相似，但是具体的类型和 MySQL 中有所区别，最主要的区别就在于 ES 中支持可分词的数据类型，如：Text 类型，可分词类型是用以支持全文检索的，这也是 ES 生态最核心的功能。</p>
<h4 id="2-1、数字类型"><a href="#2-1、数字类型" class="headerlink" title="2.1、数字类型"></a><strong>2.1、数字类型</strong></h4><ul>
<li><strong>long：64 位有符号整形</strong></li>
<li><strong>integer：32 位有符号整形</strong></li>
<li><strong>short：16 位有符号整形</strong></li>
<li><strong>byte：8位有符号整形</strong></li>
<li><strong>double：双精度 64位浮点类型</strong></li>
<li><strong>float：单精度 64位浮点类型</strong></li>
<li>half_float：半精度 64位浮点类型</li>
<li>scaled_float：缩放类型浮点数，按固定 double 比例因子缩放</li>
<li>unsigned_long：无符号 64 位整数。</li>
</ul>
<h4 id="2-2、基本数据类型"><a href="#2-2、基本数据类型" class="headerlink" title="2.2、基本数据类型"></a><strong>2.2、基本数据类型</strong></h4><ul>
<li><strong>binary：Base64 字符串二进制值</strong></li>
<li><strong>boolean：布尔类型，接收 ture 和 false 两个值</strong></li>
<li><strong>alias：字段别名</strong></li>
</ul>
<h4 id="2-3、Keywords-类型"><a href="#2-3、Keywords-类型" class="headerlink" title="2.3、Keywords 类型"></a><strong>2.3、Keywords 类型</strong></h4><ul>
<li><strong>keyword：适用于索引结构化的字段，可以用于过滤、排序、聚合。keyword类型的字段只能通过精确值搜索到。如 Id、姓名这类字段应使用 keyword</strong></li>
<li>constant_keyword：始终包含相同值的关键字字段</li>
<li>wildcard：可针对类似 grep 的</li>
</ul>
<h4 id="2-4、Dates（时间类型）"><a href="#2-4、Dates（时间类型）" class="headerlink" title="2.4、Dates（时间类型）"></a><strong>2.4、Dates</strong>（时间类型）</h4><ul>
<li><strong>date：JSON 没有日期数据类型，因此 Elasticsearch 中的日期可以是以下三种</strong><ul>
<li><strong>包含格式化日期的字符串，例如 “2015-01-01”、 “2015&#x2F;01&#x2F;01 12:10:30”</strong></li>
<li><strong>时间戳，表示<em>自”1970年 1 月 1 日”以来的毫秒</em>数&#x2F;秒数。</strong></li>
</ul>
</li>
<li><strong>date_nanos</strong>：此数据类型是对 date 类型的补充。但是有一个重要区别。date 类型存储最高精度为毫秒，而date_nanos 类型存储日期最高精度是纳秒，但是高精度意味着可存储的日期范围小，即：从大约 1970 到 2262，因为日期仍存储为表示纳秒的长 自时代以来。</li>
</ul>
<h4 id="2-5、对象类型"><a href="#2-5、对象类型" class="headerlink" title="2.5、对象类型"></a>2.5、对象类型</h4><ul>
<li><strong>object：非基本数据类型之外，默认的 json 对象为 object 类型。</strong></li>
<li><strong>flattened：单映射对象类型，其值为 json 对象。</strong></li>
<li><strong>nested ★：嵌套类型。</strong></li>
<li><strong>join：父子级关系类型。</strong></li>
</ul>
<h4 id="2-6、空间数据类型"><a href="#2-6、空间数据类型" class="headerlink" title="2.6、空间数据类型"></a>2.6、空间数据类型</h4><ul>
<li><strong>geo_point：纬度和经度点。</strong></li>
<li><strong>geo_shape：复杂的形状，例如多边形。</strong></li>
<li><strong>point</strong>：任意笛卡尔点。</li>
<li><strong>shape</strong>：任意笛卡尔几何。</li>
</ul>
<h4 id="2-7、文档排名类型"><a href="#2-7、文档排名类型" class="headerlink" title="2.7、文档排名类型"></a>2.7、文档排名类型</h4><ul>
<li>dense_vector：记录浮点值的密集向量。</li>
<li>rank_feature：记录数字特征以提高查询时的命中率。</li>
<li>rank_features：记录数字特征以提高查询时的命中率。</li>
</ul>
<h4 id="2-8、文本搜索类型"><a href="#2-8、文本搜索类型" class="headerlink" title="2.8、文本搜索类型"></a>2.8、文本搜索类型</h4><ul>
<li><p><strong>text：文本类型</strong></p>
</li>
<li><p>**annotated-text：*<em>包含特殊文本 标记。用于标识命名实体*<em>。</em></em></p>
</li>
<li><p><strong>completion ★：用于自动补全，即搜索推荐</strong></p>
</li>
<li><p><strong>search_as_you_type：</strong> 类似文本的字段，经过优化 为提供按类型完成的查询提供现成支持 用例</p>
</li>
<li><p><strong>token_count</strong>：文本中的标记计数。</p>
</li>
</ul>
<h3 id="3、两种映射类型"><a href="#3、两种映射类型" class="headerlink" title="3、两种映射类型"></a>3、两种映射类型</h3><h4 id="3-1、自动映射：Dynamic-field-mapping"><a href="#3-1、自动映射：Dynamic-field-mapping" class="headerlink" title="3.1、自动映射：Dynamic field mapping"></a>3.1、自动映射：Dynamic field mapping</h4><table>
<thead>
<tr>
<th><strong>field type</strong></th>
<th><strong>dynamic</strong></th>
</tr>
</thead>
<tbody><tr>
<td>true&#x2F;false</td>
<td>boolean</td>
</tr>
<tr>
<td>小数</td>
<td>float</td>
</tr>
<tr>
<td>数字</td>
<td>long</td>
</tr>
<tr>
<td>object</td>
<td>object</td>
</tr>
<tr>
<td>数组</td>
<td>取决于数组中的第一个非空元素的类型</td>
</tr>
<tr>
<td>日期格式字符串</td>
<td>date</td>
</tr>
<tr>
<td>数字类型字符串</td>
<td>float&#x2F;long</td>
</tr>
<tr>
<td>其他字符串</td>
<td>text + keyword</td>
</tr>
</tbody></table>
<p>除了上述字段类型之外，其他类型都必须显示映射，也就是必须手工指定，因为其他类型ES无法自动识别。</p>
<h4 id="3-2、显示映射-Expllcit-field-mapping"><a href="#3-2、显示映射-Expllcit-field-mapping" class="headerlink" title="3.2、显示映射 Expllcit field mapping"></a>3.2、显示映射 Expllcit field mapping</h4><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">PUT /product</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mapping_parameter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;parameter_value&quot;</span><span class="punctuation">,</span></span><br><span class="line">		...</span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	  ...</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="4、映射参数"><a href="#4、映射参数" class="headerlink" title="4、映射参数"></a>4、映射参数</h3><ul>
<li><p><strong>index</strong>：是否对创建对当前字段创建倒排索引，默认 true，如果不创建索引，该字段不会通过索引被搜索到,但是仍然会在 source 元数据中展示</p>
</li>
<li><p><strong>analyzer</strong>：指定分析器（character filter、tokenizer、Token filters）。</p>
</li>
<li><p><strong>boost</strong>：对当前字段相关度的评分权重，默认1</p>
</li>
<li><p><strong>coerce</strong>：是否允许强制类型转换 true “1”&#x3D;&gt; 1 false “1”&#x3D;&lt; 1</p>
</li>
<li><p><strong>copy_to</strong>：该参数允许将多个字段的值复制到组字段中，然后可以将其作为单个字段进行查询</p>
</li>
<li><p><strong>doc_values</strong>：为了提升排序和聚合效率，默认true，如果确定不需要对字段进行排序或聚合，也不需要通过脚本访问字段值，则可以禁用doc值以节省磁盘空间（不支持text和annotated_text）</p>
</li>
<li><p><strong>dynamic</strong>：控制是否可以动态添加新字段</p>
<ul>
<li><strong>true</strong> 新检测到的字段将添加到映射中。（默认）</li>
<li><strong>false</strong> 新检测到的字段将被忽略。这些字段将不会被索引，因此将无法搜索，但仍会出现在_source返回的匹配项中。这些字段不会添加到映射中，必须显式添加新字段。</li>
</ul>
</li>
<li><p><strong>strict</strong> 如果检测到新字段，则会引发异常并拒绝文档。必须将新字段显式添加到映</p>
</li>
<li><p><strong>eager_global_ordinals</strong>：用于聚合的字段上，优化聚合性能，但不适用于 Frozen indices。</p>
<ul>
<li><strong>Frozen indices</strong>（冻结索引）：有些索引使用率很高，会被保存在内存中，有些使用率特别低，宁愿在使用的时候重新创建，在使用完毕后丢弃数据，Frozen indices 的数据命中频率小，不适用于高搜索负载，数据不会被保存在内存中，堆空间占用比普通索引少得多，Frozen indices是只读的，请求可能是秒级或者分钟级。</li>
</ul>
</li>
<li><p><strong>enable</strong>：是否创建倒排索引，可以对字段操作，也可以对索引操作，如果不创建索引，让然可以检索并在_source元数据中展示，谨慎使用，该状态无法修改。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;enabled&quot;: false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>fielddata</strong>：查询时内存数据结构，在首次用当前字段聚合、排序或者在脚本中使用时，需要字段为fielddata数据结构，并且创建倒排索引保存到堆中</p>
</li>
<li><p><strong>fields</strong>：给field创建多字段，用于不同目的（全文检索或者聚合分析排序）</p>
</li>
<li><p><strong>format</strong>：格式化</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;date&quot;: &#123;</span><br><span class="line">   &quot;type&quot;:  &quot;date&quot;,</span><br><span class="line">   &quot;format&quot;: &quot;yyyy-MM-dd&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ignore_above</strong>：超过长度将被忽略</p>
</li>
<li><p><strong>ignore_malformed</strong>：忽略类型错误</p>
</li>
<li><p><strong>index_options</strong>：控制将哪些信息添加到反向索引中以进行搜索和突出显示。仅用于text字段</p>
</li>
<li><p><strong>Index_phrases</strong>：提升 exact_value 查询速度，但是要消耗更多磁盘空间</p>
</li>
<li><p><strong>Index_prefixes</strong>：前缀搜索</p>
<ul>
<li><strong>min_chars</strong>：前缀最小长度，&gt; 0，默认 2（包含）</li>
<li><strong>max_chars</strong>：前缀最大长度，&lt; 20，默认 5（包含）</li>
</ul>
</li>
<li><p><strong>meta</strong>：附加元数据</p>
</li>
<li><p><strong>normalizer</strong>：</p>
</li>
<li><p>**norms：*<em>是否禁用评分（在 filter 和聚合字段上应该禁用）*<em>。</em></em></p>
</li>
<li><p><strong>null_value</strong>：为 null 值设置默认值</p>
</li>
<li><p><strong>position_increment_gap</strong>：参考 <a target="_blank" rel="noopener" href="https://blog.csdn.net/wlei0618/article/details/128189190">match_phrase 跨值查询中 position_increment_gap 参数用法</a></p>
</li>
<li><p><strong>proterties</strong>：除了mapping还可用于object的属性设置</p>
</li>
<li><p><strong>search_analyzer</strong>：设置单独的查询时分析器：</p>
</li>
<li><p><strong>similarity</strong>：为字段设置相关度算法，支持BM25、classic（TF-IDF）、boolean</p>
</li>
<li><p><strong>store</strong>：设置字段是否仅查询</p>
</li>
<li><p><strong>term_vector</strong>：运维参数，会在进阶课程中深入讲解</p>
</li>
</ul>
<h3 id="5、Text-和-Keyword-类型"><a href="#5、Text-和-Keyword-类型" class="headerlink" title="5、Text 和 Keyword 类型"></a>5、Text 和 Keyword 类型</h3><h4 id="5-1、Text-类型"><a href="#5-1、Text-类型" class="headerlink" title="5.1、Text 类型"></a>5.1、Text 类型</h4><h5 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h5><p>当一个字段是要被全文搜索的，比如 Email 内容、产品描述，这些字段应该使用 text 类型。设置 text 类型以后，字段内容会被分析，在生成倒排索引以前，字符串会被分析器分成一个一个词项。text类型的字段不用于排序，很少用于聚合。</p>
<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ul>
<li>适用于全文检索：如 match 查询</li>
<li>文本字段会被分词</li>
<li>默认情况下，会创建倒排索引</li>
<li>自动映射器会为 Text 类型创建 Keyword 字段<img src="/img/loading.gif" data-original="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/28/1665572973023/f501f61d4a34405ca43b4cb095b7e52b.png" alt="image.png"></li>
</ul>
<h4 id="5-2-Keyword-类型"><a href="#5-2-Keyword-类型" class="headerlink" title="5.2 Keyword 类型"></a>5.2 Keyword 类型</h4><h5 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h5><p>Keyword 类型适用于不分词的字段，如姓名、Id、数字等。如果数字类型不用于范围查找，用 Keyword 的性能要高于数值类型。</p>
<h5 id="语法和语义"><a href="#语法和语义" class="headerlink" title="语法和语义"></a>语法和语义</h5><p>如当使用 keyword 类型查询时，其字段值会被作为一个整体，并保留字段值的原始属性。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title.keyword&quot;: &quot;测试文本值&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h5><ul>
<li>Keyword 不会对文本分词，会保留字段的原有属性，包括大小写等。</li>
<li>Keyword 仅仅是字段类型，而不会对搜索词产生任何影响</li>
<li>Keyword 一般用于需要精确查找的字段，或者聚合排序字段</li>
<li>Keyword 通常和 Term 搜索一起用（会在 DSL 中提到）</li>
<li>Keyword 字段的 ignore_above 参数代表其截断长度，默认 256，如果超出长度，字段值会被忽略，而不是截断。</li>
</ul>
<h3 id="6、映射模板"><a href="#6、映射模板" class="headerlink" title="6、映射模板"></a>6、映射模板</h3><h4 id="6-1、简介"><a href="#6-1、简介" class="headerlink" title="6.1、简介"></a>6.1、简介</h4><p>之前讲过的映射类型或者字段参数，都是为确定的某个字段而声明的，如果希望对符合某类要求的特定字段制定映射，就需要用到映射模板：Dynamic templates。</p>
<p>映射模板有时候也被称作：自动映射模板、动态模板等。</p>
<h4 id="6-2、用法"><a href="#6-2、用法" class="headerlink" title="6.2、用法"></a>6.2、用法</h4><h5 id="基本语法-2"><a href="#基本语法-2" class="headerlink" title="基本语法"></a>基本语法</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;dynamic_templates&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;my_template_name&quot;: &#123; </span><br><span class="line">        ... match conditions ... </span><br><span class="line">        &quot;mapping&quot;: &#123; ... &#125; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h5 id="Conditions参数"><a href="#Conditions参数" class="headerlink" title="Conditions参数"></a>C<strong>onditions参数</strong></h5><ul>
<li><strong>match_mapping_type</strong> ：主要用于对数据类型的匹配</li>
<li><strong>match 和 unmatch</strong>：用于对字段名称的匹配</li>
</ul>
<h5 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT test_dynamic_template</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_templates&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;integers&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;long&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;longs_as_strings&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;match&quot;: &quot;num_*&quot;,</span><br><span class="line">          &quot;unmatch&quot;: &quot;*_text&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码会产生以下效果：</p>
<ul>
<li>所有 long 类型字段会默认映射为 integer</li>
<li>所有文本字段，如果是以 num_ 开头，并且不以 _text 结尾，会自动映射为 keyword 类型</li>
</ul>
<h2 id="六、分词器"><a href="#六、分词器" class="headerlink" title="六、分词器"></a>六、分词器</h2><h3 id="1、什么是分词器"><a href="#1、什么是分词器" class="headerlink" title="1、什么是分词器"></a>1、什么是分词器</h3><p>分词器（Text Analysis），也称为词法分析器（Lexical Analyzer），是一种将文本（通常是自然语言文本）分解成一系列单独的词汇单元（Token）的程序。</p>
<p>在自然语言处理中，分词器通常用于将文本分解成单独的词汇单元，这些单元将作为后续处理步骤的输入。这些词汇单元可以是单词、短语或句子等文本元素，这取决于分词器的具体实现和应用场景。例如，在搜索引擎中，分词器将文本查询分解成关键词，以便于搜索引擎匹配相关文档。</p>
<p>分词器通常基于特定的规则或算法进行操作。这些规则或算法可能基于词汇表、语法规则或机器学习技术等。在一些分词器中，还可能涉及词干提取、停用词过滤、拼写纠正、同义词处理等操作，以提高分词的准确性和效果。</p>
<h3 id="2、-analyze-API"><a href="#2、-analyze-API" class="headerlink" title="2、_analyze API"></a>2、_analyze API</h3><p>在 Elasticsearch 中，可以使用 _analyze API 对指定的文本进行分词和分析，以便于调试和优化分词器的性能。</p>
<p>要使用 _analyze API，可以使用以下 HTTP 请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /&#123;index&#125;/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;&#123;analyzer_name&#125;&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;&#123;text&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，{index} 是要分析的索引名称，{analyzer_name} 是要使用的分词器的名称，{text} 是要分析的文本内容。这个请求将返回一个包含分析结果的 JSON 格式的响应。</p>
<p>例如，如果要对 “Quick brown fox” 进行分词，可以使用以下请求：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Quick brown fox&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个请求将使用标准分词器对 “Quick brown fox” 进行分词，并返回以下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;quick&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 5,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;brown&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 6,</span><br><span class="line">      &quot;end_offset&quot;: 11,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;fox&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 12,</span><br><span class="line">      &quot;end_offset&quot;: 15,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个响应包含了分析结果，其中包括了分词后的单词、单词的偏移量、类型和位置等信息。</p>
<p>总之，_analyze API 可以帮助您了解分词器的工作原理和分析结果，以便于优化分词器的性能和效果。</p>
<h3 id="3、分词器的组成"><a href="#3、分词器的组成" class="headerlink" title="3、分词器的组成"></a>3、分词器的组成</h3><h4 id="3-1、Character-Filter"><a href="#3-1、Character-Filter" class="headerlink" title="3.1、Character Filter"></a>3.1、<strong>Character Filter</strong></h4><p>分词之前的预处理，过滤无用字符</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT &lt;index_name&gt;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;my_char_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;&lt;value&gt;&quot;  // 参数 type: html_strip、mapping、pattern_replace</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="HTML-标签过滤器"><a href="#HTML-标签过滤器" class="headerlink" title="HTML 标签过滤器"></a>HTML 标签过滤器</h5><p>字符过滤器会去除 HTML 标签和转义 HTML 元素，如 <strong>、&amp;</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT test_char_filter</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;my_char_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;html_strip&quot;, </span><br><span class="line">          &quot;escaped_tags&quot;: [</span><br><span class="line">            &quot;a&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET test_html_strip_filter/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;, </span><br><span class="line">  &quot;char_filter&quot;: [&quot;my_char_filter&quot;],</span><br><span class="line">  &quot;text&quot;: [&quot;&lt;p&gt;I&#x27;m so &lt;a&gt;happy&lt;/a&gt;!&lt;/p&gt;&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>参数：</strong></p>
<ul>
<li>escaped_tags：需要保留的 html 标签</li>
</ul>
<h5 id="字符映射过滤器：Mapping-Character-Filter"><a href="#字符映射过滤器：Mapping-Character-Filter" class="headerlink" title="字符映射过滤器：Mapping Character Filter"></a>字符映射过滤器：Mapping Character Filter</h5><p>通过定义映替换为规则，把特定字符替换为指定字符</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT test_html_strip_filter</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;my_char_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;mapping&quot;,	// mapping 代表使用字符映射过滤器</span><br><span class="line">          &quot;mappings&quot;: [				// 数组中规定的字符会被等价替换为 =&gt; 指定的字符</span><br><span class="line">            &quot;滚 =&gt; *&quot;,</span><br><span class="line">            &quot;垃 =&gt; *&quot;,</span><br><span class="line">            &quot;圾 =&gt; *&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET test_html_strip_filter/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  //&quot;tokenizer&quot;: &quot;standard&quot;, </span><br><span class="line">  &quot;char_filter&quot;: [&quot;my_char_filter&quot;],</span><br><span class="line">  &quot;text&quot;: &quot;你就是个垃圾！滚&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="正则替换过滤器：Pattern-Replace-Character-Filter"><a href="#正则替换过滤器：Pattern-Replace-Character-Filter" class="headerlink" title="正则替换过滤器：Pattern Replace Character Filter"></a>正则替换过滤器：Pattern Replace Character Filter</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT text_pattern_replace_filter</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;my_char_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;pattern_replace&quot;,	// pattern_replace 代表使用正则替换过滤器</span><br><span class="line">          &quot;pattern&quot;: &quot;&quot;&quot;(\d&#123;3&#125;)\d&#123;4&#125;(\d&#123;4&#125;)&quot;&quot;&quot;,	// 正则表达式</span><br><span class="line">          &quot;replacement&quot;: &quot;$1****$2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET text_pattern_replace_filter/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;char_filter&quot;: [&quot;my_char_filter&quot;],</span><br><span class="line">  &quot;text&quot;: &quot;您的手机号是18868686688&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2、Tokenizer"><a href="#3-2、Tokenizer" class="headerlink" title="3.2、Tokenizer"></a>3.2、Tokenizer</h4><p>可以把切词器理解为预定义的切词规则。</p>
<p>官方内置了很多种切词器，默认的切词器为 standard。</p>
<p>在 Elasticsearch (ES) 中，Tokenizer 是一种文本处理组件，用于将输入的文本数据分割成称为词汇单元（Tokens）的片段。Tokenizer 在文本分析过程中起到了关键的作用，它将文本转换为可供索引和搜索的基本单位。</p>
<p>ES 提供了多种内置的 Tokenizer，每种 Tokenizer 都有不同的分割规则。下面是一些常见的 Tokenizer 示例：</p>
<ol>
<li>Standard Tokenizer（标准分词器）：<ul>
<li>这是 ES 默认的 Tokenizer，它使用 Unicode 文本分割算法将文本分割成单个词汇单元。它会去除标点符号和空格，并将文本转换为小写形式。例如，输入文本 “Hello, World!” 会被分割成两个词汇单元 “hello” 和 “world”。</li>
</ul>
</li>
<li>Whitespace Tokenizer（空格分词器）：<ul>
<li>这个 Tokenizer 根据空格字符将文本分割为词汇单元。它保留空格和标点符号，不做大小写转换。例如，输入文本 “Hello, World!” 会被分割成三个词汇单元 “Hello,”、”World!” 和 “”（空字符）。</li>
</ul>
</li>
<li>Keyword Tokenizer（关键字分词器）：<ul>
<li>这个 Tokenizer 将整个输入作为单个词汇单元。它通常用于不需要对输入进行分词的场景，如精确匹配。例如，输入文本 “Hello, World!” 会作为一个完整的词汇单元存储。</li>
</ul>
</li>
<li>Pattern Tokenizer（模式分词器）：<ul>
<li>这个 Tokenizer 根据正则表达式模式将文本分割为词汇单元。你可以根据自定义的模式定义如何分割文本。例如，使用模式 <code>\W+</code>，输入文本 “Hello, World!” 会被分割成两个词汇单元 “Hello” 和 “World”。</li>
</ul>
</li>
<li>Language-specific Tokenizers（特定语言分词器）：<ul>
<li>ES 还提供了针对特定语言的 Tokenizer，如英语、中文、日语等。这些分词器会根据特定的语言规则和语法进行分词。例如，中文分词器会将中文文本按照词语进行分割。</li>
</ul>
</li>
</ol>
<p>这些示例只是 ES 中一些常见的 Tokenizer，你还可以自定义 Tokenizer 来满足特定需求。Tokenizer 是 ES 中文本处理流程的关键组件之一，它的选择和配置对于索引和搜索的结果影响重大。根据你的数据和需求，选择适合的 Tokenizer 可以提高搜索的准确性和性能。</p>
<h4 id="3-3、Token-Filter"><a href="#3-3、Token-Filter" class="headerlink" title="3.3、Token Filter"></a>3.3、Token Filter</h4><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><p>在 Elasticsearch (ES) 中，Token Filter 是一种文本处理组件，用于对 Tokenizer 分割得到的词汇单元进行进一步的处理和修改。Token Filter 可以修改、删除或添加新的词汇单元，以改善索引和搜索的效果。</p>
<p>在 Elasticsearch 的查询 DSL (Domain Specific Language) 中，可以通过配置 Token Filter 来定义如何处理和修改文本数据。</p>
<h5 id="常见的-token-filter"><a href="#常见的-token-filter" class="headerlink" title="常见的 token filter"></a>常见的 token filter</h5><ul>
<li><code>synonym</code>：用于将指定的词汇替换为其同义词。这对于扩展搜索能力或纠正拼写错误很有用。例如，将 “car” 替换为 “automobile”。</li>
<li><code>ngram</code>：将词汇单元拆分成 n-gram（连续的 n 个字符），用于支持部分匹配和模糊搜索。例如，”quick” 可以拆分成 “qu”、”qui”、”quic”、”quick”。</li>
<li><code>stemmer</code>：应用词干提取算法，将单词还原为其词干形式。例如，将 “running” 还原为 “run”。</li>
<li><code>stop</code>：移除停用词，这些词在搜索中往往没有实际意义或频繁出现。例如，”the”、”is”、”and”。</li>
<li><code>trim</code>：修剪词汇单元的前导和尾随空格。</li>
<li><code>phonetic</code>：生成音译代码，用于支持音译搜索。例如，将 “Smith” 转换为 “SM0”.</li>
</ul>
<h5 id="案例-2"><a href="#案例-2" class="headerlink" title="案例"></a>案例</h5><p>下面是一个示例，演示了如何在查询中使用 Token Filter：</p>
<p>假设我们有一个索引，其中包含一个名为 “description” 的字段，我们希望在查询时使用 Token Filter 对输入的查询文本进行处理。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT stop_token_filter</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;my_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;stop&quot;,</span><br><span class="line">          &quot;stopwords&quot;: [</span><br><span class="line">            &quot;www&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;ignore_case&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET stop_token_filter/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;whitespace&quot;, </span><br><span class="line">  &quot;filter&quot;: [&quot;my_filter&quot;], </span><br><span class="line">  &quot;text&quot;: [&quot;WWW ELASTIC ORG CN&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4、在映射中定义分词器"><a href="#4、在映射中定义分词器" class="headerlink" title="4、在映射中定义分词器"></a>4、在映射中定义分词器</h3><h4 id="4-1、语法"><a href="#4-1、语法" class="headerlink" title="4.1、语法"></a>4.1、语法</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT &#123;index&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;title&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;&#123;analyzer&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2、内置分词器"><a href="#4-2、内置分词器" class="headerlink" title="4.2、内置分词器"></a>4.2、内置分词器</h4><ul>
<li><strong>Standard Analyzer（标准分析器）</strong> ：标准分析器是 ES 默认的分析器，它使用 Unicode 文本分割算法将文本分割成单个词汇单元。它会去除标点符号和空格，并将文本转换为小写形式。例如，将输入文本 “Hello, World!” 分析为 “hello” 和 “world”。</li>
<li><strong>Whitespace Analyzer（空格分析器）</strong> ：空格分析器根据空格字符将文本分割为词汇单元。它保留空格和标点符号，不做大小写转换。例如，将输入文本 “Hello, World!” 分析为 “Hello,”、”World!” 和 “”（空字符）。</li>
<li><strong>Simple Analyzer（简单分析器）</strong> ：简单分析器根据非字母字符将文本分割为词汇单元，并将词汇单元转换为小写形式。它不处理停用词和词干提取。例如，将输入文本 “Quick brown fox” 分析为 “quick”、”brown” 和 “fox”。</li>
<li><strong>Keyword Analyzer（关键字分析器）</strong> ：关键字分析器将整个输入作为单个词汇单元，不进行分词。它通常用于不需要对输入进行分词的场景，如精确匹配。</li>
<li><strong>Language-specific Analyzers（特定语言分析器）</strong> ：Elasticsearch 还提供了针对特定语言的分析器，如英语（English Analyzer）、法语（French Analyzer）、德语（German Analyzer）等。这些分析器根据特定的语言规则和语法进行分词、停用词过滤、词干提取等处理。</li>
</ul>
<h3 id="5、自定义分词器"><a href="#5、自定义分词器" class="headerlink" title="5、自定义分词器"></a>5、自定义分词器</h3><h4 id="5-1、概念"><a href="#5-1、概念" class="headerlink" title="5.1、概念"></a>5.1、概念</h4><p>在 Elasticsearch 中，可以通过配置自定义分词器来满足特定的需求和应用场景。自定义分词器可以根据具体的分析需求进行优化和调整，从而提高分词的准确性和效率。</p>
<p>以下是创建自定义分词器的一般步骤：</p>
<ol>
<li>编写分词器代码：您可以使用 Elasticsearch 内置的分词器代码作为基础，也可以自己编写分词器代码。分词器代码通常包括三个部分：Tokenizer、Token Filter 和 Char Filter。Tokenizer 负责将输入文本分解成单词，Token Filter 用于对单词进行处理和过滤，Char Filter 用于对文本字符进行处理和过滤。</li>
<li>将分词器代码打包成插件：您需要将自己编写的分词器代码打包成 Elasticsearch 插件，以便于在 Elasticsearch 中使用。可以使用 Elasticsearch 提供的开发工具或 Maven 等工具进行打包。</li>
<li>将插件安装到 Elasticsearch：您需要将打包好的插件安装到 Elasticsearch 中。可以使用 Elasticsearch 的插件管理工具或手动安装方式进行安装。</li>
<li>配置分词器：安装插件后，您需要在 Elasticsearch 中配置自定义分词器。可以使用 Elasticsearch 的索引模板、分析器设置或 API 等方式进行配置。</li>
</ol>
<h4 id="5-2-案例"><a href="#5-2-案例" class="headerlink" title="5.2 案例"></a>5.2 案例</h4><p>以下是一个包含自定义分词器的索引映射 DSL 示例，其中包括 Tokenizer、Token Filter 和 Char Filter 三个组件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_analyzer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;tokenizer&quot;: &quot;my_tokenizer&quot;,</span><br><span class="line">          &quot;filter&quot;: [&quot;my_token_filter&quot;],</span><br><span class="line">          &quot;char_filter&quot;: [&quot;my_char_filter&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;tokenizer&quot;: &#123;</span><br><span class="line">        &quot;my_tokenizer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;pattern&quot;,</span><br><span class="line">          &quot;pattern&quot;: &quot;\\W+&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;my_token_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;lowercase&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;my_char_filter&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;html_strip&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;my_field&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_analyzer&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个示例中，我们定义了一个名为 “my_analyzer” 的自定义分析器，它使用了我们自己定义的 “my_tokenizer” Tokenizer、”my_token_filter” Token Filter 和 “my_char_filter” Char Filter。</p>
<p>“my_tokenizer” Tokenizer 是一个基于正则表达式的 Tokenizer，用于将输入文本分解成单词。它的正则表达式 “\W+” 表示将非单词字符作为分隔符来分解单词。</p>
<p>“my_token_filter” Token Filter 是一个将所有单词转换为小写的 Token Filter。</p>
<p>“my_char_filter” Char Filter 是一个使用 HTML 去除器来过滤输入文本中的 HTML 标记的 Char Filter。</p>
<p>最后，我们将这个自定义分析器应用到 “my_field” 字段上，以进行索引和搜索。</p>
<p>以下是一个针对示例索引映射的测试数据和执行结果。</p>
<p>测试数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;my_field&quot;: &quot;&lt;p&gt;This is a Test&lt;/p&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行以下请求</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;my_field&quot;: &quot;test&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 6,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 0.2876821,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;my_index&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.2876821,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;my_field&quot; : &quot;&lt;p&gt;This is a Test&lt;/p&gt;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个执行结果中，我们使用自定义分析器对 “my_field” 字段进行了索引和搜索。搜索请求中的关键字 “test” 已经被转换成小写，并且匹配到了测试数据中的单词 “Test”。因此，我们可以看到执行结果中包含了这条文档。</p>
<h3 id="6、中文分词器"><a href="#6、中文分词器" class="headerlink" title="6、中文分词器"></a>6、中文分词器</h3><h4 id="6-1、什么是中文分词器"><a href="#6-1、什么是中文分词器" class="headerlink" title="6.1、什么是中文分词器"></a>6.1、什么是中文分词器</h4><p>中文分词器是一种针对中文语言特点的分词器，用于将中文文本按照一定的规则进行分词。由于中文语言不像英文或其他拉丁文字语言那样单词之间有空格来区分，因此在中文文本处理中，需要使用中文分词器来进行分词，以便更好地进行文本分析和搜索。</p>
<p>中文分词器可以将一个中文句子或段落拆分成一个个有意义的词语，每个词语代表一个语义单元。这对于中文文本处理来说是非常重要的，因为中文中一个词可以包含多个字，而这些字的组合方式不一定有明确的规则。例如，“人工智能”、“人民公园”、“高速公路”等都是常见的中文词汇，但它们的字的组合方式是不同的。</p>
<p>中文分词器的工作原理大致可以分为两个步骤：切词和过滤。在切词阶段，中文分词器会根据一定的规则将文本切分成一个个词语，通常采用的算法有基于字典匹配和基于统计的方法。在过滤阶段，中文分词器会根据一些过滤规则过滤掉一些无意义的词语，例如停用词等。</p>
<h4 id="6-2、下载和安装"><a href="#6-2、下载和安装" class="headerlink" title="6.2、下载和安装"></a>6.2、下载和安装</h4><ol>
<li>下载 ik 分词器 可以从 GitHub 上下载最新版本的 ik 分词器，下载地址为：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases%E3%80%82">https://github.com/medcl/elasticsearch-analysis-ik/releases。</a></li>
<li>解压 ik 分词器 将下载的 ik 分词器压缩包解压缩到 Elasticsearch 安装目录下的 plugins&#x2F;analysis-ik 目录中。如果该目录不存在，则需要手动创建。</li>
<li>重启 Elasticsearch 解压完成后，需要重启 Elasticsearch 才能加载 ik 分词器。可以使用以下命令重启 Elasticsearch：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart elasticsearch</span><br></pre></td></tr></table></figure>

<ol>
<li>测试 ik 分词器 安装完成后，可以使用 Elasticsearch 的 Analyze API 来测试 ik 分词器是否正常工作。假设有一个名为 my_index 的索引，需要对其中的一个字段进行分词，可以使用以下命令：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;这是一段中文文本&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述命令中，使用了 ik_smart 分词器对文本进行分词。如果 ik 分词器已经成功安装并正常工作，会返回分词结果。</p>
<h4 id="6-3、案例"><a href="#6-3、案例" class="headerlink" title="6.3、案例"></a>6.3、案例</h4><p>假设有一个名为 my_index 的索引，其中包含一个名为 content 的字段，需要对该字段的文本进行中文分词。</p>
<p>创建索引</p>
<p>首先，需要创建一个包含 content 字段的索引，使用以下命令创建：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cssCopy code</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加文档</p>
<p>然后，向 my_index 索引中添加一些文档，每个文档包含一个 content 字段，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bashCopy code</span><br><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;这是一个中文文本&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: &quot;我爱中国&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询分词结果</p>
<p>接下来，可以使用 Elasticsearch 的 _analyze API 来查询文本在 ik_smart 分词器下的分词结果，使用以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlCopy code</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;这是一个中文文本&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该命令将返回以下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">jsonCopy code</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;这是&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 2,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;一个&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 2,</span><br><span class="line">      &quot;end_offset&quot;: 4,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;中文&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 4,</span><br><span class="line">      &quot;end_offset&quot;: 6,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;文本&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 6,</span><br><span class="line">      &quot;end_offset&quot;: 8,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 3</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样地，查询分词器对另一个文本的分词结果，使用以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlCopy code</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;我爱中国&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该命令将返回以下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">jsonCopy code</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;我爱&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 2,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;中国&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 2,</span><br><span class="line">      &quot;end_offset&quot;: 4,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，就成功地使用了 ik 分词器对中文文本进行了分词，并查询了分词结果。</p>
<h2 id="七、JavaAPI"><a href="#七、JavaAPI" class="headerlink" title="七、JavaAPI"></a>七、JavaAPI</h2><h3 id="1、环境准备"><a href="#1、环境准备" class="headerlink" title="1、环境准备"></a>1、环境准备</h3><p>添加依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;7.8.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- elasticsearch 的客户端 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;7.8.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- elasticsearch 依赖 2.x 的 log4j --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.8.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.8.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.9.9&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- junit 单元测试 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;4.12&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>连接测试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloElasticsearch</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="comment">// 创建客户端对象</span></span><br><span class="line">		<span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">				RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)));</span><br><span class="line"><span class="comment">//		...</span></span><br><span class="line">		System.out.println(client);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 关闭客户端连接</span></span><br><span class="line">		client.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重构代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ElasticsearchTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">(RestHighLevelClient client)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectElasticsearch</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(ElasticsearchTask task)</span>&#123;</span><br><span class="line">        <span class="comment">// 创建客户端对象</span></span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            task.doSomething(client);</span><br><span class="line">            <span class="comment">// 关闭客户端连接</span></span><br><span class="line">            client.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，如果想让Elasticsearch完成一些操作，就编写一个lambda式即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeClass</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(client -&gt; &#123;</span><br><span class="line">			<span class="comment">//do something</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2、索引创建"><a href="#2、索引创建" class="headerlink" title="2、索引创建"></a>2、索引创建</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CreateIndex</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建客户端对象</span></span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建索引 - 请求对象</span></span><br><span class="line">        <span class="type">CreateIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateIndexRequest</span>(<span class="string">&quot;user2&quot;</span>);</span><br><span class="line">        <span class="comment">// 发送请求，获取响应</span></span><br><span class="line">        <span class="type">CreateIndexResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.indices().create(request,</span><br><span class="line">                RequestOptions.DEFAULT);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">acknowledged</span> <span class="operator">=</span> response.isAcknowledged();</span><br><span class="line">        <span class="comment">// 响应状态</span></span><br><span class="line">        System.out.println(<span class="string">&quot;操作状态 = &quot;</span> + acknowledged);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端连接</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3、索引查询-amp-删除"><a href="#3、索引查询-amp-删除" class="headerlink" title="3、索引查询 &amp; 删除"></a>3、索引查询 &amp; 删除</h3><p><strong>查询</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchIndex</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建客户端对象</span></span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询索引 - 请求对象</span></span><br><span class="line">        <span class="type">GetIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetIndexRequest</span>(<span class="string">&quot;user2&quot;</span>);</span><br><span class="line">        <span class="comment">// 发送请求，获取响应</span></span><br><span class="line">        <span class="type">GetIndexResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.indices().get(request,</span><br><span class="line">                RequestOptions.DEFAULT);</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;aliases:&quot;</span>+response.getAliases());</span><br><span class="line">        System.out.println(<span class="string">&quot;mappings:&quot;</span>+response.getMappings());</span><br><span class="line">        System.out.println(<span class="string">&quot;settings:&quot;</span>+response.getSettings());</span><br><span class="line"></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">aliases:&#123;user2=[]&#125;</span><br><span class="line">mappings:&#123;user2=org.elasticsearch.cluster.metadata.MappingMetadata@ad700514&#125;</span><br><span class="line">settings:&#123;user2=&#123;&quot;index.creation_date&quot;:&quot;1617948726976&quot;,&quot;index.number_of_replicas&quot;:&quot;1&quot;,&quot;index.number_of_shards&quot;:&quot;1&quot;,&quot;index.provided_name&quot;:&quot;user2&quot;,&quot;index.uuid&quot;:&quot;UGZ1ntcySnK6hWyP2qoVpQ&quot;,&quot;index.version.created&quot;:&quot;7080099&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p><strong>删除</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeleteIndex</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)));</span><br><span class="line">        <span class="comment">// 删除索引 - 请求对象</span></span><br><span class="line">        <span class="type">DeleteIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteIndexRequest</span>(<span class="string">&quot;user2&quot;</span>);</span><br><span class="line">        <span class="comment">// 发送请求，获取响应</span></span><br><span class="line">        <span class="type">AcknowledgedResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.indices().delete(request,RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 操作结果</span></span><br><span class="line">        System.out.println(<span class="string">&quot;操作结果 ： &quot;</span> + response.isAcknowledged());</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4、文档新增-amp-修改"><a href="#4、文档新增-amp-修改" class="headerlink" title="4、文档新增 &amp; 修改"></a>4、文档新增 &amp; 修改</h3><p>新增</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InsertDoc</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(client -&gt; &#123;</span><br><span class="line">            <span class="comment">// 新增文档 - 请求对象</span></span><br><span class="line">            <span class="type">IndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>();</span><br><span class="line">            <span class="comment">// 设置索引及唯一性标识</span></span><br><span class="line">            request.index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建数据对象</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">            user.setName(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">            user.setAge(<span class="number">30</span>);</span><br><span class="line">            user.setSex(<span class="string">&quot;男&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">            <span class="type">String</span> <span class="variable">productJson</span> <span class="operator">=</span> objectMapper.writeValueAsString(user);</span><br><span class="line">            <span class="comment">// 添加文档数据，数据格式为 JSON 格式</span></span><br><span class="line">            request.source(productJson, XContentType.JSON);</span><br><span class="line">            <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">            <span class="type">IndexResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="number">3.</span>打印结果信息</span><br><span class="line">            System.out.println(<span class="string">&quot;_index:&quot;</span> + response.getIndex());</span><br><span class="line">            System.out.println(<span class="string">&quot;_id:&quot;</span> + response.getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;_result:&quot;</span> + response.getResult());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_index:user</span><br><span class="line">_id:1001</span><br><span class="line">_result:UPDATED</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p><strong>修改：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpdateDoc</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(client -&gt; &#123;</span><br><span class="line">            <span class="comment">// 修改文档 - 请求对象</span></span><br><span class="line">            <span class="type">UpdateRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>();</span><br><span class="line">            <span class="comment">// 配置修改参数</span></span><br><span class="line">            request.index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>);</span><br><span class="line">            <span class="comment">// 设置请求体，对数据进行修改</span></span><br><span class="line">            request.doc(XContentType.JSON, <span class="string">&quot;sex&quot;</span>, <span class="string">&quot;女&quot;</span>);</span><br><span class="line">            <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">            <span class="type">UpdateResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">            System.out.println(<span class="string">&quot;_index:&quot;</span> + response.getIndex());</span><br><span class="line">            System.out.println(<span class="string">&quot;_id:&quot;</span> + response.getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;_result:&quot;</span> + response.getResult());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_index:user</span><br><span class="line">_id:1001</span><br><span class="line">_result:UPDATED</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>



<h3 id="5、文档查询-amp-删除"><a href="#5、文档查询-amp-删除" class="headerlink" title="5、文档查询 &amp; 删除"></a>5、文档查询 &amp; 删除</h3><p><strong>查询</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetDoc</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(client -&gt; &#123;</span><br><span class="line">            <span class="comment">//1.创建请求对象</span></span><br><span class="line">            <span class="type">GetRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>);</span><br><span class="line">            <span class="comment">//2.客户端发送请求，获取响应对象</span></span><br><span class="line">            <span class="type">GetResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.get(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="number">3.</span>打印结果信息</span><br><span class="line">            System.out.println(<span class="string">&quot;_index:&quot;</span> + response.getIndex());</span><br><span class="line">            System.out.println(<span class="string">&quot;_type:&quot;</span> + response.getType());</span><br><span class="line">            System.out.println(<span class="string">&quot;_id:&quot;</span> + response.getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;source:&quot;</span> + response.getSourceAsString());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_index:user</span><br><span class="line">_type:_doc</span><br><span class="line">_id:1001</span><br><span class="line">source:&#123;&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:30,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p><strong>删除：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeleteDoc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(client -&gt; &#123;</span><br><span class="line">            <span class="comment">//创建请求对象</span></span><br><span class="line">            <span class="type">DeleteRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>);</span><br><span class="line">            <span class="comment">//客户端发送请求，获取响应对象</span></span><br><span class="line">            <span class="type">DeleteResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">//打印信息</span></span><br><span class="line">            System.out.println(response.toString());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DeleteResponse[index=user,type=_doc,id=1001,version=16,result=deleted,shards=ShardInfo&#123;total=2, successful=1, failures=[]&#125;]</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>



<h3 id="6、文档-批量新增-amp-批量删除"><a href="#6、文档-批量新增-amp-批量删除" class="headerlink" title="6、文档 批量新增 &amp; 批量删除"></a>6、文档 批量新增 &amp; 批量删除</h3><p><strong>批量新增</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchInsertDoc</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(client -&gt; &#123;</span><br><span class="line">            <span class="comment">//创建批量新增请求对象</span></span><br><span class="line">            <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">            request.add(<span class="keyword">new</span></span><br><span class="line">                    <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>).source(XContentType.JSON, <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;zhangsan&quot;</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span></span><br><span class="line">                    <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1002&quot;</span>).source(XContentType.JSON, <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;lisi&quot;</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span></span><br><span class="line">                    <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1003&quot;</span>).source(XContentType.JSON, <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;wangwu&quot;</span>));</span><br><span class="line">            <span class="comment">//客户端发送请求，获取响应对象</span></span><br><span class="line">            <span class="type">BulkResponse</span> <span class="variable">responses</span> <span class="operator">=</span> client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">//打印结果信息</span></span><br><span class="line">            System.out.println(<span class="string">&quot;took:&quot;</span> + responses.getTook());</span><br><span class="line">            System.out.println(<span class="string">&quot;items:&quot;</span> + responses.getItems());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>批量删除：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchDeleteDoc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(client -&gt; &#123;</span><br><span class="line">            <span class="comment">//创建批量删除请求对象</span></span><br><span class="line">            <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">            request.add(<span class="keyword">new</span> <span class="title class_">DeleteRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span> <span class="title class_">DeleteRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1002&quot;</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span> <span class="title class_">DeleteRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1003&quot;</span>));</span><br><span class="line">            <span class="comment">//客户端发送请求，获取响应对象</span></span><br><span class="line">            <span class="type">BulkResponse</span> <span class="variable">responses</span> <span class="operator">=</span> client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">//打印结果信息</span></span><br><span class="line">            System.out.println(<span class="string">&quot;took:&quot;</span> + responses.getTook());</span><br><span class="line">            System.out.println(<span class="string">&quot;items:&quot;</span> + responses.getItems());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7、文档-高级查询"><a href="#7、文档-高级查询" class="headerlink" title="7、文档 高级查询"></a>7、文档 高级查询</h3><h4 id="7-1、全量查询"><a href="#7-1、全量查询" class="headerlink" title="7.1、全量查询"></a><strong>7.1、全量查询</strong></h4><p>先批量增加数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchInsertDoc</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(client -&gt; &#123;</span><br><span class="line">            <span class="comment">//创建批量新增请求对象</span></span><br><span class="line">            <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">            request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1001&quot;</span>).source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;10&quot;</span>, <span class="string">&quot;sex&quot;</span>,<span class="string">&quot;女&quot;</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1002&quot;</span>).source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;lisi&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;30&quot;</span>, <span class="string">&quot;sex&quot;</span>,<span class="string">&quot;女&quot;</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1003&quot;</span>).source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu1&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;40&quot;</span>, <span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1004&quot;</span>).source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu2&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;20&quot;</span>, <span class="string">&quot;sex&quot;</span>,<span class="string">&quot;女&quot;</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1005&quot;</span>).source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu3&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;50&quot;</span>, <span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line">            request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>().index(<span class="string">&quot;user&quot;</span>).id(<span class="string">&quot;1006&quot;</span>).source(XContentType.JSON, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;wangwu4&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;20&quot;</span>, <span class="string">&quot;sex&quot;</span>,<span class="string">&quot;男&quot;</span>));</span><br><span class="line">            <span class="comment">//客户端发送请求，获取响应对象</span></span><br><span class="line">            <span class="type">BulkResponse</span> <span class="variable">responses</span> <span class="operator">=</span> client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">//打印结果信息</span></span><br><span class="line">            System.out.println(<span class="string">&quot;took:&quot;</span> + responses.getTook());</span><br><span class="line">            System.out.println(<span class="string">&quot;items:&quot;</span> + responses.getItems());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询所有索引数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDoc</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(client -&gt; &#123;</span><br><span class="line">            <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">            <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">            request.indices(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            <span class="comment">// 构建查询的请求体</span></span><br><span class="line">            <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">            <span class="comment">// 查询所有数据</span></span><br><span class="line">            sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">            request.source(sourceBuilder);</span><br><span class="line">            <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">            <span class="comment">// 查询匹配</span></span><br><span class="line">            <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">            System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">            System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">            System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">            System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">            System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="comment">//输出每条查询的结果信息</span></span><br><span class="line">                System.out.println(hit.getSourceAsString());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">took:2ms</span><br><span class="line">timeout:false</span><br><span class="line">total:6 hits</span><br><span class="line">MaxScore:1.0</span><br><span class="line">hits========&gt;&gt;</span><br><span class="line">&#123;&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:&quot;10&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lisi&quot;,&quot;age&quot;:&quot;30&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu1&quot;,&quot;age&quot;:&quot;40&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu2&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu3&quot;,&quot;age&quot;:&quot;50&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu4&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&lt;&lt;========</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>



<h4 id="7-2、分页查询-amp-条件查询-amp-查询排序"><a href="#7-2、分页查询-amp-条件查询-amp-查询排序" class="headerlink" title="7.2、分页查询 &amp; 条件查询 &amp; 查询排序"></a>7.2、分页查询 &amp; 条件查询 &amp; 查询排序</h4><h5 id="条件查询-1"><a href="#条件查询-1" class="headerlink" title="条件查询"></a>条件查询</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDoc</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ElasticsearchTask</span> <span class="variable">SEARCH_BY_CONDITION</span> <span class="operator">=</span> client -&gt; &#123;</span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">        request.indices(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 构建查询的请求体</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        sourceBuilder.query(QueryBuilders.termQuery(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;30&quot;</span>));</span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 查询匹配</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">        System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">        System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">        System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">        System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="comment">//输出每条查询的结果信息</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(SEARCH_BY_CONDITION);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">took:1ms</span><br><span class="line">timeout:false</span><br><span class="line">total:1 hits</span><br><span class="line">MaxScore:1.0</span><br><span class="line">hits========&gt;&gt;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lisi&quot;,&quot;age&quot;:&quot;30&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&lt;&lt;========</span><br></pre></td></tr></table></figure>

<h5 id="分页查询-1"><a href="#分页查询-1" class="headerlink" title="分页查询"></a>分页查询</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDoc</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ElasticsearchTask</span> <span class="variable">SEARCH_BY_PAGING</span> <span class="operator">=</span> client -&gt; &#123;</span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">        request.indices(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 构建查询的请求体</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">        <span class="comment">// 分页查询</span></span><br><span class="line">        <span class="comment">// 当前页其实索引(第一条数据的顺序号)， from</span></span><br><span class="line">        sourceBuilder.from(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每页显示多少条 size</span></span><br><span class="line">        sourceBuilder.size(<span class="number">2</span>);</span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 查询匹配</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">        System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">        System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">        System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">        System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="comment">//输出每条查询的结果信息</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(SEARCH_BY_CONDITION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">took:1ms</span><br><span class="line">timeout:false</span><br><span class="line">total:6 hits</span><br><span class="line">MaxScore:1.0</span><br><span class="line">hits========&gt;&gt;</span><br><span class="line">&#123;&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:&quot;10&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lisi&quot;,&quot;age&quot;:&quot;30&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&lt;&lt;========</span><br></pre></td></tr></table></figure>

<h5 id="查询排序-1"><a href="#查询排序-1" class="headerlink" title="查询排序"></a>查询排序</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDoc</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ElasticsearchTask</span> <span class="variable">SEARCH_WITH_ORDER</span> <span class="operator">=</span> client -&gt; &#123;</span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">        request.indices(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建查询的请求体</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">        <span class="comment">// 排序</span></span><br><span class="line">        sourceBuilder.sort(<span class="string">&quot;age&quot;</span>, SortOrder.ASC);</span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 查询匹配</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">        System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">        System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">        System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">        System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">//输出每条查询的结果信息</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(SEARCH_WITH_ORDER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">took:1ms</span><br><span class="line">timeout:false</span><br><span class="line">total:6 hits</span><br><span class="line">MaxScore:NaN</span><br><span class="line">hits========&gt;&gt;</span><br><span class="line">&#123;&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:&quot;10&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu2&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu4&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lisi&quot;,&quot;age&quot;:&quot;30&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu1&quot;,&quot;age&quot;:&quot;40&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu3&quot;,&quot;age&quot;:&quot;50&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&lt;&lt;========</span><br></pre></td></tr></table></figure>



<h4 id="7-3、组合查询-amp-范围查询"><a href="#7-3、组合查询-amp-范围查询" class="headerlink" title="7.3、组合查询 &amp; 范围查询"></a>7.3、组合查询 &amp; 范围查询</h4><h5 id="组合查询"><a href="#组合查询" class="headerlink" title="组合查询"></a>组合查询</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDoc</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ElasticsearchTask</span> <span class="variable">SEARCH_BY_BOOL_CONDITION</span> <span class="operator">=</span> client -&gt; &#123;</span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">        request.indices(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 构建查询的请求体</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">        <span class="comment">// 必须包含</span></span><br><span class="line">        boolQueryBuilder.must(QueryBuilders.matchQuery(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;30&quot;</span>));</span><br><span class="line">        <span class="comment">// 一定不含</span></span><br><span class="line">        boolQueryBuilder.mustNot(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>));</span><br><span class="line">        <span class="comment">// 可能包含</span></span><br><span class="line">        boolQueryBuilder.should(QueryBuilders.matchQuery(<span class="string">&quot;sex&quot;</span>, <span class="string">&quot;男&quot;</span>));</span><br><span class="line">        sourceBuilder.query(boolQueryBuilder);</span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 查询匹配</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">        System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">        System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">        System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">        System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="comment">//输出每条查询的结果信息</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(SEARCH_BY_BOOL_CONDITION);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">took:28ms</span><br><span class="line">timeout:false</span><br><span class="line">total:1 hits</span><br><span class="line">MaxScore:1.0</span><br><span class="line">hits========&gt;&gt;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lisi&quot;,&quot;age&quot;:&quot;30&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&lt;&lt;========</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h5 id="范围查询-1"><a href="#范围查询-1" class="headerlink" title="范围查询"></a>范围查询</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDoc</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ElasticsearchTask</span> <span class="variable">SEARCH_BY_RANGE</span> <span class="operator">=</span> client -&gt; &#123;</span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">        request.indices(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 构建查询的请求体</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        <span class="type">RangeQueryBuilder</span> <span class="variable">rangeQuery</span> <span class="operator">=</span> QueryBuilders.rangeQuery(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        <span class="comment">// 大于等于</span></span><br><span class="line">        <span class="comment">//rangeQuery.gte(&quot;30&quot;);</span></span><br><span class="line">        <span class="comment">// 小于等于</span></span><br><span class="line">        rangeQuery.lte(<span class="string">&quot;40&quot;</span>);</span><br><span class="line">        sourceBuilder.query(rangeQuery);</span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 查询匹配</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">        System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">        System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">        System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">        System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">//输出每条查询的结果信息</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(SEARCH_BY_RANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">took:1ms</span><br><span class="line">timeout:false</span><br><span class="line">total:5 hits</span><br><span class="line">MaxScore:1.0</span><br><span class="line">hits========&gt;&gt;</span><br><span class="line">&#123;&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:&quot;10&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;lisi&quot;,&quot;age&quot;:&quot;30&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu1&quot;,&quot;age&quot;:&quot;40&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu2&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu4&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&lt;&lt;========</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>



<h4 id="7-4、模糊查询-amp-高亮查询"><a href="#7-4、模糊查询-amp-高亮查询" class="headerlink" title="7.4、模糊查询 &amp; 高亮查询"></a>7.4、模糊查询 &amp; 高亮查询</h4><h5 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDoc</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ElasticsearchTask</span> <span class="variable">SEARCH_BY_FUZZY_CONDITION</span> <span class="operator">=</span> client -&gt; &#123;</span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">        request.indices(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 构建查询的请求体</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        sourceBuilder.query(QueryBuilders.fuzzyQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;wangwu&quot;</span>).fuzziness(Fuzziness.ONE));</span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 查询匹配</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">        System.out.println(<span class="string">&quot;took:&quot;</span> + response.getTook());</span><br><span class="line">        System.out.println(<span class="string">&quot;timeout:&quot;</span> + response.isTimedOut());</span><br><span class="line">        System.out.println(<span class="string">&quot;total:&quot;</span> + hits.getTotalHits());</span><br><span class="line">        System.out.println(<span class="string">&quot;MaxScore:&quot;</span> + hits.getMaxScore());</span><br><span class="line">        System.out.println(<span class="string">&quot;hits========&gt;&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="comment">//输出每条查询的结果信息</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;&lt;&lt;========&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="comment">//        ConnectElasticsearch.connect(SEARCH_ALL);</span></span><br><span class="line"><span class="comment">//        ConnectElasticsearch.connect(SEARCH_BY_CONDITION);</span></span><br><span class="line"><span class="comment">//        ConnectElasticsearch.connect(SEARCH_BY_PAGING);</span></span><br><span class="line"><span class="comment">//        ConnectElasticsearch.connect(SEARCH_WITH_ORDER);</span></span><br><span class="line"><span class="comment">//        ConnectElasticsearch.connect(SEARCH_BY_BOOL_CONDITION);</span></span><br><span class="line"><span class="comment">//        ConnectElasticsearch.connect(SEARCH_BY_RANGE);</span></span><br><span class="line">        ConnectElasticsearch.connect(SEARCH_BY_FUZZY_CONDITION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">took:152ms</span><br><span class="line">timeout:false</span><br><span class="line">total:4 hits</span><br><span class="line">MaxScore:1.2837042</span><br><span class="line">hits========&gt;&gt;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu1&quot;,&quot;age&quot;:&quot;40&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu2&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu3&quot;,&quot;age&quot;:&quot;50&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;wangwu4&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;男&quot;&#125;</span><br><span class="line">&lt;&lt;========</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h5 id="高亮查询-1"><a href="#高亮查询-1" class="headerlink" title="高亮查询"></a>高亮查询</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class QueryDoc &#123;</span><br><span class="line">    </span><br><span class="line">    public static final ElasticsearchTask SEARCH_WITH_HIGHLIGHT = client -&gt; &#123;</span><br><span class="line">        // 高亮查询</span><br><span class="line">        SearchRequest request = new SearchRequest().indices(&quot;user&quot;);</span><br><span class="line">        //2.创建查询请求体构建器</span><br><span class="line">        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();</span><br><span class="line">        //构建查询方式：高亮查询</span><br><span class="line">        TermsQueryBuilder termsQueryBuilder =</span><br><span class="line">                QueryBuilders.termsQuery(&quot;name&quot;,&quot;zhangsan&quot;);</span><br><span class="line">        //设置查询方式</span><br><span class="line">        sourceBuilder.query(termsQueryBuilder);</span><br><span class="line">        //构建高亮字段</span><br><span class="line">        HighlightBuilder highlightBuilder = new HighlightBuilder();</span><br><span class="line">        highlightBuilder.preTags(&quot;&lt;font color=&#x27;red&#x27;&gt;&quot;);//设置标签前缀</span><br><span class="line">        highlightBuilder.postTags(&quot;&lt;/font&gt;&quot;);//设置标签后缀</span><br><span class="line">        highlightBuilder.field(&quot;name&quot;);//设置高亮字段</span><br><span class="line">        //设置高亮构建对象</span><br><span class="line">        sourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">        //设置请求体</span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        //3.客户端发送请求，获取响应对象</span><br><span class="line">        SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        //4.打印响应结果</span><br><span class="line">        SearchHits hits = response.getHits();</span><br><span class="line">        System.out.println(&quot;took::&quot;+response.getTook());</span><br><span class="line">        System.out.println(&quot;time_out::&quot;+response.isTimedOut());</span><br><span class="line">        System.out.println(&quot;total::&quot;+hits.getTotalHits());</span><br><span class="line">        System.out.println(&quot;max_score::&quot;+hits.getMaxScore());</span><br><span class="line">        System.out.println(&quot;hits::::&gt;&gt;&quot;);</span><br><span class="line">        for (SearchHit hit : hits) &#123;</span><br><span class="line">            String sourceAsString = hit.getSourceAsString();</span><br><span class="line">            System.out.println(sourceAsString);</span><br><span class="line">            //打印高亮结果</span><br><span class="line">            Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">            System.out.println(highlightFields);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;&lt;&lt;::::&quot;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ConnectElasticsearch.connect(SEARCH_WITH_HIGHLIGHT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">took::672ms</span><br><span class="line">time_out::false</span><br><span class="line">total::1 hits</span><br><span class="line">max_score::1.0</span><br><span class="line">hits::::&gt;&gt;</span><br><span class="line">&#123;&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:&quot;10&quot;,&quot;sex&quot;:&quot;女&quot;&#125;</span><br><span class="line">&#123;name=[name], fragments[[&lt;font color=&#x27;red&#x27;&gt;zhangsan&lt;/font&gt;]]&#125;</span><br><span class="line">&lt;&lt;::::</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>



<h4 id="7-5、最大值查询-amp-分组查询"><a href="#7-5、最大值查询-amp-分组查询" class="headerlink" title="7.5、最大值查询 &amp; 分组查询"></a>7.5、最大值查询 &amp; 分组查询</h4><h5 id="最大值查询"><a href="#最大值查询" class="headerlink" title="最大值查询"></a>最大值查询</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDoc</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ElasticsearchTask</span> <span class="variable">SEARCH_WITH_MAX</span> <span class="operator">=</span> client -&gt; &#123;</span><br><span class="line">        <span class="comment">// 高亮查询</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>().indices(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        sourceBuilder.aggregation(AggregationBuilders.max(<span class="string">&quot;maxAge&quot;</span>).field(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">        <span class="comment">//设置请求体</span></span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        <span class="comment">//3.客户端发送请求，获取响应对象</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//4.打印响应结果</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">        System.out.println(response);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(SEARCH_WITH_MAX);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;took&quot;:16,&quot;timed_out&quot;:false,&quot;_shards&quot;:&#123;&quot;total&quot;:1,&quot;successful&quot;:1,&quot;skipped&quot;:0,&quot;failed&quot;:0&#125;,&quot;hits&quot;:&#123;&quot;total&quot;:&#123;&quot;value&quot;:6,&quot;relation&quot;:&quot;eq&quot;&#125;,&quot;max_score&quot;:1.0,&quot;hits&quot;:[&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1001&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:&quot;10&quot;,&quot;sex&quot;:&quot;女&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1002&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;lisi&quot;,&quot;age&quot;:&quot;30&quot;,&quot;sex&quot;:&quot;女&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1003&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;wangwu1&quot;,&quot;age&quot;:&quot;40&quot;,&quot;sex&quot;:&quot;男&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1004&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;wangwu2&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;女&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1005&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;wangwu3&quot;,&quot;age&quot;:&quot;50&quot;,&quot;sex&quot;:&quot;男&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1006&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;wangwu4&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;男&quot;&#125;&#125;]&#125;,&quot;aggregations&quot;:&#123;&quot;max#maxAge&quot;:&#123;&quot;value&quot;:50.0&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h5 id="分组查询"><a href="#分组查询" class="headerlink" title="分组查询"></a>分组查询</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryDoc</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ElasticsearchTask</span> <span class="variable">SEARCH_WITH_GROUP</span> <span class="operator">=</span> client -&gt; &#123;</span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>().indices(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        sourceBuilder.aggregation(AggregationBuilders.terms(<span class="string">&quot;age_groupby&quot;</span>).field(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">        <span class="comment">//设置请求体</span></span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        <span class="comment">//3.客户端发送请求，获取响应对象</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//4.打印响应结果</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">        System.out.println(response);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ConnectElasticsearch.connect(SEARCH_WITH_GROUP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台打印：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;took&quot;:10,&quot;timed_out&quot;:false,&quot;_shards&quot;:&#123;&quot;total&quot;:1,&quot;successful&quot;:1,&quot;skipped&quot;:0,&quot;failed&quot;:0&#125;,&quot;hits&quot;:&#123;&quot;total&quot;:&#123;&quot;value&quot;:6,&quot;relation&quot;:&quot;eq&quot;&#125;,&quot;max_score&quot;:1.0,&quot;hits&quot;:[&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1001&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:&quot;10&quot;,&quot;sex&quot;:&quot;女&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1002&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;lisi&quot;,&quot;age&quot;:&quot;30&quot;,&quot;sex&quot;:&quot;女&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1003&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;wangwu1&quot;,&quot;age&quot;:&quot;40&quot;,&quot;sex&quot;:&quot;男&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1004&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;wangwu2&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;女&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1005&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;wangwu3&quot;,&quot;age&quot;:&quot;50&quot;,&quot;sex&quot;:&quot;男&quot;&#125;&#125;,&#123;&quot;_index&quot;:&quot;user&quot;,&quot;_type&quot;:&quot;_doc&quot;,&quot;_id&quot;:&quot;1006&quot;,&quot;_score&quot;:1.0,&quot;_source&quot;:&#123;&quot;name&quot;:&quot;wangwu4&quot;,&quot;age&quot;:&quot;20&quot;,&quot;sex&quot;:&quot;男&quot;&#125;&#125;]&#125;,&quot;aggregations&quot;:&#123;&quot;lterms#age_groupby&quot;:&#123;&quot;doc_count_error_upper_bound&quot;:0,&quot;sum_other_doc_count&quot;:0,&quot;buckets&quot;:[&#123;&quot;key&quot;:20,&quot;doc_count&quot;:2&#125;,&#123;&quot;key&quot;:10,&quot;doc_count&quot;:1&#125;,&#123;&quot;key&quot;:30,&quot;doc_count&quot;:1&#125;,&#123;&quot;key&quot;:40,&quot;doc_count&quot;:1&#125;,&#123;&quot;key&quot;:50,&quot;doc_count&quot;:1&#125;]&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>



<h2 id="八、ES-进阶"><a href="#八、ES-进阶" class="headerlink" title="八、ES 进阶"></a>八、ES 进阶</h2><h3 id="1、系统架构"><a href="#1、系统架构" class="headerlink" title="1、系统架构"></a>1、系统架构</h3><p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/e4d13427545dc174eb9ccface85c1f0c.png" alt="img"></p>
<p><strong>一个运行中的 Elasticsearch 实例称为一个节点，而集群是由一个或者多个拥有相同</strong><br><strong>cluster.name 配置的节点组成</strong>， 它们共同承担数据和负载的压力。当<strong>有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据</strong>。</p>
<p>当一个节点被选举成为主节点时， 它将负责管理集群范围内的所有变更，例如增加、<br>删除索引，或者增加、删除节点等。 而<strong>主节点并不需要涉及到文档级别的变更和搜索等操作</strong>，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。 任何节点都可以成为主节点。我们的示例集群就只有一个节点，所以它同时也成为了主节点。</p>
<p>作为用户，我们可以将请求发送到集群中的任何节点 ，包括主节点。 每个节点都知道<br>任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。 无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回给客户端。 Elasticsearch 对这一切的管理都是透明的。</p>
<h3 id="2、单节点集群"><a href="#2、单节点集群" class="headerlink" title="2、单节点集群"></a>2、单节点集群</h3><p>我们在包含一个空节点的集群内创建名为 users 的索引，为了演示目的，我们将分配 3个主分片和一份副本（每个主分片拥有一个副本分片）。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#PUT http://127.0.0.1:1001/users</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : 3,</span><br><span class="line">        &quot;number_of_replicas&quot; : 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>集群现在是拥有一个索引的单节点集群。所有 3 个主分片都被分配在 node-1 。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/54ee6753be248cc7d345b38a0eae7d96.png" alt="img"></p>
<p>通过 elasticsearch-head 插件（一个Chrome插件）查看集群情况 。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/e8b15d0b243d486e91f478a220da63bf.png" alt="img"></p>
<p>集群健康值:yellow( 3 of 6 )：表示当前集群的全部主分片都正常运行，但是副本分片没有全部处在正常状态。<br><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/489b6de480112879a00067b793bde685.png" alt="img">：3 个主分片正常。<br><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/3ce9a78d26ee762f0a7a8abf7817a58e.png" alt="img">：3 个副本分片都是 Unassigned，它们都没有被分配到任何节点。 <strong>在同 一个节点上既保存原始数据又保存副本是没有意义的</strong>，因为一旦失去了那个节点，我们也将丢失该节点 上的所有副本数据。<br>当前集群是正常运行的，但存在丢失数据的风险。</p>
<h3 id="3、故障转移"><a href="#3、故障转移" class="headerlink" title="3、故障转移"></a>3、故障转移</h3><p>当集群中只有一个节点在运行时，意味着会有一个单点故障问题——没有冗余。 幸运的是，我们只需再启动一个节点即可防止数据丢失。当你<strong>在同一台机器上启动了第二个节点时，只要它和第一个节点有同样的 cluster.name 配置，它就会自动发现集群并加入到其中。但是在不同机器上启动节点的时候，为了加入到同一集群，你需要配置一个可连接到的单播主机列表</strong>。之所以配置为使用单播发现，以防止节点无意中加入集群。只有在同一台机器上运行的节点才会自动组成集群。</p>
<p>如果启动了第二个节点，集群将会拥有两个节点 : 所有主分片和副本分片都已被分配 。<br>通过 elasticsearch-head 插件查看集群情况：</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/18db400822b83e727d6206f486b7b2ea.png" alt="img"></p>
<ul>
<li>集群健康值:green( 3 of 6 )：表示所有 6 个分片（包括 3 个主分片和 3 个副本分片）都在正常运行。</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/e485d8263a4aa3a94af0be951bd5a241.png" alt="img">：3 个主分片正常。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/e485d8263a4aa3a94af0be951bd5a241.png" alt="img">：第二个节点加入到集群后， 3 个副本分片将会分配到这个节点上——每 个主分片对应一个副本分片。这意味着当集群内任何一个节点出现问题时，我们的数据都完好无损。所有新被索引的文档都将会保存在主分片上，然后被并行的复制到对应的副本分片上。这就保证了我们 既可以从主分片又可以从副本分片上获得文档。</p>
<h3 id="4、水平扩容"><a href="#4、水平扩容" class="headerlink" title="4、水平扩容"></a>4、水平扩容</h3><p>怎样为我们的正在增长中的应用程序按需扩容呢？当启动了第三个节点，我们的集群将会拥有三个节点的集群 : <strong>为了分散负载而对分片进行重新分配</strong> 。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/6985fe14454c1269204478320d089bd7.png" alt="img"></p>
<p>Node 1 和 Node 2 上各有一个分片被迁移到了新的 Node 3 节点，现在每个节点上都拥有 2 个分片， 而不是之前的 3 个。 这表示每个节点的硬件资源（CPU, RAM, I&#x2F;O）将被更少的分片所共享，每个分片的性能将会得到提升。</p>
<p><strong>但是如果我们想要扩容超过 6 个节点怎么办呢？</strong></p>
<p>主分片的数目在索引创建时就已经确定了下来。实际上，这个数目定义了这个索引能够<br>存储 的最大数据量。（实际大小取决于你的数据、硬件和使用场景。） 但是，读操作——搜索和返回数据——可以同时被主分片 或 副本分片所处理，所以当你拥有越多的副本分片时，也将拥有越高的吞吐量。</p>
<p>在运行中的集群上是可以<strong>动态调整副本分片数目</strong>的，我们可以按需伸缩集群。让我们把<br>副本数从默认的 1 增加到 2。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#PUT http://127.0.0.1:1001/users/_settings</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;number_of_replicas&quot; : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>users 索引现在拥有 9 个分片： 3 个主分片和 6 个副本分片。 这意味着我们可以将集群<br>扩容到 9 个节点，每个节点上一个分片。相比原来 3 个节点时，集群搜索性能可以提升 3 倍。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/8bf9dbf0cec5b7875bf8aa9d17a9a67c.png" alt="img"></p>
<p>当然，如果只是在相同节点数目的集群上增加更多的副本分片并不能提高性能，因为每<br>个分片从节点上获得的资源会变少。 你需要增加更多的硬件资源来提升吞吐量。</p>
<p>但是更多的副本分片数提高了数据冗余量：按照上面的节点配置，我们可以在失去 2 个节点的情况下不丢失任何数据。</p>
<h3 id="5、应对故障"><a href="#5、应对故障" class="headerlink" title="5、应对故障"></a>5、应对故障</h3><p>我们关闭第一个节点，这时集群的状态为:关闭了一个节点后的集群。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/44e841004be934e6bce08187ca3852bb.png" alt="img"></p>
<p>我们关闭的节点是一个主节点。而集群必须拥有一个主节点来保证正常工作，所以发生<br>的第一件事情就是选举一个新的主节点： Node 2 。在我们关闭 Node 1 的同时也失去了主分片 1 和 2 ，并且在缺失主分片的时候索引也不能正常工作。 如果此时来检查集群的状况，我们看到的状态将会为 red ：不是所有主分片都在正常工作。</p>
<p>幸运的是，在其它节点上存在着这两个主分片的完整副本， 所以<strong>新的主节点立即将这些分片在 Node 2 和 Node 3 上对应的副本分片提升为主分片</strong>， 此时集群的状态将会为yellow。这个提升主分片的过程是瞬间发生的，如同按下一个开关一般。</p>
<img src="/img/loading.gif" data-original="/2023/10/01/Elasticsearch/10/01/Elasticsearch/e956bda7e0d005699e27760d4193d101.png" class title="img">

<p><strong>为什么我们集群状态是 yellow 而不是 green 呢？</strong></p>
<p><strong>虽然我们拥有所有的三个主分片，但是同时设置了每个主分片需要对应 2 份副本分片，而此时只存在一份副本分片</strong>。 所以集群不能为 green 的状态，不过我们不必过于担心：如果我们同样关闭了 Node 2 ，我们的程序 依然 可以保持在不丢任何数据的情况下运行，因为Node 3 为每一个分片都保留着一份副本。</p>
<p>如果想回复原来的样子，要确保Node-1的配置文件有如下配置：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">discovery.seed_hosts: [&quot;localhost:9302&quot;, &quot;localhost:9303&quot;]</span><br></pre></td></tr></table></figure>

<p>集群可以将缺失的副本分片再次进行分配，那么集群的状态也将恢复成之前的状态。 如果 Node 1 依然拥有着之前的分片，它将尝试去重用它们，同时仅从主分片复制发生了修改的数据文件。和之前的集群相比，只是 Master 节点切换了。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/37eea6a8dae7ba908312f2ebf0eced11.png" alt="img"></p>
<h3 id="6、路由计算-amp-分片控制"><a href="#6、路由计算-amp-分片控制" class="headerlink" title="6、路由计算 &amp; 分片控制"></a>6、路由计算 &amp; 分片控制</h3><h4 id="6-1、路由计算"><a href="#6-1、路由计算" class="headerlink" title="6.1、路由计算"></a>6.1、路由计算</h4><p>当索引一个文档的时候，文档会被存储到一个主分片中。 Elasticsearch 如何知道一个<br>文档应该存放到哪个分片中呢？</p>
<p>当我们创建文档时，它如何决定这个文档应当被存储在分片 1 还是分片 2 中呢？首先这肯定不会是随机的，否则将来要获取文档的时候我们就不知道从何处寻找了。实际上，这个过程是根据下面这个公式决定的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure>

<p><strong>routing 是一个可变值，默认是文档的 _id ，也可以设置成一个自定义的值</strong>。 routing 通过hash 函数生成一个数字，然后这个数字再除以 <code>number_of_primary_shards </code>（主分片的数量）后得到余数 。这个分布在 0 到 <code>number_of_primary_shards-1</code> 之间的余数，就是我们所寻求的文档所在分片的位置。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/9c34e8603887c2bed475416e3b67cd9a.png" alt="img"></p>
<p>这<strong>就解释了为什么我们要在创建索引的时候就确定好主分片的数量并且永远不会改变这个数量:因为如果数量变化了，那么所有之前路由的值都会无效，文档也再也找不到了。</strong></p>
<p>所有的文档API ( get . index . delete 、 bulk , update以及 mget ）都接受一个叫做<strong>routing 的路由参数，通过这个参数我们可以自定义文档到分片的映射</strong>。一个自定义的路由参数可以用来确保所有相关的文档—一例如所有属于同一个用户的文档——都被存储到同一个分片中。</p>
<h4 id="6-2、分片控制"><a href="#6-2、分片控制" class="headerlink" title="6.2、分片控制"></a>6.2、分片控制</h4><p>我们可以发送请求到集群中的任一节点。每个节点都有能力处理任意请求。每个节点都知道集群中任一文档位置，所以可以直接将请求转发到需要的节点上。在下面的例子中，如果将所有的请求发送到Node 1001，我们将其称为协调节点<strong>coordinating node</strong>。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/3940d6cdb197259368542b86384911a4.png" alt="img"></p>
<p>当发送请求的时候， 为了扩展负载，更好的做法是轮询集群中所有的节点。</p>
<h3 id="7、数据写流程"><a href="#7、数据写流程" class="headerlink" title="7、数据写流程"></a>7、数据写流程</h3><p>新建、索引和删除请求都是写操作， 必须在主分片上面完成之后才能被复制到相关的副本分片。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/418356a32516c222a8d366df021276c2.png" alt="img"></p>
<p>在客户端收到成功响应时，文档变更已经在主分片和所有副本分片执行完成，变更是安全的。有一些可选的请求参数允许您影响这个过程，可能以数据安全为代价提升性能。这些选项很少使用，因为 Elasticsearch 已经很快，但是为了完整起见， 请参考下文：</p>
<p>1、<code>consistency</code></p>
<ul>
<li>即一致性。在默认设置下，即使仅仅是在试图执行一个写操作之前，主分片都会要求必须要有规定数量quorum（或者换种说法，也即必须要有大多数）的分片副本处于活跃可用状态，才会去执行写操作（其中分片副本 可以是主分片或者副本分片）。这是为了避免在发生网络分区故障（network partition）的时候进行写操作，进而导致数据不一致。 规定数量即： <code>int((primary + number_of_replicas) / 2 ) + 1</code></li>
<li>consistency 参数的值可以设为：<ul>
<li>one ：只要主分片状态 ok 就允许执行写操作。</li>
<li>all：必须要主分片和所有副本分片的状态没问题才允许执行写操作。</li>
<li>quorum：默认值为quorum , 即大多数的分片副本状态没问题就允许执行写操作。</li>
</ul>
</li>
<li>注意，规定数量的计算公式中number_of_replicas指的是在索引设置中的设定副本分片数，而不是指当前处理活动状态的副本分片数。如果你的索引设置中指定了当前索引拥有3个副本分片，那规定数量的计算结果即：int((1 primary + 3 replicas) &#x2F; 2) + 1 &#x3D; 3，如果此时你只启动两个节点，那么处于活跃状态的分片副本数量就达不到规定数量，也因此您将无法索引和删除任何文档。</li>
</ul>
<p>2、<code>timeout</code></p>
<ul>
<li>如果没有足够的副本分片会发生什么？Elasticsearch 会等待，希望更多的分片出现。默认情况下，它最多等待 1 分钟。 如果你需要，你可以使用timeout参数使它更早终止：100是100 毫秒，30s是30秒。</li>
</ul>
<p>新索引默认有1个副本分片，这意味着为满足规定数量应该需要两个活动的分片副本。 但是，这些默认的设置会阻止我们在单一节点上做任何事情。为了避免这个问题，要求只有当number_of_replicas 大于1的时候，规定数量才会执行。</p>
<h3 id="8、数据读流程"><a href="#8、数据读流程" class="headerlink" title="8、数据读流程"></a>8、数据读流程</h3><p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/7139df83ee6f7a59c5d3252d34cc8762.png" alt="img"></p>
<p>在处理读取请求时，协调结点在每次请求的时候都会通过轮询所有的副本分片来达到负载均衡。在文档被检索时，已经被索引的文档可能已经存在于主分片上但是还没有复制到副本分片。 在这种情况下，副本分片可能会报告文档不存在，但是主分片可能成功返回文档。 一旦索引请求成功返回给用户，文档在主分片和副本分片都是可用的。</p>
<h3 id="9、更新流程-amp-批量操作流程"><a href="#9、更新流程-amp-批量操作流程" class="headerlink" title="9、更新流程 &amp; 批量操作流程"></a>9、更新流程 &amp; 批量操作流程</h3><h4 id="9-1、更新流程"><a href="#9-1、更新流程" class="headerlink" title="9.1、更新流程"></a>9.1、更新流程</h4><p>部分更新一个文档结合了先前说明的读取和写入流程：</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/ca41993144aee98311671278725437cd.png" alt="img"></p>
<p>部分更新一个文档的步骤如下：</p>
<ol>
<li>客户端向Node 1发送更新请求。</li>
<li>它将请求转发到主分片所在的Node 3 。</li>
<li>Node 3从主分片检索文档，修改_source字段中的JSON，并且尝试重新索引主分片的文档。如果文档已经被另一个进程修改,它会重试步骤3 ,超过retry_on_conflict次后放弃。</li>
<li>如果 Node 3成功地更新文档，它将新版本的文档并行转发到Node 1和 Node 2上的副本分片，重新建立索引。一旦所有副本分片都返回成功，Node 3向协调节点也返回成功，协调节点向客户端返回成功。</li>
</ol>
<p>当主分片把更改转发到副本分片时， 它不会转发更新请求。 相反，它转发完整文档的新版本。请记住，这些更改将会异步转发到副本分片，并且不能保证它们以发送它们相同的顺序到达。 如果 Elasticsearch 仅转发更改请求，则可能以错误的顺序应用更改，导致得到损坏的文档。</p>
<h4 id="9-2、批量操作流程"><a href="#9-2、批量操作流程" class="headerlink" title="9.2、批量操作流程"></a>9.2、批量操作流程</h4><p><strong>mget和 bulk API的模式类似于单文档模式。</strong>区别在于<strong>协调节点知道每个文档存在于哪个分片中。它将整个多文档请求分解成每个分片的多文档请求，并且将这些请求并行转发到每个参与节点。</strong></p>
<p>协调节点一旦收到来自每个节点的应答，就将每个节点的响应收集整理成单个响应，返回给客户端。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/b90ea9c79138d8361ca339cff205fdb0.png" alt="img"></p>
<p>用单个 mget 请求取回多个文档所需的步骤顺序:</p>
<ol>
<li><p>客户端向 Node 1 发送 mget 请求。</p>
</li>
<li><p>Node 1为每个分片构建多文档获取请求，然后并行转发这些请求到托管在每个所需的主分片或者副本分片的节点上。一旦收到所有答复，Node 1 构建响应并将其返回给客户端。</p>
</li>
</ol>
<p>可以对docs数组中每个文档设置routing参数。</p>
<p>bulk API， 允许在单个批量请求中执行多个创建、索引、删除和更新请求。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/83499315a7b8ab81471a88f3e142f0a8.png" alt="img"></p>
<p>bulk API 按如下步骤顺序执行：</p>
<ol>
<li>客户端向Node 1 发送 bulk请求。</li>
<li>Node 1为每个节点创建一个批量请求，并将这些请求并行转发到每个包含主分片的节点主机。</li>
<li>主分片一个接一个按顺序执行每个操作。当每个操作成功时,主分片并行转发新文档（或删除）到副本分片，然后执行下一个操作。一旦所有的副本分片报告所有操作成功，该节点将向协调节点报告成功，协调节点将这些响应收集整理并返回给客户端。</li>
</ol>
<h3 id="10、倒排索引"><a href="#10、倒排索引" class="headerlink" title="10、倒排索引"></a>10、倒排索引</h3><p>分片是Elasticsearch最小的工作单元。但是究竟什么是一个分片，它是如何工作的？</p>
<p>传统的数据库每个字段存储单个值，但这对全文检索并不够。文本字段中的每个单词需要被搜索，对数据库意味着需要单个字段有索引多值的能力。最好的支持是一个字段多个值需求的数据结构是<strong>倒排索引</strong>。</p>
<h4 id="10-1、倒排索引原理"><a href="#10-1、倒排索引原理" class="headerlink" title="10.1、倒排索引原理"></a>10.1、倒排索引原理</h4><p>Elasticsearch使用一种称为倒排索引的结构，它适用于快速的全文搜索。</p>
<p>见其名，知其意，有倒排索引，肯定会对应有正向索引。正向索引（forward index），反向索引（inverted index）更熟悉的名字是倒排索引。</p>
<p>所谓的正向索引，就是搜索引擎会将待搜索的文件都对应一个文件ID，搜索时将这个ID和搜索关键字进行对应，形成K-V对，然后对关键字进行统计计数。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/cba02cc6d7c5f054dfe5d58fafac9a6a.png" alt="img"></p>
<p>但是互联网上收录在搜索引擎中的文档的数目是个天文数字，这样的索引结构根本无法满足实时返回排名结果的要求。所以，搜索引擎会将正向索引重新构建为倒排索引，即把文件ID对应到关键词的映射转换为关键词到文件ID的映射，每个关键词都对应着一系列的文件，这些文件中都出现这个关键词。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/a1f52e96e0ac218b5024d708202afba4.png" alt="img"></p>
<h4 id="10-2、倒排索引的例子"><a href="#10-2、倒排索引的例子" class="headerlink" title="10.2、倒排索引的例子"></a>10.2、倒排索引的例子</h4><p>一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。例如，假设我们有两个文档，每个文档的content域包含如下内容：</p>
<ul>
<li>The quick brown fox jumped over the lazy dog</li>
<li>Quick brown foxes leap over lazy dogs in summer</li>
</ul>
<p>为了创建倒排索引，我们首先将每个文档的content域拆分成单独的词（我们称它为词条或tokens )，创建一个包含所有不重复词条的排序列表，然后列出每个词条出现在哪个文档。结果如下所示：<br><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/3cc642e9bae776c3e617f9d117d41e21.png" alt="img"></p>
<p>现在，如果我们想搜索 <code>quick</code> <code>brown</code> ，我们只需要查找包含每个词条的文档：</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/f26aaa01e011edfa68736956b2f1ddea.png" alt="img"></p>
<p>两个文档都匹配，但是第一个文档比第二个匹配度更高。如果我们使用仅计算匹配词条数量的简单相似性算法，那么我们可以说，对于我们查询的相关性来讲，第一个文档比第二个文档更佳。</p>
<p>但是，我们目前的倒排索引有一些问题：</p>
<ul>
<li><code>Quick</code>和<code>quick</code>以独立的词条出现，然而用户可能认为它们是相同的词。</li>
<li><code>fox</code>和<code>foxes</code>非常相似，就像<code>dog</code>和<code>dogs</code>；他们有相同的词根。</li>
<li><code>jumped</code>和<code>leap</code>，尽管没有相同的词根，但他们的意思很相近。他们是同义词。</li>
</ul>
<p>使用前面的索引搜索<code>+Quick +fox</code>不会得到任何匹配文档。(记住，＋前缀表明这个词必须存在）。</p>
<p>只有同时出现<code>Quick</code>和<code>fox</code> 的文档才满足这个查询条件，但是第一个文档包含<code>quick fox </code>，第二个文档包含<code>Quick foxes </code>。</p>
<p>我们的用户可以合理的期望两个文档与查询匹配。我们可以做的更好。</p>
<p>如果我们将词条规范为标准模式，那么我们可以找到与用户搜索的词条不完全一致，但具有足够相关性的文档。例如：</p>
<ul>
<li><code>Quick</code>可以小写化为<code>quick</code>。</li>
<li><code>foxes</code>可以词干提取变为词根的格式为<code>fox</code>。类似的，<code>dogs</code>可以为提取为<code>dog</code>。</li>
<li><code>jumped</code>和<code>leap</code>是同义词，可以索引为相同的单词<code>jump </code>。</li>
</ul>
<p>现在索引看上去像这样：<br><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/19813d1918c89461303377444cf85c8c.png" alt="img"></p>
<p>这还远远不够。我们搜索<code>+Quick +fox </code>仍然会失败，因为在我们的索引中，已经没有<code>Quick</code>了。但是，如果我们对搜索的字符串使用与<code>content</code>域相同的标准化规则，会变成查询<code>+quick +fox</code>，这样两个文档都会匹配！分词和标准化的过程称为分析，这非常重要。你只能搜索在索引中出现的词条，所以索引文本和查询字符串必须标准化为相同的格式。</p>
<h3 id="11、文档搜索"><a href="#11、文档搜索" class="headerlink" title="11、文档搜索"></a>11、文档搜索</h3><h4 id="11-1、不可改变的倒排索引"><a href="#11-1、不可改变的倒排索引" class="headerlink" title="11.1、不可改变的倒排索引"></a>11.1、不可改变的倒排索引</h4><p>早期的全文检索会为整个文档集合建立一个很大的倒排索引并将其写入到磁盘。 一旦新的索引就绪，旧的就会被其替换，这样最近的变化便可以被检索到。</p>
<p>倒排索引被写入磁盘后是不可改变的：它永远不会修改。</p>
<ul>
<li><p>不需要锁。如果你从来不更新索引，你就不需要担心多进程同时修改数据的问题。</p>
</li>
<li><p>一旦索引被读入内核的文件系统缓存，便会留在哪里，由于其不变性。只要文件系统缓存中还有足够的空间，那么大部分读请求会直接请求内存，而不会命中磁盘。这提供了很大的性能提升。</p>
</li>
<li><p>其它缓存(像filter缓存)，在索引的生命周期内始终有效。它们不需要在每次数据改变时被重建，因为数据不会变化。</p>
</li>
<li><p>写入单个大的倒排索引允许数据被压缩，减少磁盘IO和需要被缓存到内存的索引的使用量。</p>
</li>
</ul>
<p>当然，一个不变的索引也有不好的地方。主要事实是它是不可变的! 你不能修改它。如果你需要让一个新的文档可被搜索，你需要重建整个索引。这要么对一个索引所能包含的数据量造成了很大的限制，要么对索引可被更新的频率造成了很大的限制。</p>
<h4 id="11-2、动态更新索引"><a href="#11-2、动态更新索引" class="headerlink" title="11.2、动态更新索引"></a>11.2、动态更新索引</h4><p>如何在保留不变性的前提下实现倒排索引的更新？</p>
<p>答案是：用更多的索引。通过增加新的补充索引来反映新近的修改，而不是直接重写整个倒排索引。每一个倒排索引都会被轮流查询到,从最早的开始查询完后再对结果进行合并。</p>
<p>Elasticsearch基于Lucene，这个java库引入了<strong>按段搜索</strong>的概念。每一段本身都是一个倒排索引，但索引在 Lucene 中除表示所有段的集合外，还增加了提交点的概念—一个列出了所有已知段的文件。<br><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/9ee1adbb2d55e710257e01b812a6d8cf.png" alt="img"></p>
<p>按段搜索会以如下流程执行：</p>
<p>一、新文档被收集到内存索引缓存。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/9d499fde966ee9825fa5a424d8357489.png" alt="img"></p>
<p>二、不时地, 缓存被提交。</p>
<p>一个新的段，一个追加的倒排索引，被写入磁盘。<br>一个新的包含新段名字的提交点被写入磁盘。<br>磁盘进行同步，所有在文件系统缓存中等待的写入都刷新到磁盘，以确保它们被写入物理文件<br>三、新的段被开启，让它包含的文档可见以被搜索。</p>
<p>四、内存缓存被清空，等待接收新的文档。<br><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/f74828ff58cc4635a97e88706a221e50.png" alt="img"></p>
<p>当一个查询被触发，所有已知的段按顺序被查询。词项统计会对所有段的结果进行聚合，以保证每个词和每个文档的关联都被准确计算。这种方式可以用相对较低的成本将新文档添加到索引。</p>
<p>段是不可改变的，所以既不能从把文档从旧的段中移除，也不能修改旧的段来进行反映文档的更新。取而代之的是，每个提交点会包含一个.del 文件，文件中会列出这些被删除文档的段信息。</p>
<p>当一个<strong>文档被“删除”</strong>时，它实际上只是在 .del 文件中被标记删除。一个被标记删除的文档仍然可以被查询匹配到，但它会在最终结果被返回前从结果集中移除。</p>
<p><strong>文档更新</strong>也是类似的操作方式:当一个文档被更新时，旧版本文档被标记删除，文档的新版本被索引到一个新的段中。可能两个版本的文档都会被一个查询匹配到，但被删除的那个旧版本文档在结果集返回前就已经被移除。</p>
<h3 id="12、文档刷新-amp-文档刷写-amp-文档合并"><a href="#12、文档刷新-amp-文档刷写-amp-文档合并" class="headerlink" title="12、文档刷新 &amp; 文档刷写 &amp; 文档合并"></a>12、文档刷新 &amp; 文档刷写 &amp; 文档合并</h3><p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/b3b31c1e592d5aa794e7c9fcb259c924.png" alt="img"></p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/521c25f0f16247240234d1b8eb3c5f25.png" alt="img"></p>
<h4 id="近实时搜索"><a href="#近实时搜索" class="headerlink" title="近实时搜索"></a>近实时搜索</h4><p>随着按段（per-segment）搜索的发展，一个新的文档从索引到可被搜索的延迟显著降低了。新文档在几分钟之内即可被检索，但这样还是不够快。磁盘在这里成为了瓶颈。<strong>提交（Commiting）一个新的段到磁盘需要一个fsync来确保段被物理性地写入磁盘，这样在断电的时候就不会丢失数据</strong>。但是fsync操作代价很大；如果每次索引一个文档都去执行一次的话会造成很大的性能问题。</p>
<p>我们需要的是一个更轻量的方式来使一个文档可被搜索，这意味着fsync要从整个过程中被移除。在Elasticsearch和磁盘之间是<strong>文件系统缓存</strong>。像之前描述的一样，在内存索引缓冲区中的文档会被写入到一个新的段中。但是这里新段会被先写入到文件系统缓存—这一步代价会比较低，稍后再被刷新到磁盘—这一步代价比较高。不过只要文件已经在缓存中，就可以像其它文件一样被打开和读取了。<br><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/a679d4f5f4bfa6913a53316251beef2a.png" alt="img"></p>
<p>Lucene允许新段被写入和打开，使其包含的文档在未进行一次完整提交时便对搜索可见。这种方式比进行一次提交代价要小得多，并且在不影响性能的前提下可以被频繁地执行。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/673d3a77e254fa3a5a6f5293ffb125ab.png" alt="img"></p>
<p>在 Elasticsearch 中，写入和打开一个新段的轻量的过程叫做refresh。默认情况下每个分片会每秒自动刷新一次。这就是为什么我们说 Elasticsearch是近实时搜索：文档的变化并不是立即对搜索可见，但会在一秒之内变为可见。</p>
<p>这些行为可能会对新用户造成困惑：他们索引了一个文档然后尝试搜索它，但却没有搜到。这个问题的解决办法是用refresh API执行一次手动刷新：&#x2F;usersl_refresh</p>
<p>尽管刷新是比提交轻量很多的操作，它还是会有性能开销。当写测试的时候，手动刷新很有用，但是不要在生产环境下每次索引一个文档都去手动刷新。相反，你的应用需要意识到Elasticsearch 的近实时的性质，并接受它的不足。</p>
<p>并不是所有的情况都需要每秒刷新。可能你正在使用Elasticsearch索引大量的日志文件，你可能想优化索引速度而不是近实时搜索，可以通过设置refresh_interval ，降低每个索引的刷新频率。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">    	&quot;refresh_interval&quot;: &quot;30s&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>refresh_interval可以在既存索引上进行动态更新。在生产环境中，当你正在建立一个大的新索引时，可以先关闭自动刷新，待开始使用该索引时，再把它们调回来。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 关闭自动刷新</span><br><span class="line">PUT /users/_settings</span><br><span class="line">&#123; &quot;refresh_interval&quot;: -1 &#125;</span><br><span class="line"></span><br><span class="line"># 每一秒刷新</span><br><span class="line">PUT /users/_settings</span><br><span class="line">&#123; &quot;refresh_interval&quot;: &quot;1s&quot; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="持久化变更"><a href="#持久化变更" class="headerlink" title="持久化变更"></a>持久化变更</h4><p>如果没有用fsync把数据从文件系统缓存刷（flush）到硬盘，我们不能保证数据在断电甚至是程序正常退出之后依然存在。为了保证Elasticsearch 的可靠性，需要确保数据变化被持久化到磁盘。在动态更新索引，我们说一次完整的提交会将段刷到磁盘，并写入一个包含所有段列表的提交点。Elasticsearch 在启动或重新打开一个索引的过程中使用这个提交点来判断哪些段隶属于当前分片。</p>
<p>即使通过每秒刷新(refresh）实现了近实时搜索，我们仍然需要经常进行完整提交来确保能从失败中恢复。但在两次提交之间发生变化的文档怎么办?我们也不希望丢失掉这些数据。Elasticsearch 增加了一个translog ，或者叫事务日志，在每一次对Elasticsearch进行操作时均进行了日志记录。</p>
<p>整个流程如下:</p>
<p>一、一个文档被索引之后，就会被添加到内存缓冲区，并且追加到了 translog</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/baeab48c8d6b87660ac4fb954e9c9731.png" alt="img"></p>
<p>二、刷新（refresh）使分片每秒被刷新（refresh）一次：</p>
<ul>
<li>这些在内存缓冲区的文档被写入到一个新的段中，且没有进行fsync操作。</li>
<li>这个段被打开，使其可被搜索。</li>
<li>内存缓冲区被清空。</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/17be4247e6b23f31b1e589c70d61e817.png" alt="img"></p>
<p>三、这个进程继续工作，更多的文档被添加到内存缓冲区和追加到事务日志。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/4b5c4a3a3ffb4c84625bb283f6a67018.png" alt="img"></p>
<p>四、每隔一段时间—例如translog变得越来越大，索引被刷新（flush）；一个新的translog被创建，并且一个全量提交被执行。</p>
<ul>
<li><p>所有在内存缓冲区的文档都被写入一个新的段。</p>
</li>
<li><p>缓冲区被清空。</p>
</li>
<li><p>一个提交点被写入硬盘。</p>
</li>
<li><p>文件系统缓存通过fsync被刷新（flush） 。</p>
</li>
<li><p>老的translog被删除。</p>
</li>
</ul>
<p>translog 提供所有还没有被刷到磁盘的操作的一个持久化纪录。当Elasticsearch启动的时候，它会从磁盘中使用最后一个提交点去恢复己知的段，并且会重放translog 中所有在最后一次提交后发生的变更操作。</p>
<p>translog 也被用来提供实时CRUD。当你试着通过ID查询、更新、删除一个文档，它会在尝试从相应的段中检索之前，首先检查 translog任何最近的变更。这意味着它总是能够实时地获取到文档的最新版本。<br><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/11c7d2cc05244e669eb8402dd8049de9.png" alt="img"></p>
<p>执行一个提交并且截断translog 的行为在 Elasticsearch被称作一次flush。分片每30分钟被自动刷新（flush)，或者在 translog 太大的时候也会刷新。</p>
<p>你很少需要自己手动执行flush操作，通常情况下，自动刷新就足够了。这就是说，在重启节点或关闭索引之前执行 flush有益于你的索引。当Elasticsearch尝试恢复或重新打开一个索引，它需要重放translog中所有的操作，所以如果日志越短，恢复越快。</p>
<p>translog 的目的是保证操作不会丢失，在文件被fsync到磁盘前，被写入的文件在重启之后就会丢失。默认translog是每5秒被fsync刷新到硬盘，或者在每次写请求完成之后执行（e.g. index, delete, update, bulk）。这个过程在主分片和复制分片都会发生。最终，基本上，这意味着在整个请求被fsync到主分片和复制分片的translog之前，你的客户端不会得到一个200 OK响应。</p>
<p>在每次请求后都执行一个fsync会带来一些性能损失，尽管实践表明这种损失相对较小（特别是 bulk 导入，它在一次请求中平摊了大量文档的开销）。</p>
<p>但是对于一些大容量的偶尔丢失几秒数据问题也并不严重的集群，使用异步的 fsync还是比较有益的。比如，写入的数据被缓存到内存中，再每5秒执行一次 fsync 。如果你决定使用异步translog 的话，你需要保证在发生 crash 时，丢失掉 sync_interval时间段的数据也无所谓。请在决定前知晓这个特性。如果你不确定这个行为的后果，最好是使用默认的参数{“index.translog.durability”: “request”}来避免数据丢失。</p>
<h4 id="段合并"><a href="#段合并" class="headerlink" title="段合并"></a>段合并</h4><p>由于自动刷新流程每秒会创建一个新的段，这样会导致短时间内的段数量暴增。而段数目太多会带来较大的麻烦。每一个段都会消耗文件句柄、内存和 cpu运行周期。更重要的是，每个搜索请求都必须轮流检查每个段；所以段越多，搜索也就越慢。</p>
<p>Elasticsearch通过在后台进行段合并来解决这个问题。小的段被合并到大的段，然后这些大的段再被合并到更大的段。</p>
<p>段合并的时候会将那些旧的已删除文档从文件系统中清除。被删除的文档（或被更新文档的旧版本）不会被拷贝到新的大段中。</p>
<p>启动段合并不需要你做任何事。进行索引和搜索时会自动进行。</p>
<p>一、当索引的时候，刷新（refresh）操作会创建新的段并将段打开以供搜索使用。</p>
<p>二、合并进程选择一小部分大小相似的段，并且在后台将它们合并到更大的段中。这并不会中断索引和搜索。<br><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/c907ca35bd7c0393d46aec2c7038af19.png" alt="img"></p>
<p>三、一旦合并结束，老的段被删除</p>
<ul>
<li>新的段被刷新(flush)到了磁盘。</li>
<li>写入一个包含新段且排除旧的和较小的段的新提交点。</li>
<li>新的段被打开用来搜索。老的段被删除。</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/a00cc1c19652c47fcfb663aaf337a41b.png" alt="img"></p>
<p>合并大的段需要消耗大量的 I&#x2F;O 和 CPU 资源，如果任其发展会影响搜索性能。 Elasticsearch在默认情况下会对合并流程进行资源限制，所以搜索仍然有足够的资源很好地执行。</p>
<h3 id="13、文档分析"><a href="#13、文档分析" class="headerlink" title="13、文档分析"></a>13、文档分析</h3><p>分析包含下面的过程：</p>
<ul>
<li><p>将一块文本分成适合于倒排索引的独立的词条。</p>
</li>
<li><p>将这些词条统一化为标准格式以提高它们的“可搜索性”，或者recall。</p>
</li>
</ul>
<p>分析器执行上面的工作。分析器实际上是将三个功能封装到了一个包里：</p>
<ul>
<li>字符过滤器：首先，字符串按顺序通过每个 字符过滤器 。他们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉 HTML，或者将 &amp; 转化成 and。</li>
<li>分词器：其次，字符串被分词器分为单个的词条。一个简单的分词器遇到空格和标点的时候，可能会将文本拆分成词条。</li>
<li>Token 过滤器：最后，词条按顺序通过每个 token 过滤器 。这个过程可能会改变词条（例如，小写化Quick ），删除词条（例如， 像 a， and， the 等无用词），或者增加词条（例如，像jump和leap这种同义词）</li>
</ul>
<h4 id="内置分析器"><a href="#内置分析器" class="headerlink" title="内置分析器"></a>内置分析器</h4><p>Elasticsearch还附带了可以直接使用的预包装的分析器。接下来我们会列出最重要的分析器。为了证明它们的差异，我们看看每个分析器会从下面的字符串得到哪些词条：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;Set the shape to semi-transparent by calling set_trans(5)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>标准分析器</li>
</ul>
<p>标准分析器是Elasticsearch 默认使用的分析器。它是分析各种语言文本最常用的选择。它根据Unicode 联盟定义的单词边界划分文本。删除绝大部分标点。最后，将词条小写。它会产生：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set, the, shape, to, semi, transparent, by, calling, set_trans, 5</span><br></pre></td></tr></table></figure>

<ul>
<li>简单分析器</li>
</ul>
<p>简单分析器在任何不是字母的地方分隔文本，将词条小写。它会产生：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set, the, shape, to, semi, transparent, by, calling, set, trans</span><br></pre></td></tr></table></figure>

<ul>
<li>空格分析器</li>
</ul>
<p>空格分析器在空格的地方划分文本。它会产生:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Set, the, shape, to, semi-transparent, by, calling, set_trans(5)</span><br></pre></td></tr></table></figure>

<ul>
<li>语言分析器</li>
</ul>
<p>特定语言分析器可用于很多语言。它们可以考虑指定语言的特点。例如，英语分析器附带了一组英语无用词（常用单词，例如and或者the ,它们对相关性没有多少影响），它们会被删除。由于理解英语语法的规则，这个分词器可以提取英语单词的词干。</p>
<p>英语分词器会产生下面的词条：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set, shape, semi, transpar, call, set_tran, 5</span><br></pre></td></tr></table></figure>

<p>注意看transparent、calling和 set_trans已经变为词根格式。</p>
<p><strong>分析器使用场景</strong><br>当我们索引一个文档，它的全文域被分析成词条以用来创建倒排索引。但是，当我们在全文域搜索的时候，我们需要将查询字符串通过相同的分析过程，以保证我们搜索的词条格式与索引中的词条格式一致。</p>
<p>全文查询，理解每个域是如何定义的，因此它们可以做正确的事：</p>
<ul>
<li><p>当你查询一个全文域时，会对查询字符串应用相同的分析器，以产生正确的搜索词条列表。</p>
</li>
<li><p>当你查询一个精确值域时，不会分析查询字符串，而是搜索你指定的精确值。</p>
</li>
</ul>
<h4 id="测试分析器"><a href="#测试分析器" class="headerlink" title="测试分析器"></a>测试分析器</h4><p>有些时候很难理解分词的过程和实际被存储到索引中的词条，特别是你刚接触Elasticsearch。为了理解发生了什么，你可以使用analyze API来看文本是如何被分析的。在消息体里，指定分析器和要分析的文本。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#GET http://localhost:9200/_analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">    &quot;text&quot;: &quot;Text to analyze&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果中每个元素代表一个单独的词条：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;tokens&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;text&quot;, </span><br><span class="line">            &quot;start_offset&quot;: 0, </span><br><span class="line">            &quot;end_offset&quot;: 4, </span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;, </span><br><span class="line">            &quot;position&quot;: 1</span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;to&quot;, </span><br><span class="line">            &quot;start_offset&quot;: 5, </span><br><span class="line">            &quot;end_offset&quot;: 7, </span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;, </span><br><span class="line">            &quot;position&quot;: 2</span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;analyze&quot;, </span><br><span class="line">            &quot;start_offset&quot;: 8, </span><br><span class="line">            &quot;end_offset&quot;: 15, </span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;, </span><br><span class="line">            &quot;position&quot;: 3</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>token是实际存储到索引中的词条。</li>
<li>start_ offset 和end_ offset指明字符在原始字符串中的位置。</li>
<li>position指明词条在原始文本中出现的位置。</li>
</ul>
<h4 id="指定分析器"><a href="#指定分析器" class="headerlink" title="指定分析器"></a>指定分析器</h4><p>当Elasticsearch在你的文档中检测到一个新的字符串域，它会自动设置其为一个全文字符串域，使用 标准 分析器对它进行分析。你不希望总是这样。可能你想使用一个不同的分析器，适用于你的数据使用的语言。有时候你想要一个字符串域就是一个字符串域，不使用分析，直接索引你传入的精确值，例如用户 ID 或者一个内部的状态域或标签。要做到这一点，我们必须手动指定这些域的映射。</p>
<p>（细粒度指定分析器）</p>
<h4 id="IK分词器"><a href="#IK分词器" class="headerlink" title="IK分词器"></a>IK分词器</h4><p>首先通过 Postman 发送 GET 请求查询分词效果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># GET http://localhost:9200/_analyze</span><br><span class="line">&#123;</span><br><span class="line">	&quot;text&quot;:&quot;测试单词&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ES 的默认分词器无法识别中文中测试、 单词这样的词汇，而是简单的将每个字拆完分为一个词。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;tokens&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;测&quot;, </span><br><span class="line">            &quot;start_offset&quot;: 0, </span><br><span class="line">            &quot;end_offset&quot;: 1, </span><br><span class="line">            &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;, </span><br><span class="line">            &quot;position&quot;: 0</span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;试&quot;, </span><br><span class="line">            &quot;start_offset&quot;: 1, </span><br><span class="line">            &quot;end_offset&quot;: 2, </span><br><span class="line">            &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;, </span><br><span class="line">            &quot;position&quot;: 1</span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;单&quot;, </span><br><span class="line">            &quot;start_offset&quot;: 2, </span><br><span class="line">            &quot;end_offset&quot;: 3, </span><br><span class="line">            &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;, </span><br><span class="line">            &quot;position&quot;: 2</span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;词&quot;, </span><br><span class="line">            &quot;start_offset&quot;: 3, </span><br><span class="line">            &quot;end_offset&quot;: 4, </span><br><span class="line">            &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;, </span><br><span class="line">            &quot;position&quot;: 3</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的结果显然不符合我们的使用要求，所以我们需要下载 ES 对应版本的中文分词器。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.8.0">IK 中文分词器下载网址</a></p>
<p>将解压后的后的文件夹放入 ES 根目录下的 plugins 目录下，重启 ES 即可使用。</p>
<p>我们这次加入新的查询参数”analyzer”:“ik_max_word”。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># GET http://localhost:9200/_analyze</span><br><span class="line">&#123;</span><br><span class="line">	&quot;text&quot;:&quot;测试单词&quot;,</span><br><span class="line">	&quot;analyzer&quot;:&quot;ik_max_word&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ik_max_word：会将文本做最细粒度的拆分。</li>
<li>ik_smart：会将文本做最粗粒度的拆分。</li>
</ul>
<p>使用中文分词后的结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;tokens&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;测试&quot;, </span><br><span class="line">            &quot;start_offset&quot;: 0, </span><br><span class="line">            &quot;end_offset&quot;: 2, </span><br><span class="line">            &quot;type&quot;: &quot;CN_WORD&quot;, </span><br><span class="line">            &quot;position&quot;: 0</span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;单词&quot;, </span><br><span class="line">            &quot;start_offset&quot;: 2, </span><br><span class="line">            &quot;end_offset&quot;: 4, </span><br><span class="line">            &quot;type&quot;: &quot;CN_WORD&quot;, </span><br><span class="line">            &quot;position&quot;: 1</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ES 中也可以进行扩展词汇，首先查询</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#GET http://localhost:9200/_analyze</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;text&quot;:&quot;弗雷尔卓德&quot;,</span><br><span class="line">    &quot;analyzer&quot;:&quot;ik_max_word&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仅仅可以得到每个字的分词结果，我们需要做的就是使分词器识别到弗雷尔卓德也是一个词语。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;tokens&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;弗&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 0,</span><br><span class="line">            &quot;end_offset&quot;: 1,</span><br><span class="line">            &quot;type&quot;: &quot;CN_CHAR&quot;,</span><br><span class="line">            &quot;position&quot;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;雷&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 1,</span><br><span class="line">            &quot;end_offset&quot;: 2,</span><br><span class="line">            &quot;type&quot;: &quot;CN_CHAR&quot;,</span><br><span class="line">            &quot;position&quot;: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;尔&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 2,</span><br><span class="line">            &quot;end_offset&quot;: 3,</span><br><span class="line">            &quot;type&quot;: &quot;CN_CHAR&quot;,</span><br><span class="line">            &quot;position&quot;: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;卓&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 3,</span><br><span class="line">            &quot;end_offset&quot;: 4,</span><br><span class="line">            &quot;type&quot;: &quot;CN_CHAR&quot;,</span><br><span class="line">            &quot;position&quot;: 3</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;德&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 4,</span><br><span class="line">            &quot;end_offset&quot;: 5,</span><br><span class="line">            &quot;type&quot;: &quot;CN_CHAR&quot;,</span><br><span class="line">            &quot;position&quot;: 4</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>首先进入 ES 根目录中的 plugins 文件夹下的 ik 文件夹，进入 config 目录，创建 custom.dic文件，写入“弗雷尔卓德”。</li>
<li>同时打开 IKAnalyzer.cfg.xml 文件，将新建的 custom.dic 配置其中。</li>
<li>重启 ES 服务器 。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;</span><br><span class="line">&lt;properties&gt;</span><br><span class="line">	&lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;</span><br><span class="line">	&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br><span class="line">	&lt;entry key=&quot;ext_dict&quot;&gt;custom.dic&lt;/entry&gt;</span><br><span class="line">	 &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br><span class="line">	&lt;entry key=&quot;ext_stopwords&quot;&gt;&lt;/entry&gt;</span><br><span class="line">	&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br><span class="line">	&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="line">	&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br><span class="line">	&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>

<p>扩展后再次查询</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># GET http://localhost:9200/_analyze</span><br><span class="line">&#123;</span><br><span class="line">	&quot;text&quot;:&quot;测试单词&quot;,</span><br><span class="line">	&quot;analyzer&quot;:&quot;ik_max_word&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;tokens&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;弗雷尔卓德&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 0,</span><br><span class="line">            &quot;end_offset&quot;: 5,</span><br><span class="line">            &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">            &quot;position&quot;: 0</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自定义分析器"><a href="#自定义分析器" class="headerlink" title="自定义分析器"></a>自定义分析器</h4><p>虽然Elasticsearch带有一些现成的分析器，然而在分析器上Elasticsearch真正的强大之处在于，你可以通过在一个适合你的特定数据的设置之中组合字符过滤器、分词器、词汇单元过滤器来创建自定义的分析器。在分析与分析器我们说过，一个分析器就是在一个包里面组合了三种函数的一个包装器，三种函数按照顺序被执行：</p>
<p><strong>字符过滤器</strong><br>字符过滤器用来整理一个尚未被分词的字符串。例如，如果我们的文本是HTML格式的，它会包含像</p><p>或者<div>这样的HTML标签，这些标签是我们不想索引的。我们可以使用html清除字符过滤器来移除掉所有的HTML标签，并且像把&amp;Aacute;转换为相对应的Unicode字符Á 这样，转换HTML实体。一个分析器可能有0个或者多个字符过滤器。</div></p>
<p><strong>分词器</strong><br>一个分析器必须有一个唯一的分词器。分词器把字符串分解成单个词条或者词汇单元。标准分析器里使用的标准分词器把一个字符串根据单词边界分解成单个词条，并且移除掉大部分的标点符号，然而还有其他不同行为的分词器存在。</p>
<p>例如，关键词分词器完整地输出接收到的同样的字符串，并不做任何分词。空格分词器只根据空格分割文本。正则分词器根据匹配正则表达式来分割文本。</p>
<p><strong>词单元过滤器</strong><br>经过分词，作为结果的词单元流会按照指定的顺序通过指定的词单元过滤器。词单元过滤器可以修改、添加或者移除词单元。我们已经提到过lowercase和stop词过滤器，但是在Elasticsearch 里面还有很多可供选择的词单元过滤器。词干过滤器把单词遏制为词干。ascii_folding过滤器移除变音符，把一个像”très”这样的词转换为“tres”。</p>
<p>ngram和 edge_ngram词单元过滤器可以产生适合用于部分匹配或者自动补全的词单元。</p>
<p><strong>自定义分析器例子</strong><br>接下来，我们看看如何创建自定义的分析器：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#PUT http://localhost:9200/my_index</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;analysis&quot;: &#123;</span><br><span class="line">            &quot;char_filter&quot;: &#123;</span><br><span class="line">                &quot;&amp;_to_and&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;mapping&quot;, </span><br><span class="line">                    &quot;mappings&quot;: [</span><br><span class="line">                        &quot;&amp;=&gt; and &quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;filter&quot;: &#123;</span><br><span class="line">                &quot;my_stopwords&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;stop&quot;, </span><br><span class="line">                    &quot;stopwords&quot;: [</span><br><span class="line">                        &quot;the&quot;, </span><br><span class="line">                        &quot;a&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;analyzer&quot;: &#123;</span><br><span class="line">                &quot;my_analyzer&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;custom&quot;, </span><br><span class="line">                    &quot;char_filter&quot;: [</span><br><span class="line">                        &quot;html_strip&quot;, </span><br><span class="line">                        &quot;&amp;_to_and&quot;</span><br><span class="line">                    ], </span><br><span class="line">                    &quot;tokenizer&quot;: &quot;standard&quot;, </span><br><span class="line">                    &quot;filter&quot;: [</span><br><span class="line">                        &quot;lowercase&quot;, </span><br><span class="line">                        &quot;my_stopwords&quot;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>索引被创建以后，使用 analyze API 来 测试这个新的分析器：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># GET http://127.0.0.1:9200/my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;text&quot;:&quot;The quick &amp; brown fox&quot;,</span><br><span class="line">    &quot;analyzer&quot;: &quot;my_analyzer&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;tokens&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;quick&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 4,</span><br><span class="line">            &quot;end_offset&quot;: 9,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;and&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 10,</span><br><span class="line">            &quot;end_offset&quot;: 11,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;brown&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 12,</span><br><span class="line">            &quot;end_offset&quot;: 17,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 3</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;fox&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 18,</span><br><span class="line">            &quot;end_offset&quot;: 21,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 4</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="14、文档控制"><a href="#14、文档控制" class="headerlink" title="14、文档控制"></a>14、文档控制</h3><h4 id="14-1、文档冲突"><a href="#14-1、文档冲突" class="headerlink" title="14.1、文档冲突"></a>14.1、文档冲突</h4><p>当我们使用index API更新文档，可以一次性读取原始文档，做我们的修改，然后重新索引整个文档。最近的索引请求将获胜：无论最后哪一个文档被索引，都将被唯一存储在 Elasticsearch 中。如果其他人同时更改这个文档，他们的更改将丢失。</p>
<p>很多时候这是没有问题的。也许我们的主数据存储是一个关系型数据库，我们只是将数据复制到Elasticsearch中并使其可被搜索。也许两个人同时更改相同的文档的几率很小。或者对于我们的业务来说偶尔丢失更改并不是很严重的问题。</p>
<p>但有时丢失了一个变更就是非常严重的。试想我们使用Elasticsearch 存储我们网上商城商品库存的数量，每次我们卖一个商品的时候，我们在 Elasticsearch 中将库存数量减少。有一天，管理层决定做一次促销。突然地，我们一秒要卖好几个商品。假设有两个web程序并行运行，每一个都同时处理所有商品的销售。</p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/49ca2ec50db3ddd0fcd1f364ac600b96.png" alt="img"></p>
<p>web_1 对stock_count所做的更改已经丢失，因为 web_2不知道它的 stock_count的拷贝已经过期。结果我们会认为有超过商品的实际数量的库存，因为卖给顾客的库存商品并不存在，我们将让他们非常失望。</p>
<p>变更越频繁，读数据和更新数据的间隙越长，也就越可能丢失变更。在数据库领域中，有两种方法通常被用来确保并发更新时变更不会丢失：</p>
<ul>
<li>悲观并发控制：这种方法被关系型数据库广泛使用，它假定有变更冲突可能发生，因此阻塞访问资源以防止冲突。一个典型的例子是读取一行数据之前先将其锁住，确保只有放置锁的线程能够对这行数据进行修改。</li>
<li>乐观并发控制：Elasticsearch 中使用的这种方法假定冲突是不可能发生的，并且不会阻塞正在尝试的操作。然而，如果源数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如何解决冲突。例如，可以重试更新、使用新的数据、或者将相关情况报告给用户。</li>
</ul>
<h4 id="14-2、乐观并发控制"><a href="#14-2、乐观并发控制" class="headerlink" title="14.2、乐观并发控制"></a>14.2、乐观并发控制</h4><p>Elasticsearch是分布式的。当文档创建、更新或删除时，新版本的文档必须复制到集群中的其他节点。Elasticsearch也是异步和并发的，这意味着这些复制请求被并行发送，并且到达目的地时也许顺序是乱的。Elasticsearch需要一种方法确保文档的旧版本不会覆盖新的版本。</p>
<p>当我们之前讨论index , GET和DELETE请求时，我们指出每个文档都有一个_version（版本号），当文档被修改时版本号递增。Elasticsearch使用这个version号来确保变更以正确顺序得到执行。如果旧版本的文档在新版本之后到达，它可以被简单的忽略。</p>
<p>我们可以利用version号来确保应用中相互冲突的变更不会导致数据丢失。我们通过指定想要修改文档的 version号来达到这个目的。如果该版本不是当前版本号，我们的请求将会失败。</p>
<p>老的版本es使用version，但是新版本不支持了，会报下面的错误，提示我们用if_seq _no和if _primary_term</p>
<p>创建索引</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#PUT http://127.0.0.1:9200/shopping/_create/1001</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1001&quot;,</span><br><span class="line">    &quot;_version&quot;: 1,</span><br><span class="line">    &quot;result&quot;: &quot;created&quot;,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 10,</span><br><span class="line">    &quot;_primary_term&quot;: 15</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#POST http://127.0.0.1:9200/shopping/_update/1001</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot;:&#123;</span><br><span class="line">        &quot;title&quot;:&quot;华为手机&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1001&quot;,</span><br><span class="line">    &quot;_version&quot;: 2,</span><br><span class="line">    &quot;result&quot;: &quot;updated&quot;,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 11,</span><br><span class="line">    &quot;_primary_term&quot;: 15</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>旧版本使用的防止冲突更新方法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#POST http://127.0.0.1:9200/shopping/_update/1001?version=1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot;:&#123;</span><br><span class="line">        &quot;title&quot;:&quot;华为手机2&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;error&quot;: &#123;</span><br><span class="line">        &quot;root_cause&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;type&quot;: &quot;action_request_validation_exception&quot;,</span><br><span class="line">                &quot;reason&quot;: &quot;Validation Failed: 1: internal versioning can not be used for optimistic concurrency control. Please use `if_seq_no` and `if_primary_term` instead;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;type&quot;: &quot;action_request_validation_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;Validation Failed: 1: internal versioning can not be used for optimistic concurrency control. Please use `if_seq_no` and `if_primary_term` instead;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;status&quot;: 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新版本使用的防止冲突更新方法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#POST http://127.0.0.1:9200/shopping/_update/1001?if_seq_no=11&amp;if_primary_term=15</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot;:&#123;</span><br><span class="line">        &quot;title&quot;:&quot;华为手机2&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1001&quot;,</span><br><span class="line">    &quot;_version&quot;: 3,</span><br><span class="line">    &quot;result&quot;: &quot;updated&quot;,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 12,</span><br><span class="line">    &quot;_primary_term&quot;: 16</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="14-3、外部系统版本控制"><a href="#14-3、外部系统版本控制" class="headerlink" title="14.3、外部系统版本控制"></a>14.3、外部系统版本控制</h4><p>一个常见的设置是使用其它数据库作为主要的数据存储，使用Elasticsearch做数据检索，这意味着主数据库的所有更改发生时都需要被复制到Elasticsearch，如果多个进程负责这一数据同步，你可能遇到类似于之前描述的并发问题。</p>
<p>如果你的主数据库已经有了版本号，或一个能作为版本号的字段值比如timestamp，那么你就可以在 Elasticsearch 中通过增加 version_type&#x3D;extermal到查询字符串的方式重用这些相同的版本号，版本号必须是大于零的整数，且小于9.2E+18，一个Java中 long类型的正值。</p>
<p>外部版本号的处理方式和我们之前讨论的内部版本号的处理方式有些不同，Elasticsearch不是检查当前_version和请求中指定的版本号是否相同，而是检查当前_version是否小于指定的版本号。如果请求成功，外部的版本号作为文档的新_version进行存储。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#POST http://127.0.0.1:9200/shopping/_doc/1001?version=300&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">	&quot;title&quot;:&quot;华为手机2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;1001&quot;,</span><br><span class="line">    &quot;_version&quot;: 300,</span><br><span class="line">    &quot;result&quot;: &quot;updated&quot;,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 13,</span><br><span class="line">    &quot;_primary_term&quot;: 16</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="15、文档展示-Kibana"><a href="#15、文档展示-Kibana" class="headerlink" title="15、文档展示-Kibana"></a>15、文档展示-Kibana</h3><p>Kibana是一个免费且开放的用户界面，能够让你对Elasticsearch 数据进行可视化，并让你在Elastic Stack 中进行导航。你可以进行各种操作，从跟踪查询负载，到理解请求如何流经你的整个应用，都能轻松完成。</p>
<p><a target="_blank" rel="noopener" href="https://artifacts.elastic.co/downloads/kibana/kibana-7.8.0-windows-x86_64.zip">Kibana下载网址</a></p>
<p>一、解压缩下载的 zip 文件。</p>
<p>二、修改 config&#x2F;kibana.yml 文件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 默认端口</span><br><span class="line">server.port: 5601</span><br><span class="line"># ES 服务器的地址</span><br><span class="line">elasticsearch.hosts: [&quot;http://localhost:9200&quot;]</span><br><span class="line"># 索引名</span><br><span class="line">kibana.index: &quot;.kibana&quot;</span><br><span class="line"># 支持中文</span><br><span class="line">i18n.locale: &quot;zh-CN&quot;</span><br></pre></td></tr></table></figure>

<p>三、Windows 环境下执行 bin&#x2F;kibana.bat 文件。（首次启动有点耗时）</p>
<p>四、通过浏览器访问：<a href="http://localhost:5601。">http://localhost:5601。</a></p>
<p><img src="/img/loading.gif" data-original="https://img-blog.csdnimg.cn/img_convert/d066ba5e26916624b5d056d04c5580ac.png" alt="img"></p>
<h2 id="九、Elasticsearch集成"><a href="#九、Elasticsearch集成" class="headerlink" title="九、Elasticsearch集成"></a>九、Elasticsearch集成</h2><h3 id="1、框架集成-SpringData-整体介绍"><a href="#1、框架集成-SpringData-整体介绍" class="headerlink" title="1、框架集成-SpringData-整体介绍"></a>1、框架集成-SpringData-整体介绍</h3><p>Spring Data是一个用于简化数据库、非关系型数据库、索引库访问，并支持云服务的开源框架。其主要目标是使得对数据的访问变得方便快捷，并支持 map-reduce框架和云计算数据服务。Spring Data可以极大的简化JPA(Elasticsearch…)的写法，可以在几乎不用写实现的情况下，实现对数据的访问和操作。除了CRUD 外，还包括如分页、排序等一些常用的功能。</p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data">Spring Data 的官网</a></p>
<p>Spring Data 常用的功能模块如下：</p>
<ul>
<li><p>Spring Data JDBC</p>
</li>
<li><p>Spring Data JPA</p>
</li>
<li><p>Spring Data LDAP</p>
</li>
<li><p>Spring Data MongoDB</p>
</li>
<li><p>Spring Data Redis</p>
</li>
<li><p>Spring Data R2DBC</p>
</li>
<li><p>Spring Data REST</p>
</li>
<li><p>Spring Data for Apache Cassandra</p>
</li>
<li><p>Spring Data for Apache Geode</p>
</li>
<li><p>Spring Data for Apache Solr</p>
</li>
<li><p>Spring Data for Pivotal GemFire</p>
</li>
<li><p>Spring Data Couchbase</p>
</li>
<li><p>Spring Data Elasticsearch</p>
</li>
<li><p>Spring Data Envers</p>
</li>
<li><p>Spring Data Neo4j</p>
</li>
<li><p>Spring Data JDBC Extensions</p>
</li>
<li><p>Spring for Apache Hadoop</p>
</li>
</ul>
<p><strong>Spring Data Elasticsearch 介绍</strong><br>Spring Data Elasticsearch基于Spring Data API简化 Elasticsearch 操作，将原始操作Elasticsearch 的客户端API进行封装。Spring Data为Elasticsearch 项目提供集成搜索引擎。Spring Data Elasticsearch POJO的关键功能区域为中心的模型与Elastichsearch交互文档和轻松地编写一个存储索引库数据访问层。</p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data-elasticsearch">Spring Data Elasticsearch 官网</a></p>
<h3 id="2、框架集成-SpringData-代码功能集成"><a href="#2、框架集成-SpringData-代码功能集成" class="headerlink" title="2、框架集成-SpringData-代码功能集成"></a>2、框架集成-SpringData-代码功能集成</h3><p>一、创建Maven项目。</p>
<p>二、修改pom文件，增加依赖关系。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.3.6.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.lun&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;SpringDataWithES&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>三、增加配置文件。</p>
<p>在 resources 目录中增加application.properties文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># es 服务地址</span><br><span class="line">elasticsearch.host=127.0.0.1</span><br><span class="line"># es 服务端口</span><br><span class="line">elasticsearch.port=9200</span><br><span class="line"># 配置日志级别,开启 debug 日志</span><br><span class="line">logging.level.com.atguigu.es=debug</span><br></pre></td></tr></table></figure>

<p>四、Spring Boot 主程序。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>五、数据实体类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;shopping&quot;, shards = 3, replicas = 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">    <span class="comment">//必须有 id,这里的 id 是全局唯一的标识，等同于 es 中的&quot;_id&quot;</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;<span class="comment">//商品唯一标识</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * type : 字段数据类型</span></span><br><span class="line"><span class="comment">     * analyzer : 分词器类型</span></span><br><span class="line"><span class="comment">     * index : 是否索引(默认:true)</span></span><br><span class="line"><span class="comment">     * Keyword : 短语,不进行分词</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String title;<span class="comment">//商品名称</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String category;<span class="comment">//分类名称</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Double)</span></span><br><span class="line">    <span class="keyword">private</span> Double price;<span class="comment">//商品价格</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword, index = false)</span></span><br><span class="line">    <span class="keyword">private</span> String images;<span class="comment">//图片地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>六、配置类</p>
<ul>
<li>ElasticsearchRestTemplate是spring-data-elasticsearch项目中的一个类,和其他spring项目中的 template类似。</li>
<li>在新版的spring-data-elasticsearch 中，ElasticsearchRestTemplate 代替了原来的ElasticsearchTemplate。</li>
<li>原因是ElasticsearchTemplate基于TransportClient，TransportClient即将在8.x 以后的版本中移除。所以，我们推荐使用ElasticsearchRestTemplate。</li>
<li>ElasticsearchRestTemplate基于RestHighLevelClient客户端的。需要自定义配置类，继承AbstractElasticsearchConfiguration，并实现elasticsearchClient()抽象方法，创建RestHighLevelClient对象。</li>
</ul>
<p>AbstractElasticsearchConfiguration源码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.data.elasticsearch.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.ElasticsearchOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.convert.ElasticsearchConverter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Christoph Strobl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Peter-Josef Meisch</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ElasticsearchConfigurationSupport</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractElasticsearchConfiguration</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchConfigurationSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//需重写本方法</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">abstract</span> RestHighLevelClient <span class="title function_">elasticsearchClient</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean(name = &#123; &quot;elasticsearchOperations&quot;, &quot;elasticsearchTemplate&quot; &#125;)</span></span><br><span class="line">	<span class="keyword">public</span> ElasticsearchOperations <span class="title function_">elasticsearchOperations</span><span class="params">(ElasticsearchConverter elasticsearchConverter)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ElasticsearchRestTemplate</span>(elasticsearchClient(), elasticsearchConverter);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要自定义配置类，继承AbstractElasticsearchConfiguration，并实现elasticsearchClient()抽象方法，创建RestHighLevelClient对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;elasticsearch&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchConfig</span> <span class="keyword">extends</span> <span class="title class_">AbstractElasticsearchConfiguration</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host ;</span><br><span class="line">    <span class="keyword">private</span> Integer port ;</span><br><span class="line">    <span class="comment">//重写父类方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestHighLevelClient <span class="title function_">elasticsearchClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RestClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(host, port));</span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">restHighLevelClient</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">RestHighLevelClient</span>(builder);</span><br><span class="line">        <span class="keyword">return</span> restHighLevelClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>七、DAO 数据访问对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductDao</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;Product, Long&gt;&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3、框架集成-SpringData-集成测试-索引操作"><a href="#3、框架集成-SpringData-集成测试-索引操作" class="headerlink" title="3、框架集成-SpringData-集成测试-索引操作"></a>3、框架集成-SpringData-集成测试-索引操作</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataESIndexTest</span> &#123;</span><br><span class="line">    <span class="comment">//注入 ElasticsearchRestTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line">    <span class="comment">//创建索引并增加映射配置</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//创建索引，系统初始化会自动创建索引</span></span><br><span class="line">        System.out.println(<span class="string">&quot;创建索引&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//创建索引，系统初始化会自动创建索引</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flg</span> <span class="operator">=</span> elasticsearchRestTemplate.deleteIndex(Product.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;删除索引 = &quot;</span> + flg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用Postman 检测有没有创建和删除。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">#GET http<span class="punctuation">:</span><span class="comment">//localhost:9200/_cat/indices?v </span></span><br></pre></td></tr></table></figure>



<h3 id="4、框架集成-SpringData-集成测试-文档操作"><a href="#4、框架集成-SpringData-集成测试-文档操作" class="headerlink" title="4、框架集成-SpringData-集成测试-文档操作"></a>4、框架集成-SpringData-集成测试-文档操作</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataESProductDaoTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductDao productDao;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(<span class="number">2L</span>);</span><br><span class="line">        product.setTitle(<span class="string">&quot;华为手机&quot;</span>);</span><br><span class="line">        product.setCategory(<span class="string">&quot;手机&quot;</span>);</span><br><span class="line">        product.setPrice(<span class="number">2999.0</span>);</span><br><span class="line">        product.setImages(<span class="string">&quot;http://www.atguigu/hw.jpg&quot;</span>);</span><br><span class="line">        productDao.save(product);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//POSTMAN, GET http://localhost:9200/product/_doc/2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(<span class="number">2L</span>);</span><br><span class="line">        product.setTitle(<span class="string">&quot;小米 2 手机&quot;</span>);</span><br><span class="line">        product.setCategory(<span class="string">&quot;手机&quot;</span>);</span><br><span class="line">        product.setPrice(<span class="number">9999.0</span>);</span><br><span class="line">        product.setImages(<span class="string">&quot;http://www.atguigu/xm.jpg&quot;</span>);</span><br><span class="line">        productDao.save(product);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//POSTMAN, GET http://localhost:9200/product/_doc/2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据 id 查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findById</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> productDao.findById(<span class="number">2L</span>).get();</span><br><span class="line">        System.out.println(product);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findAll</span><span class="params">()</span>&#123;</span><br><span class="line">        Iterable&lt;Product&gt; products = productDao.findAll();</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(<span class="number">2L</span>);</span><br><span class="line">        productDao.delete(product);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//POSTMAN, GET http://localhost:9200/product/_doc/2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//批量新增</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAll</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;Product&gt; productList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">            product.setId(Long.valueOf(i));</span><br><span class="line">            product.setTitle(<span class="string">&quot;[&quot;</span>+i+<span class="string">&quot;]小米手机&quot;</span>);</span><br><span class="line">            product.setCategory(<span class="string">&quot;手机&quot;</span>);</span><br><span class="line">            product.setPrice(<span class="number">1999.0</span> + i);</span><br><span class="line">            product.setImages(<span class="string">&quot;http://www.atguigu/xm.jpg&quot;</span>);</span><br><span class="line">            productList.add(product);</span><br><span class="line">        &#125;</span><br><span class="line">        productDao.saveAll(productList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByPageable</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//设置排序(排序方式，正序还是倒序，排序的 id)</span></span><br><span class="line">        <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> Sort.by(Sort.Direction.DESC,<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="type">int</span> currentPage=<span class="number">0</span>;<span class="comment">//当前页，第一页从 0 开始， 1 表示第二页</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">5</span>;<span class="comment">//每页显示多少条</span></span><br><span class="line">        <span class="comment">//设置查询分页</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(currentPage, pageSize,sort);</span><br><span class="line">        <span class="comment">//分页查询</span></span><br><span class="line">        Page&lt;Product&gt; productPage = productDao.findAll(pageRequest);</span><br><span class="line">        <span class="keyword">for</span> (Product Product : productPage.getContent()) &#123;</span><br><span class="line">            System.out.println(Product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5、框架集成-SpringData-集成测试-文档搜索"><a href="#5、框架集成-SpringData-集成测试-文档搜索" class="headerlink" title="5、框架集成-SpringData-集成测试-文档搜索"></a>5、框架集成-SpringData-集成测试-文档搜索</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataESSearchTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductDao productDao;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * term 查询</span></span><br><span class="line"><span class="comment">     * search(termQueryBuilder) 调用搜索方法，参数查询构建器对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">termQuery</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;小米&quot;</span>);</span><br><span class="line">                Iterable&lt;Product&gt; products = productDao.search(termQueryBuilder);</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * term 查询加分页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">termQueryByPage</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> currentPage= <span class="number">0</span> ;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="comment">//设置查询分页</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(currentPage, pageSize);</span><br><span class="line">        <span class="type">TermQueryBuilder</span> <span class="variable">termQueryBuilder</span> <span class="operator">=</span> QueryBuilders.termQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;小米&quot;</span>);</span><br><span class="line">                Iterable&lt;Product&gt; products =</span><br><span class="line">                        productDao.search(termQueryBuilder,pageRequest);</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.println(product);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6、框架集成-SparkStreaming-集成"><a href="#6、框架集成-SparkStreaming-集成" class="headerlink" title="6、框架集成-SparkStreaming-集成"></a>6、框架集成-SparkStreaming-集成</h3><p>Spark Streaming 是Spark core API的扩展，支持实时数据流的处理，并且具有可扩展，高吞吐量，容错的特点。数据可以从许多来源获取,如Kafka， Flume，Kinesis或TCP sockets，并且可以使用复杂的算法进行处理，这些算法使用诸如 map，reduce，join和 window等高级函数表示。最后，处理后的数据可以推送到文件系统，数据库等。实际上，您可以将Spark的机器学习和图形处理算法应用于数据流。</p>
<p>一、创建Maven项目。</p>
<p>二、修改 pom 文件，增加依赖关系。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;project</span><br><span class="line">    xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="line">    xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line">    &lt;groupId&gt;com.lun.es&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sparkstreaming-elasticsearch&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.0</span>&lt;/version&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;<span class="number">8</span>&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;<span class="number">8</span>&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-core_2<span class="number">.12</span>&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">3.0</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spark-streaming_2<span class="number">.12</span>&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">3.0</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">7.8</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- elasticsearch 的客户端 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">7.8</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- elasticsearch 依赖 <span class="number">2.</span>x 的 log4j --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">2.8</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">2.8</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- &lt;dependency&gt;--&gt;</span><br><span class="line">        &lt;!-- &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;--&gt;</span><br><span class="line">        &lt;!-- &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;--&gt;</span><br><span class="line">        &lt;!-- &lt;version&gt;<span class="number">2.11</span><span class="number">.1</span>&lt;/version&gt;--&gt;</span><br><span class="line">        &lt;!-- &lt;/dependency&gt;--&gt;</span><br><span class="line">        &lt;!-- &amp;lt;!&amp;ndash; junit 单元测试 &amp;ndash;&amp;gt;--&gt;</span><br><span class="line">        &lt;!-- &lt;dependency&gt;--&gt;</span><br><span class="line">        &lt;!-- &lt;groupId&gt;junit&lt;/groupId&gt;--&gt;</span><br><span class="line">        &lt;!-- &lt;artifactId&gt;junit&lt;/artifactId&gt;--&gt;</span><br><span class="line">        &lt;!-- &lt;version&gt;<span class="number">4.12</span>&lt;/version&gt;--&gt;</span><br><span class="line">        &lt;!-- &lt;/dependency&gt;--&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>三、功能实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">object SparkStreamingESTest &#123;</span><br><span class="line"></span><br><span class="line">    def <span class="title function_">main</span><span class="params">(args: Array[String])</span>: Unit = &#123;</span><br><span class="line">        <span class="type">val</span> <span class="variable">sparkConf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;ESTest&quot;</span>)</span><br><span class="line">        <span class="type">val</span> <span class="variable">ssc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StreamingContext</span>(sparkConf, Seconds(<span class="number">3</span>))</span><br><span class="line">        val ds: ReceiverInputDStream[String] = ssc.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>)</span><br><span class="line">        ds.foreachRDD(</span><br><span class="line">            rdd =&gt; &#123;</span><br><span class="line">                println(<span class="string">&quot;*************** &quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">                rdd.foreach(</span><br><span class="line">                    data =&gt; &#123;</span><br><span class="line">                        <span class="type">val</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)));</span><br><span class="line">                        <span class="comment">// 新增文档 - 请求对象</span></span><br><span class="line">                        <span class="type">val</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>();</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 设置索引及唯一性标识</span></span><br><span class="line">                        <span class="type">val</span> <span class="variable">ss</span> <span class="operator">=</span> data.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">                        println(<span class="string">&quot;ss = &quot;</span> + ss.mkString(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">                        request.index(<span class="string">&quot;sparkstreaming&quot;</span>).id(ss(<span class="number">0</span>));</span><br><span class="line">                        </span><br><span class="line">                        <span class="type">val</span> <span class="variable">productJson</span> <span class="operator">=</span></span><br><span class="line">                            s<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                            | &#123; &quot;data&quot;:&quot;$&#123;ss(1)&#125;&quot; &#125;</span></span><br><span class="line"><span class="string">                            |&quot;&quot;&quot;</span>.stripMargin;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 添加文档数据，数据格式为 JSON 格式</span></span><br><span class="line">                        request.source(productJson,XContentType.JSON);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 客户端发送请求，获取响应对象</span></span><br><span class="line">                        <span class="type">val</span> <span class="variable">response</span> <span class="operator">=</span> client.index(request,</span><br><span class="line">                        RequestOptions.DEFAULT);</span><br><span class="line">                        System.out.println(<span class="string">&quot;_index:&quot;</span> + response.getIndex());</span><br><span class="line">                        System.out.println(<span class="string">&quot;_id:&quot;</span> + response.getId());</span><br><span class="line">                        System.out.println(<span class="string">&quot;_result:&quot;</span> + response.getResult());</span><br><span class="line">                        client.close()</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        ssc.start()</span><br><span class="line">        ssc.awaitTermination()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7、框架集成-Flink-集成"><a href="#7、框架集成-Flink-集成" class="headerlink" title="7、框架集成-Flink-集成"></a>7、框架集成-Flink-集成</h3><p>Apache Spark是一-种基于内存的快速、通用、可扩展的大数据分析计算引擎。Apache Spark掀开了内存计算的先河，以内存作为赌注，贏得了内存计算的飞速发展。但是在其火热的同时，开发人员发现，在Spark中，计算框架普遍存在的缺点和不足依然没有完全解决，而这些问题随着5G时代的来临以及决策者对实时数据分析结果的迫切需要而凸显的更加明显：</p>
<ul>
<li><p>乱序数据，迟到数据</p>
</li>
<li><p>低延迟，高吞吐，准确性</p>
</li>
<li><p>容错性</p>
</li>
<li><p>数据精准一次性处理（Exactly-Once）</p>
</li>
</ul>
<p>Apache Flink是一个框架和分布式处理引擎，用于对无界和有界数据流进行有状态计算。在Spark火热的同时，也默默地发展自己，并尝试着解决其他计算框架的问题。慢慢地，随着这些问题的解决，Flink 慢慢被绝大数程序员所熟知并进行大力推广，阿里公司在2015年改进Flink，并创建了内部分支Blink，目前服务于阿里集团内部搜索、推荐、广告和蚂蚁等大量核心实时业务。</p>
<p>一、创建Maven项目。</p>
<p>二、修改 pom 文件，增加相关依赖类库。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project</span><br><span class="line">    xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="line">    xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0</span></span><br><span class="line"><span class="string">http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line">    &lt;groupId&gt;com.lun.es&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;flink-elasticsearch&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.0</span>&lt;/version&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;<span class="number">8</span>&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;<span class="number">8</span>&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flink-scala_2<span class="number">.12</span>&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.12</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flink-streaming-scala_2<span class="number">.12</span>&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.12</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flink-clients_2<span class="number">.12</span>&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.12</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flink-connector-elasticsearch7_2<span class="number">.11</span>&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.12</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- jackson --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">2.11</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>三、功能实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlinkElasticsearchSinkTest</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">		DataStreamSource&lt;String&gt; source = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>);</span><br><span class="line">		List&lt;HttpHost&gt; httpHosts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		httpHosts.add(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>));</span><br><span class="line">		<span class="comment">//httpHosts.add(new HttpHost(&quot;10.2.3.1&quot;, 9200, &quot;http&quot;));</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// use a ElasticsearchSink.Builder to create an ElasticsearchSink</span></span><br><span class="line">		ElasticsearchSink.Builder&lt;String&gt; esSinkBuilder = <span class="keyword">new</span> <span class="title class_">ElasticsearchSink</span>.Builder&lt;&gt;(httpHosts, </span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">ElasticsearchSinkFunction</span>&lt;String&gt;() &#123;</span><br><span class="line">				<span class="keyword">public</span> IndexRequest <span class="title function_">createIndexRequest</span><span class="params">(String element)</span> &#123;</span><br><span class="line">					Map&lt;String, String&gt; json = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">					json.put(<span class="string">&quot;data&quot;</span>, element);</span><br><span class="line">					<span class="keyword">return</span> Requests.indexRequest()</span><br><span class="line">						.index(<span class="string">&quot;my-index&quot;</span>)</span><br><span class="line">						<span class="comment">//.type(&quot;my-type&quot;)</span></span><br><span class="line">						.source(json);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String element, RuntimeContext ctx, RequestIndexer indexer)</span> &#123;</span><br><span class="line">					indexer.add(createIndexRequest(element));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// configuration for the bulk requests; this instructs the sink to emit after every element, otherwise they would be buffered</span></span><br><span class="line">		esSinkBuilder.setBulkFlushMaxActions(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// provide a RestClientFactory for custom configuration on the internally createdREST client</span></span><br><span class="line">		<span class="comment">// esSinkBuilder.setRestClientFactory(</span></span><br><span class="line">		<span class="comment">// restClientBuilder -&gt; &#123;</span></span><br><span class="line">			<span class="comment">// restClientBuilder.setDefaultHeaders(...)</span></span><br><span class="line">			<span class="comment">// restClientBuilder.setMaxRetryTimeoutMillis(...)</span></span><br><span class="line">			<span class="comment">// restClientBuilder.setPathPrefix(...)</span></span><br><span class="line">			<span class="comment">// restClientBuilder.setHttpClientConfigCallback(...)</span></span><br><span class="line">		<span class="comment">// &#125;</span></span><br><span class="line">		<span class="comment">// );</span></span><br><span class="line">		source.addSink(esSinkBuilder.build());</span><br><span class="line">		env.execute(<span class="string">&quot;flink-es&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="十、ES-优化"><a href="#十、ES-优化" class="headerlink" title="十、ES 优化"></a>十、ES 优化</h2><h3 id="1、优化-硬件选择"><a href="#1、优化-硬件选择" class="headerlink" title="1、优化-硬件选择"></a>1、优化-硬件选择</h3><p>Elasticsearch 的基础是 Lucene，所有的索引和文档数据是存储在本地的磁盘中，具体的路径可在 ES 的配置文件<code>…/config/elasticsearch.yml</code>中配置，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#</span><br><span class="line"># Path to directory where to store the data (separate multiple locations by comma):</span><br><span class="line">#</span><br><span class="line">path.data: /path/to/data</span><br><span class="line">#</span><br><span class="line"># Path to log files:</span><br><span class="line">#</span><br><span class="line">path.logs: /path/to/logs</span><br></pre></td></tr></table></figure>


<p>磁盘在现代服务器上通常都是瓶颈。Elasticsearch重度使用磁盘，你的磁盘能处理的吞吐量越大，你的节点就越稳定。这里有一些优化磁盘I&#x2F;O的技巧：</p>
<ul>
<li>使用SSD就像其他地方提过的，他们比机械磁盘优秀多了。</li>
<li>使用RAID0。条带化RAID会提高磁盘IO，代价显然就是当一块硬盘故障时整个就故障了。不要使用镜像或者奇偶校验RAID，因为副本已经提供了这个功能。</li>
<li>另外，使用多块硬盘，并允许Elasticsearch 通过多个path data目录配置把数据条带化分配到它们上面。</li>
<li>不要使用远程挂载的存储，比如NFS或者SMB&#x2F;CIFS。这个引入的延迟对性能来说完全是背道而驰的。</li>
</ul>
<h3 id="2、优化-分片策略"><a href="#2、优化-分片策略" class="headerlink" title="2、优化-分片策略"></a>2、优化-分片策略</h3><h4 id="合理设置分片数"><a href="#合理设置分片数" class="headerlink" title="合理设置分片数"></a>合理设置分片数</h4><p>分片和副本的设计为 ES 提供了支持分布式和故障转移的特性，但并不意味着分片和副本是可以无限分配的。而且索引的分片完成分配后由于索引的路由机制，我们是不能重新修改分片数的。</p>
<p>可能有人会说，我不知道这个索引将来会变得多大，并且过后我也不能更改索引的大小，所以为了保险起见，还是给它设为 1000 个分片吧。但是需要知道的是，一个分片并不是没有代价的。需要了解：</p>
<ul>
<li><p>一个分片的底层即为一个 Lucene 索引，会消耗一定文件句柄、内存、以及 CPU运转。</p>
</li>
<li><p>每一个搜索请求都需要命中索引中的每一个分片，如果每一个分片都处于不同的节点还好， 但如果多个分片都需要在同一个节点上竞争使用相同的资源就有些糟糕了。</p>
</li>
<li><p>用于计算相关度的词项统计信息是基于分片的。如果有许多分片，每一个都只有很少的数据会导致很低的相关度。</p>
</li>
</ul>
<p>一个业务索引具体需要分配多少分片可能需要架构师和技术人员对业务的增长有个预先的判断，横向扩展应当分阶段进行。为下一阶段准备好足够的资源。 只有当你进入到下一个阶段，你才有时间思考需要作出哪些改变来达到这个阶段。一般来说，我们遵循一些原则：</p>
<ul>
<li><p>控制每个分片占用的硬盘容量不超过 ES 的最大 JVM 的堆空间设置（一般设置不超过 32G，参考下文的 JVM 设置原则），因此，如果索引的总容量在 500G 左右，那分片大小在 16 个左右即可；当然，最好同时考虑原则 2。</p>
</li>
<li><p>考虑一下 node 数量，一般一个节点有时候就是一台物理机，如果分片数过多，大大超过了节点数，很可能会导致一个节点上存在多个分片，一旦该节点故障，即使保持了 1 个以上的副本，同样有可能会导致数据丢失，集群无法恢复。所以， 一般都设置分片数不超过节点数的 3 倍。</p>
</li>
<li><p>主分片，副本和节点最大数之间数量，我们分配的时候可以参考以下关系：<code>节点数&lt;=主分片数 *（副本数+1）</code></p>
</li>
</ul>
<h4 id="推迟分片分配"><a href="#推迟分片分配" class="headerlink" title="推迟分片分配"></a>推迟分片分配</h4><p>对于节点瞬时中断的问题，默认情况，集群会等待一分钟来查看节点是否会重新加入，如果这个节点在此期间重新加入，重新加入的节点会保持其现有的分片数据，不会触发新的分片分配。这样就可以减少 ES 在自动再平衡可用分片时所带来的极大开销。</p>
<p>通过修改参数 delayed_timeout ，可以延长再均衡的时间，可以全局设置也可以在索引级别进行修改：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#PUT /_all/_settings</span><br><span class="line">&#123;</span><br><span class="line">	&quot;settings&quot;: &#123;</span><br><span class="line">		&quot;index.unassigned.node_left.delayed_timeout&quot;: &quot;5m&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3、优化-路由选择"><a href="#3、优化-路由选择" class="headerlink" title="3、优化-路由选择"></a>3、优化-路由选择</h3><p>当我们查询文档的时候， Elasticsearch 如何知道一个文档应该存放到哪个分片中呢？它其实是通过下面这个公式来计算出来：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shards</span><br><span class="line">routing 默认值是文档的 id，也可以采用自定义值，比如用户 id。</span><br></pre></td></tr></table></figure>

<p><strong>不带routing查询</strong><br>在查询的时候因为不知道要查询的数据具体在哪个分片上，所以整个过程分为2个步骤</p>
<ul>
<li>分发：请求到达协调节点后，协调节点将查询请求分发到每个分片上。</li>
<li>聚合：协调节点搜集到每个分片上查询结果，在将查询的结果进行排序，之后给用户返回结果。</li>
</ul>
<p><strong>带routing查询</strong><br>查询的时候，可以直接根据routing 信息定位到某个分配查询，不需要查询所有的分配，经过协调节点排序。向上面自定义的用户查询，如果routing 设置为userid 的话，就可以直接查询出数据来，效率提升很多。</p>
<h3 id="4、优化-写入速度优化"><a href="#4、优化-写入速度优化" class="headerlink" title="4、优化-写入速度优化"></a>4、优化-写入速度优化</h3><p>ES 的默认配置，是综合了数据可靠性、写入速度、搜索实时性等因素。实际使用时，我们需要根据公司要求，进行偏向性的优化。</p>
<p>针对于搜索性能要求不高，但是对写入要求较高的场景，我们需要尽可能的选择恰当写优化策略。综合来说，可以考虑以下几个方面来提升写索引的性能：</p>
<ul>
<li><p>加大Translog Flush，目的是降低Iops、Writeblock。</p>
</li>
<li><p>增加Index Refesh间隔，目的是减少Segment Merge的次数。</p>
</li>
<li><p>调整Bulk 线程池和队列。</p>
</li>
<li><p>优化节点间的任务分布。</p>
</li>
<li><p>优化Lucene层的索引建立，目的是降低CPU及IO。</p>
</li>
</ul>
<h4 id="优化存储设备"><a href="#优化存储设备" class="headerlink" title="优化存储设备"></a>优化存储设备</h4><p>ES 是一种密集使用磁盘的应用，在段合并的时候会频繁操作磁盘，所以对磁盘要求较高，当磁盘速度提升之后，集群的整体性能会大幅度提高。</p>
<h4 id="合理使用合并"><a href="#合理使用合并" class="headerlink" title="合理使用合并"></a>合理使用合并</h4><p>Lucene 以段的形式存储数据。当有新的数据写入索引时， Lucene 就会自动创建一个新的段。</p>
<p>随着数据量的变化，段的数量会越来越多，消耗的多文件句柄数及 CPU 就越多，查询效率就会下降。</p>
<p>由于 Lucene 段合并的计算量庞大，会消耗大量的 I&#x2F;O，所以 ES 默认采用较保守的策略，让后台定期进行段合并。</p>
<h4 id="减少-Refresh-的次数"><a href="#减少-Refresh-的次数" class="headerlink" title="减少 Refresh 的次数"></a>减少 Refresh 的次数</h4><p>Lucene 在新增数据时，采用了延迟写入的策略，默认情况下索引的refresh_interval 为1 秒。</p>
<p>Lucene 将待写入的数据先写到内存中，超过 1 秒（默认）时就会触发一次 Refresh，然后 Refresh 会把内存中的的数据刷新到操作系统的文件缓存系统中。</p>
<p>如果我们对搜索的实效性要求不高，可以将 Refresh 周期延长，例如 30 秒。</p>
<p>这样还可以有效地减少段刷新次数，但这同时意味着需要消耗更多的 Heap 内存。</p>
<h4 id="加大-Flush-设置"><a href="#加大-Flush-设置" class="headerlink" title="加大 Flush 设置"></a>加大 Flush 设置</h4><p>Flush 的主要目的是把文件缓存系统中的段持久化到硬盘，当 Translog 的数据量达到 512MB 或者 30 分钟时，会触发一次 Flush。</p>
<p>index.translog.flush_threshold_size 参数的默认值是 512MB，我们进行修改。</p>
<p>增加参数值意味着文件缓存系统中可能需要存储更多的数据，所以我们需要为操作系统的文件缓存系统留下足够的空间。</p>
<h4 id="减少副本的数量"><a href="#减少副本的数量" class="headerlink" title="减少副本的数量"></a>减少副本的数量</h4><p>ES 为了保证集群的可用性，提供了 Replicas（副本）支持，然而每个副本也会执行分析、索引及可能的合并过程，所以 Replicas 的数量会严重影响写索引的效率。</p>
<p>当写索引时，需要把写入的数据都同步到副本节点，副本节点越多，写索引的效率就越慢。</p>
<p>如果我们需要大批量进行写入操作，可以先禁止Replica复制，设置<br>index.number_of_replicas: 0 关闭副本。在写入完成后， Replica 修改回正常的状态。</p>
<h3 id="5、优化-内存设置"><a href="#5、优化-内存设置" class="headerlink" title="5、优化-内存设置"></a>5、优化-内存设置</h3><p>ES 默认安装后设置的内存是 1GB，对于任何一个现实业务来说，这个设置都太小了。如果是通过解压安装的 ES，则在 ES 安装文件中包含一个 jvm.option 文件，添加如下命令来设置 ES 的堆大小， Xms 表示堆的初始大小， Xmx 表示可分配的最大内存，都是 1GB。</p>
<p>确保 Xmx 和 Xms 的大小是相同的，其目的是为了能够在 Java 垃圾回收机制清理完堆区后不需要重新分隔计算堆区的大小而浪费资源，可以减轻伸缩堆大小带来的压力。</p>
<p>假设你有一个 64G 内存的机器，按照正常思维思考，你可能会认为把 64G 内存都给ES 比较好，但现实是这样吗， 越大越好？虽然内存对 ES 来说是非常重要的，但是答案是否定的！</p>
<p>因为 ES 堆内存的分配需要满足以下两个原则：</p>
<ul>
<li><p>不要超过物理内存的 50%： Lucene 的设计目的是把底层 OS 里的数据缓存到内存中。Lucene 的段是分别存储到单个文件中的，这些文件都是不会变化的，所以很利于缓存，同时操作系统也会把这些段文件缓存起来，以便更快的访问。如果我们设置的堆内存过大， Lucene 可用的内存将会减少，就会严重影响降低 Lucene 的全文本查询性能。</p>
</li>
<li><p>堆内存的大小最好不要超过 32GB：在 Java 中，所有对象都分配在堆上，然后有一个 Klass Pointer 指针指向它的类元数据。这个指针在 64 位的操作系统上为 64 位， 64 位的操作系统可以使用更多的内存（2^64）。在 32 位的系统上为 32 位， 32 位的操作系统的最大寻址空间为 4GB（2^32）。但是 64 位的指针意味着更大的浪费，因为你的指针本身大了。浪费内存不算，更糟糕的是，更大的指针在主内存和缓存器（例如 LLC, L1 等）之间移动数据的时候，会占用更多的带宽。</p>
</li>
</ul>
<p>最终我们都会采用 31 G 设置</p>
<ul>
<li>-Xms 31g</li>
<li>-Xmx 31g</li>
</ul>
<p>假设你有个机器有 128 GB 的内存，你可以创建两个节点，每个节点内存分配不超过 32 GB。也就是说不超过 64 GB 内存给 ES 的堆内存，剩下的超过 64 GB 的内存给 Lucene。</p>
<h3 id="6、优化-重要配置"><a href="#6、优化-重要配置" class="headerlink" title="6、优化-重要配置"></a>6、优化-重要配置</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>参数值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>cluster.name</td>
<td>elasticsearch</td>
<td>配置 ES 的集群名称，默认值是 ES，建议改成与所存数据相关的名称， ES 会自动发现在同一网段下的 集群名称相同的节点。</td>
</tr>
<tr>
<td>node.name</td>
<td>node-1</td>
<td>集群中的节点名，在同一个集群中不能重复。节点 的名称一旦设置，就不能再改变了。当然，也可以 设 置 成 服 务 器 的 主 机 名 称 ， 例 如 node.name:${HOSTNAME}。</td>
</tr>
<tr>
<td>node.master</td>
<td>true</td>
<td>指定该节点是否有资格被选举成为 Master 节点，默 认是 True，如果被设置为 True，则只是有资格成为 Master 节点，具体能否成为 Master 节点，需要通 过选举产生。</td>
</tr>
<tr>
<td>node.data</td>
<td>true</td>
<td>指定该节点是否存储索引数据，默认为 True。数据 的增、删、改、查都是在 Data 节点完成的。</td>
</tr>
<tr>
<td>index.number_of_shards</td>
<td>1</td>
<td>设置都索引分片个数，默认是 1 片。也可以在创建 索引时设置该值，具体设置为多大都值要根据数据 量的大小来定。如果数据量不大，则设置成 1 时效 率最高。</td>
</tr>
<tr>
<td>index.number_of_replicas</td>
<td>1</td>
<td>设置默认的索引副本个数，默认为 1 个。副本数越 多，集群的可用性越好，但是写索引时需要同步的 数据越多。</td>
</tr>
<tr>
<td>transport.tcp.compress</td>
<td>true</td>
<td>设置在节点间传输数据时是否压缩，默认为 False， 不压缩。</td>
</tr>
<tr>
<td>discovery.zen.minimum_master_nodes</td>
<td>1</td>
<td>设置在选举 Master 节点时需要参与的最少的候选 主节点数，默认为 1。如果使用默认值，则当网络 不稳定时有可能会出现脑裂。合 理 的 数 值 为 (master_eligible_nodes&#x2F;2)+1 ， 其 中 master_eligible_nodes 表示集群中的候选主节点数</td>
</tr>
<tr>
<td>discovery.zen.ping.timeout</td>
<td>3s</td>
<td>设置在集群中自动发现其他节点时 Ping 连接的超 时时间，默认为 3 秒。 在较差的网络环境下需要设置得大一点，防止因误 判该节点的存活状态而导致分片的转移</td>
</tr>
</tbody></table>
<h2 id="100、遇到的错误"><a href="#100、遇到的错误" class="headerlink" title="100、遇到的错误"></a>100、遇到的错误</h2><h3 id="1、问题一：docker-Error-response-from-daemon-driver-failed-programming-external-connectivity-on-endpoint-es"><a href="#1、问题一：docker-Error-response-from-daemon-driver-failed-programming-external-connectivity-on-endpoint-es" class="headerlink" title="1、问题一：docker: Error response from daemon: driver failed programming external connectivity on endpoint es"></a>1、问题一：docker: Error response from daemon: driver failed programming external connectivity on endpoint es</h3><p><strong>原因分析：</strong><br>这个错误可以理解为：docker在启动容器的时候或者是对docker做配置时，对防火墙设置重新启动等操作，这导致docker的相关配置被清除，导致在查询防火墙规则的时候找不到docker的链。</p>
<p><strong>解决方案：</strong><br>直接重新启动docker，再次相关的docker容器即可。</p>
<p>重启docker：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p> 挨个启动docker中的容器：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker ps -a  #查出配置所有的容器</span><br><span class="line">docker start 容器名  #启动对应容器名的容器</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">HUA</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/10/01/Elasticsearch/">http://example.com/2023/10/01/Elasticsearch/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">阿华</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/page4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/10/04/PandaSearch/"><img class="prev-cover" src="/img/loading.gif" data-original="/img/page6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2023/09/29/DeBug/"><img class="next-cover" src="/img/loading.gif" data-original="/img/page5.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/loading.gif" data-original="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">HUA</div><div class="author-info__description">不要放弃</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/TINGTING-GIT" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="tencent://AddContact/?fromld=45&amp;fromSubld=1&amp;subcmd=all&amp;uin=2164277973&amp;website=www.oicqzone.com" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="mailto:2164277973@qq.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><div class="xpand" style="height:200px;"><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div></div><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople1.js"></script><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/zdog.dist.js"></script><script id="rendered-js" src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople.js"></script><style>.card-widget.card-announcement {
margin: 0;
align-items: center;
justify-content: center;
text-align: center;
}
canvas {
display: block;
margin: 0 auto;
cursor: move;
}</style><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81ES-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">一、ES 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Elasticsearch-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">1、Elasticsearch 是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81ES-%E8%A7%A3%E5%86%B3%E4%BA%86%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.</span> <span class="toc-text">2、ES 解决了什么问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81%E4%B8%8D%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1、不适用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E9%80%89%E5%9E%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2、选型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3、应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">全文搜索引擎</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Elasticsearch-%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">Elasticsearch 应用案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">1.3.</span> <span class="toc-text">3、倒排索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81ES-%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">二、ES 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%9F%BA%E4%BA%8E-Windows-%E7%9A%84%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.</span> <span class="toc-text">1、基于 Windows 的环境安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1%E3%80%81%E5%AE%89%E8%A3%85Java%E7%8E%AF%E5%A2%83"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1、安装Java环境</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ES%E4%B8%8EJDK%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">ES与JDK兼容性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Java%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">Java下载安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Java%E7%89%88%E6%9C%AC%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">Java版本冲突问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2%E3%80%81%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85-ES"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2、下载并安装 ES</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80-amp-%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">下载地址&amp;中文文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">文件目录</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3%E3%80%81%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3、启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-%E3%80%81%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E5%AF%86%E7%A0%81"><span class="toc-number">2.1.4.</span> <span class="toc-text">1.4 、修改默认密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5%E3%80%81%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F%E4%B8%8E%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.5.</span> <span class="toc-text">1.5、生产模式与开发模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F%E5%92%8C%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.5.1.</span> <span class="toc-text">生产模式和开发模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%AF%BC%E6%A3%80%E6%9F%A5"><span class="toc-number">2.1.5.2.</span> <span class="toc-text">引导检查</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9%E5%8F%91%E7%8E%B0"><span class="toc-number">2.1.5.3.</span> <span class="toc-text">单节点发现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6%E3%80%81%E5%8D%95%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4"><span class="toc-number">2.1.6.</span> <span class="toc-text">1.6、单节点集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD-Security%E5%92%8CSSL"><span class="toc-number">2.1.6.1.</span> <span class="toc-text">关闭 Security和SSL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-number">2.1.6.2.</span> <span class="toc-text">配置项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8"><span class="toc-number">2.1.6.3.</span> <span class="toc-text">服务启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-number">2.1.6.4.</span> <span class="toc-text">验证服务状态</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7%E3%80%81%E5%A4%9A%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4"><span class="toc-number">2.1.7.</span> <span class="toc-text">1.7、多节点集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E7%AD%96%E7%95%A5"><span class="toc-number">2.1.7.1.</span> <span class="toc-text">自动发现策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%A4%9A%E9%A1%B9%E7%9B%AE%E9%9B%86%E7%BE%A4"><span class="toc-number">2.1.7.2.</span> <span class="toc-text">本地多项目集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%8D%95%E9%A1%B9%E7%9B%AE%E9%9B%86%E7%BE%A4"><span class="toc-number">2.1.7.3.</span> <span class="toc-text">本地单项目集群</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-8%E3%80%81%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2-Kibana"><span class="toc-number">2.1.8.</span> <span class="toc-text">1.8、安装和部署 Kibana</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-9%E3%80%81%E5%B8%B8%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B7%A5%E5%85%B7"><span class="toc-number">2.1.9.</span> <span class="toc-text">1.9、常用客户端工具</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%9F%BA%E4%BA%8E-Linux-%E7%9A%84%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.</span> <span class="toc-text">2、基于 Linux 的环境安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81%E6%9E%84%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1、构建虚拟机环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E6%9E%84%E5%BB%BA-CentOS-%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2、构建 CentOS 镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">下载系统镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">配置环境</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81%E6%9E%84%E5%BB%BA-ES-%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%EF%BC%88%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2Once%EF%BC%89"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3、构建 ES 运行环境（单节点部署Once）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E4%B8%8E%E8%A7%A3%E5%8E%8B"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">下载与解压</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Elastic-%E8%B4%A6%E5%8F%B7"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">Elastic  账号</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">常见问题及解决方案</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4%E3%80%81%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2-%E5%B0%9A%E7%A1%85%E8%B0%B7"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.4、单节点部署 尚硅谷</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8B%E8%BD%AF%E4%BB%B6"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">解压软件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">创建用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.4.3.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%BD%AF%E4%BB%B6"><span class="toc-number">2.2.4.4.</span> <span class="toc-text">启动软件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">2.2.4.5.</span> <span class="toc-text">关闭防火墙</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.4.6.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5%E3%80%81%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.5、集群配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0"><span class="toc-number">2.2.5.1.</span> <span class="toc-text">自动发现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%9A%84%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.5.2.</span> <span class="toc-text">集群的核心配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">2.2.5.3.</span> <span class="toc-text">集群搭建</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6%E3%80%81%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2"><span class="toc-number">2.2.6.</span> <span class="toc-text">2.6、节点角色</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%EF%BC%88active-master%EF%BC%89"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">主节点（active master）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#master-%E5%80%99%E9%80%89%E8%8A%82%E7%82%B9-x2F-%E6%8A%95%E7%A5%A8%E8%8A%82%E7%82%B9"><span class="toc-number">2.2.6.2.</span> <span class="toc-text">master 候选节点&#x2F;投票节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#data%EF%BC%9A%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9"><span class="toc-number">2.2.6.3.</span> <span class="toc-text">data：数据节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ingest%EF%BC%9A%E9%A2%84%E5%A4%84%E7%90%86%E8%8A%82%E7%82%B9"><span class="toc-number">2.2.6.4.</span> <span class="toc-text">ingest：预处理节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#remote-cluster-client%EF%BC%9A"><span class="toc-number">2.2.6.5.</span> <span class="toc-text">remote_cluster_client：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">2.2.7.</span> <span class="toc-text">2.7、高可用集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.7.1.</span> <span class="toc-text">节点配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2Kibana"><span class="toc-number">2.2.7.2.</span> <span class="toc-text">部署Kibana</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-Kibana%EF%BC%9A"><span class="toc-number">2.2.7.2.1.</span> <span class="toc-text">下载 Kibana：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8B%EF%BC%9A"><span class="toc-number">2.2.7.2.2.</span> <span class="toc-text">解压：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.7.2.3.</span> <span class="toc-text">配置</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">3.</span> <span class="toc-text">三、核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%8A%82%E7%82%B9%EF%BC%9ANode"><span class="toc-number">3.1.</span> <span class="toc-text">1、节点：Node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%A7%92%E8%89%B2%EF%BC%9ARoles"><span class="toc-number">3.2.</span> <span class="toc-text">2、角色：Roles</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A7%92%E8%89%B2"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.1 常见的角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E4%BD%BF%E7%94%A8%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.2 使用和配置方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%B4%A2%E5%BC%95%EF%BC%9AIndex"><span class="toc-number">3.3.</span> <span class="toc-text">3、索引：Index</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E7%B1%BB%E5%9E%8B%EF%BC%9AType"><span class="toc-number">3.4.</span> <span class="toc-text">4、类型：Type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%96%87%E6%A1%A3%EF%BC%9ADocument"><span class="toc-number">3.5.</span> <span class="toc-text">5、文档：Document</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E5%AD%97%E6%AE%B5%EF%BC%9AField"><span class="toc-number">3.6.</span> <span class="toc-text">6、字段：Field</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E6%98%A0%E5%B0%84%EF%BC%9AMapping"><span class="toc-number">3.7.</span> <span class="toc-text">7、映射：Mapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E5%88%86%E7%89%87%EF%BC%9AShard"><span class="toc-number">3.8.</span> <span class="toc-text">8、分片：Shard</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1%E3%80%81%E5%88%86%E7%89%87%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">3.8.1.</span> <span class="toc-text">8.1、分片的基本概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2%E3%80%81%E5%88%86%E7%89%87%E7%9A%84%E7%A7%8D%E7%B1%BB"><span class="toc-number">3.8.2.</span> <span class="toc-text">8.2、分片的种类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3%E3%80%81%E5%88%86%E7%89%87%E7%9A%84%E4%BD%9C%E7%94%A8%E5%92%8C%E6%84%8F%E4%B9%89"><span class="toc-number">3.8.3.</span> <span class="toc-text">8.3、分片的作用和意义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4%E3%80%81%E5%88%86%E7%89%87%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%AD%96%E7%95%A5"><span class="toc-number">3.8.4.</span> <span class="toc-text">8.4、分片的基本策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81%E5%89%AF%E6%9C%AC%EF%BC%9AReplicas"><span class="toc-number">3.9.</span> <span class="toc-text">10、副本：Replicas</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81%E5%88%86%E9%85%8D%EF%BC%9AAllocation"><span class="toc-number">3.10.</span> <span class="toc-text">11、分配：Allocation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12%E3%80%81%E9%9B%86%E7%BE%A4%EF%BC%9ACluster"><span class="toc-number">3.11.</span> <span class="toc-text">12、集群：Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1%E3%80%81%E9%9B%86%E7%BE%A4%E7%9A%84%E5%81%A5%E5%BA%B7%E5%80%BC%E6%A3%80%E6%9F%A5"><span class="toc-number">3.11.1.</span> <span class="toc-text">12.1、集群的健康值检查</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="toc-number">3.11.1.1.</span> <span class="toc-text">健康状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E5%80%BC%E6%A3%80%E6%9F%A5"><span class="toc-number">3.11.1.2.</span> <span class="toc-text">健康值检查</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13%E3%80%81%E7%B4%A2%E5%BC%95%E5%92%8C%E6%96%87%E6%A1%A3"><span class="toc-number">3.12.</span> <span class="toc-text">13、索引和文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1%E3%80%81%E7%B4%A2%E5%BC%95"><span class="toc-number">3.12.1.</span> <span class="toc-text">13.1、索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2%E3%80%81%E6%96%87%E6%A1%A3"><span class="toc-number">3.12.2.</span> <span class="toc-text">13.2、文档</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%B4%A2%E5%BC%95%E5%92%8C%E6%96%87%E6%A1%A3"><span class="toc-number">4.</span> <span class="toc-text">四、索引和文档</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">4.1.</span> <span class="toc-text">1、创建索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">4.1.1.</span> <span class="toc-text">1.1 基本语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E7%B4%A2%E5%BC%95%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="toc-number">4.1.2.</span> <span class="toc-text">1.2 索引命名规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E7%B4%A2%E5%BC%95%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%84%E6%88%90"><span class="toc-number">4.1.3.</span> <span class="toc-text">1.3 索引的基本组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4%E3%80%81Postman%E8%AF%B7%E6%B1%82%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">4.1.4.</span> <span class="toc-text">1.4、Postman请求创建索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-number">4.2.</span> <span class="toc-text">2、删除索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81%E5%91%BD%E4%BB%A4%E5%88%A0%E9%99%A4"><span class="toc-number">4.2.1.</span> <span class="toc-text">2.1、命令删除</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E7%B4%A2%E5%BC%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">判断索引是否存在</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E8%AF%B7%E6%B1%82%E5%88%A0%E9%99%A4"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.2、请求删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%B4%A2%E5%BC%95%E7%9A%84%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%80%A7"><span class="toc-number">4.3.</span> <span class="toc-text">3、索引的不可变性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%93%AA%E4%BA%9B%E5%8F%82%E6%95%B0%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="toc-number">4.3.1.</span> <span class="toc-text">3.1 哪些参数不可变</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%9C%89%E4%BB%80%E4%B9%88%E5%BD%B1%E5%93%8D"><span class="toc-number">4.3.2.</span> <span class="toc-text">3.2 有什么影响</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3"><span class="toc-number">4.3.3.</span> <span class="toc-text">3.3 如何解决</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E7%B4%A2%E5%BC%95%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.4.</span> <span class="toc-text">4、索引的查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1%E3%80%81%E5%91%BD%E4%BB%A4%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.1、命令查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%89%B9%E5%AE%9A%E7%B4%A2%E5%BC%95"><span class="toc-number">4.4.1.1.</span> <span class="toc-text">查询特定索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95"><span class="toc-number">4.4.1.2.</span> <span class="toc-text">查询集群中所有索引</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2%E3%80%81%E8%AF%B7%E6%B1%82%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.4.2.</span> <span class="toc-text">4.2、请求查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">查看所有索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%8D%95%E4%B8%AA%E7%B4%A2%E5%BC%95"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">查看单个索引</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E7%B4%A2%E5%BC%95%E6%96%87%E6%A1%A3"><span class="toc-number">4.5.</span> <span class="toc-text">5、索引文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1%E3%80%81%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA"><span class="toc-number">4.5.1.</span> <span class="toc-text">5.1、命令创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2%E3%80%81%E8%AF%B7%E6%B1%82%E5%88%9B%E5%BB%BA"><span class="toc-number">4.5.2.</span> <span class="toc-text">5.2、请求创建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">4.6.</span> <span class="toc-text">6、查询文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1%E3%80%81%E5%91%BD%E4%BB%A4%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.1.</span> <span class="toc-text">6.1、命令查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-1"><span class="toc-number">4.6.1.1.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">4.6.1.2.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#source-API"><span class="toc-number">4.6.1.3.</span> <span class="toc-text">_source API</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2%E3%80%81%E8%AF%B7%E6%B1%82%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.</span> <span class="toc-text">6.2、请求查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.1.</span> <span class="toc-text">普通查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2-amp-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-amp-%E6%9F%A5%E8%AF%A2%E6%8E%92%E5%BA%8F"><span class="toc-number">4.6.2.2.</span> <span class="toc-text">条件查询 &amp; 分页查询 &amp; 查询排序</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.2.1.</span> <span class="toc-text">条件查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.2.2.</span> <span class="toc-text">分页查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%8E%92%E5%BA%8F"><span class="toc-number">4.6.2.2.3.</span> <span class="toc-text">查询排序</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2-amp-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.3.</span> <span class="toc-text">多条件查询 &amp; 范围查询</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.3.1.</span> <span class="toc-text">多条件查询</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.3.2.</span> <span class="toc-text">范围查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2-amp-%E5%AE%8C%E5%85%A8%E5%8C%B9%E9%85%8D-amp-%E9%AB%98%E4%BA%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.4.</span> <span class="toc-text">全文检索 &amp; 完全匹配 &amp; 高亮查询</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-number">4.6.2.4.1.</span> <span class="toc-text">全文检索</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%8C%E5%85%A8%E5%8C%B9%E9%85%8D"><span class="toc-number">4.6.2.4.2.</span> <span class="toc-text">完全匹配</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.4.3.</span> <span class="toc-text">高亮查询</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.6.2.5.</span> <span class="toc-text">聚合查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-number">4.7.</span> <span class="toc-text">7、删除文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1%E3%80%81%E5%91%BD%E4%BB%A4%E5%88%A0%E9%99%A4"><span class="toc-number">4.7.1.</span> <span class="toc-text">7.1、命令删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2%E3%80%81%E8%AF%B7%E6%B1%82%E5%88%A0%E9%99%A4"><span class="toc-number">4.7.2.</span> <span class="toc-text">7.2、请求删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="toc-number">4.8.</span> <span class="toc-text">8、更新文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1%E3%80%81%E5%91%BD%E4%BB%A4%E4%BF%AE%E6%94%B9"><span class="toc-number">4.8.1.</span> <span class="toc-text">8.1、命令修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2%E3%80%81%E8%AF%B7%E6%B1%82%E4%BF%AE%E6%94%B9"><span class="toc-number">4.8.2.</span> <span class="toc-text">8.2、请求修改</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E4%BF%AE%E6%94%B9"><span class="toc-number">4.8.2.1.</span> <span class="toc-text">全量修改</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E4%BF%AE%E6%94%B9"><span class="toc-number">4.8.2.2.</span> <span class="toc-text">局部修改</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Mapping"><span class="toc-number">5.</span> <span class="toc-text">五、Mapping</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Mapping-%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">1、Mapping 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1%E3%80%81%E6%98%A0%E5%B0%84%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">5.1.1.</span> <span class="toc-text">1.1、映射的基本概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2%E3%80%81%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95-mapping"><span class="toc-number">5.1.2.</span> <span class="toc-text">1.2、查看索引 mapping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3%E3%80%81%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F%E6%93%8D%E4%BD%9C%E6%98%A0%E5%B0%84"><span class="toc-number">5.1.3.</span> <span class="toc-text">1.3、请求方式操作映射</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%AD%97%E6%AE%B5%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text">2、字段数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.1.</span> <span class="toc-text">2.1、数字类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.2.</span> <span class="toc-text">2.2、基本数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81Keywords-%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.3.</span> <span class="toc-text">2.3、Keywords 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4%E3%80%81Dates%EF%BC%88%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B%EF%BC%89"><span class="toc-number">5.2.4.</span> <span class="toc-text">2.4、Dates（时间类型）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5%E3%80%81%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.5.</span> <span class="toc-text">2.5、对象类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6%E3%80%81%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.6.</span> <span class="toc-text">2.6、空间数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7%E3%80%81%E6%96%87%E6%A1%A3%E6%8E%92%E5%90%8D%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.7.</span> <span class="toc-text">2.7、文档排名类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8%E3%80%81%E6%96%87%E6%9C%AC%E6%90%9C%E7%B4%A2%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.8.</span> <span class="toc-text">2.8、文本搜索类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E4%B8%A4%E7%A7%8D%E6%98%A0%E5%B0%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.3.</span> <span class="toc-text">3、两种映射类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1%E3%80%81%E8%87%AA%E5%8A%A8%E6%98%A0%E5%B0%84%EF%BC%9ADynamic-field-mapping"><span class="toc-number">5.3.1.</span> <span class="toc-text">3.1、自动映射：Dynamic field mapping</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2%E3%80%81%E6%98%BE%E7%A4%BA%E6%98%A0%E5%B0%84-Expllcit-field-mapping"><span class="toc-number">5.3.2.</span> <span class="toc-text">3.2、显示映射 Expllcit field mapping</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%98%A0%E5%B0%84%E5%8F%82%E6%95%B0"><span class="toc-number">5.4.</span> <span class="toc-text">4、映射参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81Text-%E5%92%8C-Keyword-%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.5.</span> <span class="toc-text">5、Text 和 Keyword 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1%E3%80%81Text-%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.5.1.</span> <span class="toc-text">5.1、Text 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">5.5.1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">5.5.1.2.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-Keyword-%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.5.2.</span> <span class="toc-text">5.2 Keyword 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">5.5.2.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E5%92%8C%E8%AF%AD%E4%B9%89"><span class="toc-number">5.5.2.2.</span> <span class="toc-text">语法和语义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-1"><span class="toc-number">5.5.2.3.</span> <span class="toc-text">注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%98%A0%E5%B0%84%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.6.</span> <span class="toc-text">6、映射模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc-number">5.6.1.</span> <span class="toc-text">6.1、简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2%E3%80%81%E7%94%A8%E6%B3%95"><span class="toc-number">5.6.2.</span> <span class="toc-text">6.2、用法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-2"><span class="toc-number">5.6.2.1.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Conditions%E5%8F%82%E6%95%B0"><span class="toc-number">5.6.2.2.</span> <span class="toc-text">Conditions参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="toc-number">5.6.2.3.</span> <span class="toc-text">案例</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">6.</span> <span class="toc-text">六、分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">6.1.</span> <span class="toc-text">1、什么是分词器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81-analyze-API"><span class="toc-number">6.2.</span> <span class="toc-text">2、_analyze API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-number">6.3.</span> <span class="toc-text">3、分词器的组成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1%E3%80%81Character-Filter"><span class="toc-number">6.3.1.</span> <span class="toc-text">3.1、Character Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HTML-%E6%A0%87%E7%AD%BE%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">6.3.1.1.</span> <span class="toc-text">HTML 标签过滤器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E6%98%A0%E5%B0%84%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%9AMapping-Character-Filter"><span class="toc-number">6.3.1.2.</span> <span class="toc-text">字符映射过滤器：Mapping Character Filter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E6%9B%BF%E6%8D%A2%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%9APattern-Replace-Character-Filter"><span class="toc-number">6.3.1.3.</span> <span class="toc-text">正则替换过滤器：Pattern Replace Character Filter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2%E3%80%81Tokenizer"><span class="toc-number">6.3.2.</span> <span class="toc-text">3.2、Tokenizer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3%E3%80%81Token-Filter"><span class="toc-number">6.3.3.</span> <span class="toc-text">3.3、Token Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">6.3.3.1.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84-token-filter"><span class="toc-number">6.3.3.2.</span> <span class="toc-text">常见的 token filter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-2"><span class="toc-number">6.3.3.3.</span> <span class="toc-text">案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%9C%A8%E6%98%A0%E5%B0%84%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">6.4.</span> <span class="toc-text">4、在映射中定义分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1%E3%80%81%E8%AF%AD%E6%B3%95"><span class="toc-number">6.4.1.</span> <span class="toc-text">4.1、语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2%E3%80%81%E5%86%85%E7%BD%AE%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">6.4.2.</span> <span class="toc-text">4.2、内置分词器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">6.5.</span> <span class="toc-text">5、自定义分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1%E3%80%81%E6%A6%82%E5%BF%B5"><span class="toc-number">6.5.1.</span> <span class="toc-text">5.1、概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E6%A1%88%E4%BE%8B"><span class="toc-number">6.5.2.</span> <span class="toc-text">5.2 案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">6.6.</span> <span class="toc-text">6、中文分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">6.6.1.</span> <span class="toc-text">6.1、什么是中文分词器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2%E3%80%81%E4%B8%8B%E8%BD%BD%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">6.6.2.</span> <span class="toc-text">6.2、下载和安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3%E3%80%81%E6%A1%88%E4%BE%8B"><span class="toc-number">6.6.3.</span> <span class="toc-text">6.3、案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81JavaAPI"><span class="toc-number">7.</span> <span class="toc-text">七、JavaAPI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">7.1.</span> <span class="toc-text">1、环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%B4%A2%E5%BC%95%E5%88%9B%E5%BB%BA"><span class="toc-number">7.2.</span> <span class="toc-text">2、索引创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%B4%A2%E5%BC%95%E6%9F%A5%E8%AF%A2-amp-%E5%88%A0%E9%99%A4"><span class="toc-number">7.3.</span> <span class="toc-text">3、索引查询 &amp; 删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%96%87%E6%A1%A3%E6%96%B0%E5%A2%9E-amp-%E4%BF%AE%E6%94%B9"><span class="toc-number">7.4.</span> <span class="toc-text">4、文档新增 &amp; 修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2-amp-%E5%88%A0%E9%99%A4"><span class="toc-number">7.5.</span> <span class="toc-text">5、文档查询 &amp; 删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%96%87%E6%A1%A3-%E6%89%B9%E9%87%8F%E6%96%B0%E5%A2%9E-amp-%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span class="toc-number">7.6.</span> <span class="toc-text">6、文档 批量新增 &amp; 批量删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E6%96%87%E6%A1%A3-%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.</span> <span class="toc-text">7、文档 高级查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1%E3%80%81%E5%85%A8%E9%87%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.1.</span> <span class="toc-text">7.1、全量查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2%E3%80%81%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-amp-%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2-amp-%E6%9F%A5%E8%AF%A2%E6%8E%92%E5%BA%8F"><span class="toc-number">7.7.2.</span> <span class="toc-text">7.2、分页查询 &amp; 条件查询 &amp; 查询排序</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">7.7.2.1.</span> <span class="toc-text">条件查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">7.7.2.2.</span> <span class="toc-text">分页查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%8E%92%E5%BA%8F-1"><span class="toc-number">7.7.2.3.</span> <span class="toc-text">查询排序</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3%E3%80%81%E7%BB%84%E5%90%88%E6%9F%A5%E8%AF%A2-amp-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.3.</span> <span class="toc-text">7.3、组合查询 &amp; 范围查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.3.1.</span> <span class="toc-text">组合查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">7.7.3.2.</span> <span class="toc-text">范围查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4%E3%80%81%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2-amp-%E9%AB%98%E4%BA%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.4.</span> <span class="toc-text">7.4、模糊查询 &amp; 高亮查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.4.1.</span> <span class="toc-text">模糊查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E6%9F%A5%E8%AF%A2-1"><span class="toc-number">7.7.4.2.</span> <span class="toc-text">高亮查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-5%E3%80%81%E6%9C%80%E5%A4%A7%E5%80%BC%E6%9F%A5%E8%AF%A2-amp-%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.5.</span> <span class="toc-text">7.5、最大值查询 &amp; 分组查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%80%E5%A4%A7%E5%80%BC%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.5.1.</span> <span class="toc-text">最大值查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.5.2.</span> <span class="toc-text">分组查询</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81ES-%E8%BF%9B%E9%98%B6"><span class="toc-number">8.</span> <span class="toc-text">八、ES 进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">8.1.</span> <span class="toc-text">1、系统架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%8D%95%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4"><span class="toc-number">8.2.</span> <span class="toc-text">2、单节点集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">8.3.</span> <span class="toc-text">3、故障转移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%AE%B9"><span class="toc-number">8.4.</span> <span class="toc-text">4、水平扩容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%BA%94%E5%AF%B9%E6%95%85%E9%9A%9C"><span class="toc-number">8.5.</span> <span class="toc-text">5、应对故障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97-amp-%E5%88%86%E7%89%87%E6%8E%A7%E5%88%B6"><span class="toc-number">8.6.</span> <span class="toc-text">6、路由计算 &amp; 分片控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1%E3%80%81%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97"><span class="toc-number">8.6.1.</span> <span class="toc-text">6.1、路由计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2%E3%80%81%E5%88%86%E7%89%87%E6%8E%A7%E5%88%B6"><span class="toc-number">8.6.2.</span> <span class="toc-text">6.2、分片控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E6%95%B0%E6%8D%AE%E5%86%99%E6%B5%81%E7%A8%8B"><span class="toc-number">8.7.</span> <span class="toc-text">7、数据写流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E6%95%B0%E6%8D%AE%E8%AF%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">8.8.</span> <span class="toc-text">8、数据读流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B-amp-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">8.9.</span> <span class="toc-text">9、更新流程 &amp; 批量操作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1%E3%80%81%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">8.9.1.</span> <span class="toc-text">9.1、更新流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2%E3%80%81%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">8.9.2.</span> <span class="toc-text">9.2、批量操作流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">8.10.</span> <span class="toc-text">10、倒排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-1%E3%80%81%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86"><span class="toc-number">8.10.1.</span> <span class="toc-text">10.1、倒排索引原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2%E3%80%81%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">8.10.2.</span> <span class="toc-text">10.2、倒排索引的例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81%E6%96%87%E6%A1%A3%E6%90%9C%E7%B4%A2"><span class="toc-number">8.11.</span> <span class="toc-text">11、文档搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-1%E3%80%81%E4%B8%8D%E5%8F%AF%E6%94%B9%E5%8F%98%E7%9A%84%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-number">8.11.1.</span> <span class="toc-text">11.1、不可改变的倒排索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2%E3%80%81%E5%8A%A8%E6%80%81%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95"><span class="toc-number">8.11.2.</span> <span class="toc-text">11.2、动态更新索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12%E3%80%81%E6%96%87%E6%A1%A3%E5%88%B7%E6%96%B0-amp-%E6%96%87%E6%A1%A3%E5%88%B7%E5%86%99-amp-%E6%96%87%E6%A1%A3%E5%90%88%E5%B9%B6"><span class="toc-number">8.12.</span> <span class="toc-text">12、文档刷新 &amp; 文档刷写 &amp; 文档合并</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2"><span class="toc-number">8.12.1.</span> <span class="toc-text">近实时搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%8F%98%E6%9B%B4"><span class="toc-number">8.12.2.</span> <span class="toc-text">持久化变更</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AE%B5%E5%90%88%E5%B9%B6"><span class="toc-number">8.12.3.</span> <span class="toc-text">段合并</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13%E3%80%81%E6%96%87%E6%A1%A3%E5%88%86%E6%9E%90"><span class="toc-number">8.13.</span> <span class="toc-text">13、文档分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">8.13.1.</span> <span class="toc-text">内置分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">8.13.2.</span> <span class="toc-text">测试分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">8.13.3.</span> <span class="toc-text">指定分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IK%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">8.13.4.</span> <span class="toc-text">IK分词器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">8.13.5.</span> <span class="toc-text">自定义分析器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14%E3%80%81%E6%96%87%E6%A1%A3%E6%8E%A7%E5%88%B6"><span class="toc-number">8.14.</span> <span class="toc-text">14、文档控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1%E3%80%81%E6%96%87%E6%A1%A3%E5%86%B2%E7%AA%81"><span class="toc-number">8.14.1.</span> <span class="toc-text">14.1、文档冲突</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-2%E3%80%81%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-number">8.14.2.</span> <span class="toc-text">14.2、乐观并发控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14-3%E3%80%81%E5%A4%96%E9%83%A8%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="toc-number">8.14.3.</span> <span class="toc-text">14.3、外部系统版本控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15%E3%80%81%E6%96%87%E6%A1%A3%E5%B1%95%E7%A4%BA-Kibana"><span class="toc-number">8.15.</span> <span class="toc-text">15、文档展示-Kibana</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81Elasticsearch%E9%9B%86%E6%88%90"><span class="toc-number">9.</span> <span class="toc-text">九、Elasticsearch集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90-SpringData-%E6%95%B4%E4%BD%93%E4%BB%8B%E7%BB%8D"><span class="toc-number">9.1.</span> <span class="toc-text">1、框架集成-SpringData-整体介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90-SpringData-%E4%BB%A3%E7%A0%81%E5%8A%9F%E8%83%BD%E9%9B%86%E6%88%90"><span class="toc-number">9.2.</span> <span class="toc-text">2、框架集成-SpringData-代码功能集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90-SpringData-%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95-%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C"><span class="toc-number">9.3.</span> <span class="toc-text">3、框架集成-SpringData-集成测试-索引操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90-SpringData-%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95-%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-number">9.4.</span> <span class="toc-text">4、框架集成-SpringData-集成测试-文档操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90-SpringData-%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95-%E6%96%87%E6%A1%A3%E6%90%9C%E7%B4%A2"><span class="toc-number">9.5.</span> <span class="toc-text">5、框架集成-SpringData-集成测试-文档搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90-SparkStreaming-%E9%9B%86%E6%88%90"><span class="toc-number">9.6.</span> <span class="toc-text">6、框架集成-SparkStreaming-集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90-Flink-%E9%9B%86%E6%88%90"><span class="toc-number">9.7.</span> <span class="toc-text">7、框架集成-Flink-集成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81ES-%E4%BC%98%E5%8C%96"><span class="toc-number">10.</span> <span class="toc-text">十、ES 优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%BC%98%E5%8C%96-%E7%A1%AC%E4%BB%B6%E9%80%89%E6%8B%A9"><span class="toc-number">10.1.</span> <span class="toc-text">1、优化-硬件选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%BC%98%E5%8C%96-%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="toc-number">10.2.</span> <span class="toc-text">2、优化-分片策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E7%90%86%E8%AE%BE%E7%BD%AE%E5%88%86%E7%89%87%E6%95%B0"><span class="toc-number">10.2.1.</span> <span class="toc-text">合理设置分片数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A8%E8%BF%9F%E5%88%86%E7%89%87%E5%88%86%E9%85%8D"><span class="toc-number">10.2.2.</span> <span class="toc-text">推迟分片分配</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E4%BC%98%E5%8C%96-%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9"><span class="toc-number">10.3.</span> <span class="toc-text">3、优化-路由选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E4%BC%98%E5%8C%96-%E5%86%99%E5%85%A5%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96"><span class="toc-number">10.4.</span> <span class="toc-text">4、优化-写入速度优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87"><span class="toc-number">10.4.1.</span> <span class="toc-text">优化存储设备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E5%90%88%E5%B9%B6"><span class="toc-number">10.4.2.</span> <span class="toc-text">合理使用合并</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%8F%E5%B0%91-Refresh-%E7%9A%84%E6%AC%A1%E6%95%B0"><span class="toc-number">10.4.3.</span> <span class="toc-text">减少 Refresh 的次数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E5%A4%A7-Flush-%E8%AE%BE%E7%BD%AE"><span class="toc-number">10.4.4.</span> <span class="toc-text">加大 Flush 设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E5%89%AF%E6%9C%AC%E7%9A%84%E6%95%B0%E9%87%8F"><span class="toc-number">10.4.5.</span> <span class="toc-text">减少副本的数量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E4%BC%98%E5%8C%96-%E5%86%85%E5%AD%98%E8%AE%BE%E7%BD%AE"><span class="toc-number">10.5.</span> <span class="toc-text">5、优化-内存设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E4%BC%98%E5%8C%96-%E9%87%8D%E8%A6%81%E9%85%8D%E7%BD%AE"><span class="toc-number">10.6.</span> <span class="toc-text">6、优化-重要配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#100%E3%80%81%E9%81%87%E5%88%B0%E7%9A%84%E9%94%99%E8%AF%AF"><span class="toc-number">11.</span> <span class="toc-text">100、遇到的错误</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%97%AE%E9%A2%98%E4%B8%80%EF%BC%9Adocker-Error-response-from-daemon-driver-failed-programming-external-connectivity-on-endpoint-es"><span class="toc-number">11.1.</span> <span class="toc-text">1、问题一：docker: Error response from daemon: driver failed programming external connectivity on endpoint es</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/07/HTTP%E7%8A%B6%E6%80%81%E7%A0%81/" title="无题"><img src="/img/loading.gif" data-original="/img/page3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/10/07/HTTP%E7%8A%B6%E6%80%81%E7%A0%81/" title="无题">无题</a><time datetime="2023-10-07T15:09:36.518Z" title="发表于 2023-10-07 23:09:36">2023-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/06/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" title="JUC并发编程"><img src="/img/loading.gif" data-original="/img/page4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JUC并发编程"/></a><div class="content"><a class="title" href="/2023/10/06/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" title="JUC并发编程">JUC并发编程</a><time datetime="2023-10-06T06:55:28.000Z" title="发表于 2023-10-06 14:55:28">2023-10-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/04/PandaSearch/" title="无题"><img src="/img/loading.gif" data-original="/img/page6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/10/04/PandaSearch/" title="无题">无题</a><time datetime="2023-10-04T04:59:36.140Z" title="发表于 2023-10-04 12:59:36">2023-10-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/01/Elasticsearch/" title="无题"><img src="/img/loading.gif" data-original="/img/page4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/10/01/Elasticsearch/" title="无题">无题</a><time datetime="2023-10-01T01:50:57.541Z" title="发表于 2023-10-01 09:50:57">2023-10-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/29/DeBug/" title="无题"><img src="/img/loading.gif" data-original="/img/page5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/09/29/DeBug/" title="无题">无题</a><time datetime="2023-09-29T02:59:28.368Z" title="发表于 2023-09-29 10:59:28">2023-09-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By HUA</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script async src="https://npm.elemecdn.com/tzy-blog/lib/js/other/sakura.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/img/loading.gif" data-original="https://fastly.jsdelivr.net/gh/tzy13755126023/BLOG_SOURCE/theme_f/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://unpkg.zhimg.com/hexo-butterfly-clock/lib/clock.min.js"></script><!-- hexo injector body_end end -->
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(e){e.imageLazyLoadSetting.processImages=t;var n=e.imageLazyLoadSetting.isSPA,i=e.imageLazyLoadSetting.preloadRatio||1,r=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){n&&(r=o());for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(e.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];e=function(){r=r.filter(function(t){return o!==t})},(t=o).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,t.removeAttribute("data-original"),e&&e()},t.src!==i&&(n.src=i))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),e.addEventListener("resize",a),e.addEventListener("orientationchange",a)}(this);</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":20,"vOffset":-20},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>